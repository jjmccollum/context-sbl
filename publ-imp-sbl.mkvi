%D \module
%D   [       file=publ-imp-sbl,
%D        version=2021.08.07,
%D          title=SBL bibliography style,
%D       subtitle=Publications,
%D         author=Joey McCollum,
%D           date=\currentdate,
%D      copyright={PRAGMA ADE \& \CONTEXT\ Development Team}]
%C
%C This module is part of the \CONTEXT\ macro||package and is therefore copyrighted
%D by \PRAGMA. See mreadme.pdf for details.

\startbtxrenderingdefinitions[sbl]

\ifdefined\c!translate \else \def\c!translate{translate} \fi

%D Reference:
%D \startTEX
%D @manual{SBLH2,
%D     title     ={{SBL} Handbook of Style: For Biblical Studies and Related Disciplines},
%D     shorttitle={SBLHS},
%D     edition   ={2},
%D     address   ={Atlanta, GA},
%D     publisher ={SBL Press},
%D     date      ={2014},
%D     Xpages    ={368},
%D     url       ={https://www.sbl-site.org/publications/sblhandbookofstyle.aspx},
%D }
%D \stopTEX

% set ALL specific SBL compliant values

\definebtx
  [sbl]
  [\c!default=default,
   \c!specification=sbl,
   \c!otherstext={\btxspace\btxlabeltext{others}},
  %\c!journalconversion=\v!normal,
   \c!monthconversion=\v!month,
   \c!stopper:initials={. }, % with a (breakable) space
   \c!separator:names:2={\btxcomma}, % between subsequent names except for last 2
   \c!separator:names:3={\btxcomma\btxlabeltext{and}\space}, % between last 2 names if > 2
   \c!separator:names:4={\btxspace\btxlabeltext{and}\space}] % between only 2 names

% First, define list and rendering parameters

% The SBL style sorts the unnumbered rendered list by authoryear

\definebtxrendering
  [sbl]
  [\c!specification=sbl,
   \c!sorttype=authoryear, % by default, sort bibliographic entries by (author, year)
   \c!numbering=\v!no] % by default, do not number bibliographic entries

% Print the bibliographic list as a paragraph, 
% with normal alignment settings (justified and with hyphenation)
\setupbtxlist
  [sbl]
  [\c!alternative=\v!paragraph,
   \c!align={normal,verytolerant,stretch},
  %\c!width=\v!fit,
  %\c!distance=.5\emwidth,
   \c!margin=3.5\emwidth]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% List citation field styles
%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\definebtx
  [sbl:\s!list]
  [sbl]
  [\c!otherstext={\btxspace\btxlabeltext{others}},
  \c!etallimit=,
  \c!etaldisplay=,
  \c!etaloption=last,
  \c!authorconversion=normal]

% First, we define a namespace for a few special fields (mostly names that require special handling)

\definebtx
  [sbl:\s!list:author]
  [sbl:\s!list]
  [\c!authorconversion=inverted] % TODO: need to print just the first name inverted, with all subsequent names in normal order

\definebtx
  [sbl:\s!list:withauthor]
  [sbl:\s!list]

\definebtx
  [sbl:\s!list:editor]
  [sbl:\s!list] % use normal authorconversion for editors who are in addition to authors (editors in place of authors should be handled by sbl:\s!list:author)

\definebtx
  [sbl:\s!list:witheditor]
  [sbl:\s!list]

\definebtx
  [sbl:\s!list:translator]
  [sbl:\s!list]

\definebtx
  [sbl:\s!list:withtranslator]
  [sbl:\s!list]

\definebtx
  [sbl:\s!list:suffix]
  [sbl:\s!list]

\definebtx
  [sbl:\s!list:url]
  [sbl:\s!list]

\definebtx
  [sbl:\s!list:doi]
  [sbl:\s!list]

\definebtx
  [sbl:\s!list:\s!page]
  [sbl:\s!list]

\definebtx
  [sbl:\s!list:numbering]
  [sbl:\s!list]
  [\c!right={\btxspace}]

\definebtx
  [sbl:\s!list:numbering:default]
  [sbl:\s!list:numbering]

\definebtx
  [sbl:\s!list:numbering:num]
  [sbl:\s!list:numbering]
  [\c!stopper={.}]

\definebtx
  [sbl:\s!list:numbering:short]
  [sbl:\s!list:numbering]

\definebtx
  [sbl:\s!list:numbering:tag]
  [sbl:\s!list:numbering]

\definebtx
  [sbl:\s!list:numbering:index]
  [sbl:\s!list:numbering]

% Since the title may be italicized or quoted depending on the entry category, 
% it will help to define a namespace for each category.
% Note that the namespacing is simply for clarity and convenience;
% to get ConTeXt to actually use category-dependent styles, we need to use the
% \btxstartstyleandcolor[sbl:\s!list:title:\currentbtxcategory] ... \btxstopstyleandcolor environment
% (to activate the style parameter)
% and the \btxusecommand[sbl:\s!list:title:\currentbtxcategory] command
% (to invoke the command parameter)

\starttexdefinition titleemph #1
  \emph{\Word{#1}}
\stoptexdefinition

\starttexdefinition titlequote #1
  \quotation{\Word{#1}}
\stoptexdefinition

\definebtx
  [sbl:\s!list:title]
  [sbl:\s!list]
  [\c!command=\titleemph, % by default, titles should be italicized and their first word capitalized
   \c!translate=\v!yes]

\definebtx
  [sbl:\s!list:title:journal]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:article]
  [sbl:\s!list:title]
  [\c!style=, %disable italics
  \c!command=\titlequote] % article title is quoted and its first word is capitalized

\definebtx
  [sbl:\s!list:title:magazine]
  [sbl:\s!list:title:article]

\definebtx
  [sbl:\s!list:title:newspaper]
  [sbl:\s!list:title:article]

\definebtx
  [sbl:\s!list:title:periodical]
  [sbl:\s!list:title:article]

\definebtx
  [sbl:\s!list:title:review]
  [sbl:\s!list:title:article]

\definebtx
  [sbl:\s!list:title:book]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:reference]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:commentary]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:lexicon]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:manual]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:collection]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:mvbook]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:mvreference]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:mvcommentary]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:mvlexicon]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:series]
  [sbl:\s!list:title]
  [\c!style=, %disable italics
  \c!command=,] %disable capitalization

\definebtx
  [sbl:\s!list:title:inbook]
  [sbl:\s!list:title]
  [\c!style=, %disable italics
  \c!command=\titlequote] % article title is quoted and its first word is capitalized

\definebtx
  [sbl:\s!list:title:inreference]
  [sbl:\s!list:title:inbook]

\definebtx
  [sbl:\s!list:title:inlexicon]
  [sbl:\s!list:title:inbook]

\definebtx
  [sbl:\s!list:title:incommentary]
  [sbl:\s!list:title:inbook]

\definebtx
  [sbl:\s!list:title:seminarpaper]
  [sbl:\s!list:title:inbook]

\definebtx
  [sbl:\s!list:title:ancienttext]
  [sbl:\s!list:title:inbook]

\definebtx
  [sbl:\s!list:title:classictext]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:collection]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:incollection]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:proceedings]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:inproceedings]
  [sbl:\s!list:title:inbook]

\definebtx
  [sbl:\s!list:title:conference]
  [sbl:\s!list:title:inbook]

\definebtx
  [sbl:\s!list:title:conferencepaper]
  [sbl:\s!list:title:inbook]

\definebtx
  [sbl:\s!list:title:unpublished]
  [sbl:\s!list:title]
  [\c!style=, %disable italics
  \c!command=\titlequote] % unpublished title is quoted and its first word is capitalized

\definebtx
  [sbl:\s!list:title:thesis]
  [sbl:\s!list:title:unpublished]

\definebtx
  [sbl:\s!list:title:mastersthesis]
  [sbl:\s!list:title:thesis]

\definebtx
  [sbl:\s!list:title:phdthesis]
  [sbl:\s!list:title:thesis]

\definebtx
  [sbl:\s!list:title:online]
  [sbl:\s!list:title:unpublished]

\definebtx
  [sbl:\s!list:title:electronic]
  [sbl:\s!list:title:unpublished]

\definebtx
  [sbl:\s!list:title:misc]
  [sbl:\s!list:title:unpublished]

\definebtx
  [sbl:\s!list:title:literal]
  [sbl:\s!list:title:unpublished]

\definebtx
  [sbl:\s!list:type]
  [\c!command=\Word] % always capitalize, as the type field will follow a period in the list entry

\definebtx
  [sbl:\s!list:edition]
  [\c!command=\Word] % always capitalize, as the edition field will follow a period in the list entry

\definebtx
  [sbl:\s!list:note]
  [\c!command=\Word] % always capitalize, as the note field will follow a period in the list entry

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% In-text citation field styles
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% General rules to be inherited or excepted by other types of citations
\definebtx
  [sbl:\s!cite]
  [sbl]
  [\c!alternative=inline, % by default, SBL uses inline citation format (defined below)
   \c!otherstext={\btxspace\btxlabeltext{others}}, % use et al. for truncated author / editor list
   \c!etallimit=3, % don't use et al. for 3 or fewer authors
   \c!etaldisplay=1, % but if there are > 3, then only list the first explicitly
   \c!etaloption=last,
   \c!authorconversion=\v!normal, % by default, use normal name order for in-text citations
   \c!sorttype=normal, % \v!normal ?
   \c!style=, % do not apply any styles across the whole citation
   \c!compress=\v!yes] % note that cite sorts only work with compress=yes.

% Just cite the author's last name
\definebtx
  [sbl:\s!cite:name]
  [sbl:\s!cite]
  [\c!authorconversion=\v!name]

% The alternatives that follow are not suggested by SBL,
% so perhaps they are not necessary?
% TODO: authortitle (intended to use shorttitle and author's last name for subsequent citations) 
% would be useful, however.

% Just cite the author's last name in full followed by first names(s) in full
\definebtx
  [sbl:\s!cite:inverted]
  [sbl:\s!cite]
  [\c!authorconversion=\v!inverted]

% Just cite the author's last name in full followed by first initial(s)
\definebtx
  [sbl:\s!cite:invertedshort]
  [sbl:\s!cite]
  [\c!authorconversion=\v!invertedshort]

% Just cite the author's first initial(s) followed by last name in full
\definebtx
  [sbl:\s!cite:normalshort]
  [sbl:\s!cite]
  [\c!authorconversion=\v!normalshort]

% Just cite the author's name in full
\definebtx
  [sbl:\s!cite:normal]
  [sbl:\s!cite]
  [\c!authorconversion=\v!normal]

\definebtx
  [sbl:\s!cite:author]
  [sbl:\s!cite:normal]

\definebtx
  [sbl:\s!cite:authoryear]
  [sbl:\s!cite:author]
  [\c!left={(},
   \c!right={)},
   \c!inbetween={\btxcomma}]

\definebtx
  [sbl:\s!cite:authoryears]
  [sbl:\s!cite:author]
  [\c!left=, % these two settings are perhaps redundant?
   \c!right=,
   \c!inbetween={\btxcomma}]

\definebtx
  [sbl:\s!cite:authornum]
  [sbl:\s!cite:author]
  [\c!left={(},
   \c!right={)}]

\definebtx
  [sbl:\s!cite:author:num] % todo
  [sbl:\s!cite:authornum]
  [\c!left={\btxspace[},
   \c!right={]}]

\definebtx
  [sbl:\s!cite:author:year] % todo
  [sbl:\s!cite]

\definebtx
  [sbl:\s!cite:author:years] % todo
  [sbl:\s!cite:authoryears]
  [\c!inbetween=,
   \c!left={\btxspace(},
   \c!right={)}]

\definebtx
  [sbl:\s!cite:lefttext]
  [sbl:\s!cite]

\definebtx
  [sbl:\s!cite:righttext]
  [sbl:\s!cite]

\definebtx
  [sbl:\s!cite:year]
  [sbl:\s!cite]
  [\c!separator:2={\btxcomma}, % between subsequent years except for last 2
   \c!separator:3={\btxcomma\btxlabeltext{and}\space}, % between last 2 years if > 2
   \c!separator:4={\btxspace\btxlabeltext{and}\space}] % between only 2 years

% these setups need to be explicitly defined in order to get cite rendering

\startsetups \s!btx:sbl:\s!cite:author
  \fastsetup{\s!btx:\s!cite:normal}
\stopsetups

% Citation rules for titles (italicize by default)
\definebtx
  [sbl:\s!cite:title]
  [sbl:\s!cite]
  [\c!separator:2={\btxcomma}, % between subsequent titles except for last 2
   \c!separator:3={\btxcomma\btxlabeltext{and}\space}, % between last 2 titles if > 2
   \c!separator:4={\btxspace\btxlabeltext{and}\space}, % between only 2 titles
   \c!command={\language[\currentbtxlanguage]}, % set the language to that of the entry with the current title
   \c!sorttype=none,
   \c!style=\v!em]

\definebtx
  [sbl:\s!cite:journal] % when specified within an article entry
  [sbl:\s!cite:title]

[sbl:\s!cite:title:journal]
  [sbl:\s!cite:title]

% Exceptional cases; these titles are only in quotations, not italicized
% TODO: but how to place separators inside quotations (American style) rather than outside?
\definebtx
  [sbl:\s!cite:title:article]
  [sbl:\s!cite:title]
  [\c!style=\v!quotation] % article title is quoted

\definebtx
  [sbl:\s!cite:title:magazine]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:newspaper]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:periodical]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:inbook]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:inproceedings]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:thesis]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:mastersthesis]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:phdthesis]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:unpublished]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:electronic]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:online]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:misc]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:tag]
  [sbl:\s!cite]
  [\c!left={[},
   \c!right={]}]

\definebtx
  [sbl:\s!cite:index]
  [sbl:\s!cite]
  [\c!left={[},
   \c!right={]}]

% Page number citations
\definebtx
  [sbl:\s!cite:page]
  [sbl:\s!cite]
  [\c!left=,
   \c!right=,
   \c!separator:2={\btxcomma}, % between subsequent page ranges except for last 2
   \c!separator:3={\btxcomma\btxlabeltext{and}\space}, % between last 2 page ranges if > 2
   \c!separator:4={\btxspace\btxlabeltext{and}\space}] % between only 2 page ranges

\definebtx
  [sbl:\s!cite:pages]
  [sbl:\s!cite:page]

\definebtx
  [sbl:\s!cite:keywords]
  [sbl:\s!cite]

\definebtx
  [sbl:\s!cite:short]
  [sbl:\s!cite:name]

\definebtx
  [sbl:\s!cite:category]
  [sbl:\s!cite]

\definebtx
  [sbl:\s!cite:url]
  [sbl:\s!cite]
  [\c!left={(},
   \c!right={)}]

\definebtx
  [sbl:\s!cite:doi]
  [sbl:\s!cite:url]

% LaTeX-style bibliography entry number citation
\definebtx
  [sbl:\s!cite:num]
  [sbl:\s!cite]
  [\c!left={[},
   \c!right={]},
   \c!separator:2={,}, % between subsequent reference numbers except for last 2
   \c!separator:3=\btxparameter{\c!separator:2}, % between last 2 reference numbers if > 2
   \c!separator:4=\btxparameter{\c!separator:2}] % between only 2 reference numbers

% LaTeX \ref-style bibliography entry number citation
\definebtx
  [sbl:\s!cite:textnum]
  [sbl:\s!cite:num]
  [\c!left={Ref.\nbsp},
   \c!right=,
   \c!separator:2={\btxcomma}, % between subsequent reference numbers except for last 2
   \c!separator:3={\btxspace\btxlabeltext{and}\space}, % between last 2 reference numbers if > 2
   \c!separator:4={\btxspace\btxlabeltext{and}\space}] % between only 2 reference numbers

% Define default settings for citations that replicate list entries
\definebtx
  [sbl:\s!cite:entry]
  [sbl:\s!cite]
  [\c!left=, % by default, do not typeset anything to the left of the citation
   \c!right=, % by default, do not typeset anything to the right of the citation
   \c!separator:2={\btxsemicolon}, % between subsequent citations except for last 2
   \c!separator:3={\btxsemicolon\btxlabeltext{and}\space}, % between last 2 citations if > 2
   \c!separator:4={\btxspace\btxlabeltext{and}\space}] % between only 2 citations

% Inline citations are similar to list entry citations, 
% but they have slightly different rules for punctuation and capitalization for fields
\definebtx
  [sbl:\s!cite:inline]
  [sbl:\s!cite]

% List subcitations are similar to list citations
\definebtx
  [sbl:\s!cite:listsubcite]
  [sbl:\s!cite:entry]

% Inline subcitations are similar to inline citations
\definebtx
  [sbl:\s!cite:subcite]
  [sbl:\s!cite:inline]

% Parenthetical citations should be rendered exactly like inline citations, 
% but the whole citation should be surrounded by parentheses, 
% and brackets should be used where parentheses are within the citation 
% (e.g., journal years and publication and institution blocks) 
\definebtx
  [sbl:\s!cite:paren]
  [sbl:\s!cite:inline]
  [\c!left={\startparen},
   \c!right={\stopparen}]

% Citations in footnotes should be rendered exactly like citations in the text
\definebtx
  [sbl:\s!cite:footnote]
  [sbl:\s!cite:inline]

% By default, SBL uses inline format for in-text citations
\definebtx
  [sbl:\s!cite:default]
  [sbl:\s!cite:inline]

% Volume (and part) number citations
\definebtx
  [sbl:\s!cite:volume]
  [sbl:\s!cite:page]

% Now we setup for the details of the renderings

%D Sometimes we have verbose injections in an entry and these can be language
%D dependent, so we use labels.
%D
%D Because we want to mix rendering (in the manual) we need a namespace in label
%D texts:

\setupbtxlabeltext
  [en]
  [sbl:edition={ed.},
   sbl:editor={ed.},
   sbl:editionfull={edition},
   sbl:editors={eds.},
   sbl:Page={Page},
   sbl:Pages={Pages},
   sbl:esp={esp.},
   sbl:edited={edited},
   sbl:Edited={Edited},
   sbl:translator={trans.},
   sbl:translated={translated},
   sbl:Translated={Translated},
   sbl:volume={vol.},
   sbl:volumes={vols.},
   sbl:Volume={Vol.},
   sbl:Volumes={Vols.},
   sbl:part={part},
   sbl:parts={parts},
   sbl:diss={diss.},
   sbl:masters={Master's},
   sbl:phd={PhD},
   sbl:reprint={repr.},
   sbl:Reprint={Repr.},
   sbl:review={review},
   sbl:Review={Review},
   sbl:paperpresentedat={paper presented at},
   sbl:Paperpresentedat={Paper presented at},
   sbl:with={with},
   sbl:by={by},
   sbl:in={in},
   sbl:In={In},
   sbl:of={of},
   sbl:to={to},
   sbl:released={released},
   sbl:Released={Released},
   sbl:Translationof={Translation of},
   sbl:Reprintof={Reprint of}]

% First some helpers:

% Nested parentheses (used for things like publisher and institution blocks) should alternate between proper parentheses and brackets
\definedelimitedtext[paren][quotation][location=text,left={(},right={)}]
\setupdelimitedtext[paren:1][left={(},right={)}]
\setupdelimitedtext[paren:2][left={[}, right={]}]
\setupdelimitedtext[paren:3][left={(},right={)}]
\setupdelimitedtext[paren:4][left={[}, right={]}]

% Define some helper functions for subcitations
\let\btxroottag\empty% the tag of the initially cited entry
\def\shorthandtag{none}% the current entry (if any) with a shorthand to be used
\def\btxprintpubl{yes}% yes/no indicating whether publication information should be specified for the current citation or subcitation
\let\btxcurrentsubcitetype\empty% the type of subcitation we're invoking

% If the current entry or the book or collection containing it has a shorthand,
% then update the \shorthandtag variable to it
\starttexdefinition sbl:setshorthandtag
  \def\shorthandtag{none}%
  \btxdoifelse{shorthand} {
    \def\shorthandtag{\currentbtxtag}%
  } {
    \btxdoif{bookxref} {
      \def\bookxreftag{\btxflush{bookxref}}
      \clf_btxdoifelse{\currentbtxdataset}{\bookxreftag}{shorthand} {
        \def\shorthandtag{\bookxreftag}%
      } {
        \clf_btxdoif{\currentbtxdataset}{\bookxreftag}{collectionxref} {
          \def\collectionxreftag{\clf_btxflush{\currentbtxdataset}{\bookxreftag}{collectionxref}}
          \clf_btxdoif{\currentbtxdataset}{\collectionxreftag}{shorthand} {
            \def\shorthandtag{\collectionxreftag}%
          }
        }
      }
    }
  }
\stoptexdefinition

% Define handlers for same-author entries in the list
\startsetups sbl:list:sameauthor
  \fastsetup{sbl:list:sameauthor:rule} % by default, just use a long line (defined below)
\stopsetups

\startsetups sbl:list:sameauthor:rule
  \blackrule
    [\c!width=6em,
    \c!height=1ex,
    \c!depth=\dimexpr\linewidth-1ex\relax] % to lift it off the baseline (we're not underlining anything!)
\stopsetups

\startsetups [sbl:list:sameauthor:\v!empty]
  \kern\dimexpr\listparameter\c!margin-\interwordspace\relax% just indent by the margin, minus a space for the next word
\stopsetups

\startsetups sbl:list:sameauthor:ditto
  {Ibid.}
\stopsetups

% I thought \enordinaldaynumber was already defined elsewhere in ConTeXt, 
% but the engine isn't recognizing it...
\starttexdefinition btx:sbl:enordinal #1
  #1\ifnum\lasttwodigits{#1}=11
    th%
  \else\ifnum\lasttwodigits{#1}=12
    th%
  \else\ifnum\lasttwodigits{#1}=13
    th%
  \else\ifcase\lastdigit{#1}%
    th%
    \or % 1
      st%
    \or % 2
      nd%
    \or % 3
      rd%
  \else
    th%
  \fi\fi\fi\fi
\stoptexdefinition

\starttexdefinition btx:sbl:list:author
  \btxdoif {author} {
    % If this entry's author is the same as that of the previous entry, then use samauthor settings (if they're set):
    \doifelsesetups{sbl:list:sameauthor} {
      \btxdoifelsesameasprevious {author} {
        \fastsetup{sbl:list:sameauthor}
      } {
        % Print the author/editor/org name in inverted order
        % TODO: need to print the first name inverted, with all subsequent names in normal order
        \btxflush{author}
      }
    } {
      % Print the author/editor/org name in inverted order
      % TODO: need to print the first name inverted, with all subsequent names in normal order
      \btxflush{author}
    }
    % If this is an instance of an editor, then there is no author; 
    % indicate that this is an editor
    \doifelse {\btxfoundname{author}} {editor} {
      \btxcomma
      \btxsingularorplural {author} {
        \btxlabeltext{sbl:editor}
      } {
        \btxlabeltext{sbl:editors}
      }
      % Is there an assisting editor?
      \btxdoif {witheditor} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {witheditortype} {
          \btxflush{witheditortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{witheditor}
      }
    } {
      % If this is an author, is there an assisting author?
      \btxdoif {withauthor} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {withauthortype} {
          \btxflush{withauthortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{withauthor}
      }
    }
    % If the name ends with a period (as is the case for an initial or "et al."), 
    % then remove the preceding period
    \removeunwantedspaces
    \removepunctuation
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:listsubcite:author
  \btxdoif {author} {
    % If the author and withauthor match the corresponding fields in the root citation, 
    % then skip this
    \doifnot {\btxdirect{\btxfoundname{author}}\btxdirect{withauthor}} {\clf_btxdirect{\currentbtxdataset}{\btxroottag}{\btxfoundname{author}}\clf_btxdirect{\currentbtxdataset}{\btxroottag}{withauthor}} {
      % If this is an instance of an editor, then there is no author; 
      % indicate that this is an editor
      \doifelse {\btxfoundname{author}} {editor} {
        \btxlabeltext{sbl:Edited} % singular or plural doesn't matter here, as "ed." comes first
        \btxspace
        \btxlabeltext{sbl:by}
        \btxspace
        \currentbtxciteauthorbyfield
        % Is there an assisting editor?
        \btxdoif {witheditor} {
          \btxcomma
          % Use the provided text to introduce them, if one is specified
          \btxdoifelse {witheditortype} {
            \btxflush{witheditortype}
          } {
            \btxlabeltext{sbl:with}
          }
          \btxspace
          \btxflush{witheditor}
        }
      } {
        % If this is a proper author, then replace the preceding period with a comma,
        % and precede the author's name with "by"
        \removeunwantedspaces
        \removepunctuation
        \btxcomma
        \btxlabeltext{sbl:by}
        \btxspace
        \currentbtxciteauthorbyfield
        % If this is an author, is there an assisting author?
        \btxdoif {withauthor} {
          \btxcomma
          % Use the provided text to introduce them, if one is specified
          \btxdoifelse {withauthortype} {
            \btxflush{withauthortype}
          } {
            \btxlabeltext{sbl:with}
          }
          \btxspace
          \btxflush{withauthor}
        }
      }
      % If the name ends with a period (as is the case for "et al."), 
      % then remove the preceding period
      \removeunwantedspaces
      \removepunctuation
      \btxperiod
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:cite:author
  \btxdoif {author} {
    % Print the author/editor/org name first in normal order
    \currentbtxciteauthorbyfield
    % If this is an instance of an editor, then there is no author; 
    % indicate that this is an editor
    \doifelse {\btxfoundname{author}} {editor} {
      \btxcomma
      \btxsingularorplural {editor} {
        \btxlabeltext{sbl:editor}
      } {
        \btxlabeltext{sbl:editors}
      }
      % Is there an assisting editor?
      \btxdoif {witheditor} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {witheditortype} {
          \btxflush{witheditortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{witheditor}
      }
    } {
      % If this is an author or organization, is there an assisting author?
      \btxdoif {withauthor} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {withauthortype} {
          \btxflush{withauthortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{withauthor}
      }
    }
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:subcite:author
  \btxdoif {author} {
    % If the author and withauthor match the corresponding fields in the root citation, 
    % then skip this
    \doifnot {\btxdirect{\btxfoundname{author}}\btxdirect{withauthor}} {\clf_btxdirect{\currentbtxdataset}{\btxroottag}{\btxfoundname{author}}\clf_btxdirect{\currentbtxdataset}{\btxroottag}{withauthor}} {
      % If this is an instance of an editor, then there is no author; 
      % indicate that this is an editor
      \doifelse {\btxfoundname{author}} {editor} {
        \btxlabeltext{sbl:editor} % singular or plural doesn't matter here, as "ed." comes first
        \btxspace
        \currentbtxciteauthorbyfield
        % Is there an assisting editor?
        \btxdoif {witheditor} {
          \btxcomma
          % Use the provided text to introduce them, if one is specified
          \btxdoifelse {witheditortype} {
            \btxflush{witheditortype}
          } {
            \btxlabeltext{sbl:with}
          }
          \btxspace
          \btxflush{witheditor}
        }
      } {
        \btxlabeltext{sbl:by}
        \btxspace
        \currentbtxciteauthorbyfield
        % If this is an author, is there an assisting author?
        \btxdoif {withauthor} {
          \btxcomma
          % Use the provided text to introduce them, if one is specified
          \btxdoifelse {withauthortype} {
            \btxflush{withauthortype}
          } {
            \btxlabeltext{sbl:with}
          }
          \btxspace
          \btxflush{withauthor}
        }
      }
      \btxcomma
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:short:author
  \btxdoif{author} {
    \currentbtxciteauthorbyfield
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:title
  \btxdoif {title} {
    % If the entry is of type plaintitle, then do not apply formatting to its title
    \doifelse{\btxflush{type}}{plainttitle} {
      \btxflush{title}
    } {
      \btxstartstyleandcolor[sbl:\s!list:title:\currentbtxcategory]
        \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
          \btxflush{title}% set the title according to the current category
        }
      \btxstopstyleandcolor
    }
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:cite:title
  \btxdoif {title} {
    % If the entry is of type plaintitle, then do not apply formatting to its title
    \doifelse{\btxflush{type}}{plaintitle} {
      \btxflush{title}
    } {
      \btxstartstyleandcolor[sbl:\s!list:title:\currentbtxcategory]
        \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
          \btxflush{title}% set the title according to the current category
        }
      \btxstopstyleandcolor
    }
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:short:title
  % Use the shorttitle if available;
  % otherwise, use full title
  \btxdoifelse{shorttitle} {
    % If the entry is of type plaintitle, then do not apply formatting to its title
    \doifelse{\btxflush{type}}{plaintitle} {
      \btxflush{shorttitle}
    } {
      \btxstartstyleandcolor[sbl:\s!list:title:\currentbtxcategory]
        \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
          \btxflush{shorttitle}% set the title according to the current category
        }
      \btxstopstyleandcolor
    }
    \btxcomma
  } {
    \texdefinition{btx:sbl:cite:title}
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:ancienttexttitle
  \texdefinition{btx:sbl:cite:title}
\stoptexdefinition

\starttexdefinition btx:sbl:cite:ancienttexttitle
  \btxdoif {title} {
    % For PGM, typeset the shorthand PGM with book formatting
    \doifinset {\btxflush{type}} {PGM} {
      \btxstartstyleandcolor[sbl:\s!list:title:book]
        \btxusecommand[sbl:\s!list:title:book]{
          {PGM}%
        }
      \btxstopstyleandcolor
      \btxcomma
    }
    % For all other cases, just use the regular formatting
    \doifnotinset {\btxflush{type}} {PGM} {
      \texdefinition{btx:sbl:cite:title}
    }
    % If there is a lefttext containing a reference within the ancient text, then remove the preceding comma and print it after the title
    \doifnot {\currentbtxlefttext} {\empty} {
      \removeunwantedspaces
      \removepunctuation
      \btxspace
      \texdefinition{btx:sbl:cite:lefttext}
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:short:ancienttexttitle
  \btxdoif {title} {
    % For PGM, typeset the shorthand PGM with book formatting
    \doifinset {\btxflush{type}} {PGM} {
      \btxstartstyleandcolor[sbl:\s!list:title:book]
        \btxusecommand[sbl:\s!list:title:book]{
          {PGM}%
        }
      \btxstopstyleandcolor
      \btxcomma
    }
    % For all other cases, just use the regular formatting
    \doifnotinset {\btxflush{type}} {PGM} {
      \texdefinition{btx:sbl:short:title}
    }
    % If there is a lefttext containing a reference within the ancient text, then remove the preceding comma and print it after the title
    \doifnot {\currentbtxlefttext} {\empty} {
      \removeunwantedspaces
      \removepunctuation
      \btxspace
      \texdefinition{btx:sbl:cite:lefttext}
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:classictexttitle
  \texdefinition{btx:sbl:list:title}
\stoptexdefinition

\starttexdefinition btx:sbl:cite:classictexttitle
  \btxdoif {title} {
    \texdefinition{btx:sbl:cite:title}
    % If there is a lefttext containing a reference within the ancient text, then print it after the title
    \doifnot {\currentbtxlefttext} {\empty} {
      \removeunwantedspaces
      \removepunctuation
      \btxspace
      \texdefinition{btx:sbl:cite:lefttext}
    }
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:short:classictexttitle
  \texdefinition{btx:sbl:short:title}
\stoptexdefinition

\starttexdefinition btx:sbl:list:shorthand
  \btxdoif {shorthand} {
    % If the entry is of type plaintitle or plainshorthand, then do not apply formatting to its shorthand
    \doifinsetelse{\btxflush{type}}{plainttitle, plainshorthand} {
      \btxflush{shorthand}
    } {
      \btxstartstyleandcolor[sbl:\s!list:title:\currentbtxcategory]
        \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
          \btxflush{shorthand}% set the shorthand according to the current category
        }
      \btxstopstyleandcolor
    }
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:cite:shorthand
  \btxdoif {shorthand} {
    % If the entry is of type plaintitle or plainshorthand, then do not apply formatting to its shorthand
    \doifinsetelse{\btxflush{type}}{plainttitle, plainshorthand} {
      \btxflush{shorthand}
    } {
      \btxstartstyleandcolor[sbl:\s!list:title:\currentbtxcategory]
        \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
          \btxflush{shorthand}% set the shorthand according to the current category
        }
      \btxstopstyleandcolor
    }
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:cite:bookshorthand
  % Even if a book does not have a shorthand, the collection containing it might;
  % if it does, then we should use it
  \btxdoifelse {shorthand} {
    % If the entry is of type plaintitle or plainshorthand, then do not apply formatting to its shorthand
    \doifinsetelse{\btxflush{type}}{plainttitle, plainshorthand} {
      \btxflush{shorthand}
    } {
      \btxstartstyleandcolor[sbl:\s!list:title:\currentbtxcategory]
        \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
          \btxflush{shorthand}% set the shorthand according to the current category
        }
      \btxstopstyleandcolor
    }
    \btxcomma
  } {

  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:editor
  \btxdoif {editor} {
    % If editor(s) not already listed in the author position, then list here
    \doifnot {\btxfoundname{author}} {editor} {
      % Preface with "Edited by" unless a specific editortype is specified
      \btxdoifelse {editortype} {
        \btxusecommand[sbl:\s!list:title]{
          \btxflush{editortype}% make sure it's capitalized
        }
      } {
        \btxlabeltext{sbl:Edited}
        \btxspace
        \btxlabeltext{sbl:by}
      }
      \btxspace
      \btxflush{editor}
      % Is there an assisting editor?
      \btxdoif {witheditor} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {witheditortype} {
          \btxflush{witheditortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{witheditor}
      }
      % If the name ends with a period (as is the case for "et al."), 
      % then remove the preceding period
      \removeunwantedspaces
      \removepunctuation
      \btxperiod
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:listsubcite:editor
  \btxdoif {editor} {
    % If the editor and witheditor match the corresponding fields in the root citation, 
    % then skip this
    \doifnot {\btxdirect{editor}\btxdirect{witheditor}} {\clf_btxdirect{\currentbtxdataset}{\btxroottag}{editor}\clf_btxdirect{\currentbtxdataset}{\btxroottag}{witheditor}} {
      % Preface with "Edited by" unless a specific editortype is specified
      \btxdoifelse {editortype} {
        \btxusecommand[sbl:\s!list:title]{
          \btxflush{editortype}% make sure it's capitalized
        }
      } {
        \btxlabeltext{sbl:Edited}
        \btxspace
        \btxlabeltext{sbl:by}
      }
      \btxspace
      \btxflush{editor}
      % Is there an assisting editor?
      \btxdoif {witheditor} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {witheditortype} {
          \btxflush{witheditortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{witheditor}
      }
      % If the name ends with a period (as is the case for "et al."), 
      % then remove the preceding period
      \removeunwantedspaces
      \removepunctuation
      \btxperiod
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:cite:editor
  \btxdoif {editor} {
    % If editor(s) not already listed in the author position, then list here
    \doifnot {\btxfoundname{author}} {editor} {
      % Preface with the "editor" abbreviation unless a specific editortype is specified
      \btxdoifelse {editortype} {
        \btxflush{editortype}%
      } {
        \btxlabeltext{sbl:editor} % singular or plural doesn't matter here, as "ed." comes first
      }
      \btxspace
      \btxflush{editor}
      % Is there an assisting editor?
      \btxdoif {witheditor} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {witheditortype} {
          \btxflush{witheditortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{witheditor}
      }
      \btxcomma
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:subcite:editor
  \btxdoif {editor} {
    % If the editor and witheditor matches the corresponding fields in the root citation, 
    % then skip this
    \doifnot {\btxdirect{editor}\btxdirect{witheditor}} {\clf_btxdirect{\currentbtxdataset}{\btxroottag}{editor}\clf_btxdirect{\currentbtxdataset}{\btxroottag}{witheditor}} {
      % Preface with the "editor" abbreviation unless a specific editortype is specified
      \btxdoifelse {editortype} {
        \btxflush{editortype}%
      } {
        \btxlabeltext{sbl:editor} % singular or plural doesn't matter here, as "ed." comes first
      }
      \btxspace
      \btxflush{editor}
      % Is there an assisting editor?
      \btxdoif {witheditor} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {witheditortype} {
          \btxflush{witheditortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{witheditor}
      }
      \btxcomma
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:translator
  \btxdoif {translator} {
    \btxlabeltext{sbl:Translated}
    \btxspace
    % If there is a note on the work in the original language (e.g., "from the 3rd German ed."),
    % then print it here
    \btxdoif {origlanguage} {
      \btxflush{origlanguage}
      \btxspace
    }
    \btxlabeltext{sbl:by}
    \btxspace
    \btxflush{translator}
    % Is there an assisting translator?
    \btxdoif {withtranslator} {
      \btxcomma
      % Use the provided text to introduce them, if one is specified
      \btxdoifelse {withtranslatortype} {
        \btxflush{withtranslatortype}
      } {
        \btxlabeltext{sbl:with}
      }
      \btxspace
      \btxflush{withtranslator}
    }
    % If the name ends with a period (as is the case for "et al."), 
    % then remove the preceding period
    \removeunwantedspaces
    \removepunctuation
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:listsubcite:translator
  \btxdoif {translator} {
    % If the translator and withtranslator match the corresponding fields in the root citation, 
    % then skip this
    \doifnot {\btxdirect{translator}\btxdirect{withtranslator}} {\clf_btxdirect{\currentbtxdataset}{\btxroottag}{translator}\clf_btxdirect{\currentbtxdataset}{\btxroottag}{withtranslator}} {
      \btxlabeltext{sbl:Translated}
      \btxspace
      \btxlabeltext{sbl:by}
      \btxspace
      \btxflush{translator}
      % Is there an assisting translator?
      \btxdoif {withtranslator} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {withtranslatortype} {
          \btxflush{withtranslatortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{withtranslator}
      }
      % If the name ends with a period (as is the case for "et al."), 
      % then remove the preceding period
      \removeunwantedspaces
      \removepunctuation
      \btxperiod
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:cite:translator
  \btxdoif {translator} {
    \btxlabeltext{sbl:translator}
    \btxspace
    \btxflush{translator}
    % Is there an assisting translator?
    \btxdoif {withtranslator} {
      \btxcomma
      % Use the provided text to introduce them, if one is specified
      \btxdoifelse {withtranslatortype} {
        \btxflush{withtranslatortype}
      } {
        \btxlabeltext{sbl:with}
      }
      \btxspace
      \btxflush{withtranslator}
    }
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:subcite:translator
  \btxdoif {translator} {
    % If the translator and withtranslator match the corresponding fields in the root citation, 
    % then skip this
    \doifnot {\btxdirect{translator}\btxdirect{withtranslator}} {\clf_btxdirect{\currentbtxdataset}{\btxroottag}{translator}\clf_btxdirect{\currentbtxdataset}{\btxroottag}{withtranslator}} {
      \btxlabeltext{sbl:translator}
      \btxspace
      \btxflush{translator}
      % Is there an assisting translator?
      \btxdoif {withtranslator} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {withtranslatortype} {
          \btxflush{withtranslatortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{withtranslator}
      }
      \btxcomma
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:editortranslator
  % Is there an editor?
  \btxdoifelse {editor} {
    % If so, is there also a translator?
    \btxdoifelse {translator} {
      % If so, is the editor the same as the author?
      \doifelse {\btxfoundname{author}} {editor} {
        % If so, then just handle the translator
        \texdefinition{btx:sbl:list:translator}
      } {
        % If not, are the editor and translator (and their corresponding "with" fields) the same?
        \doifelse {\btxdirect{editor}\btxdirect{witheditor}} {\btxdirect{translator}\btxdirect{withtranslator}} {
          % If so, then typeset them together
          \btxlabeltext{sbl:Translated}
          \btxspace
          \btxlabeltext{and}
          \btxspace
          \btxlabeltext{sbl:edited}
          \btxspace
          % If there is a note on the work in the original language (e.g., "from the 3rd German ed."),
          % then print it here
          \btxdoif {origlanguage} {
            \btxflush{origlanguage}
            \btxspace
          }
          \btxlabeltext{sbl:by}
          \btxspace
          \btxflush{editor}
          % Is there an assisting editor/translator?
          \btxdoif {witheditor} {
            \btxcomma
            % Use the provided text(s) to introduce them, if specified
            \btxdoifelse {witheditortype} {
              \btxflush{witheditortype}
              \btxdoif {withtranslatortype} {
                \btxspace
                \btxlabeltext{and}
                \btxspace
                \btxflush{withtranslatortype}
              }
            } {
              \btxdoif {withtranslatortype} {
                \btxflush{withtranslatortype}
              }
            }
            \btxspace
            \btxflush{witheditor}
          }
          % If the name ends with a period (as is the case for "et al."), 
          % then remove the preceding period
          \removeunwantedspaces
          \removepunctuation
          \btxperiod
        } {
          % If not, then handle them separately
          \texdefinition{btx:sbl:list:editor}
          \texdefinition{btx:sbl:list:translator}
        }
      }
    } {
      % If there is no translator, is the editor the same as the author?
      \doifnot {\btxfoundname{author}} {editor} {
        % If not, then just handle the editor
        \texdefinition{btx:sbl:list:editor}
      }
    }
  } {
    % If not, then just handle the translator
    \texdefinition{btx:sbl:list:translator} 
  }
\stoptexdefinition

\starttexdefinition btx:sbl:listsubcite:editortranslator
  % Is there an editor?
  \btxdoifelse {editor} {
    % If so, is there also a translator?
    \btxdoifelse {translator} {
      % If so, is the editor the same as the author?
      \doifelse {\btxfoundname{author}} {editor} {
        % If so, then just handle the translator
        \texdefinition{btx:sbl:listsubcite:translator}
      } {
        % If not, are the editor and translator (and their corresponding "with" fields) the same?
        \doifelse {\btxdirect{editor}\btxdirect{witheditor}} {\btxdirect{translator}\btxdirect{withtranslator}} {
          % If so, then typeset them together
          \btxlabeltext{sbl:Translated}
          \btxspace
          \btxlabeltext{and}
          \btxspace
          \btxlabeltext{sbl:edited}
          \btxspace
          % If there is a note on the work in the original language (e.g., "from the 3rd German ed."),
          % then print it here
          \btxdoif {origlanguage} {
            \btxflush{origlanguage}
            \btxspace
          }
          \btxlabeltext{sbl:by}
          \btxspace
          \btxflush{editor}
          % Is there an assisting editor/translator?
          \btxdoif {witheditor} {
            \btxcomma
            % Use the provided text(s) to introduce them, if specified
            \btxdoifelse {witheditortype} {
              \btxflush{witheditortype}
              \btxdoif {withtranslatortype} {
                \btxspace
                \btxlabeltext{and}
                \btxspace
                \btxflush{withtranslatortype}
              }
            } {
              \btxdoif {withtranslatortype} {
                \btxflush{withtranslatortype}
              }
            }
            \btxspace
            \btxflush{witheditor}
          }
          % If the name ends with a period (as is the case for "et al."), 
          % then remove the preceding period
          \removeunwantedspaces
          \removepunctuation
          \btxperiod
        } {
          % If not, then handle them separately
          \texdefinition{btx:sbl:listsubcite:editor}
          \texdefinition{btx:sbl:listsubcite:translator}
        }
      }
    } {
      % If there is no translator, is the editor the same as the author?
      \doifnot {\btxfoundname{author}} {editor} {
        % If not, then just handle the editor
        \texdefinition{btx:sbl:listsubcite:editor}
      }
    }
  } {
    % If not, then just handle the translator
    \texdefinition{btx:sbl:listsubcite:translator} 
  }
\stoptexdefinition

\starttexdefinition btx:sbl:cite:editortranslator
  % Is there an editor?
  \btxdoifelse {editor} {
    % If so, is there also a translator?
    \btxdoifelse {translator} {
      % If so, is the editor the same as the author?
      \doifelse {\btxfoundname{author}} {editor} {
        % If so, then just handle the translator
        \texdefinition{btx:sbl:cite:translator}
      } {
        % If not, are the editor and translator (and their corresponding "with" fields) the same?
        \doifelse {\btxdirect{editor}\btxdirect{witheditor}} {\btxdirect{translator}\btxdirect{withtranslator}} {
          % If so, then typeset them together
          \btxlabeltext{sbl:translator}
          \btxspace
          \btxlabeltext{and}
          \btxspace
          \btxlabeltext{sbl:editor}
          \btxspace
          \btxflush{editor}
          % Is there an assisting editor/translator?
          \btxdoif {witheditor} {
            \btxcomma
            % Use the provided text(s) to introduce them, if specified
            \btxdoifelse {witheditortype} {
              \btxflush{witheditortype}
              \btxdoif {withtranslatortype} {
                \btxspace
                \btxlabeltext{and}
                \btxspace
                \btxflush{withtranslatortype}
              }
            } {
              \btxdoif {withtranslatortype} {
                \btxflush{withtranslatortype}
              }
            }
            \btxspace
            \btxflush{witheditor}
          }
          % If the name ends with a period (as is the case for "et al."), 
          % then remove the preceding period
          \removeunwantedspaces
          \removepunctuation
          \btxperiod
        } {
          % If not, then handle them separately
          \texdefinition{btx:sbl:cite:editor}
          \texdefinition{btx:sbl:cite:translator}
        }
      }
    } {
      % If there is no translator, is the editor the same as the author?
      \doifnot {\btxfoundname{author}} {editor} {
        % If not, then just handle the editor
        \texdefinition{btx:sbl:cite:editor}
      }
    }
  } {
    % If not, then just handle the translator
    \texdefinition{btx:sbl:cite:translator} 
  }
\stoptexdefinition

\starttexdefinition btx:sbl:subcite:editortranslator
  % Is there an editor?
  \btxdoifelse {editor} {
    % If so, is there also a translator?
    \btxdoifelse {translator} {
      % If so, is the editor the same as the author?
      \doifelse {\btxfoundname{author}} {editor} {
        % If so, then just handle the translator
        \texdefinition{btx:sbl:subcite:translator}
      } {
        % If not, are the editor and translator (and their corresponding "with" fields) the same?
        \doifelse {\btxdirect{editor}\btxdirect{witheditor}} {\btxdirect{translator}\btxdirect{withtranslator}} {
          % If so, then typeset them together
          \btxlabeltext{sbl:translator}
          \btxspace
          \btxlabeltext{and}
          \btxspace
          \btxlabeltext{sbl:editor}
          \btxspace
          \btxflush{editor}
          % Is there an assisting editor/translator?
          \btxdoif {witheditor} {
            \btxcomma
            % Use the provided text(s) to introduce them, if specified
            \btxdoifelse {witheditortype} {
              \btxflush{witheditortype}
              \btxdoif {withtranslatortype} {
                \btxspace
                \btxlabeltext{and}
                \btxspace
                \btxflush{withtranslatortype}
              }
            } {
              \btxdoif {withtranslatortype} {
                \btxflush{withtranslatortype}
              }
            }
            \btxspace
            \btxflush{witheditor}
          }
          % If the name ends with a period (as is the case for "et al."), 
          % then remove the preceding period
          \removeunwantedspaces
          \removepunctuation
          \btxperiod
        } {
          % If not, then handle them separately
          \texdefinition{btx:sbl:subcite:editor}
          \texdefinition{btx:sbl:subcite:translator}
        }
      }
    } {
      % If there is no translator, is the editor the same as the author?
      \doifnot {\btxfoundname{author}} {editor} {
        % If not, then just handle the editor
        \texdefinition{btx:sbl:subcite:editor}
      }
    }
  } {
    % If not, then just handle the translator
    \texdefinition{btx:sbl:subcite:translator} 
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:bookxref
  \btxdoif{bookxref} {
    \begingroup
    \def\bookxreftag{\btxdirect{\btxfoundname{bookxref}}}%
    % Print page numbers here, if there are any
    \btxdoifelse {pages} {
      \btxoneorrange {pages} {
        \btxlabeltext{sbl:Page}
      } {
        \btxlabeltext{sbl:Pages}
      }
      \btxspace
      \btxflush{pages} % TODO: implement the horrendous page range abbreviation rules used by Chicago and SBL ... if I have to
      \btxspace
      \btxlabeltext{sbl:in}
    } {
      \btxlabeltext{sbl:In}
    }
    \btxspace
    % Recursively cite the book/collection
    \textcite[listsubcite][\bookxreftag]
    \btxperiod
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:cite:bookxref
  \btxdoif{bookxref} {
    \begingroup
    \def\bookxreftag{\btxdirect{\btxfoundname{bookxref}}}%
    % Is this entry of type "ANRW"?
    \doifelse {\btxflush{type}} {ANRW} {
      % If so, then just print the shorthand (as we would for a reference or lexicon)
      \clf_btxdoif{\currentbtxdataset}{\bookxreftag}{collectionxref} {
        \def\collectionxreftag{\clf_btxflush{\currentbtxdataset}{\bookxreftag}{collectionxref}}%
        \clf_btxdoifelse{\currentbtxdataset}{\collectionxreftag}{shorthand} {
          \textcite[short][\collectionxreftag]
        } {
          \btxlabeltext{sbl:in}
          \btxspace
          \textcite[title][\collectionxreftag]
        }
        \btxcomma
      }
    } {
      % If not, then recursively cite the book/collection, preceded by "in"
      \btxlabeltext{sbl:in}
      \btxspace
      \textcite[subcite][\bookxreftag]
      \btxcomma
    }
    % If there are page numbers, then print them,
      % preceded by the book's volume and part number
      \btxdoif {pages} {
        % If the cross-referenced book is an untitled volume in a collection, 
        % then precede the page range with the volume (and part) number:
        \doif{\btxfoundname{bookxref}}{incollectionxref} {
          \textcite[volume][\bookxreftag]
          \btxcolon
          \removeunwantedspaces
        }
        \btxflush{pages}
        \btxcomma
      }
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:reviewbookxref
  \btxdoif{bookxref} {
    \begingroup
    \def\bookxreftag{\btxdirect{\btxfoundname{bookxref}}}%
    % Precede the subcitation with "Review of"
    \btxlabeltext{sbl:Review}
    \btxspace
    \btxlabeltext{sbl:of}
    \btxspace
    % Cite the title and author/editor of the the reviewed book
    \btxstartstyleandcolor[sbl:\s!list:title:book]
      \btxusecommand[sbl:\s!list:title:book]{
        \clf_btxdirect{\currentbtxdataset}{\btxflush{bookxref}}{title}% set the title according to the current category
      }
    \btxstopstyleandcolor
    \btxcomma
    \doifelse{\clf_btxfoundname{\currentbtxdataset}{\bookxreftag}{author}}{editor} {
      \btxlabeltext{sbl:editor}
    } {
      \btxlabeltext{sbl:by}
    }
    \btxspace
    \clf_btxauthor
      {\currentbtxdataset}%
      {\bookxreftag}%
      {author}%
      {%
          combiner    {normal}%
          kind        {list}%
          etallimit   {sbl:\s!cite\c!etallimit}%
          etaldisplay {sbl:\s!cite\c!etaldisplay}%
          etaloption  {sbl:\s!cite\c!etaloption}%
          symbol      {sbl:\s!cite\c!stopper:initials}%
          connector   {sbl:\s!cite\c!connector:initials}%
      }%
    \btxperiod
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:cite:reviewbookxref
  \btxdoif{bookxref} {
    \begingroup
    \def\bookxreftag{\btxdirect{\btxfoundname{bookxref}}}%
    % Precede the subcitation with "review of"
    \btxlabeltext{sbl:review}
    \btxspace
    \btxlabeltext{sbl:of}
    \btxspace
    % Cite the title and author/editor of the the reviewed book
    \btxstartstyleandcolor[sbl:\s!list:title:book]
      \btxusecommand[sbl:\s!list:title:book]{
        \clf_btxdirect{\currentbtxdataset}{\btxflush{bookxref}}{title}% set the title according to the current category
      }
    \btxstopstyleandcolor
    \btxcomma
    \doifelse{\clf_btxfoundname{\currentbtxdataset}{\bookxreftag}{author}}{editor} {
      \btxlabeltext{sbl:editor}
    } {
      \btxlabeltext{sbl:by}
    }
    \btxspace
    \clf_btxauthor
      {\currentbtxdataset}%
      {\bookxreftag}%
      {author}%
      {%
          combiner    {normal}%
          kind        {list}%
          etallimit   {sbl:\s!cite\c!etallimit}%
          etaldisplay {sbl:\s!cite\c!etaldisplay}%
          etaloption  {sbl:\s!cite\c!etaloption}%
          symbol      {sbl:\s!cite\c!stopper:initials}%
          connector   {sbl:\s!cite\c!connector:initials}%
      }%
    \btxcomma
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:short:reviewbookxref
  \btxdoif{bookxref} {
    \begingroup
    \def\bookxreftag{\btxdirect{\btxfoundname{bookxref}}}%
    % Precede the subcitation with "review of"
    \btxlabeltext{sbl:review}
    \btxspace
    \btxlabeltext{sbl:of}
    \btxspace
    % Cite the title and author/editor of the the reviewed book
    \btxstartstyleandcolor[sbl:\s!list:title:book]
      \btxusecommand[sbl:\s!list:title:book]{
        \clf_btxdirect{\currentbtxdataset}{\btxflush{bookxref}}{title}% set the title according to the current category
      }
    \btxstopstyleandcolor
    \btxspace
    \startparen
    \doifelse{\clf_btxfoundname{\currentbtxdataset}{\bookxreftag}{author}}{editor} {
      \btxlabeltext{sbl:editor}
    } {
      \btxlabeltext{sbl:by}
    }
    \btxspace
    \clf_btxauthor
      {\currentbtxdataset}%
      {\bookxreftag}%
      {author}%
      {%
          combiner    {name}%
          kind        {list}%
          etallimit   {sbl:\s!cite\c!etallimit}%
          etaldisplay {sbl:\s!cite\c!etaldisplay}%
          etaloption  {sbl:\s!cite\c!etaloption}%
          symbol      {sbl:\s!cite\c!stopper:initials}%
          connector   {sbl:\s!cite\c!connector:initials}%
      }%
    \stopparen
    \btxcomma
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:suppbookbookxref
  \btxdoif{bookxref} {
    \begingroup
    \def\bookxreftag{\btxdirect{\btxfoundname{bookxref}}}%
    % Print the section of the book (this is a required field)
    % For list citations, make sure the type is capitalized
    \btxusecommand[sbl:\s!list:type] {
      \btxflush{type}%
    }
    \btxspace
    \btxlabeltext{sbl:to}
    \btxspace
    % Recursively cite the book/collection
    \textcite[listsubcite][\bookxreftag]
    \btxperiod
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:cite:suppbookbookxref
  \btxdoif{bookxref} {
    \begingroup
    \def\bookxreftag{\btxdirect{\btxfoundname{bookxref}}}%
    % Print the section of the book (this is a required field)
    % For inline citations, this can be printed without capitalization
    \btxflush{type}
    \btxspace
    \btxlabeltext{sbl:to}
    \btxspace
    % Recursively cite the book/collection
    \textcite[subcite][\bookxreftag]
    \btxcomma
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:short:suppbookbookxref
  % Just print the type (this is a required field)
  \btxflush{type}
\stoptexdefinition

\starttexdefinition btx:sbl:cite:inreferencebookxref
  \btxdoif{bookxref} {
    \begingroup
    \def\bookxreftag{\btxdirect{\btxfoundname{bookxref}}}%
    % If the cross-referenced book is a volume in a collection, 
    % then use the shorthand of the collection;
    % otherwise, do not print information about the collection
    \clf_btxdoifelse{\currentbtxdataset}{\bookxreftag}{collectionxref} {
      \def\collectionxreftag{\clf_btxflush{\currentbtxdataset}{\bookxreftag}{collectionxref}}%
      \clf_btxdoifelse{\currentbtxdataset}{\collectionxreftag}{shorthand} {
        \textcite[short][\collectionxreftag]
      } {
        \btxlabeltext{sbl:in}
        \btxspace
        \textcite[subcite][\collectionxreftag]
      }
    } {
      % Otherwise, use the shorthand (or, failing that, a full subcitation) of the book:
      \clf_btxdoifelse{\currentbtxdataset}{\bookxreftag}{shorthand} {
        \textcite[short][\bookxreftag]
      } {
        \btxlabeltext{sbl:in}
        \btxspace
        \textcite[subcite][\bookxreftag]
      }
    }
    \btxcomma
    % If there are page numbers, then print them,
    % preceded by the book's volume and part number
    \btxdoif {pages} {
      % If the cross-referenced book has a volume number, 
      % then replace the preceding comma with a space
      \clf_btxdoif{\currentbtxdataset}{\bookxreftag}{volume} {
        \removeunwantedspaces
        \removepunctuation
        \btxspace
        \textcite[volume][\bookxreftag]
        \btxcolon
        \removeunwantedspaces
      }
      \btxflush{pages}
    }
    \btxcomma
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:cite:ancienttextbookxref
  \btxdoif{bookxref} {
    % Is this entry of type "PGM"?
    \doifelse{\btxflush{type}}{PGM}{
      % If so, then print the translator (if there is one) in parentheses,
      % but don't print anything else in parentheses (§6.4.3.3)
      \btxdoif {translator} {
        \removeunwantedspaces
        \removepunctuation
        \btxspace
        \startparen
        \btxflush{translator}
        \stopparen
        \btxcomma
      }
    } {
      % If not, then print the translator first, then print publication information in parentheses
      \btxdoif {translator} {
        \btxlabeltext{sbl:translator}
        \btxspace
        \btxflush{translator}
        \btxcomma
      }
      \removeunwantedspaces
      \removepunctuation
      \btxspace
      \startparen
      \begingroup
      % Do a full inline citation of the book containing this text
      \def\bookxreftag{\btxdirect{\btxfoundname{bookxref}}}%
      \textcite[alternative=inline,lefttext=,righttext=][\bookxreftag]
      \btxcomma
      % If there are page numbers, then print them,
      % preceded by the book's volume and part number 
      % and the text's part number
      \btxdoifelse {pages} {
        \clf_btxdoifelse{\currentbtxdataset}{\bookxreftag}{volume} {
          \removeunwantedspaces
          \removepunctuation
          \btxspace
          \textcite[volume][\bookxreftag]
          \btxdoif {part} {
            \btxperiod
            \removeunwantedspaces
            \btxflush{part}
          }
          \btxcolon
          \removeunwantedspaces
        } {
          \btxdoif {part} {
            \removeunwantedspaces
            \removepunctuation
            \btxspace
            \btxflush{part}
            \btxcolon
            \removeunwantedspaces
          }
        }
        \btxflush{pages}
        % If any specific page numbers were cited explicitly by the user, then print them next
        \texdefinition{btx:sbl:cite:righttext}
        \btxcomma
      } {
        % If there is no full page range, then format any cited pages the same way
        \doifnot {\currentbtxrighttext} {\empty} {
          \clf_btxdoifelse{\currentbtxdataset}{\bookxreftag}{volume} {
            \textcite[volume][\bookxreftag]
            \btxdoif {part} {
              \btxperiod
              \removeunwantedspaces
              \btxflush{part}
            }
            \btxcolon
            \removeunwantedspaces
          } {
            \btxdoif {part} {
              \btxperiod
              \removeunwantedspaces
              \btxflush{part}
              \btxcolon
              \removeunwantedspaces
            }
          }
          \texdefinition{btx:sbl:cite:righttext}
        }
      }
      \removeunwantedspaces
      \removepunctuation
      \endgroup
      \stopparen
      \btxcomma
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:short:ancienttextbookxref
  \btxdoif{bookxref} {
    % Is this entry of type "PGM"?
    \doifelse{\btxflush{type}}{PGM}{
      % If so, then print the translator (if there is one) in parentheses,
      % followed by any cited page numbers (§6.4.3.3)
      \btxdoif {translator} {
        \removeunwantedspaces
        \removepunctuation
        \btxspace
        \startparen
        \btxflush{translator}
        \doifnot {\currentbtxlefttext} {\empty} {
          \btxcomma
          \texdefinition{btx:sbl:short:righttext}
        }
        \stopparen
        \btxcomma
      }
    } {
      % Otherwise, if there are any cited pages, remove the preceding comma and print source shorthand and cited pages in parentheses
      \doifnot {\currentbtxrighttext} {\empty} {
        \removeunwantedspaces
        \removepunctuation
        \btxspace
        \startparen
        \begingroup
        \def\bookxreftag{\btxdirect{\btxfoundname{bookxref}}}%
        % If the book containing this text is part of a collection, then cite the shorthand (or, failing that, the title) of the collection;
        % otherwise, cite the shorthand (or, failing that, the title) of the book
        \clf_btxdoifelse {\currentbtxdataset} {\bookxreftag} {collectionxref} {
          \def\collectionxreftag{\clf_btxdirect{\currentbtxdataset}{\bookxreftag}{collectionxref}}%
          \textcite[alternative=short,lefttext=,righttext=][\collectionxreftag]
        } {
          \textcite[alternative=short,lefttext=,righttext=][\bookxreftag]
        }
        \btxcomma
        % Cited page numbers are preceded by the book's volume and part number 
        % and the text's part number
        \clf_btxdoifelse {\currentbtxdataset} {\bookxreftag} {volume} {
          \removeunwantedspaces
          \removepunctuation
          \btxspace
          \textcite[volume][\bookxreftag]
          \btxdoif {part} {
            \removeunwantedspaces
            \removepunctuation
            \btxperiod
            \removeunwantedspaces
            \btxflush{part}
          }
          \btxcolon
          \removeunwantedspaces
        } {
          \btxdoif {part} {
            \removeunwantedspaces
            \removepunctuation
            \btxspace
            \removeunwantedspaces
            \btxflush{part}
            \btxcolon
            \removeunwantedspaces
          }
        }
        \texdefinition{btx:sbl:short:righttext}
        \removeunwantedspaces
        \removepunctuation
        \endgroup
        \stopparen
        \btxcomma
      }
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:cite:classictextbookxref
  \btxdoif {bookxref} {
    % The book cross-reference will always be in parentheses/brackets:
    \removeunwantedspaces
    \removepunctuation
    \btxspace
    \startparen
    \begingroup
    \def\bookxreftag{\btxdirect{\btxfoundname{bookxref}}}%
    % If there is a translator, then print their last name
    \btxdoif {translator} {
      \btxflushauthorname{translator}
      \btxcomma
    }
    % Is this text included in the Loeb Classical Library?
    \doif {\btxflush{type}} {LCL} {
      % If so, then print "LCL" (§6.4.2)
      {LCL}
      \btxcomma
    }
    % Is this a text by a church father?
    \doif {\btxflush{type}} {churchfather} {
      % If so, then print the shorthand (or, failing that, the title) of the collection, book, or series containing this text, followed by any cited page numbers
      \doif {\btxfoundname{bookxref}} {collectionxref} {
        \textcite[alternative=short,lefttext=,righttext=][\bookxreftag]
        \btxcomma
        \texdefinition{btx:sbl:cite:righttext}
      }
      \doif {\btxfoundname{bookxref}} {incollectionxref} {
        \def\collectionxreftag{\btxdirect{\btxfoundname{bookxref}}}%
        \textcite[alternative=short,lefttext=,righttext=][\collectionxreftag]
        \btxspace
        \textcite[volume][\bookxreftag]
        \btxcolon
        \removeunwantedspaces
        \texdefinition{btx:sbl:cite:righttext}
      }
      \doif {\btxfoundname{bookxref}} {bookxref} {
        \textcite[alternative=short,lefttext=,righttext=][\bookxreftag]
        \btxcomma
        \texdefinition{btx:sbl:cite:righttext}
      }
      \doif {\btxfoundname{bookxref}} {seriesxref} {
        % If this book belongs to a series, then cite the shorthand (or, failing that, the title) of the series
        \def\seriesxreftag{\btxdirect{\btxfoundname{bookxref}}}%
        \textcite[alternative=short,lefttext=,righttext=][\seriesxreftag]
        % If the series itself has a series number (e.g., "WUNT 2", the second series of WUNT),
        % then print that number before the series entry number, with a forward slash in between
        \btxdoifelse {seriesseries} {
          \removeunwantedspaces
          \removepunctuation
          \btxspace
          \btxflush{seriesseries}
          \btxdoif {number} {
            \removeunwantedspaces
            {/}
            \btxflush{number}
          }
          \doifnot {\currentbtxrighttext} {\empty} {
            \btxcolon
            \removeunwantedspaces
            \texdefinition{btx:sbl:cite:righttext}
          }
        } {
          % Otherwise, just print the series entry number, if there is one
          \btxdoifelse {number} {
            \removeunwantedspaces
            \removepunctuation
            \btxspace
            \btxflush{number}
            \doifnot {\currentbtxrighttext} {\empty} {
              \btxcolon
              \removeunwantedspaces
              \texdefinition{btx:sbl:cite:righttext}
            }
          } {
            % If there is no series entry number, then just print any cited page numbers
            \removeunwantedspaces
            \removepunctuation
            \texdefinition{btx:sbl:cite:righttext}
          }
        } 
      }
    }
    \removeunwantedspaces
    \removepunctuation
    \endgroup
    \stopparen
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:collectionxref
  \btxdoif{collectionxref} {
    \begingroup
    \def\collectionxreftag{\btxflush{collectionxref}}%
    % If there is a volume number, then print it here
    \btxdoifelse {volume} {
      \btxoneorrange {volume} {
        \btxlabeltext{sbl:Volume}
      } {
        \btxlabeltext{sbl:Volumes}
      }
      \btxspace
      \btxflush{volume}
      % Is there a part number subdividing the volume?
      \btxdoif {part} {
        \btxcomma
        \btxoneorrange {part} {
          \btxlabeltext{sbl:part}
        } {
          \btxlabeltext{sbl:parts}
        }
        \btxspace
        \btxflush{part}
      }
      \btxspace
      \btxlabeltext{sbl:of}
    } {
      \btxlabeltext{sbl:In}
    }
    \btxspace
    \def\btxprintpubl{no}% don't print the publication information of the collection
    \textcite[listsubcite][\btxflush{collectionxref}] % recursively cite the collection, but do not save it to the list
    \endgroup
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:listsubcite:collectionxref
  \btxdoif{collectionxref} {
    \begingroup
    \def\collectionxreftag{\btxflush{collectionxref}}%
    % If there is a volume number, then print it here
    \btxdoif {volume} {
      \btxoneorrange {volume} {
        % If the entry is not in the incollection category, then we start a sentence with the volume (and part) here;
        % otherwise, it is in the middle of a sentence
        \doifelse {\currentbtxcategory} {incollection} {
          \btxlabeltext{sbl:volume}
        } {
          \btxlabeltext{sbl:Volume}
        }   
      } {
        % If the entry is not in the incollection category, then we start a sentence with the volume (and part) here;
        % otherwise, it is in the middle of a sentence
        \doifelse {\currentbtxcategory} {incollection} {
          \btxlabeltext{sbl:volumes}
        } {
          \btxlabeltext{sbl:Volumes}
        }
      }
      \btxspace
      \btxflush{volume}
      % Is there a part number subdividing the volume?
      \btxdoif {part} {
        \btxcomma
        \btxoneorrange {part} {
          \btxlabeltext{sbl:part}
        } {
          \btxlabeltext{sbl:parts}
        }
        \btxspace
        \btxflush{part}
      }
      \btxspace
      \btxlabeltext{sbl:of}
      \btxspace
    }
    \def\btxprintpubl{no}% don't print the publication information of the collection
    \textcite[listsubcite][\collectionxreftag] % recursively cite the collection, but do not save it to the list
    \endgroup
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:cite:collectionxref
  \btxdoif{collectionxref} {
    \begingroup
    \def\collectionxreftag{\btxflush{collectionxref}}%
    % If the entry is in the incollection category, then we do not cite the volume (and part) here
    % (they will be cited with the page numbers later),
    % and we just cite the collection in full inline format
    \doifelse {\currentbtxcategory} {incollection} {
      \def\btxprintpubl{no}% don't print the publication information of the collection
      \textcite[inline][\collectionxreftag] % recursively cite the collection in full inline form
    } {
      \btxdoif {volume} {
        \btxoneorrange {volume} {
          \btxlabeltext{sbl:volume}
        } {
          \btxlabeltext{sbl:volumes}
        }
        \btxspace
        \btxflush{volume}
        % Is there a part number subdividing the volume?
        \btxdoif {part} {
          \btxcomma
          \btxoneorrange {part} {
            \btxlabeltext{sbl:part}
          } {
            \btxlabeltext{sbl:parts}
          }
          \btxspace
          \btxflush{part}
        }
        \btxspace
        \btxlabeltext{sbl:of}
        \btxspace
      }
      \def\btxprintpubl{no}% don't print the publication information of the collection
      \textcite[subcite][\collectionxreftag] % recursively subcite the collection
    }
    \endgroup
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:subcite:collectionxref
  \btxdoif{collectionxref} {
    \begingroup
    \def\collectionxreftag{\btxflush{collectionxref}}%
    % If the entry is in the incollection category, then we do not cite the volume (and part) here
    % (they will be cited with the page numbers later)
    \doifelse {\currentbtxcategory} {incollection} {
      \def\btxprintpubl{no}% don't print the publication information of the collection
      \textcite[inline][\collectionxreftag] % recursively cite the collection in full inline form
    } {
      \btxdoif {volume} {
        \btxoneorrange {volume} {
          \btxlabeltext{sbl:volume}
        } {
          \btxlabeltext{sbl:volumes}
        }
        \btxspace
        \btxflush{volume}
        % Is there a part number subdividing the volume?
        \btxdoif {part} {
          \btxcomma
          \btxoneorrange {part} {
            \btxlabeltext{sbl:part}
          } {
            \btxlabeltext{sbl:parts}
          }
          \btxspace
          \btxflush{part}
        }
        \btxspace
        \btxlabeltext{sbl:of}
        \btxspace
      }
      \def\btxprintpubl{no}% don't print the publication information of the collection
      \textcite[subcite][\btxflush{collectionxref}] % recursively subcite the collection
    }
    \endgroup
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:volumes
  \btxdoif {volumes} {
    \btxflush{volumes}
    \btxspace
    \doifelse {\btxflush{volumes}} {1} {
      \btxlabeltext{sbl:volume}
    } {
      \btxlabeltext{sbl:volumes}
    }
    % Don't duplicate the period from "vol." or "vols."
    \removeunwantedspaces
    \removepunctuation
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:cite:volumes
  \btxdoif {volumes} {
    \btxflush{volumes}
    \btxspace
    \doifelse {\btxflush{volumes}} {1} {
      \btxlabeltext{sbl:volume}
    } {
      \btxlabeltext{sbl:volumes}
    }
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:edition
  \btxdoif{edition} {
    % Is the edition a string or a number?
    \doifnumberelse {\btxflush{edition}} {
      % If a number, then convert it to an ordinal
      \texdefinition{btx:sbl:enordinal}{\btxflush{edition}}
      \btxspace
      \btxlabeltext{sbl:edition}
    } {
      % If a string, then capitalize its first word
      \btxusecommand[sbl:\s!list:edition] {
        \btxflush{edition}%
      }
      \btxspace
      \btxlabeltext{sbl:edition}
    }
    % Don't duplicate the period from "ed."
    \removeunwantedspaces
    \removepunctuation
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:cite:edition
  \btxdoif{edition} {
    % Is the edition a string or a number?
    \doifnumberelse {\btxflush{edition}} {
      % If a number, then convert it to an ordinal
      \texdefinition{btx:sbl:enordinal}{\btxflush{edition}}
      \btxspace
      \btxlabeltext{sbl:edition}
    } {
      % If a string, then print it as-is
      \btxflush{edition}
      \btxspace
      \btxlabeltext{sbl:edition}
    }
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:seriesxref
  \btxdoif {series} {
    % Is this a cross-reference to a separate entry for the series?
    \doifelse {\btxfoundname{series}} {seriesxref} {
      % If so, then recursively cite the series, but do not add it to the list
      \begingroup
      \def\btxprintpubl{no}% don't print publication information about the series
      \textcite[listsubcite][\btxflush{series}]
      \endgroup
    } {
      % Otherwise, this field just contains the series name; print it with the appropriate formatting
      \btxstartstyleandcolor[sbl:\s!list:title:series]
        \btxusecommand[sbl:\s!list:title:series] {
          \btxflush{series}% set the series name according to its style
        }
      \btxstopstyleandcolor
    }
    % If the series itself has a series number (e.g., "WUNT 2", the second series of WUNT),
    % then print that number before the series entry number, with a forward slash in between
    \btxdoifelse {seriesseries} {
      \btxspace
      \btxflush{seriesseries}
      \btxdoif {number} {
        \removeunwantedspaces
        {/}
        \btxflush{number}
      }
    } {
      % Otherwise, just print the series entry number, if there is one
      \btxdoif {number} {
        \btxspace
        \btxflush{number}
      }
    }
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:cite:seriesxref
  \btxdoif {series} {
    % Is this a cross-reference to a separate entry for the series?
    \doifelse {\btxfoundname{series}} {seriesxref} {
      % If so, then recursively cite the series, but do not add it to the list
      \begingroup
      \def\btxprintpubl{no}% don't print publication information about the series
      \textcite[subcite][\btxflush{series}]
      \endgroup
    } {
      % Otherwise, this field just contains the series name; print it with the appropriate formatting
      \btxstartstyleandcolor[sbl:\s!list:title:series]
        \btxusecommand[sbl:\s!list:title:series] {
          \btxflush{series}% set the series name according to its style
        }
      \btxstopstyleandcolor
    }
    % If the series itself has a series number (e.g., "WUNT 2", the second series of WUNT),
    % then print that number before the series entry number, with a forward slash in between
    \btxdoifelse {seriesseries} {
      \btxspace
      \btxflush{seriesseries}
      \btxdoif {number} {
        \removeunwantedspaces
        {/}
        \btxflush{number}
      }
    } {
      % Otherwise, just print the series entry number, if there is one
      \btxdoif {number} {
        \btxspace
        \btxflush{number}
      }
    }
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:howpublished
  \btxdoif {howpublished} {
    % Print the how-published statement
    \btxflush{howpublished}
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:cite:howpublished
  \btxdoif {howpublished} {
    % Print the how-published statement
    \btxflush{howpublished}
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:journalxref
  \btxdoif {journal} {
    % Is this a cross-reference to a separate entry for the journal?
    \doifelse {\btxfoundname{journal}} {journalxref} {
      % If so, then recursively cite the journal, but do not add it to the list
      \begingroup
      \def\btxprintpubl{no}%
      \textcite[listsubcite][\btxflush{journal}]
      \endgroup
    } {
      % Otherwise, this field just contains the journal name; print it with the appropriate formatting
      \btxstartstyleandcolor[sbl:\s!list:title:journal]
        \btxusecommand[sbl:\s!list:title:journal] {
          \btxflush{journal}% set the journal name according to its style
        }
      \btxstopstyleandcolor
    }
    % Print the volume number(s), if any
    % TODO: Need to handle the case of multiple volumes/numbers, dates, and page numbers separated by "and"
    \btxdoif {volume} {
      \btxspace
      \btxflush{volume}
      % If there is an issue number or range, then print it after the volume number, with a period in between
      \btxdoif {number} {
        \removeunwantedspaces
        \btxperiod
        \removeunwantedspaces
        \btxflush{number}
      }
    }
    % Print the date
    % TODO: If date is in "YYYY-MM-DD" format, 
    % then it should be printed in "DD Month YYYY" format without parentheses and followed by a comma;
    % otherwise, it should be printed as a year (preceded by the month, if provided) in parentheses followed by a colon.
    \btxdoif {date} {
      \btxspace
      \startparen
      \btxflush{date}
      \stopparen
    }
    \btxcolon
    % Print the page numbers
    \btxdoif {pages} {
      \btxflush{pages}
    }
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:cite:journalxref
  \btxdoif {journal} {
    % Is this a cross-reference to a separate entry for the journal?
    \doifelse {\btxfoundname{journal}} {journalxref} {
      % If so, then recursively cite the journal, but do not add it to the list
      \begingroup
      \def\btxprintpubl{no}%
      \textcite[subcite][\btxflush{journal}]
      \endgroup
    } {
      % Otherwise, this field just contains the journal name; print it with the appropriate formatting
      \btxstartstyleandcolor[sbl:\s!list:title:journal]
        \btxusecommand[sbl:\s!list:title:journal] {
          \btxflush{journal}% set the journal name according to its style
        }
      \btxstopstyleandcolor
    }
    % Print the volume number(s), if any
    % TODO: Need to handle the case of multiple volumes/numbers, dates, and page numbers separated by "and"
    \btxdoif {volume} {
      \btxspace
      \btxflush{volume}
      % If there is an issue number or range, then print it after the volume number, with a period in between
      \btxdoif {number} {
        \removeunwantedspaces
        \btxperiod
        \removeunwantedspaces
        \btxflush{number}
      }
    }
    % Print the date
    % TODO: If date is in "YYYY-MM-DD" format, 
    % then it should be printed in "DD Month YYYY" format without parentheses and followed by a comma;
    % otherwise, it should be printed as a year (preceded by the month, if provided) in parentheses followed by a colon.
    \btxdoif {date} {
      \btxspace
      \startparen
      \btxflush{date}
      \stopparen
    }
    \btxcolon
    % Print the page numbers
    \btxdoif {pages} {
      \btxflush{pages}
    }
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:publisher
  \btxdoif {publisher} {
    % Is this a reprint?
    \btxdoif {origpublisher} {
      % Is there an original publication location?
      \btxdoif {origlocation} {
        \btxflush{origlocation}
        \btxcolon
      }
      % Is there an original publisher?
      \doif {\btxfoundname{origpublisher}} {origpublisher} {
        \btxflush{origpublisher}
        \btxcomma
      }
      % Is there an original publication date?
      \btxdoif {origdate} {
        \btxflush{origdate}
        \btxcomma
      }
      % Remove the last punctuation token and replace it with a period,
      % followed by the reprint notation
      \removeunwantedspaces
      \removepunctuation
      \btxperiod
      \btxlabeltext{sbl:Reprint}
      \btxcomma
    }
    % Is there a location?
    \btxdoif {location} {
      \btxflush{location}
      \btxcolon
    }
    % Is there a publisher?
    \btxdoif {publisher} {
      \btxflush{publisher}
      \btxcomma
    }
    
    % Is there a publication date?
    \btxdoif{date} {
      \btxflush{date}
      \btxcomma
    }
    % Close the publication block
    \removeunwantedspaces
    \removepunctuation
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:cite:publisher
  \btxdoif {publisher} {
    % Remove all preceding punctuation and spaces and use a parenthesis or bracket
    \removeunwantedspaces
    \removepunctuation
    \btxspace
    \startparen
    % Is this a reprint?
    \btxdoif {origpublisher} {
      % Is there an original publication location?
      \btxdoif {origlocation} {
        \btxflush{origlocation}
        \btxcolon
      }
      % Is there an original publisher?
      \doif {\btxfoundname{origpublisher}} {origpublisher} {
        \btxflush{origpublisher}
        \btxcomma
      }
      % Is there an original publication date?
      \btxdoif {origdate} {
        \btxflush{origdate}
        \btxcomma
      }
      % Remove the last punctuation token and replace it with a semicolon,
      % followed by the reprint notation
      \removeunwantedspaces
      \removepunctuation
      \btxsemicolon
      \btxlabeltext{sbl:reprint}
      \btxcomma
    }
    % Is there a location?
    \btxdoif {location} {
      \btxflush{location}
      \btxcolon
    }
    % Is there a publisher?
    \btxdoif {publisher} {
      \btxflush{publisher}
      \btxcomma
    }
    
    % Is there a publication date?
    \btxdoif{date} {
      \btxflush{date}
      \btxcomma
    }
    % Close the publication block
    \removeunwantedspaces
    \removepunctuation
    \stopparen
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:institution
  \btxdoif {institution} {
    % Print which type of thesis is being cited
    \doifelse {\currentbtxcategory} {phdthesis} {
      \btxlabeltext{sbl:phd}
      \btxspace
      \btxlabeltext{sbl:diss}
      \btxcomma
    } {
      \doifelse {\currentbtxcategory} {mastersthesis} {
        \btxlabeltext{sbl:masters}
        \btxspace
        \btxlabeltext{sbl:diss}
        \btxcomma
      } {
        \btxdoif {type} {
          \doif {\btxfield{type}} {phdthesis} {
            \btxlabeltext{sbl:phd}
            \btxspace
            \btxlabeltext{sbl:diss}
            \btxcomma
          }
          \doif {\btxfield{type}} {mastersthesis} {
            \btxlabeltext{sbl:masters}
            \btxspace
            \btxlabeltext{sbl:diss}
            \btxcomma
          }
        }
      }
    }
    % Print the institution name:
    \btxflush{institution}
    \btxcomma
    % Print the date:
    \btxdoif {date} {
      \btxflush{date}
      \btxcomma
    }
    \removeunwantedspaces
    \removepunctuation
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:cite:institution
  \btxdoif {institution} {
    % Remove all preceding punctuation and spaces and use a parenthesis or bracket
    \removeunwantedspaces
    \removepunctuation
    \btxspace
    \startparen
    % Print which type of thesis is being cited
    \doifelse {\currentbtxcategory} {phdthesis} {
      \btxlabeltext{sbl:phd}
      \btxspace
      \btxlabeltext{sbl:diss}
      \btxcomma
    } {
      \doifelse {\currentbtxcategory} {mastersthesis} {
        \btxlabeltext{sbl:masters}
        \btxspace
        \btxlabeltext{sbl:diss}
        \btxcomma
      } {
        \btxdoif {type} {
          \doif {\btxfield{type}} {phdthesis} {
            \btxlabeltext{sbl:phd}
            \btxspace
            \btxlabeltext{sbl:diss}
            \btxcomma
          }
          \doif {\btxfield{type}} {mastersthesis} {
            \btxlabeltext{sbl:masters}
            \btxspace
            \btxlabeltext{sbl:diss}
            \btxcomma
          }
        }
      }
    }
    % Print the institution name:
    \btxflush{institution}
    \btxcomma
    % Print the date:
    \btxdoif {date} {
      \btxflush{date}
      \btxcomma
    }
    % Close the institution block
    \removeunwantedspaces
    \removepunctuation
    \stopparen
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:presentedat
  \btxdoif {eventtitle} {
    % Print the "paper presented at" preamble
    \btxlabeltext{sbl:Paperpresentedat}
    \btxspace
    \btxflush{eventtitle}
    \btxperiod
    % Is there a location?
    \btxdoif {location} {
      \btxflush{location}
      \btxcomma
    }
    % Is there an event date?
    % TODO: If date is in "YYYY-MM-DD" format, 
    % then it should be printed in "DD Month YYYY" format
    \btxdoif {date} {
      \btxflush{date} % 
      \btxcomma
    }
    % Close the block
    \removeunwantedspaces
    \removepunctuation
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:cite:presentedat
  \btxdoif {eventtitle} {
    % Remove all preceding punctuation and spaces and use a parenthesis
    \removeunwantedspaces
    \removepunctuation
    \btxspace
    \startparen
    % Print the "paper presented at" preamble
    \btxlabeltext{sbl:paperpresentedat}
    \btxspace
    \btxflush{eventtitle}
    \btxcomma
    % Is there a location?
    \btxdoif {location} {
      \btxflush{location}
      \btxcomma
    }
    % Is there an event date?
    % TODO: If date is in "YYYY-MM-DD" format, 
    % then it should be printed in "DD Month YYYY" format
    \btxdoif {date} {
      \btxflush{date} % 
      \btxcomma
    }
    % Close the block
    \removeunwantedspaces
    \removepunctuation
    \stopparen
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:ebook
  \btxdoif {eprint} {
    % Just print the eprint as an edition (e.g., "Nook edition")
    \btxflush{eprint}
    \btxspace
    \btxlabeltext{sbl:editionfull}
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:cite:ebook
  \btxdoif {eprint} {
    % Just print the eprint as an edition (e.g., "Nook edition")
    \btxflush{eprint}
    \btxspace
    \btxlabeltext{sbl:editionfull}
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:pages
  \btxdoif {pages} {
    \btxflush{pages} % TODO: implement the horrendous page range abbreviation rules used by Chicago and SBL ... if I have to
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:cite:pages
  \btxdoif {pages} {
    \btxflush{pages} % TODO: implement the horrendous page range abbreviation rules used by Chicago and SBL ... if I have to
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:reprxref
  \btxdoif{reprxref} {
    % Is this reprint a reprint in the same lanugage, or a translation?
    \doif {\btxfoundname{reprxref}} {reprxref} {
      \btxlabeltext{sbl:Reprintof}
      \btxspace
    }
    \doif {\btxfoundname{reprxref}} {transxref} {
      \btxlabeltext{sbl:Translationof}
      \btxspace
    }
    % Recursively cite the reprinted/translated version, but do not add it to the list
    \begingroup
    \def\btxprintpubl{yes}%
    \textcite[listsubcite][\btxflush{reprxref}]
    \endgroup
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:cite:reprxref
  \btxdoif{reprxref} {
    % Is this reprint a reprint in the same lanugage, or a translation?
    \doif {\btxfoundname{reprxref}} {reprxref} {
      \removeunwantedspaces
      \removepunctuation
      \btxsemicolon
      \btxlabeltext{sbl:reprint}
      \btxspace
      \btxlabeltext{sbl:of}
      \btxspace
    }
    \doif {\btxfoundname{reprxref}} {transxref} {
      \removeunwantedspaces
      \removepunctuation
      \btxsemicolon
      \btxlabeltext{sbl:translator}
      \btxspace
      \btxlabeltext{sbl:of}
      \btxspace
    }
    % Recursively cite the reprinted/translated version, but do not add it to the list
    \begingroup
    \def\btxprintpubl{yes}%
    \textcite[subcite][\btxflush{reprxref}]
    \endgroup
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:eprint
  % Is the eprint field present?
  \btxdoifelse {eprint} {
    % Does it have an eprintclass?
    \btxdoifelse {eprintclass} {
      % If so, then this is a document published only online
      % Print the release date first, if there is one:
      \btxdoif {eprintdate} {
        \btxlabeltext{sbl:Released}
        \btxspace
        \btxflush{eprintdate} % TODO: convert "YYYY-MM-DD" input to "DD Month YYYY" format
        \btxperiod
      }
      % If it has an eprinttype, then produce a DOI using it
      \btxdoif {eprinttype} {
        {\sc doi}
        \btxcolon
        \removeunwantedspaces
        \btxflush{eprinttype}
        \removeunwantedspaces
        {/}
        \btxcolon
      }
      % Then print the eprint identifier
      \btxflush{eprint}
      % Finally, print its eprintclass in parentheses or brackets
      \btxspace
      \startparen
      \btxflush{eprintclass}
      \stopparen
      \btxperiod
    } {
      % If not, then this is an online database or website with eprint fields
      % Print its eprinttype first, if there is one
      \btxdoif {eprinttype} {
        \btxflush{eprinttype}
        \btxperiod
      }
      % Print the release date next, if there is one:
      \btxdoif {eprintdate} {
        \btxlabeltext{sbl:Released}
        \btxspace
        \btxflush{eprintdate} % TODO: convert "YYYY-MM-DD" input to "DD Month YYYY" format
        \btxperiod
      }
      % Then print the eprint identifier
      \btxflush{eprint}
      \btxperiod
      % If a DOI was specified, then use it here
      \btxdoif {doi} {
        {\sc doi}
        \btxcolon
        \removeunwantedspaces
        \btxflush{doi}
        \btxperiod
      }
    }
  } {
    % If not, then treat this as a website or blog post
    % Does it have a blog title?
    \btxdoif {journal} {
      \doifelse {\btxfoundname{journal}} {journalxref} {
        \begingroup
        \def\btxprintpubl{no}%
        \textcite[subcite][\btxflush{journal}]
        \endgroup
      } {
        \btxstartstyleandcolor[sbl:\s!list:title:journal]
          \btxusecommand[sbl:\s!list:title:journal] {
            \btxflush{journal}% set the journal name according to its style
          }
        \btxstopstyleandcolor
      }
      \btxperiod
    }
    % Then print the date of the post, if specified
    \btxdoif {date} {
      \btxflush{date} % TODO: convert "YYYY-MM-DD" input to "DD Month YYYY" format
      \btxperiod
    }
    % Then print the URL, if specified
    \btxdoif {doi} {
      \hyphenatedurl{\btxflush{doi}}
      \btxperiod
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:cite:eprint
  % Is the eprint field present?
  \btxdoifelse {eprint} {
    % Does it have an eprintclass?
    \btxdoifelse {eprintclass} {
      % If so, then this is a document published only online
      % Print the release date first, if there is one:
      \btxdoif {eprintdate} {
        \btxlabeltext{sbl:released}
        \btxspace
        \btxflush{eprintdate} % TODO: convert "YYYY-MM-DD" input to "DD Month YYYY" format
        \btxcomma
      }
      % If it has an eprinttype, then produce a DOI using it
      \btxdoif {eprinttype} {
        {\sc doi}
        \btxcolon
        \removeunwantedspaces
        \btxflush{eprinttype}
        \removeunwantedspaces
        {/}
        \btxcolon
      }
      % Then print the eprint identifier
      \btxflush{eprint}
      \btxspace
      % Finally, print its eprintclass in parentheses or brackets
      \startparen
      \btxflush{eprintclass}
      \stopparen
      \btxcomma
    } {
      % If not, then this is an online database or website with eprint fields
      % Print its eprinttype first, if there is one
      \btxdoif {eprinttype} {
        \btxflush{eprinttype}
        \btxcomma
      }
      % Print the release date next, if there is one:
      \btxdoif {eprintdate} {
        \btxlabeltext{sbl:released}
        \btxspace
        \btxflush{eprintdate} % TODO: convert "YYYY-MM-DD" input to "DD Month YYYY" format
        \btxcomma
      }
      % Then print the eprint identifier
      \btxflush{eprint}
      \btxcomma
      % If a DOI was specified, then use it here
      \btxdoif {doi} {
        {\sc doi}
        \btxcolon
        \removeunwantedspaces
        \btxflush{doi}
        \btxcomma
      }
    }
  } {
    % If not, then treat this as a website or blog post
    % Does it have a blog cross-reference?
    \btxdoif {journal} {
      \doifelse {\btxfoundname{journal}} {journalxref} {
        \begingroup
        \def\btxprintpubl{no}%
        \textcite[subcite][\btxflush{journal}]
        \endgroup
      } {
        \btxstartstyleandcolor[sbl:\s!list:title:journal]
          \btxusecommand[sbl:\s!list:title:journal] {
            \btxflush{journal}% set the journal name according to its style
          }
        \btxstopstyleandcolor
      }
      \btxcomma
    }
    % Then print the date of the post, if specified
    \btxdoif {date} {
      \btxflush{date} % TODO: convert "YYYY-MM-DD" input to "DD Month YYYY" format
      \btxcomma
    }
    % Then print the URL, if specified
    \btxdoif {doi} {
      \hyphenatedurl{\btxflush{doi}}
      \btxcomma
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:doi
  \btxdoif {doi} {
    % If the URL is actually a DOI (the preferred case), then indicate this
    \doifelse {\btxfoundname{doi}} {doi} {
      {\sc doi}
      \btxcolon
      \removeunwantedspaces
      \hyphenatedurl{\btxflush{doi}}
      % If both a DOI and URL are present, then print the URL after the DOI
      \btxdoif {url} {
        \btxperiod
        \hyphenatedurl{\btxflush{url}}
      }
    } {
      \hyphenatedurl{\btxflush{doi}}
    }
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:cite:doi
  \btxdoif {doi} {
    % If the URL is actually a DOI (the preferred case), then indicate this
    \doifelse {\btxfoundname{doi}} {doi} {
      {\sc doi}
      \btxcolon
      \removeunwantedspaces
      \hyphenatedurl{\btxflush{doi}}
      % If both a DOI and URL are present, then print the URL after the DOI
      \btxdoif {url} {
        \btxcomma
        \hyphenatedurl{\btxflush{url}}
      }
    } {
      \hyphenatedurl{\btxflush{doi}}
    }
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:note
  \btxdoif {note} {
    % Make sure the first word is capitalized
    \btxusecommand[sbl:\s!list:note] {
      \btxflush{note}%
    }
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:cite:note
  \btxdoif {note} {
    \btxflush{note}
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:cite:lefttext
  % In this specification, the lefttext parameter should be reserved for things like line numbers or references within an ancient or classic work,
  % as it will be placed after the ancient or classical work title and not the reference to the work containing or translating it.
  \doifnot {\currentbtxlefttext} {\empty} {
    \currentbtxlefttext
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:short:lefttext
  \texdefinition{btx:sbl:cite:lefttext}
\stoptexdefinition

\starttexdefinition btx:sbl:cite:righttext
  % In this specification, the righttext parameter should be reserved for things like page, chapter, and section numbers,
  % as it will sometimes be added directly after a volume (and part) number. (This should be discernable from the category of the entry.) 
  % If the entry already has a full page range, then this should be prefaced with "esp."
  \doifnot {\currentbtxrighttext} {\empty} {
    \btxdoif {pages} {
      \btxlabeltext{sbl:esp}
      \btxspace
    }
    \currentbtxrighttext
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:short:righttext
  % Same as inline variant, except that we don't need to check for existing page ranges
  \doifnot {\currentbtxrighttext} {\empty} {
    \currentbtxrighttext
    \btxcomma
  }
\stoptexdefinition

% List citation setups

\startsetups btx:sbl:list:book
  \texdefinition{btx:sbl:list:author}
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:list:collectionxref}
  \texdefinition{btx:sbl:list:editortranslator}
  \texdefinition{btx:sbl:list:edition}
  \texdefinition{btx:sbl:list:seriesxref}
  \texdefinition{btx:sbl:list:publisher}
  \texdefinition{btx:sbl:list:ebook}
  \texdefinition{btx:sbl:list:doi}
  \texdefinition{btx:sbl:list:reprxref}
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:reference
  \fastsetup{btx:sbl:list:book}
\stopsetups

\startsetups btx:sbl:list:commentary
  \fastsetup{btx:sbl:list:book}
\stopsetups

\startsetups btx:sbl:list:lexicon
  \fastsetup{btx:sbl:list:book}
\stopsetups

\startsetups btx:sbl:list:manual
  \fastsetup{btx:sbl:list:book}
\stopsetups

\startsetups btx:sbl:list:proceedings
  \fastsetup{btx:sbl:list:book}
\stopsetups

\startsetups btx:sbl:list:mvbook
  \texdefinition{btx:sbl:list:author}
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:list:editortranslator}
  \texdefinition{btx:sbl:list:edition}
  \texdefinition{btx:sbl:list:volumes}
  \texdefinition{btx:sbl:list:seriesxref}
  \texdefinition{btx:sbl:list:publisher}
  \texdefinition{btx:sbl:list:ebook}
  \texdefinition{btx:sbl:list:doi}
  \texdefinition{btx:sbl:list:reprxref}
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:mvreference
  \fastsetup{btx:sbl:list:mvbook}
\stopsetups

\startsetups btx:sbl:list:mvcommentary
  \fastsetup{btx:sbl:list:mvbook}
\stopsetups

\startsetups btx:sbl:list:mvlexicon
  \fastsetup{btx:sbl:list:mvbook}
\stopsetups

\startsetups btx:sbl:list:collection
  \fastsetup{btx:sbl:list:mvbook}
\stopsetups

\startsetups btx:sbl:list:incollection % this should really only be subcited, but we'll allow it
  \texdefinition{btx:sbl:list:collectionxref}
  \texdefinition{btx:sbl:list:seriesxref}
  \texdefinition{btx:sbl:list:publisher}
  \texdefinition{btx:sbl:list:ebook}
  \texdefinition{btx:sbl:list:doi}
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:series
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:list:editortranslator}
  \texdefinition{btx:sbl:list:volumes}
  \texdefinition{btx:sbl:list:publisher}
  \texdefinition{btx:sbl:list:doi}
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:inbook
  \texdefinition{btx:sbl:list:author}
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:list:bookxref}
  \texdefinition{btx:sbl:list:reprxref}
  \texdefinition{btx:sbl:list:doi}
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:suppbook
  \texdefinition{btx:sbl:list:author}
  \texdefinition{btx:sbl:list:suppbookbookxref}
  \texdefinition{btx:sbl:list:reprxref}
  \texdefinition{btx:sbl:list:doi}
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:inreference
  \fastsetup{btx:sbl:list:inbook}
\stopsetups

% This should never be cited in the list
\startsetups btx:sbl:list:inlexicon
\stopsetups

\startsetups btx:sbl:list:incommentary
  \fastsetup{btx:sbl:list:inbook}
\stopsetups

\startsetups btx:sbl:list:inproceedings
  \fastsetup{btx:sbl:list:inbook}
\stopsetups

\startsetups btx:sbl:list:seminarpaper
  \fastsetup{btx:sbl:list:inproceedings}
\stopsetups

% This should never be cited in the list
\startsetups btx:sbl:list:ancienttext
\stopsetups

\startsetups btx:sbl:list:classictext
  \texdefinition{btx:sbl:list:author}
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:list:editortranslator}
  \texdefinition{btx:sbl:list:bookxref}
  \texdefinition{btx:sbl:list:doi}
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:journal
  \fastsetup{btx:sbl:list:series}
\stopsetups

\startsetups btx:sbl:list:article
  \texdefinition{btx:sbl:list:author}
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:list:journalxref}
  \texdefinition{btx:sbl:list:doi}
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:magazine
  \fastsetup{btx:sbl:list:article}
\stopsetups

\startsetups btx:sbl:list:newspaper
  \fastsetup{btx:sbl:list:article}
\stopsetups

\startsetups btx:sbl:list:periodical
  \fastsetup{btx:sbl:list:article}
\stopsetups

\startsetups btx:sbl:list:review
  \texdefinition{btx:sbl:list:author}
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:list:reviewbookxref}
  \texdefinition{btx:sbl:list:journalxref}
  \texdefinition{btx:sbl:list:doi}
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:thesis
  \texdefinition{btx:sbl:list:author}
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:list:editortranslator}
  \texdefinition{btx:sbl:list:institution}
  \texdefinition{btx:sbl:list:doi}
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:mastersthesis
  \fastsetup{btx:sbl:list:thesis}
\stopsetups

\startsetups btx:sbl:list:phdthesis
  \fastsetup{btx:sbl:list:thesis}
\stopsetups

\startsetups btx:sbl:list:conferencepaper
  \texdefinition{btx:sbl:list:author}
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:list:presentedat}
  \texdefinition{btx:sbl:list:doi}
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:online
  \texdefinition{btx:sbl:list:author}
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:list:editortranslator}
  \texdefinition{btx:sbl:list:eprint}
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:misc
  \texdefinition{btx:sbl:list:author}
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:list:editortranslator}
  \texdefinition{btx:sbl:list:edition}
  \texdefinition{btx:sbl:list:seriesxref}
  \texdefinition{btx:sbl:list:howpublished}
  \texdefinition{btx:sbl:list:publisher}
  \texdefinition{btx:sbl:list:doi}
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

% List subcitation setups
\startsetups btx:sbl:listsubcite:book
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:listsubcite:author}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:listsubcite:collectionxref}
    \texdefinition{btx:sbl:listsubcite:editortranslator}
    \texdefinition{btx:sbl:list:edition}
    \texdefinition{btx:sbl:list:seriesxref}
    \texdefinition{btx:sbl:list:publisher}
    \texdefinition{btx:sbl:list:ebook}
    \texdefinition{btx:sbl:list:doi}
    \texdefinition{btx:sbl:list:reprxref}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:listsubcite:reference
  \fastsetup{btx:sbl:listsubcite:book}
\stopsetups

\startsetups btx:sbl:listsubcite:commentary
  \fastsetup{btx:sbl:listsubcite:book}
\stopsetups

\startsetups btx:sbl:listsubcite:lexicon
  \fastsetup{btx:sbl:listsubcite:book}
\stopsetups

\startsetups btx:sbl:listsubcite:manual
  \fastsetup{btx:sbl:listsubcite:book}
\stopsetups

\startsetups btx:sbl:listsubcite:proceedings
  \fastsetup{btx:sbl:listsubcite:book}
\stopsetups

\startsetups btx:sbl:listsubcite:mvbook
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:listsubcite:author}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:listsubcite:editortranslator}
    \texdefinition{btx:sbl:list:edition}
    \texdefinition{btx:sbl:list:volumes}
    \texdefinition{btx:sbl:list:seriesxref}
    \texdefinition{btx:sbl:list:publisher}
    \texdefinition{btx:sbl:list:ebook}
    \texdefinition{btx:sbl:list:doi}
    \texdefinition{btx:sbl:list:reprxref}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:listsubcite:mvreference
  \fastsetup{btx:sbl:listsubcite:mvbook}
\stopsetups

\startsetups btx:sbl:listsubcite:mvcommentary
  \fastsetup{btx:sbl:listsubcite:mvbook}
\stopsetups

\startsetups btx:sbl:listsubcite:mvlexicon
  \fastsetup{btx:sbl:listsubcite:mvbook}
\stopsetups

\startsetups btx:sbl:listsubcite:collection
  \fastsetup{btx:sbl:listsubcite:mvbook}
\stopsetups

\startsetups btx:sbl:listsubcite:incollection
  \texdefinition{btx:sbl:listsubcite:collectionxref}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:list:bookseries}
    \texdefinition{btx:sbl:list:publisher}
    \texdefinition{btx:sbl:list:ebook}
    \texdefinition{btx:sbl:list:doi}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:listsubcite:series
  % Always use the short form in subcites, if available
  \btxdoifelse {shorthand} {
    \texdefinition{btx:sbl:list:shorthand}
  } {
    \texdefinition{btx:sbl:list:title}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:listsubcite:inbook
  % Titles are not necessary for booksupps, 
  % so render the author correctly if there isn't one
  \btxdoifelse {title} {
    \texdefinition{btx:sbl:list:title}
    \texdefinition{btx:sbl:listsubcite:author}
  } {
    \texdefinition{btx:sbl:cite:author}
  }
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:list:bookxref}
    \texdefinition{btx:sbl:list:reprxref}
    \texdefinition{btx:sbl:list:doi}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:listsubcite:suppbook
  \fastsetup{btx:sbl:listsubcite:inbook}
\stopsetups

\startsetups btx:sbl:listsubcite:inreference
  \fastsetup{btx:sbl:listsubcite:inbook}
\stopsetups

% This should never be cited in the list
\startsetups btx:sbl:listsubcite:inlexicon
\stopsetups

\startsetups btx:sbl:listsubcite:incommentary
  \fastsetup{btx:sbl:listsubcite:inbook}
\stopsetups

\startsetups btx:sbl:listsubcite:inproceedings
  \fastsetup{btx:sbl:listsubcite:inbook}
\stopsetups

\startsetups btx:sbl:listsubcite:seminarpaper
  \fastsetup{btx:sbl:listsubcite:inproceedings}
\stopsetups

% This should never be cited in the list
\startsetups btx:sbl:listsubcite:ancienttext
\stopsetups

% This should never be cited in the list
\startsetups btx:sbl:listsubcite:classictext
\stopsetups

\startsetups btx:sbl:listsubcite:journal
  \fastsetup{btx:sbl:listsubcite:series}
\stopsetups

\startsetups btx:sbl:listsubcite:article
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:listsubcite:author}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:list:journalxref}
    \texdefinition{btx:sbl:list:doi}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:listsubcite:magazine
  \fastsetup{btx:sbl:listsubcite:article}
\stopsetups

\startsetups btx:sbl:listsubcite:newspaper
  \fastsetup{btx:sbl:listsubcite:article}
\stopsetups

\startsetups btx:sbl:listsubcite:periodical
  \fastsetup{btx:sbl:listsubcite:article}
\stopsetups

\startsetups btx:sbl:listsubcite:review
  % Titles are not necessary for book reviews, 
  % so render the author correctly if there isn't one
  \btxdoifelse {title} {
    \texdefinition{btx:sbl:list:title}
    \texdefinition{btx:sbl:listsubcite:author}
  } {
    \texdefinition{btx:sbl:cite:author}
  }
  \texdefinition{btx:sbl:list:bookxref}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:list:journalxref}
    \texdefinition{btx:sbl:list:doi}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:listsubcite:thesis
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:listsubcite:author}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:listsubcite:editortranslator}
    \texdefinition{btx:sbl:list:institution}
    \texdefinition{btx:sbl:list:doi}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:listsubcite:mastersthesis
  \fastsetup{btx:sbl:listsubcite:thesis}
\stopsetups

\startsetups btx:sbl:listsubcite:phdthesis
  \fastsetup{btx:sbl:listsubcite:thesis}
\stopsetups

\startsetups btx:sbl:listsubcite:conferencepaper
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:listsubcite:author}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:list:presentedat}
    \texdefinition{btx:sbl:list:doi}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:listsubcite:online
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:listsubcite:author}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:list:editortranslator}
    \texdefinition{btx:sbl:list:eprint}
  }
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

% Inline citation setups
\startsetups btx:sbl:cite:book
  \texdefinition{btx:sbl:cite:author}
  \texdefinition{btx:sbl:cite:title}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:cite:collectionxref}
    \texdefinition{btx:sbl:cite:editortranslator}
    \texdefinition{btx:sbl:cite:edition}
    \texdefinition{btx:sbl:cite:seriesxref}
    \texdefinition{btx:sbl:cite:publisher}
    \texdefinition{btx:sbl:cite:ebook}
    \texdefinition{btx:sbl:cite:doi}
  }
  \texdefinition{btx:sbl:cite:note}
  \texdefinition{btx:sbl:cite:righttext}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:cite:reprxref}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:cite:reference
  % Otherwise, cite the author and title
  \texdefinition{btx:sbl:cite:author}
  \texdefinition{btx:sbl:cite:title}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:cite:collectionxref}
    \texdefinition{btx:sbl:cite:editortranslator}
    \texdefinition{btx:sbl:cite:edition}
    \texdefinition{btx:sbl:cite:seriesxref}
    \texdefinition{btx:sbl:cite:publisher}
    \texdefinition{btx:sbl:cite:ebook}
    \texdefinition{btx:sbl:cite:doi}
  }
  \texdefinition{btx:sbl:cite:note}
  \texdefinition{btx:sbl:cite:righttext}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:cite:reprxref}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:cite:lexicon
  \fastsetup{btx:sbl:cite:reference}
\stopsetups

\startsetups btx:sbl:cite:commentary
  % Otherwise, cite the author and title
  \texdefinition{btx:sbl:cite:author}
  \texdefinition{btx:sbl:cite:title}
  % Only recursively cite publication data if the \btxprintpubl variable is set;
  % for commentaries, the collection is not cited inline (§6.4.10.1)
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:cite:collectionxref}
    \texdefinition{btx:sbl:cite:editortranslator}
    \texdefinition{btx:sbl:cite:edition}
    \texdefinition{btx:sbl:cite:seriesxref}
    \texdefinition{btx:sbl:cite:publisher}
    \texdefinition{btx:sbl:cite:ebook}
    \texdefinition{btx:sbl:cite:doi}
  }
  \texdefinition{btx:sbl:cite:note}
  \texdefinition{btx:sbl:cite:righttext}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:cite:reprxref}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:cite:manual
  \fastsetup{btx:sbl:cite:book}
\stopsetups

\startsetups btx:sbl:cite:proceedings
  \fastsetup{btx:sbl:cite:book}
\stopsetups

\startsetups btx:sbl:cite:mvbook
  % Otherwise, cite the author and title
  \texdefinition{btx:sbl:cite:author}
  \texdefinition{btx:sbl:cite:title}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:cite:editortranslator}
    \texdefinition{btx:sbl:cite:edition}
    \texdefinition{btx:sbl:cite:volumes}
    \texdefinition{btx:sbl:cite:seriesxref}
    \texdefinition{btx:sbl:cite:publisher}
    \texdefinition{btx:sbl:cite:ebook}
    \texdefinition{btx:sbl:cite:doi}
  }
  \texdefinition{btx:sbl:cite:note}
  \texdefinition{btx:sbl:cite:righttext}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:cite:reprxref}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:cite:mvreference
  \fastsetup{btx:sbl:cite:mvbook}
\stopsetups

\startsetups btx:sbl:cite:mvlexicon
  \fastsetup{btx:sbl:cite:mvbook}
\stopsetups

\startsetups btx:sbl:cite:mvcommentary
  \fastsetup{btx:sbl:cite:mvbook}
\stopsetups

\startsetups btx:sbl:cite:collection
  \fastsetup{btx:sbl:cite:mvbook}
\stopsetups

\startsetups btx:sbl:cite:incollection
  \texdefinition{btx:sbl:cite:author}
  \texdefinition{btx:sbl:cite:title}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:cite:collectionxref}
    \texdefinition{btx:sbl:cite:editortranslator}
    \texdefinition{btx:sbl:cite:edition}
    \texdefinition{btx:sbl:cite:seriesxref}
    \texdefinition{btx:sbl:cite:publisher}
    \texdefinition{btx:sbl:cite:ebook}
    \texdefinition{btx:sbl:cite:doi}
  }
  \texdefinition{btx:sbl:cite:note}
  \texdefinition{btx:sbl:cite:righttext}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:cite:reprxref}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:cite:series
  \texdefinition{btx:sbl:cite:title}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:cite:editortranslator}
    \texdefinition{btx:sbl:cite:volumes}
    \texdefinition{btx:sbl:cite:publisher}
    \texdefinition{btx:sbl:cite:doi}
  }
  \texdefinition{btx:sbl:cite:note}
  \texdefinition{btx:sbl:cite:righttext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:cite:inbook
  \texdefinition{sbl:setshorthandtag}
  \texdefinition{btx:sbl:cite:author}
  \texdefinition{btx:sbl:cite:title}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:cite:bookxref}
    \texdefinition{btx:sbl:cite:doi}
  }
  \texdefinition{btx:sbl:cite:note}
  \texdefinition{btx:sbl:cite:righttext}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:cite:reprxref}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:cite:suppbook
  \texdefinition{btx:sbl:cite:author}
  \texdefinition{btx:sbl:cite:suppbookbookxref}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:cite:doi}
  }
  \texdefinition{btx:sbl:cite:note}
  \texdefinition{btx:sbl:cite:righttext}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:cite:reprxref}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:cite:inreference
  \texdefinition{btx:sbl:cite:author}
  \texdefinition{btx:sbl:cite:title}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:cite:inreferencebookxref}
    \texdefinition{btx:sbl:cite:doi}
  }
  \texdefinition{btx:sbl:cite:note}
  \texdefinition{btx:sbl:cite:righttext}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:cite:reprxref}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:cite:inlexicon
  \fastsetup{btx:sbl:cite:inreference}
\stopsetups

\startsetups btx:sbl:cite:incommentary
  \fastsetup{btx:sbl:cite:inreference}
\stopsetups

\startsetups btx:sbl:cite:inproceedings
  \fastsetup{btx:sbl:cite:inbook}
\stopsetups

\startsetups btx:sbl:cite:seminarpaper
  \fastsetup{btx:sbl:cite:inproceedings}
\stopsetups

\startsetups btx:sbl:cite:ancienttext
  \texdefinition{sbl:setshorthandtag}
  % If this entry has a shorthand, then cite it
  \doifelse {\shorthandtag} {\currentbtxtag} {
    \texdefinition{btx:sbl:cite:shorthand}
  } {
    % Otherwise, cite the author and title
    \texdefinition{btx:sbl:cite:author}
    \texdefinition{btx:sbl:cite:ancienttexttitle} % lefttext is handled in here
    % Only recursively cite publication data if the \btxprintpubl variable is set
    \texdefinition{btx:sbl:cite:ancienttextbookxref} % righttext is handled in here
    \doif {\btxprintpubl} {yes} {
      \texdefinition{btx:sbl:cite:doi}
      \texdefinition{btx:sbl:cite:reprxref}
    }
    \texdefinition{btx:sbl:cite:note}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:cite:classictext
  \texdefinition{btx:sbl:cite:author}
  \texdefinition{btx:sbl:cite:classictexttitle} % lefttext is handled in here
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:cite:classictextbookxref} % righttext is handled in here
    \texdefinition{btx:sbl:cite:doi}
    \texdefinition{btx:sbl:cite:reprxref}
  }
  \texdefinition{btx:sbl:cite:note}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:cite:journal
  \fastsetup{btx:sbl:cite:series}
\stopsetups

\startsetups btx:sbl:cite:article
  \texdefinition{btx:sbl:cite:author}
  \texdefinition{btx:sbl:cite:title}
  \texdefinition{btx:sbl:cite:journalxref}
  \texdefinition{btx:sbl:cite:doi}
  \texdefinition{btx:sbl:cite:note}
  \texdefinition{btx:sbl:cite:righttext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:cite:magazine
  \fastsetup{btx:sbl:cite:article}
\stopsetups

\startsetups btx:sbl:cite:newspaper
  \fastsetup{btx:sbl:cite:article}
\stopsetups

\startsetups btx:sbl:cite:periodical
  \fastsetup{btx:sbl:cite:article}
\stopsetups

\startsetups btx:sbl:cite:review
  \texdefinition{btx:sbl:cite:author}
  \texdefinition{btx:sbl:cite:title}
  \texdefinition{btx:sbl:cite:reviewbookxref}
  \texdefinition{btx:sbl:cite:journalxref}
  \texdefinition{btx:sbl:cite:doi}
  \texdefinition{btx:sbl:cite:note}
  \texdefinition{btx:sbl:cite:righttext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:cite:thesis
  \texdefinition{btx:sbl:cite:author}
  \texdefinition{btx:sbl:cite:title}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:cite:editortranslator}
    \texdefinition{btx:sbl:cite:institution}
    \texdefinition{btx:sbl:cite:doi}
  }
  \texdefinition{btx:sbl:cite:note}
  \texdefinition{btx:sbl:cite:righttext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:cite:mastersthesis
  \fastsetup{btx:sbl:cite:thesis}
\stopsetups

\startsetups btx:sbl:cite:phdthesis
  \fastsetup{btx:sbl:cite:thesis}
\stopsetups

\startsetups btx:sbl:cite:conferencepaper
  \texdefinition{btx:sbl:cite:title}
  \texdefinition{btx:sbl:cite:author}
  \texdefinition{btx:sbl:cite:presentedat}
  \texdefinition{btx:sbl:cite:doi}
  \texdefinition{btx:sbl:cite:note}
  \texdefinition{btx:sbl:cite:righttext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:cite:online
  \texdefinition{btx:sbl:cite:author}
  \texdefinition{btx:sbl:cite:title}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:cite:editortranslator}
    \texdefinition{btx:sbl:cite:eprint}
  }
  \texdefinition{btx:sbl:cite:note}
  \texdefinition{btx:sbl:cite:righttext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

% Inline subcitation setups
\startsetups btx:sbl:subcite:book
  \btxdoifelse {shorthand} {
    \texdefinition{btx:sbl:cite:shorthand}
  } {
    \texdefinition{btx:sbl:cite:title}
    \texdefinition{btx:sbl:subcite:author}
    % Only recursively cite publication data if the \btxprintpubl variable is set
    \doif {\btxprintpubl} {yes} {
      \texdefinition{btx:sbl:subcite:collectionxref}
      \texdefinition{btx:sbl:subcite:editortranslator}
      \texdefinition{btx:sbl:cite:edition}
      \texdefinition{btx:sbl:cite:seriesxref}
      \texdefinition{btx:sbl:cite:publisher}
      \texdefinition{btx:sbl:cite:ebook}
      \texdefinition{btx:sbl:cite:doi}
      \texdefinition{btx:sbl:cite:reprxref}
    }
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:subcite:reference
  \fastsetup{btx:sbl:subcite:book}
\stopsetups

\startsetups btx:sbl:subcite:commentary
  \fastsetup{btx:sbl:subcite:book}
\stopsetups

\startsetups btx:sbl:subcite:lexicon
  \fastsetup{btx:sbl:subcite:book}
\stopsetups

\startsetups btx:sbl:subcite:manual
  \fastsetup{btx:sbl:subcite:book}
\stopsetups

\startsetups btx:sbl:subcite:proceedings
  \fastsetup{btx:sbl:subcite:book}
\stopsetups

\startsetups btx:sbl:subcite:mvbook
  \btxdoifelse {shorthand} {
    \texdefinition{btx:sbl:cite:shorthand}
  } {
    \texdefinition{btx:sbl:cite:title}
    \texdefinition{btx:sbl:subcite:author}
    % Only recursively cite publication data if the \btxprintpubl variable is set
    \doif {\btxprintpubl} {yes} {
      \texdefinition{btx:sbl:subcite:editortranslator}
      \texdefinition{btx:sbl:cite:edition}
      \texdefinition{btx:sbl:cite:volumes}
      \texdefinition{btx:sbl:cite:seriesxref}
      \texdefinition{btx:sbl:cite:publisher}
      \texdefinition{btx:sbl:cite:ebook}
      \texdefinition{btx:sbl:cite:doi}
      \texdefinition{btx:sbl:cite:reprxref}
    }
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:subcite:mvreference
  \fastsetup{btx:sbl:subcite:mvbook}
\stopsetups

\startsetups btx:sbl:subcite:mvcommentary
  \fastsetup{btx:sbl:subcite:mvbook}
\stopsetups

\startsetups btx:sbl:subcite:mvlexicon
  \fastsetup{btx:sbl:subcite:mvbook}
\stopsetups

\startsetups btx:sbl:subcite:collection
  \fastsetup{btx:sbl:subcite:mvbook}
\stopsetups

\startsetups btx:sbl:subcite:incollection
  % If the parent collection has a shorthand field, then just cite it
  \texdefinition{btx:sbl:subcite:collectionxref}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:cite:bookseries}
    \texdefinition{btx:sbl:cite:publisher}
    \texdefinition{btx:sbl:cite:ebook}
    \texdefinition{btx:sbl:cite:doi}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:subcite:series
  % Always use the short form in subcites, if available
  \btxdoifelse {shorthand} {
    \texdefinition{btx:sbl:cite:shorthand}
  } {
    \texdefinition{btx:sbl:cite:title}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:subcite:inbook
  % Titles are not necessary for booksupps, 
  % so render the author correctly if there isn't one
  \btxdoifelse {title} {
    \texdefinition{btx:sbl:cite:title}
    \texdefinition{btx:sbl:subcite:author}
  } {
    \texdefinition{btx:sbl:cite:author}
  }
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:cite:bookxref}
    \texdefinition{btx:sbl:cite:reprxref}
    \texdefinition{btx:sbl:cite:doi}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:subcite:suppbook
  \fastsetup{btx:sbl:subcite:inbook}
\stopsetups

\startsetups btx:sbl:subcite:inreference
  \fastsetup{btx:sbl:subcite:inbook}
\stopsetups

\startsetups btx:sbl:subcite:inlexicon
  \fastsetup{btx:sbl:subcite:inbook}
\stopsetups

\startsetups btx:sbl:subcite:incommentary
  \fastsetup{btx:sbl:subcite:inbook}
\stopsetups

\startsetups btx:sbl:subcite:inproceedings
  \fastsetup{btx:sbl:subcite:inbook}
\stopsetups

\startsetups btx:sbl:subcite:seminarpaper
  \fastsetup{btx:sbl:subcite:inproceedings}
\stopsetups

\startsetups btx:sbl:subcite:ancienttext
  \fastsetup{btx:sbl:subcite:inbook}
\stopsetups

\startsetups btx:sbl:subcite:classictext
  \fastsetup{btx:sbl:subcite:inbook}
\stopsetups

\startsetups btx:sbl:subcite:journal
  \fastsetup{btx:sbl:subcite:series}
\stopsetups

\startsetups btx:sbl:subcite:article
  \texdefinition{btx:sbl:cite:title}
  \texdefinition{btx:sbl:subcite:author}
  \texdefinition{btx:sbl:cite:journalxref}
  \texdefinition{btx:sbl:cite:doi}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:subcite:magazine
  \fastsetup{btx:sbl:subcite:article}
\stopsetups

\startsetups btx:sbl:subcite:newspaper
  \fastsetup{btx:sbl:subcite:article}
\stopsetups

\startsetups btx:sbl:subcite:periodical
  \fastsetup{btx:sbl:subcite:article}
\stopsetups

\startsetups btx:sbl:subcite:review
  % Titles are not necessary for book reviews, 
  % so render the author correctly if there isn't one
  \btxdoifelse {title} {
    \texdefinition{btx:sbl:cite:title}
    \texdefinition{btx:sbl:subcite:author}
  } {
    \texdefinition{btx:sbl:cite:author}
  }
  \texdefinition{btx:sbl:cite:bookxref}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:cite:journalxref}
    \texdefinition{btx:sbl:cite:doi}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:subcite:thesis
  \texdefinition{btx:sbl:cite:title}
  \texdefinition{btx:sbl:subcite:author}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:subcite:editortranslator}
    \texdefinition{btx:sbl:cite:institution}
    \texdefinition{btx:sbl:cite:doi}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:subcite:mastersthesis
  \fastsetup{btx:sbl:subcite:thesis}
\stopsetups

\startsetups btx:sbl:subcite:phdthesis
  \fastsetup{btx:sbl:subcite:thesis}
\stopsetups

\startsetups btx:sbl:subcite:conferencepaper
  \texdefinition{btx:sbl:cite:title}
  \texdefinition{btx:sbl:subcite:author}
  % Only recursively cite publication data if the \btxprintpubl variable is set
  \doif {\btxprintpubl} {yes} {
    \texdefinition{btx:sbl:cite:presentedat}
    \texdefinition{btx:sbl:cite:doi}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

% Short citation setups
\startsetups btx:sbl:short:book
  \btxdoifelse {shorthand} {
    \texdefinition{btx:sbl:cite:shorthand}
  } {
    \texdefinition{btx:sbl:short:author}
    \texdefinition{btx:sbl:short:title}
  }
  \texdefinition{btx:sbl:short:righttext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:short:reference
  \fastsetup{btx:sbl:short:book}
\stopsetups

\startsetups btx:sbl:short:commentary
  \fastsetup{btx:sbl:short:book}
\stopsetups

\startsetups btx:sbl:short:lexicon
  \fastsetup{btx:sbl:short:book}
\stopsetups

\startsetups btx:sbl:short:manual
  \fastsetup{btx:sbl:short:book}
\stopsetups

\startsetups btx:sbl:short:proceedings
  \fastsetup{btx:sbl:short:book}
\stopsetups

\startsetups btx:sbl:short:mvbook
  \fastsetup{btx:sbl:short:book}
\stopsetups

\startsetups btx:sbl:short:mvreference
  \fastsetup{btx:sbl:short:mvbook}
\stopsetups

\startsetups btx:sbl:short:mvcommentary
  \fastsetup{btx:sbl:short:mvbook}
\stopsetups

\startsetups btx:sbl:short:mvlexicon
  \fastsetup{btx:sbl:short:mvbook}
\stopsetups

\startsetups btx:sbl:short:collection
  \fastsetup{btx:sbl:short:mvbook}
\stopsetups

\startsetups btx:sbl:short:incollection
  \fastsetup{btx:sbl:short:book}
\stopsetups

\startsetups btx:sbl:short:series
  \fastsetup{btx:sbl:short:book}
\stopsetups

\startsetups btx:sbl:short:inbook
  \btxdoifelse {shorthand} {
    \texdefinition{btx:sbl:cite:shorthand}
  } {
    \texdefinition{btx:sbl:short:author}
    \texdefinition{btx:sbl:short:title}
  }
  % If the type of this entry is "ANRW", then print the shorthand of the collection after the article title, followed by the volume and part and any cited page numbers
  \doifelse {\btxflush{type}} {ANRW} {
    \btxstartstyleandcolor[sbl:\s!list:title:book]
      \btxusecommand[sbl:\s!list:title:book]{
        {ANRW}%
      }
    \btxstopstyleandcolor
    \btxspace
    \begingroup
    \def\bookxreftag{\btxflush{bookxref}}
    \textcite[volume][\bookxreftag]
    \doifelse {\currentbtxrighttext} {\empty} {
      % If no pages are specified, then cite the full page range, if there is one
      \btxdoif {pages} {
        \btxcolon
        \removeunwantedspaces
        \btxflush{pages}
      }
    } {
      \btxcolon
      \removeunwantedspaces
      \currentbtxrighttext
    }
    \endgroup
    \btxcomma
  } {
    % Otherwise, just print the cited page number as-is
    \texdefinition{btx:sbl:short:righttext}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:short:suppbook
  % Print the author, followed by the type of this entry
  \texdefinition{btx:sbl:short:author}
  \texdefinition{btx:sbl:short:suppbookbookxref}
  \texdefinition{btx:sbl:short:righttext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:short:inreference
  \fastsetup{btx:sbl:short:inbook}
\stopsetups

\startsetups btx:sbl:short:inlexicon
  \fastsetup{btx:sbl:short:inbook}
\stopsetups

\startsetups btx:sbl:short:incommentary
  \fastsetup{btx:sbl:short:inbook}
\stopsetups

\startsetups btx:sbl:short:inproceedings
  \fastsetup{btx:sbl:short:inbook}
\stopsetups

\startsetups btx:sbl:short:seminarpaper
  \fastsetup{btx:sbl:short:inproceedings}
\stopsetups

\startsetups btx:sbl:short:ancienttext
  \btxdoifelse {shorthand} {
    \texdefinition{btx:sbl:cite:shorthand}
    \doifnot {\currentbtxlefttext} {\empty} {
      \removeunwantedspaces
      \removepunctuation
      \btxspace
      \texdefinition{btx:sbl:short:lefttext}
    }
  } {
    \texdefinition{btx:sbl:short:author}
    \texdefinition{btx:sbl:short:ancienttexttitle} % lefttext is handled in here
    \texdefinition{btx:sbl:short:ancienttextbookxref} % righttext is handled in here
  }
\stopsetups

\startsetups btx:sbl:short:classictext
  \btxdoifelse {shorthand} {
    \texdefinition{btx:sbl:cite:shorthand}
    \doifnot {\currentbtxlefttext} {\empty} {
      \removeunwantedspaces
      \removepunctuation
      \btxspace
      \texdefinition{btx:sbl:short:lefttext}
    }
  } {
    \texdefinition{btx:sbl:short:author}
    \texdefinition{btx:sbl:short:classictexttitle} % lefttext is handled in here
    \texdefinition{btx:sbl:short:classictextbookxref} % righttext is handled in here
  }
\stopsetups

\startsetups btx:sbl:short:journal
  \fastsetup{btx:sbl:short:series}
\stopsetups

\startsetups btx:sbl:short:article
  \fastsetup{btx:sbl:short:book}
\stopsetups

\startsetups btx:sbl:short:magazine
  \fastsetup{btx:sbl:short:article}
\stopsetups

\startsetups btx:sbl:short:newspaper
  \fastsetup{btx:sbl:short:article}
\stopsetups

\startsetups btx:sbl:short:periodical
  \fastsetup{btx:sbl:short:article}
\stopsetups

\startsetups btx:sbl:short:review
  % Print the author, then either the title (if there is one) or a summary of the review
  \texdefinition{btx:sbl:short:author}
  \btxdoifelse{title} {
    \texdefinition{btx:sbl:short:title}
  } {
    \texdefinition{btx:sbl:short:reviewbookxref}
  }
  \texdefinition{btx:sbl:short:righttext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:short:thesis
  \fastsetup{btx:sbl:short:book}
\stopsetups

\startsetups btx:sbl:short:mastersthesis
  \fastsetup{btx:sbl:short:thesis}
\stopsetups

\startsetups btx:sbl:short:phdthesis
  \fastsetup{btx:sbl:short:thesis}
\stopsetups

\startsetups btx:sbl:short:conferencepaper
  \fastsetup{btx:sbl:short:book}
\stopsetups

%%%%%%%%%%%%%%%%%%%%%%%%%
% Cite alternative setups
%%%%%%%%%%%%%%%%%%%%%%%%%

% List citation setup
\startsetups btx:sbl:\s!cite:entry
  \fastsetup{\s!btx:\s!cite:concat}
  \fastsetup{\s!btx:\s!cite:left}
  \begingroup
  % Reset variables for new citation
  \let\btxroottag\currentbtxtag
  \def\shorthandtag{none}%
  \def\btxprintpubl{yes}%
  \let\btxcurrentsubcitetype\empty
  % Then cite the list entry
  \btxhandleciteentry
  \endgroup
  \fastsetup{\s!btx:\s!cite:right}
\stopsetups

% List subcitation setup
\startsetups btx:sbl:\s!cite:listsubcite
  \begingroup
  % This gets cleared in cites, so set it here 
  \def\currentbtxcategory{\btxfield{category}}%
  \fastsetup{btx:sbl:listsubcite:\currentbtxcategory}
  \endgroup
\stopsetups

% Inline citation setup
\startsetups btx:sbl:\s!cite:inline
  \fastsetup{\s!btx:\s!cite:concat}
  \fastsetup{\s!btx:\s!cite:left}
  \begingroup
  % This gets cleared in cites, so set it here
  \def\currentbtxcategory{\btxfield{category}}%
  % Reset variables for new citation
  \let\btxroottag\currentbtxtag
  \def\shorthandtag{none}%
  \let\btxcurrentsubcitetype\empty
  % Then invoke the appropriate setup
  \doifelse {\btxflush{type}} {inlineshorthand} {
    \fastsetup{btx:sbl:short:\currentbtxcategory}
  } {
    \fastsetup{btx:sbl:cite:\currentbtxcategory}
  }
  \endgroup
  \fastsetup{\s!btx:\s!cite:right}
\stopsetups

% Inline subcitation setup
\startsetups btx:sbl:\s!cite:subcite
  \begingroup
  \def\shorthandtag{none}%
  % This gets cleared in cites, so set it here
  \def\currentbtxcategory{\btxfield{category}}%
  \fastsetup{btx:sbl:subcite:\currentbtxcategory}
  \endgroup
\stopsetups

% Inline parenthetical citation setup
\startsetups btx:sbl:cite:paren
  \fastsetup{btx:sbl:\s!cite:inline}
\stopsetups

% Footnote citation setup
\startsetups btx:sbl:cite:footnote
  \startfootnote
    \fastsetup{btx:sbl:\s!cite:inline}
  \stopfootnote
\stopsetups

% Volume (and part) number citation setup
\startsetups btx:sbl:cite:volume
  \btxdoif{volume} {
    \btxflush{volume}
    \removeunwantedspaces
    \btxdoif{part} {
      \btxperiod
      \removeunwantedspaces
      \btxflush{part}
    }
    \removeunwantedspaces
  }
\stopsetups

% Short citations setup
\startsetups btx:sbl:cite:short
  \fastsetup{\s!btx:\s!cite:concat}
  \fastsetup{\s!btx:\s!cite:left}
  \begingroup
  \def\currentbtxcategory{\btxfield{category}}%
  \fastsetup{btx:sbl:short:\currentbtxcategory}
  \endgroup
  \removeunwantedspaces
  \removepunctuation
  \fastsetup{\s!btx:\s!cite:right}
\stopsetups

\stopbtxrenderingdefinitions
