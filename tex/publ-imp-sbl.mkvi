%D \module
%D   [       file=publ-imp-sbl,
%D        version=2021.08.07,
%D          title=SBL bibliography style,
%D       subtitle=Publications,
%D         author=Joey McCollum,
%D           date=\currentdate,
%D      copyright={PRAGMA ADE \& \CONTEXT\ Development Team}]
%C
%C This module is part of the \CONTEXT\ macro||package and is therefore copyrighted
%D by \PRAGMA. See mreadme.pdf for details.

% NOTE FOR HANS: Because of cross-reference relationships between bibliographic entries that this rendering uses,
% I have had to use several low-level macros to retrieve fields from entries other than the current one.
% Specifically, these are \clf_btxfield, \clf_btxdirect, \clf_btxdoif, \clf_btxdoifelse, \clf_btxfoundname, and \clf_btxauthor.
% Higher-level helper functions should be defined to serve the same functions.

\startbtxrenderingdefinitions[sbl]

\ifdefined\c!translate \else \def\c!translate{translate} \fi

%D Reference:
%D \startTEX
%D @manual{SBLH2,
%D     title     ={Society of Biblical Literature Handbook of Style},
%D     shorttitle={SBLHS},
%D     shorthand ={SBLHS},
%D     edition   ={2},
%D     address   ={Atlanta, GA},
%D     publisher ={SBL Press},
%D     date      ={2014},
%D     Xpages    ={368},
%D     url       ={https://www.sbl-site.org/publications/sblhandbookofstyle.aspx},
%D }
%D \stopTEX

% set ALL specific SBL compliant values

\definebtx
  [sbl]
  [\c!default=default,
   \c!specification=sbl,
   \c!otherstext={\btxspace\btxlabeltext{others}},
   % TODO: the following fields are not language-sensitive and probably should be
   useibid=\v!no, % useibid=yes will enable abbreviation of consecutive citations of the same entry as "ibid."
   useidem=\v!no, % useidem=yes will enable abbreviation of an author cited multiple times consecutively as "idem"
   synonym=\v!abbreviation, % TODO: this can determine which synonyms set we will use for shorthands
   synonyms=\v!abbreviations, % TODO: this can determine which synonyms set we will use for shorthands
   sameauthor=\v!rule, % rule = use horizontal rule for same author in list; empty = use empty space; ditto = use "idem"; none = print repeated author as-is
   titleauthor=\v!no, % titleauthor=yes will print the author after the title (used for subcitation and abbreviation list purposes)
   useauthor=\v!yes, % useauthor=no will skip printing the author
   usecrossref=\v!yes, % usecrossref=no will skip printing the cross-referenced source
   usepubl=\v!yes, % usepubl=no will skip printing the publication fields (non-author editor, translator, edition, volumes, series, publisher, DOI, e-print, etc.)
   lefttext=\empty, % empty by default
   altloctext=\empty, %empty by default
   loctext=\empty, %empty by default
   righttext=\empty, % empty by default
   punct=\empty, % trailing punctuation (empty by default)
  %\c!journalconversion=\v!normal,
   \c!monthconversion=\v!month,
   \c!stopper:initials={. }, % with a (breakable) space
   \c!separator:names:2={\btxcomma}, % between subsequent names except for last 2
   \c!separator:names:3={\btxcomma\btxlabeltext{and}\space}, % between last 2 names if > 2
   \c!separator:names:4={\btxspace\btxlabeltext{and}\space}] % between only 2 names

% Because some common punctuation characters are escaped in publ-ini.mkiv,
% we have to set this option separately
\pushcatcodetable
\setcatcodetable\ctxcatcodes
  \setupbtx[sbl][autopunctuation={!,.:;?}]% undelimited list of trailing punctuation to move before footnote citations
\popcatcodetable

% First, define list and rendering parameters

% Sort the unnumbered rendered list by authortitle
\definebtxrendering
  [sbl]
  [\c!specification=sbl,
   \c!sorttype=authortitle, % defined in publ-aut.lua
   \c!numbering=\v!no] % by default, do not number bibliographic entries

% Print the bibliographic list as a paragraph, 
% with normal alignment settings (justified and with hyphenation)
\setupbtxlist
  [sbl]
  [\c!alternative=\v!paragraph,
   \c!align={normal,verytolerant,stretch},
  %\c!width=\v!fit,
  %\c!distance=.5\emwidth,
   \c!margin=3.5\emwidth]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% List citation field styles
%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\definebtx
  [sbl:\s!list]
  [sbl]
  [\c!otherstext={\btxspace\btxlabeltext{others}},
  \c!etallimit=,
  \c!etaldisplay=,
  \c!etaloption=last,
  \c!authorconversion=normal]

% First, we define a namespace for a few special fields (mostly names that require special handling)

\definebtx
  [sbl:\s!list:author]
  [sbl:\s!list]
  [\c!authorconversion=invertedfirst,
  \c!separator:names:4={\btxcomma\btxlabeltext{and}\space}] % between only 2 names

\definebtx
  [sbl:\s!list:withauthor]
  [sbl:\s!list]

\definebtx
  [sbl:\s!list:editor]
  [sbl:\s!list] % use normal authorconversion for editors who are in addition to authors (editors in place of authors should be handled by sbl:\s!list:author)

\definebtx
  [sbl:\s!list:witheditor]
  [sbl:\s!list]

\definebtx
  [sbl:\s!list:translator]
  [sbl:\s!list]

\definebtx
  [sbl:\s!list:withtranslator]
  [sbl:\s!list]

\definebtx
  [sbl:\s!list:suffix]
  [sbl:\s!list]

\definebtx
  [sbl:\s!list:url]
  [sbl:\s!list]

\definebtx
  [sbl:\s!list:doi]
  [sbl:\s!list]

\definebtx
  [sbl:\s!list:\s!page]
  [sbl:\s!list]

\definebtx
  [sbl:\s!list:numbering]
  [sbl:\s!list]
  [\c!right={\btxspace}]

\definebtx
  [sbl:\s!list:numbering:default]
  [sbl:\s!list:numbering]

\definebtx
  [sbl:\s!list:numbering:num]
  [sbl:\s!list:numbering]
  [\c!stopper={.}]

\definebtx
  [sbl:\s!list:numbering:short]
  [sbl:\s!list:numbering]

\definebtx
  [sbl:\s!list:numbering:tag]
  [sbl:\s!list:numbering]

\definebtx
  [sbl:\s!list:numbering:index]
  [sbl:\s!list:numbering]

% Since the title may be italicized or quoted depending on the entry category, 
% it will help to define a namespace for each category.
% Note that the namespacing is simply for clarity and convenience;
% to get ConTeXt to actually use category-dependent styles, we need to use the
% \btxstartstyleandcolor[sbl:\s!list:title:\currentbtxcategory] ... \btxstopstyleandcolor environment
% (to activate the style parameter)
% and the \btxusecommand[sbl:\s!list:title:\currentbtxcategory] command
% (to invoke the command parameter)

\starttexdefinition titleemph #1
  \emph{\Word{#1}}
\stoptexdefinition

\starttexdefinition titlequote #1
  \quotation{\Word{#1}}
\stoptexdefinition

\definebtx
  [sbl:\s!list:title]
  [sbl:\s!list]
  [\c!command=\titleemph, % by default, titles should be italicized and their first word capitalized
   \c!translate=\v!yes]

\definebtx
  [sbl:\s!list:title:mvbook]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:mvreference]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:mvcollection]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:mvproceedings]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:series]
  [sbl:\s!list:title]
  [\c!command=,] %disable italics and capitalization

\definebtx
  [sbl:\s!list:title:journal]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:book]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:reference]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:collection]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:proceedings]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:manual]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:inbook]
  [sbl:\s!list:title]
  [\c!command=\titlequote] % article title is quoted and its first word is capitalized

\definebtx
  [sbl:\s!list:title:inreference]
  [sbl:\s!list:title:inbook]

\definebtx
  [sbl:\s!list:title:incollection]
  [sbl:\s!list:title:inbook]

\definebtx
  [sbl:\s!list:title:inproceedings]
  [sbl:\s!list:title:inbook]

\definebtx
  [sbl:\s!list:title:article]
  [sbl:\s!list:title]
  [\c!command=\titlequote] % article title is quoted and its first word is capitalized

\definebtx
  [sbl:\s!list:title:magazine]
  [sbl:\s!list:title:article]

\definebtx
  [sbl:\s!list:title:newspaper]
  [sbl:\s!list:title:article]

\definebtx
  [sbl:\s!list:title:periodical]
  [sbl:\s!list:title:article]

\definebtx
  [sbl:\s!list:title:review]
  [sbl:\s!list:title:article]

\definebtx
  [sbl:\s!list:title:ancienttext]
  [sbl:\s!list:title:inbook]

\definebtx
  [sbl:\s!list:title:classictext]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:conferencepaper]
  [sbl:\s!list:title:inbook]

\definebtx
  [sbl:\s!list:title:thesis]
  [sbl:\s!list:title:unpublished]

\definebtx
  [sbl:\s!list:title:mastersthesis]
  [sbl:\s!list:title:thesis]

\definebtx
  [sbl:\s!list:title:phdthesis]
  [sbl:\s!list:title:thesis]

\definebtx
  [sbl:\s!list:title:unpublished]
  [sbl:\s!list:title]
  [\c!command=\titlequote] % unpublished title is quoted and its first word is capitalized

\definebtx
  [sbl:\s!list:title:online]
  [sbl:\s!list:title:unpublished]

\definebtx
  [sbl:\s!list:title:electronic]
  [sbl:\s!list:title:unpublished]

\definebtx
  [sbl:\s!list:title:misc]
  [sbl:\s!list:title:unpublished]

\definebtx
  [sbl:\s!list:title:literal]
  [sbl:\s!list:title:unpublished]

\definebtx
  [sbl:\s!list:date]
  [\c!command=\btx_sbl_convertdate] % convert dates in "YYYY-MM-DD" or "YYYY-MM" format to "d month year" or "month year" format

\definebtx
  [sbl:\s!list:pages]
  [\c!command=\btx_sbl_abbreviatepagerange] % truncate page ranges according to Chicago/SBL rules

\definebtx
  [sbl:\s!list:type]
  [\c!command=\Word] % always capitalize, as the type field will follow a period in the list entry

\definebtx
  [sbl:\s!list:edition]
  [\c!command=\btx_sbl_ordinal] % convert numerical edition fields to ordinal form

\definebtx
  [sbl:\s!list:note]
  [\c!command=\Word] % always capitalize, as the note field will follow a period in the list entry

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% In-text citation field styles
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% General rules to be inherited or excepted by other types of citations
\definebtx
  [sbl:\s!cite]
  [sbl]
  [\c!alternative=footnote, % by default, SBL uses footnote citation format (defined below)
   \c!otherstext={\btxspace\btxlabeltext{others}}, % use et al. for truncated author / editor list
   \c!etallimit=3, % don't use et al. for 3 or fewer authors
   \c!etaldisplay=1, % but if there are > 3, then only list the first explicitly
   \c!etaloption=last,
   \c!authorconversion=\v!normal, % by default, use normal name order for in-text citations
   \c!sorttype=normal, % \v!normal ?
   \c!style=, % do not apply any styles across the whole citation
   \c!compress=\v!yes] % note that cite sorts only work with compress=yes.

% Just cite the author's last name
\definebtx
  [sbl:\s!cite:name]
  [sbl:\s!cite]
  [\c!authorconversion=\v!name]

% The alternatives that follow are not suggested by SBL,
% so perhaps they are not necessary?

% Just cite the author's last name in full followed by first names(s) in full
\definebtx
  [sbl:\s!cite:inverted]
  [sbl:\s!cite]
  [\c!authorconversion=\v!inverted]

% Cite the authors, with the first in inverted order and the rest in normal order
\definebtx
  [sbl:\s!cite:invertedfirst]
  [sbl:\s!cite]
  [\c!authorconversion=\v!invertedfirst]

% Just cite the author's last name in full followed by first initial(s)
\definebtx
  [sbl:\s!cite:invertedshort]
  [sbl:\s!cite]
  [\c!authorconversion=\v!invertedshort]

% Just cite the author's first initial(s) followed by last name in full
\definebtx
  [sbl:\s!cite:normalshort]
  [sbl:\s!cite]
  [\c!authorconversion=\v!normalshort]

% Just cite the author's name in full
\definebtx
  [sbl:\s!cite:normal]
  [sbl:\s!cite]
  [\c!authorconversion=\v!normal]

\definebtx
  [sbl:\s!cite:author]
  [sbl:\s!cite:normal]

\definebtx
  [sbl:\s!cite:lefttext]
  [sbl:\s!cite]

\definebtx
  [sbl:\s!cite:righttext]
  [sbl:\s!cite]

\definebtx
  [sbl:\s!cite:year]
  [sbl:\s!cite]
  [\c!separator:2={\btxcomma}, % between subsequent years except for last 2
   \c!separator:3={\btxcomma\btxlabeltext{and}\space}, % between last 2 years if > 2
   \c!separator:4={\btxspace\btxlabeltext{and}\space}] % between only 2 years

% these setups need to be explicitly defined in order to get cite rendering

\startsetups \s!btx:sbl:\s!cite:author
  \fastsetup{\s!btx:\s!cite:normal}
\stopsetups

% Citation rules for titles (italicize by default)
\definebtx
  [sbl:\s!cite:title]
  [sbl:\s!cite]
  [\c!separator:2={\btxcomma}, % between subsequent titles except for last 2
   \c!separator:3={\btxcomma\btxlabeltext{and}\space}, % between last 2 titles if > 2
   \c!separator:4={\btxspace\btxlabeltext{and}\space}, % between only 2 titles
   \c!command={\language[\currentbtxlanguage]}, % set the language to that of the entry with the current title
   \c!sorttype=none,
   \c!command=\titleemph]

\definebtx
  [sbl:\s!cite:title:journal]
  [sbl:\s!cite:title]

% Exceptional cases; these titles are only in quotations, not italicized
\definebtx
  [sbl:\s!cite:title:article]
  [sbl:\s!cite:title]
  [\c!command=\titlequote] % article title is quoted

\definebtx
  [sbl:\s!cite:title:magazine]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:newspaper]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:periodical]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:inbook]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:inproceedings]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:thesis]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:mastersthesis]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:phdthesis]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:unpublished]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:electronic]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:online]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:misc]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:tag]
  [sbl:\s!cite]
  [\c!left={[},
   \c!right={]}]

\definebtx
  [sbl:\s!cite:index]
  [sbl:\s!cite]
  [\c!left={[},
   \c!right={]}]

% Page number citations
\definebtx
  [sbl:\s!cite:page]
  [sbl:\s!cite]
  [\c!left=,
   \c!right=,
   \c!command=\btx_sbl_abbreviatepagerange, % truncate page ranges according to Chicago/SBL rules
   \c!separator:2={\btxcomma}, % between subsequent page ranges except for last 2
   \c!separator:3={\btxcomma\btxlabeltext{and}\space}, % between last 2 page ranges if > 2
   \c!separator:4={\btxspace\btxlabeltext{and}\space}] % between only 2 page ranges

\definebtx
  [sbl:\s!cite:pages]
  [sbl:\s!cite:page]

\definebtx
  [sbl:\s!cite:keywords]
  [sbl:\s!cite]

\definebtx
  [sbl:\s!cite:short]
  [sbl:\s!cite]
  [\c!left={[},
   \c!right={]}]

\definebtx
  [sbl:\s!cite:category]
  [sbl:\s!cite]

\definebtx
  [sbl:\s!cite:url]
  [sbl:\s!cite]
  [\c!left={(},
   \c!right={)}]

\definebtx
  [sbl:\s!cite:doi]
  [sbl:\s!cite:url]

% LaTeX-style bibliography entry number citation
\definebtx
  [sbl:\s!cite:num]
  [sbl:\s!cite]
  [\c!left={[},
   \c!right={]},
   \c!separator:2={,}, % between subsequent reference numbers except for last 2
   \c!separator:3=\btxparameter{\c!separator:2}, % between last 2 reference numbers if > 2
   \c!separator:4=\btxparameter{\c!separator:2}] % between only 2 reference numbers

% LaTeX \ref-style bibliography entry number citation
\definebtx
  [sbl:\s!cite:textnum]
  [sbl:\s!cite:num]
  [\c!left={Ref.\nbsp},
   \c!right=,
   \c!separator:2={\btxcomma}, % between subsequent reference numbers except for last 2
   \c!separator:3={\btxspace\btxlabeltext{and}\space}, % between last 2 reference numbers if > 2
   \c!separator:4={\btxspace\btxlabeltext{and}\space}] % between only 2 reference numbers

% Define default settings for citations that replicate list entries
\definebtx
  [sbl:\s!cite:entry]
  [sbl:\s!cite]
  [\c!separator:2={\btxsemicolon}, % between subsequent citations except for last 2
   \c!separator:3={\btxsemicolon\btxlabeltext{and}\space}, % between last 2 citations if > 2
   \c!separator:4={\btxsemicolon\btxlabeltext{and}\space}] % between only 2 citations

% Inline citations are similar to list entry citations, 
% but they have slightly different rules for punctuation and capitalization for fields
\definebtx
  [sbl:\s!cite:inline]
  [sbl:\s!cite]
  [\c!separator:2={\btxsemicolon}, % between subsequent citations except for last 2
   \c!separator:3={\btxsemicolon\btxlabeltext{and}\space}, % between last 2 citations if > 2
   \c!separator:4={\btxsemicolon\btxlabeltext{and}\space}] % between only 2 citations

\definebtx
  [sbl:\s!cite:inlinelong]
  [sbl:\s!cite:inline]

\definebtx
  [sbl:\s!cite:inlineshort]
  [sbl:\s!cite:name]

% Parenthetical citations should be rendered exactly like inline citations, 
% but the whole citation should be surrounded by parentheses, 
% and brackets should be used where parentheses are within the citation 
% (e.g., journal years and publication and institution blocks) 
\definebtx
  [sbl:\s!cite:paren]
  [sbl:\s!cite:inline]

% Citations in footnotes (and endnotes, for the philistines who use them) should be rendered exactly like citations in the text, 
% but followed by a period and placed in footnotes
\definebtx
  [sbl:\s!cite:footnote]
  [sbl:\s!cite:inline]

% By default, SBL uses inline format for in-text citations
\definebtx
  [sbl:\s!cite:default]
  [sbl:\s!cite:inline]

% Volume (and part) number citations
\definebtx
  [sbl:\s!cite:volume]
  [sbl:\s!cite:page]

% Now we setup for the details of the renderings

%D Sometimes we have verbose injections in an entry and these can be language
%D dependent, so we use labels.
%D
%D Because we want to mix rendering (in the manual) we need a namespace in label
%D texts:

\setupbtxlabeltext
  [en]
  [
  sbl:ibid={ibid.},
  sbl:idem={idem},
  sbl:edition={ed.},
  sbl:editionfull={edition},
  sbl:editor={ed.},
  sbl:editors={eds.},
  sbl:Page={Page},
  sbl:Pages={Pages},
  sbl:here={here},
  sbl:edited={edited},
  sbl:Edited={Edited},
  sbl:translator={trans.},
  sbl:translated={translated},
  sbl:Translated={Translated},
  sbl:volume={vol.},
  sbl:Volume={Vol.},
  sbl:volumes={vols.},
  sbl:Volumes={Vols.},
  sbl:part={part},
  sbl:parts={parts},
  sbl:masters={Master's},
  sbl:thesis={thesis},
  sbl:phd={PhD},
  sbl:diss={diss.},
  sbl:reprint={repr.},
  sbl:Reprint={Repr.},
  sbl:paperpresentedat={paper presented at},
  sbl:Paperpresentedat={Paper presented at},
  sbl:with={with},
  sbl:by={by},
  sbl:in={in},
  sbl:In={In},
  sbl:of={of},
  sbl:to={to},
  sbl:released={released},
  sbl:Released={Released},
  sbl:reviewof={review of},
  sbl:Reviewof={Review of},
  sbl:translationof={trans. of},
  sbl:Translationof={Translation of},
  sbl:reprintof={repr. of},
  sbl:Reprintof={Reprint of},
  % locator abbreviations (§8.1.3)
  sbl:loc:book={bk.},
  sbl:loc:books={bks.},
  sbl:loc:chapter={ch.},
  sbl:loc:chapters={chs.},
  sbl:loc:column={col.},
  sbl:loc:columns={cols.},
  sbl:loc:episode={ep.},
  sbl:loc:episodes={eps.},
  sbl:loc:figure={fig.},
  sbl:loc:figures={figs.},
  sbl:loc:folio={fol.},
  sbl:loc:folios={fols.},
  sbl:loc:fragment={frag.},
  sbl:loc:fragments={frags.},
  sbl:loc:line={line},
  sbl:loc:lines={lines},
  sbl:loc:note={n.},
  sbl:loc:notes={nn.},
  sbl:loc:issue={no.},
  sbl:loc:issues={nos.},
  sbl:loc:opus={op.},
  sbl:loc:opera={opp.},
  sbl:loc:page={p.},% this is not used in practice, as page numbers are printed without a locator prefix
  sbl:loc:pages={pp.},% this is not used in practice, as page numbers are printed without a locator prefix
  sbl:loc:paragraph={¶},
  sbl:loc:paragraphs={¶¶},
  sbl:loc:part={pt.},
  sbl:loc:parts={pts.},
  sbl:loc:plate={pl.},
  sbl:loc:plates={pls.},
  sbl:loc:recension={rec.},
  sbl:loc:recensions={recs.},
  sbl:loc:section={§},
  sbl:loc:sections={§§},
  sbl:loc:subverbo={s.v.},
  sbl:loc:subverbi={s.vv.},
  sbl:loc:verse={v.},
  sbl:loc:verses={vv.},
  sbl:loc:volume={vol.},
  sbl:loc:volumes={vols.}
  ]

% First some helpers:

%Setup nested quotation handling (e.g., article titles with quotes)
\setupdelimitedtext[quotation:1][left={\symbol[leftquotation]},right={\symbol[rightquotation]}]
\setupdelimitedtext[quotation:2][left={\symbol[leftquote]}, right={\symbol[rightquote]}]
\setupdelimitedtext[quotation:3][left={\symbol[leftquotation]},right={\symbol[rightquotation]}]
\setupdelimitedtext[quotation:4][left={\symbol[leftquote]}, right={\symbol[rightquote]}]

% Nested parentheses (used for things like publisher and institution blocks) should alternate between proper parentheses and brackets
\definedelimitedtext[paren][quotation][location=text,left={(},right={)}]
\setupdelimitedtext[paren:1][left={(},right={)}]
\setupdelimitedtext[paren:2][left={[}, right={]}]
\setupdelimitedtext[paren:3][left={(},right={)}]
\setupdelimitedtext[paren:4][left={[}, right={]}]

% Setup abbreviation settings
\definesynonyms[abbreviation][abbreviations][\infull][\inshort] % we need the \inshort command to access abbreviations by their entry tag

% Various Lua macros for parsing and conversion
\startluacode
  publications.btx = publications.btx or {}

  local sbl = {}
  publications.btx.sbl = sbl

  function sbl.isrange(str)
    if string.find(str, "-") then
      return true
    end
    -- TODO: this may be language-dependent, as some languages may use commas instead of periods as section/subsection separators
    if string.find(str, ",") then
      return true
    end
    return false
  end

  function sbl.doifrange(str, ifyes)
    if string.find(str, "-") then
      context(ifyes)
    end
    -- TODO: this may be language-dependent, as some languages may use commas instead of periods as section/subsection separators
    if string.find(str, ",") then
      context(ifyes)
    end
  end

  function sbl.doifrangeelse(str, ifyes, ifno)
    if sbl.isrange(str) then
      context(ifyes)
    else
      context(ifno)
    end
    return
  end

  function sbl.regexsplit(str, regex)
    -- by default, split on whitespace
    if regex == nil then
      regex = "%s+"
    end
    local splits = {}
    local i = 1
    local next_start = 0
    local next_end = 0
    while true do
      -- get the next occurrence of the separator pattern
      next_start, next_end = string.find(str, regex, i) -- find next occurrence of separator pattern
      if next_start == nil then
        -- if there isn't one, then add the suffix of the input string starting at the current index and exit the loop
        table.insert(splits, string.sub(str, i, string.len(str)))
        break
      else
        -- if there is, then add the substring between the current index and the start of the match,
        -- then update the current index
        table.insert(splits, string.sub(str, i, next_start - 1))
        i = next_end + 1
      end
    end
    return splits
  end

  function sbl.isprefix(prefix, str)
    if string.find(str, "^" .. prefix) then
      return true
    end
    return false
  end

  function sbl.doifprefix(prefix, str, ifyes)
    -- if the given string is a prefix of the given string, then print the "ifyes" argument
    if sbl.isprefix(prefix, str) then
      context(ifyes)
    end
  end

  function sbl.doifprefixelse(prefix, str, ifyes, ifno)
    -- if the given string is a prefix of the given string, then print the ifyes argument; otherwise, print the ifno argument
    if sbl.isprefix(prefix, str) then
      context(ifyes)
    else
      context(ifno)
    end
  end

  function sbl.hasnumericprefix(str)
    -- does the string begin with an Arabic numeral?
    if string.match(str, "^%d") then
      return(true)
    end
    -- if not, then does it consist of only Roman numerals before a space, comma, or period, or before the end of a string?
    if string.count(str, "%s") > 0 then
       if string.match(str, "^[IVXLCMivxlcm]+[,%.]*%s") then
         return(true)
       end
       return(false)
    else
      if string.match(str, "^[IVXLCMivxlcm]+$") then
        return(true)
      end
      return(false)
    end
  end

  function sbl.doifhasnumericprefix(str, ifyes)
    if sbl.hasnumericprefix(str) then
      context(ifyes)
    end
  end

  function sbl.doifhasnumericprefixelse(str, ifyes, ifno)
    if sbl.hasnumericprefix(str) then
      context(ifyes)
    else
      context(ifno)
    end
  end

  function sbl.hasnumericsuffix(str)
    -- does the string end with a string followed by an Arabic or Roman numeral?
    if string.match(str, "%s[%dIVXLCMivxlcm]+$") then
      return(true)
    end
    return(false)
  end

  function sbl.doifhasnumericsuffix(str, ifyes)
    if sbl.hasnumericsuffix(str) then
      context(ifyes)
    end
  end

  function sbl.doifhasnumericsuffixelse(str, ifyes, ifno)
    if sbl.hasnumericsuffix(str) then
      context(ifyes)
    else
      context(ifno)
    end
  end

  function sbl.hasvolumepartprefix(str)
    if string.match(str, "^%d+[%.:/]") then
      return(true)
    end
    return(false)
  end

  function sbl.doifhasvolumepartprefix(str, ifyes)
    if sbl.hasvolumepartprefix(str) then
      context(ifyes)
    end
  end

  function sbl.doifhasvolumepartprefixelse(str, ifyes, ifno)
    if sbl.hasvolumepartprefix(str) then
      context(ifyes)
    else
      context(ifno)
    end
  end

  function sbl.startswithpunct(str)
    if string.match(str, "^[%.%?,;:!]") then
      return(true)
    end
    return(false)
  end

  function sbl.doifstartswithpunct(str, ifyes)
    if sbl.startswithpunct(str) then
      context(ifyes)
    end
  end

  function sbl.doifstartswithpunctelse(str, ifyes, ifno)
    if sbl.startswithpunct(str) then
      context(ifyes)
    else
      context(ifno)
    end
  end

  function sbl.endswithpunct(str)
    if string.match(str, "[%.%?,;:!]$") then
      return(true)
    end
    return(false)
  end

  function sbl.doifendswithpunct(str, ifyes)
    if sbl.endswithpunct(str) then
      context(ifyes)
    end
  end

  function sbl.doifendswithpunctelse(str, ifyes, ifno)
    if sbl.endswithpunct(str) then
      context(ifyes)
    else
      context(ifno)
    end
  end

  function sbl.ispagerange(str)
    -- a page citation may consist of several page ranges separated by commas (and whitespace)
    if string.count(str, ",%s*") > 0 then
      -- if so, then split it along these separators and recursively test all of them
      --local commasplitter = string.wordsplitter(",") -- when Hans adds it
      local components = sbl.regexsplit(str, ",%s*")
      for i=1,#components do
        if not sbl.ispagerange(components[i]) then
          return false
        end
      end
      return true
    end
    -- a colon may separate volume (and part) numbers from the page range proper
    if string.count(str, ":") > 0 then
      -- if so, then split it and recursively test the substring after the colon
      local left = string.split(str, ":")[1]
      local right = string.split(str, ":")[2]
      if sbl.ispagerange(right) then
        return true
      end
      return(false)
    end
    -- otherwise, just make sure that the input matches the pattern for a page range
    if string.match(str, "^%d+%-%-%d+$") then
      return(true)
    end
    return(false)
  end

  function sbl.doifpagerange(str, ifyes)
    if sbl.ispagerange(str) then
      context(ifyes)
    end
  end

  function sbl.doifpagerangeelse(str, ifyes, ifno)
    if sbl.ispagerange(str) then
      context(ifyes)
    else
      context(ifno)
    end
  end

  function sbl.ordinal(num)
    -- if the input is not a number, then print is as-is;
    -- otherwise, strip it of any leading zeroes (which may have been included for sorting purposes)
    if not tonumber(num) then
      context(num)
      return
    else
      num = tostring(tonumber(num))
    end
    if string.sub(num, -2, -1) == "11" or string.sub(num, -2, -1) == "12" or string.sub(num, -2, -1) == "13" then
      context("%sth", num)
      return
    end
    if string.sub(num, -1, -1) == "1" then
      context("%sst", num)
      return
    end
    if string.sub(num, -1, -1) == "2" then
      context("%snd", num)
      return
    end
    if string.sub(num, -1, -1) == "3" then
      context("%srd", num)
      return
    else
      context("%sth", num)
      return
    end
  end

  function sbl.abbreviatepagerange(pages)
    -- if this is not a page range, then print it as-is
    if string.count(pages, "%-%-") == 0 then
      context(pages)
      return
    end
    -- if the page range is prefixed with volume and part numbers, followed by a colon 
    -- then recursively process the actual page range 
    -- and add the prefix back when we're done
    if string.count(pages, ":") > 0 then
      local volume_prefix = string.split(pages, ":")[1]
      local pages_in_volume = string.split(pages, ":")[2]
      context("%s:", volume_prefix)
      sbl.abbreviatepagerange(pages_in_volume)
      return
    end
    -- if this is a disjoint set of page ranges separated by commas (and possibly whitespace),
    -- then recursively convert each one, separating them by a comma and a single space
    local page_ranges = sbl.regexsplit(pages, ",%s*")
    if #page_ranges > 1 then
      for i=1,#page_ranges do
        sbl.abbreviatepagerange(page_ranges[i])
        if i < #page_ranges then
          context(", ")
        end
      end
      return
    end
    -- if this is a single page range, then truncate according to Chicago/SBL's horrendous rules
    -- (§4.2.3)
    local start_page = string.split(pages, "--")[1]
    local end_page = string.split(pages, "--")[2]
    -- if either page number is not an Arabic numeral (e.g., Roman numerals),
    -- then print the range as-is
    if not tonumber(start_page) or not tonumber(end_page) then
      context(pages)
      return
    end
    -- otherwise, if the second page number is smaller than the first page number, then print the range as-is 
    -- (this shouldn't happen unless users are already applying this rule)
    if tonumber(end_page) < tonumber(start_page) then
      context(pages)
      return
    end
    -- otherwise, if the second page number is equal to the first page number, then the "range" is just a single page;
    -- print just the first page number
    if tonumber(end_page) == tonumber(start_page) then
      context(start_page)
      return
    end
    -- otherwise, if the second page number has more digits than the first page number, then print the range as-is
    if string.len(end_page) > string.len(start_page) then
      context(pages)
      return
    end
    -- otherwise, if both numbers are fewer than three digits, then print the range as-is
    if string.len(start_page) < 3 then
      context(pages)
      return
    end
    -- otherwise, if the first page number ends in 00, then print the range as-is
    if string.sub(start_page, -2, -1) == "00" then
      context(pages)
      return
    end
    -- otherwise, if both page numbers end in 01-09, then only use the last digit of the end page in the range
    if tonumber(string.sub(start_page, -2, -1)) < 10 and tonumber(string.sub(end_page, -2, -1)) < 10 then
      context("%s--%s", start_page, string.sub(end_page, -1, -1))
      return
    end
    -- otherwise, find the first digit at which the two numbers differ 
    -- and only use the suffix starting from that position of the end page in the range
    -- unless it is the last position, in which case use the last two digits
    local index = 1
    while string.sub(start_page, 1, index) == string.sub(end_page, 1, index) do
      index = index + 1
    end
    if index == string.len(start_page) then
      index = index - 1
    end
    context("%s--%s", start_page, string.sub(end_page, index, -1))
    return
  end
	
  function sbl.convertdate(date)
    -- if the date is a string without date formatting (e.g., "forthcoming", or a single year), then return it as-is
    if string.count(date, "%-") == 0 then
      context(date)
      return
    end
    -- if the date is a range of years, then return it as-is
    if string.count(date, "%-%-") > 0 then
      context(date)
      return
    end
    local components = string.split(date, "-")
    if #components == 1 then
      context.date({y = components[1]}, {"year"})
      return
    end
    if #components == 2 then
      context.date({y = components[1], m = components[2]}, {"month,year"})
      return
    end
    if #components == 3 then
      context.date({y = components[1], m = components[2], d = components[3]}, {"d,month,year"})
      return
    else
      context(date)
      return
    end
  end

  function sbl.serializelocationpublisher(location, publisher)
    -- split all fields into arrays of components separated by the word "and"
    --local andsplitter = string.wordsplitter("and") -- when Hans adds it
    --local locations = wordsplitter(location)
    --local publishers = wordsplitter(publisher)
    local locations = sbl.regexsplit(location, "%s+and%s+")
    local publishers = sbl.regexsplit(publisher, "%s+and%s+")
    -- if the locations array is shorter than the publishers array (because we may be citing multiple publishers in the same city), 
    -- then pad it with its last value (if it has one) until it is the same length
    while #locations < #publishers do
      if locations[#locations] and locations[#locations] ~= "" then
        table.insert(locations, locations[#locations])
      else
        break
      end
    end
    for i=1,#publishers do
      context("%s: %s", locations[i], publishers[i])
      if i < #publishers then
        context("; ")
      end
    end
  end

  function sbl.serializevolumenumberdatepage(volume, number, date, page)
    -- split all fields into arrays of components separated by the word "and"
    --local andsplitter = string.wordsplitter("and") -- when Hans adds it
    --local volumes = andsplitter(volume)
    --local numbers = andsplitter(number)
    --local dates = andsplitter(date)
    --local pages = andsplitter(page)
    local volumes = {}
    if string.count(volume, "%s+and%s+") > 0 then
      volumes = sbl.regexsplit(volume, "%s+and%s+")
    else
      if volume and volume ~= "" then
        table.insert(volumes, volume)
      end
    end
    local numbers = {}
    if string.count(number, "%s+and%s+") > 0 then
      numbers = sbl.regexsplit(number, "%s+and%s+")
    else
      if number and number ~= "" then
        table.insert(numbers, number)
      end
    end
    local dates = {}
    if string.count(date, "%s+and%s+") > 0 then
      dates = sbl.regexsplit(date, "%s+and%s+")
    else
      if date and date ~= "" then
        table.insert(dates, date)
      end
    end
    local pages = {}
    if string.count(page, "%s+and%s+") > 0 then
      pages = sbl.regexsplit(page, "%s+and%s+")
    else
      if page and page ~= "" then
        table.insert(pages, page)
      end
    end
    -- pad all arrays until they are the length of the longest array
    local max_len = math.max(#volumes, #numbers, #dates, #pages)
    while #volumes < max_len do
      if volumes[#volumes] and volumes[#volumes] ~= "" then
        table.insert(volumes, volumes[#volumes])
      else
        table.insert(volumes, "")
      end
    end
    while #numbers < max_len do
      if numbers[#numbers] and numbers[#numbers] ~= "" then
        table.insert(numbers, numbers[#numbers])
      else
        table.insert(numbers, "")
      end
    end
    while #dates < max_len do
      if dates[#dates] and dates[#dates] ~= "" then
        table.insert(dates, dates[#dates])
      else
        table.insert(dates, "")
      end
    end
    while #pages < max_len do
      if pages[#pages] and pages[#pages] ~= "" then
        table.insert(pages, pages[#pages])
      else
        table.insert(pages, "")
      end
    end
    -- now print all fields together
    for i=1,max_len do
      if volumes[i] ~= "" then
        context(" ") -- add a space to follow the journal name
        context("%s", volumes[i])
        if numbers[i] ~= "" then
          context(".%s", numbers[i])
        end
      end
      -- we replace surrounding parentheses and colons with commas if it is a full date
      if string.find(dates[i], "%d%d%d%d%-%d%d%-%d%d") then
        context(", ")
        sbl.convertdate(dates[i])
        context(",")
      else
        context(" (")
        sbl.convertdate(dates[i])
        context("):")
      end
      if pages[i] ~= "" then
        context(" ")
        sbl.abbreviatepagerange(pages[i])
      end
      if i < max_len then
        context(";")
      end
    end
  end
\stopluacode
\def\btx_sbl_doifrange#1#2{\ctxlua{publications.btx.sbl.doifrange([==[#1]==],[==[#2]==])}}
\def\btx_sbl_doifrangeelse#1#2#3{\ctxlua{publications.btx.sbl.doifrangeelse([==[#1]==],[==[#2]==],[==[#3]==])}}
\def\btx_sbl_doifprefix#1#2#3{\ctxlua{publications.btx.sbl.doifprefix([==[#1]==],[==[#2]==],[==[#3]==])}}
\def\btx_sbl_doifprefixelse#1#2#3#4{\ctxlua{publications.btx.sbl.doifprefixelse([==[#1]==],[==[#2]==],[==[#3]==],[==[#4]==])}}
\def\btx_sbl_doifhasnumericprefix#1#2{\ctxlua{publications.btx.sbl.doifhasnumericprefix([==[#1]==],[==[#2]==])}}
\def\btx_sbl_doifhasnumericprefixelse#1#2#3{\ctxlua{publications.btx.sbl.doifhasnumericprefixelse([==[#1]==],[==[#2]==],[==[#3]==])}}
\def\btx_sbl_doifhasnumericsuffix#1#2{\ctxlua{publications.btx.sbl.doifhasnumericsuffix([==[#1]==],[==[#2]==])}}
\def\btx_sbl_doifhasnumericsuffixelse#1#2#3{\ctxlua{publications.btx.sbl.doifhasnumericsuffixelse([==[#1]==],[==[#2]==],[==[#3]==])}}
\def\btx_sbl_doifhasvolumepartprefix#1#2{\ctxlua{publications.btx.sbl.doifhasvolumepartprefix([==[#1]==],[==[#2]==])}}
\def\btx_sbl_doifhasvolumepartprefixelse#1#2#3{\ctxlua{publications.btx.sbl.doifhasvolumepartprefixelse([==[#1]==],[==[#2]==],[==[#3]==])}}
\def\btx_sbl_doifstartswithpunct#1#2{\ctxlua{publications.btx.sbl.doifstartswithpunct([==[#1]==],[==[#2]==])}}
\def\btx_sbl_doifstartswithpunctelse#1#2#3{\ctxlua{publications.btx.sbl.doifstartswithpunctelse([==[#1]==],[==[#2]==],[==[#3]==])}}
\def\btx_sbl_doifendswithpunct#1#2{\ctxlua{publications.btx.sbl.doifendswithpunct([==[#1]==],[==[#2]==])}}
\def\btx_sbl_doifendswithpunctelse#1#2#3{\ctxlua{publications.btx.sbl.doifendswithpunctelse([==[#1]==],[==[#2]==],[==[#3]==])}}
\def\btx_sbl_doifpagerange#1#2{\ctxlua{publications.btx.sbl.doifpagerange([==[#1]==],[==[#2]==])}}
\def\btx_sbl_doifpagerangeelse#1#2#3{\ctxlua{publications.btx.sbl.doifpagerangeelse([==[#1]==],[==[#2]==],[==[#3]==])}}
\def\btx_sbl_ordinal#1{\ctxlua{publications.btx.sbl.ordinal([==[#1]==])}}
\def\btx_sbl_abbreviatepagerange#1{\ctxlua{publications.btx.sbl.abbreviatepagerange([==[#1]==])}}
\def\btx_sbl_convertdate#1{\ctxlua{publications.btx.sbl.convertdate([==[#1]==])}}
\def\btx_sbl_serializelocationpublisher#1#2{\ctxlua{publications.btx.sbl.serializelocationpublisher([==[#1]==],[==[#2]==])}}
\def\btx_sbl_serializevolumenumberdatepage#1#2#3#4{\ctxlua{publications.btx.sbl.serializevolumenumberdatepage([==[#1]==],[==[#2]==],[==[#3]==],[==[#4]==])}}

\starttexdefinition btx:sbl:doifsamefield #1#2#3#4
  % If two input entry tags (#1 and #2) have the same field (#3),
  % then execute input #4
  \doif {\clf_btxdirect{\currentbtxdataset}{#1}{#3}} {\clf_btxdirect{\currentbtxdataset}{#2}{#3}} {
    {#4}
  }
\stoptexdefinition

\starttexdefinition btx:sbl:doifnotsamefield #1#2#3#4
  % If two input entry tags (#1 and #2) do not have the same field (#3),
  % then execute input #4
  \doifnot {\clf_btxdirect{\currentbtxdataset}{#1}{#3}} {\clf_btxdirect{\currentbtxdataset}{#2}{#3}} {
    {#4}
  }
\stoptexdefinition

\starttexdefinition btx:sbl:doifsamefieldelse #1#2#3#4#5
  % If two input entry tags (#1 and #2) have the same field (#3),
  % then execute input #4; otherwise, execute input #5
  \doifelse {\clf_btxdirect{\currentbtxdataset}{#1}{#3}} {\clf_btxdirect{\currentbtxdataset}{#2}{#3}} {
    {#4}
  } {
    {#5}
  }
\stoptexdefinition

\starttexdefinition btx:sbl:doifsameauthorelse #1#2#3#4
  % If two input entry tags (#1 and #2) have the same author (and contributing/assisting author) fields
  % (not including editors in the place of authors),
  % then execute input #3; otherwise, execute input #4
  \texdefinition{btx:sbl:doifsamefieldelse} {#1}{#2}{author} {
    % Are the assisting authors identical?
    \texdefinition{btx:sbl:doifsamefieldelse} {#1}{#2}{withauthor} {
      {#3}
    } {
      {#4}
    }
  } {
    {#4}
  }
\stoptexdefinition

\starttexdefinition btx:sbl:doifsameeditorelse #1#2#3#4
  % If two input entry tags (#1 and #2) have the same editor (and contributing/assisting editor) fields, 
  % then execute input #3; otherwise, execute input #4
  \texdefinition{btx:sbl:doifsamefieldelse} {#1}{#2}{editor} {
    % Are the assisting editors identical?
    \texdefinition{btx:sbl:doifsamefieldelse} {#1}{#2}{witheditor} {
      {#3}
    } {
      {#4}
    }
  } {
    {#4}
  }
\stoptexdefinition

% Define some helper functions for subcitations
\starttexdefinition btx:sbl:doifsamefoundnameauthorelse #1#2#3#4
  % If two input entry tags (#1 and #2) have the same found-name author (and contributing/assisting author) fields
  % (i.e., author, editor, or in some cases, organization),
  % then execute input #3; otherwise, execute input #4
  \doifelse {\clf_btxfoundname{\currentbtxdataset}{#1}{author}} {\clf_btxfoundname{\currentbtxdataset}{#2}{author}} {
    \doifelse {\clf_btxfoundname{\currentbtxdataset}{#1}{author}} {editor} {
      % Are the editors identical?
      \texdefinition{btx:sbl:doifsameeditorelse} {#1}{#2} {
        {#3}
      } {
        {#4}
      }
    } {
      % Are the authors identical?
      \texdefinition{btx:sbl:doifsameauthorelse} {#1}{#2} {
        {#3}
      } {
        {#4}
      }
    }
  } {
    {#4}
  }
\stoptexdefinition

\starttexdefinition btx:sbl:doifsametitleelse #1#2#3#4
  % If two input entry tags (#1 and #2) have the same title and subtitle,
  % then execute input #3; otherwise, execute input #4
  \texdefinition{btx:sbl:doifsamefieldelse}{#1}{#2}{title} {
    \texdefinition{btx:sbl:doifsamefieldelse}{#1}{#2}{subtitle} {
      {#3}
    } {
      {#4}
    }
  } {
    {#4}
  }
\stoptexdefinition

\starttexdefinition btx:sbl:doifownfield #1#2
  % If the current entry has a field (#1) that is not inherited from a cross-referenced entry,
  % then execute input #2
  \btxdoif{#1} {
    \btxdoifelse{crossref} {
      \begingroup
      \def\crossreftag{\btxflush{crossref}}
      \texdefinition{btx:sbl:doifnotsamefield}{\currentbtxtag}{\crossreftag}{#1} {
        #2
      }
      \endgroup
    } {
      #2
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:doifownfieldelse #1#2#3
  % If the current entry has a field (#1) that is not inherited from a cross-referenced entry,
  % then execute input #2; otherwise, execute input #3
  \btxdoifelse{#1} {
    \btxdoifelse{crossref} {
      \begingroup
      \def\crossreftag{\btxflush{crossref}}
      \texdefinition{btx:sbl:doifsamefieldelse}{\currentbtxtag}{\crossreftag}{#1} {
        #3
      } {
        #2
      }
      \endgroup
    } {
      #2
    }
  } {
    #3
  }
\stoptexdefinition

\starttexdefinition btx:sbl:doifshorthand #1
  % If the current entry or any of its cross-referenced entries has a shorthand,
  % then execute input #1
  \btxdoifelse{shorthand} {
    #1
  } {
    \btxdoif{crossref} {
      \begingroup
      \def\crossreftag{\btxflush{crossref}}
      \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{shorthand} {
        #1
      } {
        \clf_btxdoif{\currentbtxdataset}{\crossreftag}{crossref} {
          \def\collectiontag{\clf_btxdirect{\currentbtxdataset}{\crossreftag}{crossref}}
          \clf_btxdoif{\currentbtxdataset}{\collectiontag}{shorthand} {
            #1
          }
        }
      }
      \endgroup
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:doifshorthandelse #1#2
  % If the current entry or any of its cross-referenced entries has a shorthand,
  % then execute input #1; otherwise, execute input #2
  \btxdoifelse{shorthand} {
    #1
  } {
    \btxdoifelse{crossref} {
      \begingroup
      \def\crossreftag{\btxflush{crossref}}
      \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{shorthand} {
        #1
      } {
        \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{crossref} {
          \def\collectiontag{\clf_btxdirect{\currentbtxdataset}{\crossreftag}{crossref}}
          \clf_btxdoifelse{\currentbtxdataset}{\collectiontag}{shorthand} {
            #1
          } {
            #2
          }
        } {
          #2
        }
      }
      \endgroup
    } {
      #2
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:doifibidelse #1#2#3
  % If the useibid option is set and the entry with the given tag (#1) matches the last one cited,
  % then execute input #2; otherwise, execute input #3
  % TODO: Replace this with a proper ibid-tracking helper when one is ready
  \doifelse {\btxparameter{useibid}} {\v!yes} {
    \doifelse {#1} {\getvariable{btx:sbl}{previousinlinetag}} {
      #2
    } {
      #3
    }
  } {
    #3
  }
\stoptexdefinition

% Define a helper for previous author handling
% TODO: Remove this if we end up implementing a general-purpose macro for it in publ-ini.lua and publ-ini.mkiv
\setxvariables[btx:sbl][previousinlinetag=\empty]% the tag of last entry cited inline

% Define handlers for same-author entries in the list
\startsetups sbl:list:sameauthor:rule
  \blackrule
    [\c!width=6em,
    \c!height=0.75ex,
    \c!depth=\dimexpr\linewidth-0.75ex\relax] % to lift it off the baseline (we're not underlining anything!)
\stopsetups

\startsetups sbl:list:sameauthor:empty
  \kern\dimexpr\listparameter\c!margin-\interwordspace\relax% just indent by the margin, minus a space for the next word
\stopsetups

\startsetups sbl:list:sameauthor:ditto
  \Word{\btxlabeltext{sbl:idem}} % capitalize for list entries
\stopsetups

\startsetups sbl:list:sameauthor:none
  \btxflush{author}
\stopsetups

% Define macro for typesetting CSL locators in text (or lefttext or righttext)
% TODO: This would ideally be implemented in its own TeX module with default settings,
% and this implementation would override it with SBL-specific settings
\starttexdefinition loc [#1]
	\doifassignmentelse{#1} {
		% TODO: all parameters should be prefixed with \c! for multilingual support; 
		% their equivalents in other languages should be assigned according to the mappings at https://github.com/citation-style-language/locales
		\getparameters[btxsblloc][#1]
    % Was a volume number specified?
    \doifdefined{btxsbllocvol} {
      % Then typeset the number without a CSL abbreviation, followed by a comma
      \btxsbllocvol
      \btxcomma
      % If a page number is also specified, then replace the comma with a colon without surrounding space
      \doifdefined{btxsbllocp} {
        \removeunwantedspaces
        \removepunctuation
        \btxcolon
        \removeunwantedspaces
      }
      % If a part is also specified, then replace the comma with a period without surrounding space
      \doifdefined{btxsbllocpt} {
        \removeunwantedspaces
        \removepunctuation
        \btxperiod
        \removeunwantedspaces
      }
      % If a number is also specified, then replace the comma with a period without surrounding space
      \doifdefined{btxsbllocno} {
        \removeunwantedspaces
        \removepunctuation
        \btxperiod
        \removeunwantedspaces
      }
    }
    % Was an issue number specified?
    \doifdefined{btxsbllocno} {
      % Was a volume number also specified?
      \doifdefinedelse{btxsbllocvol} {
        % If so, then typeset the number without a CSL abbreviation, followed by a comma
        \btxsbllocno
        \btxcomma
        % If a page number is also specified, then replace the comma with a colon without surrounding space
        \doifdefined{btxsbllocp} {
          \removeunwantedspaces
          \removepunctuation
          \btxcolon
          \removeunwantedspaces
        }
        % If a part is also specified, then replace the comma with a period without surrounding space
        \doifdefined{btxsbllocpt} {
          \removeunwantedspaces
          \removepunctuation
          \btxperiod
          \removeunwantedspaces
        }
      } {
        % Otherwise, typeset the number with its CSL abbreviation, followed by a comma
        \btx_sbl_doifrangeelse{\btxsbllocno} {
          \btxlabeltext{sbl:loc:issues}
        } {
          \btxlabeltext{sbl:loc:issue}
        }
        \btxsbllocno
        \btxcomma
      }
    }
    % Was a part number specified?
    \doifdefined{btxsbllocpt} {
      % Was a volume number also specified?
      \doifdefinedelse{btxsbllocvol} {
        % If so, typeset the number without a CSL abbreviation, followed by a comma
        \btxsbllocpt
        \btxcomma
        % If a page number is also specified, then replace the comma with a colon without surrounding space
        \doifdefined{btxsbllocp} {
          \removeunwantedspaces
          \removepunctuation
          \btxcolon
          \removeunwantedspaces
        }
      } {
        % Otherwise, typeset the number with its CSL abbreviation, followed by a comma
        \btx_sbl_doifrangeelse{\btxsbllocpt} {
          \btxlabeltext{sbl:loc:parts}
        } {
          \btxlabeltext{sbl:loc:part}
        }
        \btxsbllocpt
        \btxcomma
      }
    }
    % Was a page number specified?
    \doifdefined{btxsbllocp} {
      % Typeset the number without a CSL abbreviation, followed by a comma
      \btx_sbl_abbreviatepagerange{\btxsbllocp} % abbreviate the page range according to SBL/Chicago rules
      \btxcomma
      % If a note number is also specified, then replace the comma with a space
      \doifdefined{btxsbllocn} {
        \removeunwantedspaces
        \removepunctuation
        \btxspace
      }
    }
    % Was a footnote number specified?
    \doifdefined{btxsbllocn} {
      % Then typeset the number with its CSL abbreviation, followed by a comma
      \btx_sbl_doifrangeelse{\btxsbllocn} {
        \btxlabeltext{sbl:loc:notes}
      } {
        \btxlabeltext{sbl:loc:note}
      }
      \btxspace
      \btxsbllocn
      \btxcomma
    }
    % Was a figure number specified?
    \doifdefined{btxsbllocfig} {
      % Then typeset the number with its CSL abbreviation, followed by a comma
      \btx_sbl_doifrangeelse{\btxsbllocfig} {
        \btxlabeltext{sbl:loc:figures}
      } {
        \btxlabeltext{sbl:loc:figure}
      }
      \btxspace
      \btxsbllocfig
      \btxcomma
    }
    % Was an opus number specified?
    \doifdefined{btxsbllocop} {
      % Then typeset the number with its CSL abbreviation, followed by a comma
      \btx_sbl_doifrangeelse{\btxsbllocop} {
        \btxlabeltext{sbl:loc:opera}
      } {
        \btxlabeltext{sbl:loc:opus}
      }
      \btxspace
      \btxsbllocop
      \btxcomma
    }
    % Was a book number specified?
    \doifdefined{btxsbllocbk} {
      % Then typeset the number with its CSL abbreviation, followed by a comma
      \btx_sbl_doifrangeelse{\btxsbllocbk} {
        \btxlabeltext{sbl:loc:books}
      } {
        \btxlabeltext{sbl:loc:book}
      }
      \btxspace
      \btxsbllocbk
      \btxcomma
    }
    % Was an episode number specified?
    \doifdefined{btxsbllocep} {
      % Then typeset the number with its CSL abbreviation, followed by a comma
      \btx_sbl_doifrangeelse{\btxsbllocep} {
        \btxlabeltext{sbl:loc:episodes}
      } {
        \btxlabeltext{sbl:loc:episode}
      }
      \btxspace
      \btxsbllocep
      \btxcomma
    }
    % Was a chapter number specified?
    \doifdefined{btxsbllocchap} {
      % Then typeset the number with its CSL abbreviation, followed by a comma
      \btx_sbl_doifrangeelse{\btxsbllocchap} {
        \btxlabeltext{sbl:loc:chapters}
      } {
        \btxlabeltext{sbl:loc:chapter}
      }
      \btxspace
      \btxsbllocchap
      \btxcomma
    }
    % Was a verse number specified?
    \doifdefined{btxsbllocv} {
      % Then typeset the chapter number with its CSL abbreviation, followed by a comma
      \btx_sbl_doifrangeelse{\btxsbllocv} {
        \btxlabeltext{sbl:loc:verses}
      } {
        \btxlabeltext{sbl:loc:verse}
      }
      \btxspace
      \btxsbllocv
      \btxcomma
    }
    % Was a folio number specified?
    \doifdefined{btxsbllocfol} {
      % Then typeset the number with its CSL abbreviation, followed by a comma
      \btx_sbl_doifrangeelse{\btxsbllocfol} {
        \btxlabeltext{sbl:loc:folios}
      } {
        \btxlabeltext{sbl:loc:folio}
      }
      \btxspace
      \btxsbllocfol
      \btxcomma
    }
    % Was a fragment number specified?
    \doifdefined{btxsbllocfrag} {
      % Then typeset the number with its CSL abbreviation, followed by a comma
      \btx_sbl_doifrangeelse{\btxsbllocfrag} {
        \btxlabeltext{sbl:loc:fragments}
      } {
        \btxlabeltext{sbl:loc:fragment}
      }
      \btxspace
      \btxsbllocfrag
      \btxcomma
    }
    % Was a plate number specified?
    \doifdefined{btxsbllocpl} {
      % Then typeset the number with its CSL abbreviation, followed by a comma
      \btx_sbl_doifrangeelse{\btxsbllocpl} {
        \btxlabeltext{sbl:loc:plates}
      } {
        \btxlabeltext{sbl:loc:plate}
      }
      \btxspace
      \btxsbllocpl
      \btxcomma
    }
    % Was a column number specified?
    \doifdefined{btxsblloccol} {
      % Then typeset the number with its CSL abbreviation, followed by a comma
      \btx_sbl_doifrangeelse{\btxsblloccol} {
        \btxlabeltext{sbl:loc:columns}
      } {
        \btxlabeltext{sbl:loc:column}
      }
      \btxspace
      \btxsblloccol
      \btxcomma
    }
    % Was a line number specified?
    \doifdefined{btxsbllocl} {
      % Then typeset the number with its CSL abbreviation, followed by a comma
      \btx_sbl_doifrangeelse{\btxsbllocl} {
        \btxlabeltext{sbl:loc:lines}
      } {
        \btxlabeltext{sbl:loc:line}
      }
      \btxspace
      \btxsbllocl
      \btxcomma
    }
		% Was a sub verbo entry specified?
    \doifdefined{btxsbllocsv} {
      % Then typeset the number with its CSL abbreviation, followed by a comma
      \btx_sbl_doifrangeelse{\btxsbllocsv} {
        \btxlabeltext{sbl:loc:subverbi}
      } {
        \btxlabeltext{sbl:loc:subverbo}
      }
      \btxspace
      \btxsbllocsv
      \btxcomma
    }
    % Was a section number specified?
    \doifdefined{btxsbllocsec} {
      % If any of the preceding keys was specified, then replace any preceding punctuation with a space
      % and typeset the number with its CSL abbreviation, followed by a comma
      \ifdefined\btxsbllocvol
        \removeunwantedspaces\removepunctuation\btxspace
      \orelse\ifdefined\btxsbllocno
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsbllocpt
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsbllocp
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsbllocn
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsbllocfig
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsbllocop
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsbllocbk
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsbllocep
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsbllocchap
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsbllocv
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsbllocfol
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsbllocfrag
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsbllocpl
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsblloccol
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsbllocl
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsbllocsv
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \fi
      \btx_sbl_doifrangeelse{\btxsbllocsec} {
        \btxlabeltext{sbl:loc:sections}
      } {
        \btxlabeltext{sbl:loc:section}
      }
      \btxspace
      \btxsbllocsec
      \btxcomma
    }
    % Was a paragraph number specified?
    \doifdefined{btxsbllocpara} {
      % If any of the preceding keys was specified, then replace any preceding punctuation with a space
      % and typeset the number with its CSL abbreviation, followed by a comma
      \ifdefined\btxsbllocvol
        \removeunwantedspaces\removepunctuation\btxspace
      \orelse\ifdefined\btxsbllocno
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsbllocpt
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsbllocp
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsbllocn
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsbllocfig
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsbllocop
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsbllocbk
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsbllocep
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsbllocchap
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsbllocv
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsbllocfol
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsbllocfrag
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsbllocpl
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsblloccol
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsbllocl
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsbllocsv
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \orelse\ifdefined\btxsbllocsec
        \removeunwantedspaces\removepunctuation\btxspace
      \fi
      \fi
      \btx_sbl_doifrangeelse{\btxsbllocpara} {
        \btxlabeltext{sbl:loc:paragraphs}
      } {
        \btxlabeltext{sbl:loc:paragraph}
      }
      \btxspace
      \btxsbllocpara
      \btxcomma
    }
	} {
		% If the input is just a value and not an assignment list,
		% then print it with minimal reformatting.
		% TODO: Category-dependent default pagination settings would be enforced here.
    #1
    \btxcomma
	}
  \removeunwantedspaces
  \removepunctuation
\stoptexdefinition

% Define variables indicating which material precedes the loctext (or altloctext) in a citation;
% these will be used for contextual formatting in the loctextloc macro
\def\btxsblshorthandbeforeloctext{no}
\def\btxsblvolumebeforeloctext{no}

% Define macro for typesetting CSL locators in the loctext field,
% with additional rules for removing or changing preceding punctuation.
% TODO: This would ideally be implemented in its own TeX module with default settings,
% and this implementation would override it with SBL-specific settings
\starttexdefinition loctextloc [#1]
	\doifassignmentelse{#1} {
		% TODO: all parameters should be prefixed with \c! for multilingual support; 
		% their equivalents in other languages should be assigned according to the mappings at https://github.com/citation-style-language/locales
		\getparameters[btxsblloc][#1]
    % Was a volume number specified?
    \doifdefined{btxsbllocvol} {
      % If the loctext is preceded by a shorthand, then remove the comma after the shorthand
      \doif{\btxsblshorthandbeforeloctext}{yes} {
        \removeunwantedspaces
        \removepunctuation
        \btxspace
      }
      % Then typeset the number without a CSL abbreviation, followed by a comma
      \btxsbllocvol
      \btxcomma
      % If a page number is also specified, then replace the comma with a colon without surrounding space
      \doifdefined{btxsbllocp} {
        \removeunwantedspaces
        \removepunctuation
        \btxcolon
        \removeunwantedspaces
      }
      % If a part is also specified, then replace the comma with a period without surrounding space
      \doifdefined{btxsbllocpt} {
        \removeunwantedspaces
        \removepunctuation
        \btxperiod
        \removeunwantedspaces
      }
      % If a number is also specified, then replace the comma with a period without surrounding space
      \doifdefined{btxsbllocno} {
        \removeunwantedspaces
        \removepunctuation
        \btxperiod
        \removeunwantedspaces
      }
    }
    % Was an issue number specified?
    \doifdefined{btxsbllocno} {
      % If the loctext is preceded by a shorthand, then remove the comma after the shorthand
      \doif{\btxsblshorthandbeforeloctext}{yes} {
        \removeunwantedspaces
        \removepunctuation
        \btxspace
      }
      % Was a volume number also specified?
      \doifdefinedelse{btxsbllocvol} {
        % If so, then typeset the number without a CSL abbreviation, followed by a comma
        \btxsbllocno
        \btxcomma
        % If a page number is also specified, then replace the comma with a colon without surrounding space
        \doifdefined{btxsbllocp} {
          \removeunwantedspaces
          \removepunctuation
          \btxcolon
          \removeunwantedspaces
        }
        % If a part is also specified, then replace the comma with a period without surrounding space
        \doifdefined{btxsbllocpt} {
          \removeunwantedspaces
          \removepunctuation
          \btxperiod
          \removeunwantedspaces
        }
      } {
        % Otherwise, typeset the number with its CSL abbreviation, followed by a comma
        \btx_sbl_doifrangeelse{\btxsbllocno} {
          \btxlabeltext{sbl:loc:issues}
        } {
          \btxlabeltext{sbl:loc:issue}
        }
        \btxsbllocno
        \btxcomma
      }
    }
    % Was a part number specified?
    \doifdefined{btxsbllocpt} {
      % If the loctext is preceded by a shorthand, then remove the comma after the shorthand
      \doif{\btxsblshorthandbeforeloctext}{yes} {
        \removeunwantedspaces
        \removepunctuation
        \btxspace
      }
      % Was a volume number also specified?
      \doifdefinedelse{btxsbllocvol} {
        % If so, typeset the number without a CSL abbreviation, followed by a comma
        \btxsbllocpt
        \btxcomma
        % If a page number is also specified, then replace the comma with a colon without surrounding space
        \doifdefined{btxsbllocp} {
          \removeunwantedspaces
          \removepunctuation
          \btxcolon
          \removeunwantedspaces
        }
      } {
        % Otherwise, typeset the number with its CSL abbreviation, followed by a comma
        \btx_sbl_doifrangeelse{\btxsbllocpt} {
          \btxlabeltext{sbl:loc:parts}
        } {
          \btxlabeltext{sbl:loc:part}
        }
        \btxsbllocpt
        \btxcomma
      }
    }
    % Was a page number specified?
    \doifdefined{btxsbllocp} {
      % If the loctext is preceded by a volume/part division, then replace the comma after it with a colon without surrounding spaces
      \doif{\btxsblvolumebeforeloctext}{yes} {
        \removeunwantedspaces
        \removepunctuation
        \btxcolon
        \removeunwantedspaces
      }
      % Typeset the number without a CSL abbreviation, followed by a comma
      \btx_sbl_abbreviatepagerange{\btxsbllocp} % abbreviate the page range according to SBL/Chicago rules
      \btxcomma
      % If a note number is also specified, then replace the comma with a space
      \doifdefined{btxsbllocn} {
        \removeunwantedspaces
        \removepunctuation
        \btxspace
      }
    }
    % Was a footnote number specified?
    \doifdefined{btxsbllocn} {
      % Then typeset the number with its CSL abbreviation, followed by a comma
      \btx_sbl_doifrangeelse{\btxsbllocn} {
        \btxlabeltext{sbl:loc:notes}
      } {
        \btxlabeltext{sbl:loc:note}
      }
      \btxspace
      \btxsbllocn
      \btxcomma
    }
    % Was a figure number specified?
    \doifdefined{btxsbllocfig} {
      % Then typeset the number with its CSL abbreviation, followed by a comma
      \btx_sbl_doifrangeelse{\btxsbllocfig} {
        \btxlabeltext{sbl:loc:figures}
      } {
        \btxlabeltext{sbl:loc:figure}
      }
      \btxspace
      \btxsbllocfig
      \btxcomma
    }
    % Was an opus number specified?
    \doifdefined{btxsbllocop} {
      % Then typeset the number with its CSL abbreviation, followed by a comma
      \btx_sbl_doifrangeelse{\btxsbllocop} {
        \btxlabeltext{sbl:loc:opera}
      } {
        \btxlabeltext{sbl:loc:opus}
      }
      \btxspace
      \btxsbllocop
      \btxcomma
    }
    % Was a book number specified?
    \doifdefined{btxsbllocbk} {
      % Then typeset the number with its CSL abbreviation, followed by a comma
      \btx_sbl_doifrangeelse{\btxsbllocbk} {
        \btxlabeltext{sbl:loc:books}
      } {
        \btxlabeltext{sbl:loc:book}
      }
      \btxspace
      \btxsbllocbk
      \btxcomma
    }
    % Was an episode number specified?
    \doifdefined{btxsbllocep} {
      % Then typeset the number with its CSL abbreviation, followed by a comma
      \btx_sbl_doifrangeelse{\btxsbllocep} {
        \btxlabeltext{sbl:loc:episodes}
      } {
        \btxlabeltext{sbl:loc:episode}
      }
      \btxspace
      \btxsbllocep
      \btxcomma
    }
    % Was a chapter number specified?
    \doifdefined{btxsbllocchap} {
      % Then typeset the number with its CSL abbreviation, followed by a comma
      \btx_sbl_doifrangeelse{\btxsbllocchap} {
        \btxlabeltext{sbl:loc:chapters}
      } {
        \btxlabeltext{sbl:loc:chapter}
      }
      \btxspace
      \btxsbllocchap
      \btxcomma
    }
    % Was a verse number specified?
    \doifdefined{btxsbllocv} {
      % Then typeset the chapter number with its CSL abbreviation, followed by a comma
      \btx_sbl_doifrangeelse{\btxsbllocv} {
        \btxlabeltext{sbl:loc:verses}
      } {
        \btxlabeltext{sbl:loc:verse}
      }
      \btxspace
      \btxsbllocv
      \btxcomma
    }
    % Was a folio number specified?
    \doifdefined{btxsbllocfol} {
      % Then typeset the number with its CSL abbreviation, followed by a comma
      \btx_sbl_doifrangeelse{\btxsbllocfol} {
        \btxlabeltext{sbl:loc:folios}
      } {
        \btxlabeltext{sbl:loc:folio}
      }
      \btxspace
      \btxsbllocfol
      \btxcomma
    }
    % Was a fragment number specified?
    \doifdefined{btxsbllocfrag} {
      % Then typeset the number with its CSL abbreviation, followed by a comma
      \btx_sbl_doifrangeelse{\btxsbllocfrag} {
        \btxlabeltext{sbl:loc:fragments}
      } {
        \btxlabeltext{sbl:loc:fragment}
      }
      \btxspace
      \btxsbllocfrag
      \btxcomma
    }
    % Was a plate number specified?
    \doifdefined{btxsbllocpl} {
      % Then typeset the number with its CSL abbreviation, followed by a comma
      \btx_sbl_doifrangeelse{\btxsbllocpl} {
        \btxlabeltext{sbl:loc:plates}
      } {
        \btxlabeltext{sbl:loc:plate}
      }
      \btxspace
      \btxsbllocpl
      \btxcomma
    }
    % Was a column number specified?
    \doifdefined{btxsblloccol} {
      % Then typeset the number with its CSL abbreviation, followed by a comma
      \btx_sbl_doifrangeelse{\btxsblloccol} {
        \btxlabeltext{sbl:loc:columns}
      } {
        \btxlabeltext{sbl:loc:column}
      }
      \btxspace
      \btxsblloccol
      \btxcomma
    }
    % Was a line number specified?
    \doifdefined{btxsbllocl} {
      % Then typeset the number with its CSL abbreviation, followed by a comma
      \btx_sbl_doifrangeelse{\btxsbllocl} {
        \btxlabeltext{sbl:loc:lines}
      } {
        \btxlabeltext{sbl:loc:line}
      }
      \btxspace
      \btxsbllocl
      \btxcomma
    }
		% Was a sub verbo entry specified?
    \doifdefined{btxsbllocsv} {
      % Then typeset the number with its CSL abbreviation, followed by a comma
      \btx_sbl_doifrangeelse{\btxsbllocsv} {
        \btxlabeltext{sbl:loc:subverbi}
      } {
        \btxlabeltext{sbl:loc:subverbo}
      }
      \btxspace
      \btxsbllocsv
      \btxcomma
    }
    % Was a section number specified?
    \doifdefined{btxsbllocsec} {
      % Remove any preceding comma
      \removeunwantedspaces
      \removepunctuation
      \btxspace
      \btx_sbl_doifrangeelse{\btxsbllocsec} {
        \btxlabeltext{sbl:loc:sections}
      } {
        \btxlabeltext{sbl:loc:section}
      }
      \btxspace
      \btxsbllocsec
      \btxcomma
    }
    % Was a paragraph number specified?
    \doifdefined{btxsbllocpara} {
      % Remove any preceding comma
      \removeunwantedspaces
      \removepunctuation
      \btxspace
      \btx_sbl_doifrangeelse{\btxsbllocpara} {
        \btxlabeltext{sbl:loc:paragraphs}
      } {
        \btxlabeltext{sbl:loc:paragraph}
      }
      \btxspace
      \btxsbllocpara
      \btxcomma
    }
	} {
		% If the input is just a value and not an assignment list,
		% then print it with minimal reformatting.
		% TODO: Category-dependent default pagination settings would be enforced here.

    % If the loctext is preceded by a shorthand
    % and the input starts with a volume/part division, 
    % then remove the comma after the shorthand
    \doif{\btxsblshorthandbeforeloctext}{yes} {
      \btx_sbl_doifhasvolumepartprefix{#1} {
        \removeunwantedspaces
        \removepunctuation
        \btxspace
      }
    }
    % If the loctext is preceded by a volume/part division
    % and the input starts with a numeric prefix, 
    % then replace the comma after it with a colon without surrounding spaces
    \doif{\btxsblvolumebeforeloctext}{yes} {
      \btx_sbl_doifhasnumericprefix{#1} {
        \removeunwantedspaces
        \removepunctuation
        \btxcolon
        \removeunwantedspaces
      }
    }
    % If the loctext starts with a section or paragraph mark,
    % then replace any preceding punctuation with a space
    \btx_sbl_doifprefix{§}{#1} {
      \removeunwantedspaces
      \removepunctuation
      \btxspace
    }
    \btx_sbl_doifprefix{¶}{#1} {
      \removeunwantedspaces
      \removepunctuation
      \btxspace
    }
    #1
    \btxcomma
	}
  \removeunwantedspaces
  \removepunctuation
\stoptexdefinition

% Now define context-dependent helper functions
\starttexdefinition btx:sbl:list:author
  \btxdoif {author} {
    % If this entry's author is the same as that of the previous entry, then use sameauthor settings:
    \btxdoifsameaspreviouselse {author} {
      \fastsetup{sbl:list:sameauthor:\btxparameter{sameauthor}}
    } {
      \btxflush{author}
    }
    % If this is an instance of an editor, then there is no author; 
    % indicate that this is an editor
    \doifelse {\btxfoundname{author}} {editor} {
      \btxcomma
      \btxsingularorplural {author} {
        \btxlabeltext{sbl:editor}
      } {
        \btxlabeltext{sbl:editors}
      }
      % Is there an assisting editor?
      \btxdoif {witheditor} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {witheditortype} {
          \btxflush{witheditortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{witheditor}
      }
    } {
      % If this is an author, is there an assisting author?
      \btxdoif {withauthor} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {withauthortype} {
          \btxflush{withauthortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{withauthor}
      }
    }
    % If the name ends with a period (as is the case for an initial or "et al."), 
    % then remove the preceding period
    \removeunwantedspaces
    \removepunctuation
    \btxperiod
    % If this author is the same as the previous one in the list,
    % the sameauthor option is "empty",
    % and there is no withauthor or witheditor field,
    % then remove the punctuation entirely
    \btxdoifsameaspreviouselse {author} {
      \doif{\btxparameter{sameauthor}} {empty} {
        \btxdoifnot{withauthor} {
          \btxdoifnot{witheditor} {
            \removeunwantedspaces
            \removepunctuation
          }
        }
      }
    } {}
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:author-after-title
  \btxdoif {author} {
    % If this is an instance of an editor, then there is no author; 
    % indicate that this is an editor
    \doifelse {\btxfoundname{author}} {editor} {
      \btxlabeltext{sbl:Edited} % singular or plural doesn't matter here, as "ed." comes first
      \btxspace
      \btxlabeltext{sbl:by}
      \btxspace
      \currentbtxciteauthorbyfield
      % Is there an assisting editor?
      \btxdoif {witheditor} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {witheditortype} {
          \btxflush{witheditortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{witheditor}
      }
    } {
      % If this is a proper author, then replace the preceding period with a comma,
      % and precede the author's name with "by"
      \removeunwantedspaces
      \removepunctuation
      \btxcomma
      \btxlabeltext{sbl:by}
      \btxspace
      \currentbtxciteauthorbyfield
      % If this is an author, is there an assisting author?
      \btxdoif {withauthor} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {withauthortype} {
          \btxflush{withauthortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{withauthor}
      }
    }
    % If the name ends with a period (as is the case for "et al."), 
    % then remove the preceding period
    \removeunwantedspaces
    \removepunctuation
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinelong:author
  \btxdoif {author} {
    % If the useidem option is set and this author matches the previously cited author, then just print "idem";
    % otherwise, print the author/editor/org name first in normal order
    \doifelse{\btxparameter{useidem}} {\v!yes} {
      \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\getvariable{btx:sbl}{previousinlinetag}} {
        \btxlabeltext{sbl:idem}
      } {
        \currentbtxciteauthorbyfield
      }
    } {
      \currentbtxciteauthorbyfield
    }
    % If this is an instance of an editor, then there is no author; 
    % indicate that this is an editor
    \doifelse {\btxfoundname{author}} {editor} {
      \btxcomma
      \btxsingularorplural {editor} {
        \btxlabeltext{sbl:editor}
      } {
        \btxlabeltext{sbl:editors}
      }
      % Is there an assisting editor?
      \btxdoif {witheditor} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {witheditortype} {
          \btxflush{witheditortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{witheditor}
      }
    } {
      % If this is an author or organization, is there an assisting author?
      \btxdoif {withauthor} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {withauthortype} {
          \btxflush{withauthortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{withauthor}
      }
    }
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinelong:author-after-title
  \btxdoif {author} {
    % If this is an instance of an editor, then there is no author; 
    % indicate that this is an editor
    \doifelse {\btxfoundname{author}} {editor} {
      \btxlabeltext{sbl:editor} % singular or plural doesn't matter here, as "ed." comes first
      \btxspace
      \currentbtxciteauthorbyfield
      % Is there an assisting editor?
      \btxdoif {witheditor} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {witheditortype} {
          \btxflush{witheditortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{witheditor}
      }
    } {
      \btxlabeltext{sbl:by}
      \btxspace
      \currentbtxciteauthorbyfield
      % If this is an author, is there an assisting author?
      \btxdoif {withauthor} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {withauthortype} {
          \btxflush{withauthortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{withauthor}
      }
    }
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlineshort:author
  \btxdoif{author} {
    % If the useidem option is set and this author matches the previously cited author, then just print "idem";
    % otherwise, print the author/editor's last name
    \doifelse{\btxparameter{useidem}} {\v!yes} {
      \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\getvariable{btx:sbl}{previousinlinetag}} {
        \btxlabeltext{sbl:idem}
      } {
        \currentbtxciteauthorbyfield
      }
    } {
      \currentbtxciteauthorbyfield
    }
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:title
  \doifinset {\currentbtxcategory} {ancienttext} {
    \texdefinition{btx:sbl:list:ancienttexttitle}
  }
  \doifnotinset {\currentbtxcategory} {ancienttext} {
    \btxdoif {title} {
      \btxstartstyleandcolor[sbl:\s!list:title:\currentbtxcategory]
        \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
          \btxflush{title}% set the title according to the current category
        }
        \btxdoif {subtitle} {
          \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
            \btxcolon% add a colon between title and subtitle
            \btxflush{subtitle}% set the subtitle according to the current category
          }
        }
      \btxstopstyleandcolor
      \btxperiod
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinelong:title
  \doifinset {\currentbtxcategory} {ancienttext} {
    \texdefinition{btx:sbl:inlinelong:ancienttexttitle}
  }
  \doifinset {\currentbtxcategory} {classictext} {
    \texdefinition{btx:sbl:inlinelong:classictexttitle}
  }
  \doifnotinset {\currentbtxcategory} {ancienttext, classictext} {
    \btxdoif {title} {
      \btxstartstyleandcolor[sbl:\s!list:title:\currentbtxcategory]
        \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
          \btxflush{title}% set the title according to the current category
        }
        \btxdoif {subtitle} {
          \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
            \btxcolon% add a colon between title and subtitle
            \btxflush{subtitle}% set the subtitle according to the current category
          }
        }
      \btxstopstyleandcolor
      \btxcomma
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlineshort:title
  \doifinset {\currentbtxcategory} {ancienttext} {
    \texdefinition{btx:sbl:inlineshort:ancienttexttitle}
  }
  \doifnotinset {\currentbtxcategory} {ancienttext} {
    % Use the shorttitle if available;
    % otherwise, use its title (but not any subtitle)
    \texdefinition{btx:sbl:doifownfieldelse}{shorttitle} {
      \btxstartstyleandcolor[sbl:\s!list:title:\currentbtxcategory]
        \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
          \btxflush{shorttitle}% set the title according to the current category
        }
      \btxstopstyleandcolor
      \btxcomma
    } {
      \btxstartstyleandcolor[sbl:\s!list:title:\currentbtxcategory]
        \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
          \btxflush{title}% set the title according to the current category
        }
      \btxstopstyleandcolor
      \btxcomma
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:ancienttexttitle
  \btxdoif {title} {
    % For inscriptions, chronicles, and manuscripts, print the title unformatted
    \doifinset {\btxflush{entrysubtype}} {inscription, chronicle, manuscript} {
      \btxflush{title}
      \btxdoif{subtitle} {
        \btxcolon
        \btxflush{subtitle}
      }
      \btxperiod
    }
    % For all other cases (except for PGM, in which case we should print no title), just use the regular formatting
    \doifnotinset {\btxflush{entrysubtype}} {PGM, inscription, chronicle, manuscript} {
      \btxstartstyleandcolor[sbl:\s!list:title:\currentbtxcategory]
        \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
          \btxflush{title}% set the title according to the current category
        }
        \btxdoif {subtitle} {
          \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
            \btxcolon% add a colon between title and subtitle
            \btxflush{subtitle}% set the subtitle according to the current category
          }
        }
      \btxstopstyleandcolor
      \btxperiod
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinelong:ancienttexttitle
  \btxdoif {title} {
    \begingroup
    % For PGM, typeset the shorthand PGM with book formatting
    \doifinset {\btxflush{entrysubtype}} {PGM} {
      \def\btxsblshorthandbeforeloctext{yes}
      \btxstartstyleandcolor[sbl:\s!list:title:book]
        \btxusecommand[sbl:\s!list:title:book]{
          {PGM}%
        }
      \btxstopstyleandcolor
      \btxcomma
    }
    % For inscriptions, chronicles, and manuscripts, print the title unformatted
    \doifinset {\btxflush{entrysubtype}} {inscription, chronicle, manuscript} {
      \btxflush{title}
      \btxdoif{subtitle} {
        \btxcolon
        \btxflush{subtitle}
      }
      \btxcomma
    }
    % For all other cases, just use the regular formatting
    \doifnotinset {\btxflush{entrysubtype}} {PGM, inscription, chronicle, manuscript} {
      \btxstartstyleandcolor[sbl:\s!list:title:\currentbtxcategory]
        \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
          \btxflush{title}% set the title according to the current category
        }
        \btxdoif {subtitle} {
          \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
            \btxcolon% add a colon between title and subtitle
            \btxflush{subtitle}% set the subtitle according to the current category
          }
        }
      \btxstopstyleandcolor
      \btxcomma
    }
    \texdefinition{btx:sbl:inlinelong:altloctext}
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlineshort:ancienttexttitle
  \btxdoif {title} {
    \begingroup
    % For PGM, typeset the shorthand PGM with book formatting
    \doifinset {\btxflush{entrysubtype}} {PGM} {
      \def\btxsblshorthandbeforeloctext{yes}
      \btxstartstyleandcolor[sbl:\s!list:title:book]
        \btxusecommand[sbl:\s!list:title:book]{
          {PGM}%
        }
      \btxstopstyleandcolor
      \btxcomma
    }
    % For inscriptions, chronicles, and manuscripts, print the title unformatted
    \doifinset {\btxflush{entrysubtype}} {inscription, chronicle, manuscript} {
      \texdefinition{btx:sbl:doifownfieldelse} {shorttitle} {
        \btxflush{shorttitle}
      } {
        \btxflush{title}
      }
      \btxcomma
    }
    % For all other cases, just use the regular formatting
    \doifnotinset {\btxflush{entrysubtype}} {PGM, inscription, chronicle, manuscript} {
      \btxstartstyleandcolor[sbl:\s!list:title:\currentbtxcategory]
        \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
          \texdefinition{btx:sbl:doifownfieldelse} {shorttitle} {%
            \btxflush{shorttitle}%
          }{%
            \btxflush{title}%
          }%
        }
      \btxstopstyleandcolor
      \btxcomma
    }
    \texdefinition{btx:sbl:inlineshort:altloctext}
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:classictexttitle
  \texdefinition{btx:sbl:list:title}
\stoptexdefinition

\starttexdefinition btx:sbl:inlinelong:classictexttitle
  \texdefinition{btx:sbl:inlineshort:title} % prefer the short title of classic texts, even in long citations
  \texdefinition{btx:sbl:inlinelong:altloctext}
\stoptexdefinition

\starttexdefinition btx:sbl:inlineshort:classictexttitle
  \texdefinition{btx:sbl:inlinelong:classictexttitle}
\stoptexdefinition

\starttexdefinition btx:sbl:inlineshort:shorthand
  \doifinset {\currentbtxcategory} {ancienttext} {
    \texdefinition{btx:sbl:inlineshort:ancienttextshorthand}
  }
  \doifnotinset {\currentbtxcategory} {ancienttext} {
    \texdefinition{btx:sbl:doifownfield} {shorthand} {
      % If the shorthand field matches the shorttitle field, then use title formatting;
      % otherwise, use no formatting
      \doifelse{\btxflush{shorthand}}{\btxflush{shorttitle}} {
        \btxstartstyleandcolor[sbl:\s!list:title:\currentbtxcategory]
          \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
            \btxflush{shorthand}% set the shorthand according to the current category
          }
        \btxstopstyleandcolor
      } {
        \btxflush{shorthand}
      }
      \btxcomma
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlineshort:ancienttextshorthand
  \texdefinition{btx:sbl:doifownfield} {shorthand} {
    \begingroup
    \def\btxsblshorthandbeforeloctext{yes}
    % If the shorthand field matches the shorttitle field, then use title formatting;
    % otherwise, use no formatting
    \doifelse{\btxflush{shorthand}}{\btxflush{shorttitle}} {
      % If this entry is an inscription, a chronicle, or a manuscript, then do not apply formatting to its shorthand
      \doifinsetelse{\btxflush{entrysubtype}}{inscription, chronicle, manuscript} {
        \btxflush{shorthand}
      } {
        \btxstartstyleandcolor[sbl:\s!list:title:\currentbtxcategory]
          \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
            \btxflush{shorthand}% set the shorthand according to the current category
          }
        \btxstopstyleandcolor
      }
    } {
      \btxflush{shorthand}
    }
    \btxcomma
    \texdefinition{btx:sbl:inlineshort:altloctext}
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:editor
  \btxdoif {editor} {
    % If editor(s) not already listed in the author position, then list here
    \doifnot {\btxfoundname{author}} {editor} {
      % Preface with "Edited by" unless a specific editortype is specified
      \btxdoifelse {editortype} {
        \btxusecommand[sbl:\s!list:type]{
          \btxflush{editortype}% make sure it's capitalized
        }
      } {
        \btxlabeltext{sbl:Edited}
        \btxspace
        \btxlabeltext{sbl:by}
      }
      \btxspace
      \btxflush{editor}
      % Is there an assisting editor?
      \btxdoif {witheditor} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {witheditortype} {
          \btxflush{witheditortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{witheditor}
      }
      % If the name ends with a period (as is the case for "et al."), 
      % then remove the preceding period
      \removeunwantedspaces
      \removepunctuation
      \btxperiod
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinelong:editor
  \btxdoif {editor} {
    % If editor(s) not already listed in the author position, then list here
    \doifnot {\btxfoundname{author}} {editor} {
      % Preface with the "editor" abbreviation unless a specific editortype is specified
      \btxdoifelse {editortype} {
        \btxflush{editortype}
      } {
        \btxlabeltext{sbl:editor} % singular or plural doesn't matter here, as "ed." comes first
      }
      \btxspace
      \btxflush{editor}
      % Is there an assisting editor?
      \btxdoif {witheditor} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {witheditortype} {
          \btxflush{witheditortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{witheditor}
      }
      \btxcomma
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:translator
  \btxdoif {translator} {
    \btxlabeltext{sbl:Translated}
    \btxspace
    % If there is a note on the work in the original language (e.g., "from the 3rd German ed."),
    % then print it here
    \btxdoif {origlanguage} {
      \btxflush{origlanguage}
      \btxspace
    }
    \btxlabeltext{sbl:by}
    \btxspace
    \btxflush{translator}
    % Is there an assisting translator?
    \btxdoif {withtranslator} {
      \btxcomma
      % Use the provided text to introduce them, if one is specified
      \btxdoifelse {withtranslatortype} {
        \btxflush{withtranslatortype}
      } {
        \btxlabeltext{sbl:with}
      }
      \btxspace
      \btxflush{withtranslator}
    }
    % If the name ends with a period (as is the case for "et al."), 
    % then remove the preceding period
    \removeunwantedspaces
    \removepunctuation
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinelong:translator
  \btxdoif {translator} {
    \btxlabeltext{sbl:translator}
    \btxspace
    \btxflush{translator}
    % Is there an assisting translator?
    \btxdoif {withtranslator} {
      \btxcomma
      % Use the provided text to introduce them, if one is specified
      \btxdoifelse {withtranslatortype} {
        \btxflush{withtranslatortype}
      } {
        \btxlabeltext{sbl:with}
      }
      \btxspace
      \btxflush{withtranslator}
    }
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:editortranslator
  % Is there an editor?
  \btxdoifelse {editor} {
    % If so, is there also a translator?
    \btxdoifelse {translator} {
      % If so, is the editor the same as the author?
      \doifelse {\btxfoundname{author}} {editor} {
        % If so, then just handle the translator
        \texdefinition{btx:sbl:list:translator}
      } {
        % If not, are the editor and translator (and their corresponding "with" fields) the same?
        \doifelse {\btxdirect{editor}\btxdirect{witheditor}} {\btxdirect{translator}\btxdirect{withtranslator}} {
          % If so, then typeset them together
          \btxlabeltext{sbl:Translated}
          \btxspace
          \btxlabeltext{and}
          \btxspace
          \btxlabeltext{sbl:edited}
          \btxspace
          % If there is a note on the work in the original language (e.g., "from the 3rd German ed."),
          % then print it here
          \btxdoif {origlanguage} {
            \btxflush{origlanguage}
            \btxspace
          }
          \btxlabeltext{sbl:by}
          \btxspace
          \btxflush{editor}
          % Is there an assisting editor/translator?
          \btxdoif {witheditor} {
            \btxcomma
            % Use the provided text(s) to introduce them, if specified
            \btxdoifelse {witheditortype} {
              \btxflush{witheditortype}
              \btxdoif {withtranslatortype} {
                \btxspace
                \btxlabeltext{and}
                \btxspace
                \btxflush{withtranslatortype}
              }
            } {
              \btxdoif {withtranslatortype} {
                \btxflush{withtranslatortype}
              }
            }
            \btxspace
            \btxflush{witheditor}
          }
          % If the name ends with a period (as is the case for "et al."), 
          % then remove the preceding period
          \removeunwantedspaces
          \removepunctuation
          \btxperiod
        } {
          % If not, then handle them separately
          \texdefinition{btx:sbl:list:editor}
          \texdefinition{btx:sbl:list:translator}
        }
      }
    } {
      % If there is no translator, is the editor the same as the author?
      \doifnot {\btxfoundname{author}} {editor} {
        % If not, then just handle the editor
        \texdefinition{btx:sbl:list:editor}
      }
    }
  } {
    % If not, then just handle the translator
    \texdefinition{btx:sbl:list:translator} 
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinelong:editortranslator
  % Is there an editor?
  \btxdoifelse {editor} {
    % If so, is there also a translator?
    \btxdoifelse {translator} {
      % If so, is the editor the same as the author?
      \doifelse {\btxfoundname{author}} {editor} {
        % If so, then just handle the translator
        \texdefinition{btx:sbl:inlinelong:translator}
      } {
        % If not, are the editor and translator (and their corresponding "with" fields) the same?
        \doifelse {\btxdirect{editor}\btxdirect{witheditor}} {\btxdirect{translator}\btxdirect{withtranslator}} {
          % If so, then typeset them together
          \btxlabeltext{sbl:translator}
          \btxspace
          \btxlabeltext{and}
          \btxspace
          \btxlabeltext{sbl:editor}
          \btxspace
          \btxflush{editor}
          % Is there an assisting editor/translator?
          \btxdoif {witheditor} {
            \btxcomma
            % Use the provided text(s) to introduce them, if specified
            \btxdoifelse {witheditortype} {
              \btxflush{witheditortype}
              \btxdoif {withtranslatortype} {
                \btxspace
                \btxlabeltext{and}
                \btxspace
                \btxflush{withtranslatortype}
              }
            } {
              \btxdoif {withtranslatortype} {
                \btxflush{withtranslatortype}
              }
            }
            \btxspace
            \btxflush{witheditor}
          }
          % If the name ends with a period (as is the case for "et al."), 
          % then remove the preceding period
          \removeunwantedspaces
          \removepunctuation
          \btxperiod
        } {
          % If not, then handle them separately
          \texdefinition{btx:sbl:inlinelong:editor}
          \texdefinition{btx:sbl:inlinelong:translator}
        }
      }
    } {
      % If there is no translator, is the editor the same as the author?
      \doifnot {\btxfoundname{author}} {editor} {
        % If not, then just handle the editor
        \texdefinition{btx:sbl:inlinelong:editor}
      }
    }
  } {
    % If not, then just handle the translator
    \texdefinition{btx:sbl:inlinelong:translator} 
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:inbookcrossref
  \btxdoif{crossref} {
    \begingroup
    \def\crossreftag{\btxflush{crossref}}
    % Print page numbers here, if there are any
    \btxdoifelse {pages} {
      \btxoneorrange {pages} {
        \btxlabeltext{sbl:Page}
      } {
        \btxlabeltext{sbl:Pages}
      }
      \btxspace
      % If this entry has a part number, then prefix the page range with it
      \btxdoif {part} {
        \btxflush{part}
        \btxcolon
        \removeunwantedspaces
      }
      \btxusecommand[sbl:\s!list:pages]{
        \btxflush{pages}%
      }
      \btxspace
      \btxlabeltext{sbl:in}
    } {
      \btxlabeltext{sbl:In}
    }
    \btxspace
    % Recursively cite the book or volume,
    % skipping the author in the cross-referenced source this entry has an author that matches it
    \texdefinition{btx:sbl:doifownfieldelse} {author} {
      \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\crossreftag}{
        \textcite[alternative=entry,useauthor=no,lefttext=,righttext=,loctext=,altloctext=][\crossreftag]
      } {
        \textcite[alternative=entry,titleauthor=yes,lefttext=,righttext=,loctext=,altloctext=][\crossreftag]
      }
    } {
      \textcite[alternative=entry,titleauthor=yes,lefttext=,righttext=,loctext=,altloctext=][\crossreftag]
    }
    \removeunwantedspaces
    \removepunctuation
    \btxperiod
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinelong:inbookcrossref
  \btxdoif{crossref} {
    \begingroup
    % Use a short citation if the book or set of books containing this entry has a shorthand;
    % otherwise, use a full subcitation preceded by "in"
    \def\crossreftag{\btxflush{crossref}}
    \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{crossref} {
      \def\collectiontag{\clf_btxdirect{\currentbtxdataset}{\crossreftag}{crossref}}
      \clf_btxdoifelse{\currentbtxdataset}{\collectiontag}{shorthand} {
        \textcite[alternative=inlineshort][\collectiontag]
        \btxspace
        \textcite[alternative=volume][\crossreftag]
        \btxdoif {part} {
          \btxperiod
          \removeunwantedspaces
          \btxflush{part}
        }
        \btxcolon
        \removeunwantedspaces
        \btxusecommand[sbl:\s!list:pages] {
          \btxflush{pages}%
        }
      } {
        \btxlabeltext{sbl:in}
        \btxspace
        % If the volume and collection have the same name, then prefix the page numbers with the volume number
        \texdefinition{btx:sbl:doifsametitleelse}{\crossreftag}{\collectiontag} {
          \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\crossreftag} {
            \textcite[alternative=inlinelong,useauthor=no,lefttext=,righttext=,loctext=,altloctext=,punct=][\crossreftag]
          } {
            \textcite[alternative=inlinelong,titleauthor=yes,lefttext=,righttext=,loctext=,altloctext=,punct=][\crossreftag]
          }
          \btxcomma
          \textcite[alternative=volume][\crossreftag]
          % If this entry has a part number, then include the part number in the page range prefix
          \btxdoif {part} {
            \btxperiod
            \removeunwantedspaces
            \btxflush{part}
          }
          \btxcolon
          \removeunwantedspaces
          \btxusecommand[sbl:\s!list:pages]{
            \btxflush{pages}%
          }
        } {
          \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\crossreftag} {
            \textcite[alternative=inlinelong,useauthor=no,lefttext=,righttext=,loctext=,altloctext=,punct=][\crossreftag]
          } {
            \textcite[alternative=inlinelong,titleauthor=yes,lefttext=,righttext=,loctext=,altloctext=,punct=][\crossreftag]
          }
          \btxcomma
          % If this entry has a part number, then prefix the page range with the part number
          \btxdoif {part} {
            \btxflush{part}
            \btxcolon
            \removeunwantedspaces
          }
          \btxusecommand[sbl:\s!list:pages]{
            \btxflush{pages}%
          }
        }
      }
    } {
      % Otherwise, print the shorthand of the book containing this entry, or, failing that, its entry
      \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{shorthand} {
        \textcite[alternative=inlineshort][\crossreftag]
        \btxcomma
        % If this entry has a part number, then remove the preceding comma and prefix the page range with the part number
        \btxdoif {part} {
          \removeunwantedspaces
          \removepunctuation
          \btxspace
          \btxflush{part}
          \btxcolon
          \removeunwantedspaces
        }
      } {
        \btxlabeltext{sbl:in}
        \btxspace
        \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\crossreftag} {
          \textcite[alternative=inlinelong,useauthor=no,lefttext=,righttext=,loctext=,altloctext=,punct=][\crossreftag]
        } {
          \textcite[alternative=inlinelong,titleauthor=yes,lefttext=,righttext=,loctext=,altloctext=,punct=][\crossreftag]
        }
        \btxcomma
        % If this entry has a part number, then prefix the page range with the part number
        \btxdoif {part} {
          \btxflush{part}
          \btxcolon
          \removeunwantedspaces
        }
      }
      \btxusecommand[sbl:\s!list:pages]{
        \btxflush{pages}%
      }
    }
    \btxcomma
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlineshort:inbookcrossref
  \btxdoif{crossref} {
    \begingroup
    % Does the book containing this entry belong to a multivolume set?
    \def\crossreftag{\btxflush{crossref}}
    \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{crossref} {
      % If so, does the multivolume set have a shorthand?
      \def\collectiontag{\clf_btxdirect{\currentbtxdataset}{\crossreftag}{crossref}}
      \clf_btxdoifelse{\currentbtxdataset}{\collectiontag}{shorthand} {
        % If so, then print the shorthand followed by the volume number (and any part numbers)
        \textcite[alternative=inlineshort][\collectiontag]
        \btxspace
        \textcite[alternative=volume][\crossreftag]
        \btxdoif {part} {
          \btxperiod
          \removeunwantedspaces
          \btxflush{part}
        }
        \btxcomma
      } {
        % If not, then print its title followed by the volume number (and any part numbers)
        \textcite[alternative=title][\collectiontag]
        \btxspace
        \textcite[alternative=volume][\crossreftag]
        \btxdoif {part} {
          \btxperiod
          \removeunwantedspaces
          \btxflush{part}
        }
        \btxcomma
      }
    } {
      % If not, does the book containing this entry have a shorthand?
      \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{shorthand} {
        % If so, then print the shorthand followed by any part numbers
        \textcite[alternative=inlineshort][\crossreftag]
        \btxcomma
        % If this entry has a part number, then remove the preceding comma and prefix the page range with the part number
        \btxdoif {part} {
          \removeunwantedspaces
          \removepunctuation
          \btxspace
          \btxflush{part}
          \btxcomma
        }
      } {
        % If not, then print its title followed by any part numbers
        \textcite[alternative=title][\crossreftag]
        \btxcomma
        % If this entry has a part number, then remove the preceding comma and prefix the page range with the part number
        \btxdoif {part} {
          \removeunwantedspaces
          \removepunctuation
          \btxspace
          \btxflush{part}
          \btxcomma
        }
      }
    }
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:reviewcrossref
  \btxdoif{crossref} {
    \begingroup
    \def\crossreftag{\btxflush{crossref}}
    % Precede the subcitation with "Review of"
    \btxlabeltext{sbl:Reviewof}
    \btxspace
    % Cite the title and author/editor of the the reviewed book
    \textcite[alternative=title][\crossreftag]
    \btxcomma
    \doifelse{\clf_btxfoundname{\currentbtxdataset}{\crossreftag}{author}}{editor} {
      \btxlabeltext{sbl:editor}
    } {
      \btxlabeltext{sbl:by}
    }
    \btxspace
    \clf_btxauthor
      {\currentbtxdataset}%
      {\crossreftag}%
      {author}%
      {%
          combiner    {normal}%
          kind        {cite}%
          etallimit   {sbl:\s!cite\c!etallimit}%
          etaldisplay {sbl:\s!cite\c!etaldisplay}%
          etaloption  {sbl:\s!cite\c!etaloption}%
          symbol      {sbl:\s!cite\c!stopper:initials}%
          connector   {sbl:\s!cite\c!connector:initials}%
      }%
    \btxperiod
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinelong:reviewcrossref
  \btxdoif{crossref} {
    \begingroup
    \def\crossreftag{\btxflush{crossref}}
    % Precede the subcitation with "review of"
    \btxlabeltext{sbl:reviewof}
    \btxspace
    % Cite the title and author/editor of the the reviewed book
    \textcite[alternative=title][\crossreftag]
    \btxcomma
    \doifelse{\clf_btxfoundname{\currentbtxdataset}{\crossreftag}{author}}{editor} {
      \btxlabeltext{sbl:editor}
    } {
      \btxlabeltext{sbl:by}
    }
    \btxspace
    \clf_btxauthor
      {\currentbtxdataset}%
      {\crossreftag}%
      {author}%
      {%
          combiner    {normal}%
          kind        {cite}%
          etallimit   {sbl:\s!cite\c!etallimit}%
          etaldisplay {sbl:\s!cite\c!etaldisplay}%
          etaloption  {sbl:\s!cite\c!etaloption}%
          symbol      {sbl:\s!cite\c!stopper:initials}%
          connector   {sbl:\s!cite\c!connector:initials}%
      }%
    \btxcomma
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlineshort:reviewcrossref
  \btxdoif{crossref} {
    \begingroup
    \def\crossreftag{\btxflush{crossref}}
    % Precede the subcitation with "review of"
    \btxlabeltext{sbl:reviewof}
    \btxspace
    % Cite the title and author/editor of the the reviewed book
    \textcite[alternative=title][\crossreftag]
    \btxspace
    \startparen
    \doifelse{\clf_btxfoundname{\currentbtxdataset}{\crossreftag}{author}}{editor} {
      \btxlabeltext{sbl:editor}
    } {
      \btxlabeltext{sbl:by}
    }
    \btxspace
    \clf_btxauthor
      {\currentbtxdataset}%
      {\crossreftag}%
      {author}%
      {%
          combiner    {name}%
          kind        {cite}%
          etallimit   {sbl:\s!cite\c!etallimit}%
          etaldisplay {sbl:\s!cite\c!etaldisplay}%
          etaloption  {sbl:\s!cite\c!etaloption}%
          symbol      {sbl:\s!cite\c!stopper:initials}%
          connector   {sbl:\s!cite\c!connector:initials}%
      }%
    \stopparen
    \btxcomma
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:suppbookcrossref
  \btxdoif{crossref} {
    \begingroup
    \def\crossreftag{\btxflush{crossref}}
    % Print the section of the book (this is a required field)
    % For list citations, make sure the type is capitalized
    \btxusecommand[sbl:\s!list:type] {
      \btxflush{type}%
    }
    \btxspace
    \btxlabeltext{sbl:to}
    \btxspace
    % Recursively cite the book/collection
    \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\crossreftag}{
      \textcite[alternative=entry,useauthor=no][\crossreftag]
      \removeunwantedspaces
      \removepunctuation
    } {
      \textcite[alternative=entry,titleauthor=yes][\crossreftag]
      \removeunwantedspaces
      \removepunctuation
    }
    \btxperiod
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinelong:suppbookcrossref
  \btxdoif{crossref} {
    \begingroup
    \def\crossreftag{\btxflush{crossref}}
    % Print the section of the book (this is a required field)
    % For inline citations, this can be printed without capitalization
    \btxflush{type}
    \btxspace
    \btxlabeltext{sbl:to}
    \btxspace
    % Recursively cite the book/collection
    \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\crossreftag}{
      \textcite[alternative=inlinelong,useauthor=no,lefttext=,righttext=,loctext=,altloctext=,punct=][\crossreftag]
    } {
      \textcite[alternative=inlinelong,titleauthor=yes,lefttext=,righttext=,loctext=,altloctext=,punct=][\crossreftag]
    }
    \btxcomma
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlineshort:suppbookcrossref
  % Just print the type (this is a required field)
  \btxflush{type}
  \btxcomma
\stoptexdefinition

\starttexdefinition btx:sbl:inlinelong:ancienttextcrossref
  \btxdoif{crossref} {
    % Is this entry of subtype "PGM"?
    \doifelse{\btxflush{entrysubtype}}{PGM}{
      % If so, then print the translator (if there is one) in parentheses,
      % but don't print anything else in parentheses (§6.4.3.3)
      \btxdoif {translator} {
        \removeunwantedspaces
        \removepunctuation
        \btxspace
        \startparen
        \btxflush{translator}
        \stopparen
        \btxcomma
      }
    } {
      % If not, then print the translator first, then print publication information in parentheses
      \btxdoif {translator} {
        \btxlabeltext{sbl:translator}
        \btxspace
        \btxflush{translator}
        \btxcomma
      }
      % If the book or set containing this text has a shorthand, then only cite its shorthand if there are page numbers;
      % otherwise, do a full inline citation, adding it to the list
      \begingroup
      \def\crossreftag{\btxflush{crossref}}
      \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{shorthand} {
        \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{crossref} {
          \def\collectiontag{\clf_btxdirect{\currentbtxdataset}{\crossreftag}{crossref}}
          \texdefinition{btx:sbl:doifsamefieldelse}{\crossreftag}{\collectiontag}{shorthand} {
            \doifnot{\btxflush{pages}\currentbtxloctext}{\empty} {
              \removeunwantedspaces
              \removepunctuation
              \btxspace
              \startparen
              \textcite[alternative=inlineshort][\collectiontag]
              \btxspace
              \textcite[alternative=volume][\crossreftag]
              \btxdoif {part} {
                \btxperiod
                \removeunwantedspaces
                \btxflush{part}
              }
              \btxcolon
              \removeunwantedspaces
              \btxdoif{pages} {
                \btxusecommand[sbl:\s!list:pages]{
                  \btxflush{pages}%
                }
                \btxcomma
              }
              % If a locator text was provided by the user, then print it next
              \texdefinition{btx:sbl:inlinelong:loctext}
              \removeunwantedspaces
              \removepunctuation
              \stopparen
              \btxcomma
            }
          } {
            \doifnot{\btxflush{pages}\currentbtxloctext}{\empty} {
              \removeunwantedspaces
              \removepunctuation
              \btxspace
              \startparen
              \textcite[alternative=inlineshort][\crossreftag]
              \btxcomma
              \btxdoif {part} {
                \removeunwantedspaces
                \removepunctuation
                \btxspace
                \btxflush{part}
                \btxcolon
                \removeunwantedspaces
              }
              \btxdoif{pages} {
                \btxusecommand[sbl:\s!list:pages]{
                  \btxflush{pages}%
                }
                \btxcomma
              }
              % If a locator text was provided by the user, then print it next
              \texdefinition{btx:sbl:inlinelong:loctext}
              \removeunwantedspaces
              \removepunctuation
              \stopparen
              \btxcomma
            }
          }
        } {
          \doifnot{\btxflush{pages}\currentbtxloctext}{\empty} {
            \removeunwantedspaces
            \removepunctuation
            \btxspace
            \startparen
            \textcite[alternative=inlineshort][\crossreftag]
            \btxcomma
            \btxdoif {part} {
              \removeunwantedspaces
              \removepunctuation
              \btxspace
              \btxflush{part}
              \btxcolon
              \removeunwantedspaces
            }
            \btxdoif{pages} {
              \btxusecommand[sbl:\s!list:pages]{
                \btxflush{pages}%
              }
              \btxcomma
            }
            % If a locator text was provided by the user, then print it next
            \texdefinition{btx:sbl:inlinelong:loctext}
            \removeunwantedspaces
            \removepunctuation
            \stopparen
            \btxcomma
          }
        }
      } {
        \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{crossref} {
          \def\collectiontag{\clf_btxdirect{\currentbtxdataset}{\crossreftag}{crossref}}
          \clf_btxdoifelse{\currentbtxdataset}{\collectiontag}{shorthand} {
            \doifnot{\btxflush{pages}\currentbtxloctext}{\empty} {
              \removeunwantedspaces
              \removepunctuation
              \btxspace
              \startparen
              \textcite[alternative=inlineshort][\collectiontag]
              \btxspace
              \textcite[alternative=volume][\crossreftag]
              \btxdoif {part} {
                \btxperiod
                \removeunwantedspaces
                \btxflush{part}
              }
              \btxcolon
              \removeunwantedspaces
              \btxdoif{pages} {
                \btxusecommand[sbl:\s!list:pages]{
                  \btxflush{pages}%
                }
                \btxcomma
              }
              % If a locator text was provided by the user, then print it next
              \texdefinition{btx:sbl:inlinelong:loctext}
              \removeunwantedspaces
              \removepunctuation
              \stopparen
              \btxcomma
            }
          } {
            \removeunwantedspaces
            \removepunctuation
            \btxspace
            \startparen
            %TODO: We should register the collection's entry to the list, but using \cite here doesn't print it
            \textcite[alternative=inlinelong,useauthor=yes,usepubl=yes,lefttext=,righttext=,loctext=,altloctext=,punct=][\crossreftag]
            \btxcomma
            \textcite[alternative=volume][\crossreftag]
            \btxdoif {part} {
              \btxperiod
              \removeunwantedspaces
              \btxflush{part}
            }
            \btxcolon
            \removeunwantedspaces
            \btxdoif{pages} {
              \btxusecommand[sbl:\s!list:pages]{
                \btxflush{pages}%
              }
              \btxcomma
            }
            % If a locator text was provided by the user, then print it next
            \texdefinition{btx:sbl:inlinelong:loctext}
            \removeunwantedspaces
            \removepunctuation
            \stopparen
            \btxcomma
          }
        } {
          \removeunwantedspaces
          \removepunctuation
          \btxspace
          \startparen
          \cite[alternative=inlinelong,useauthor=yes,usepubl=yes,lefttext=,righttext=,loctext=,altloctext=,punct=][\crossreftag]
          \btxcomma
          \btxdoif {part} {
            \btxflush{part}
            \btxcolon
            \removeunwantedspaces
          }
          \btxdoif{pages} {
            \btxusecommand[sbl:\s!list:pages]{
              \btxflush{pages}%
            }
            \btxcomma
          }
          % If a locator text was provided by the user, then print it next
          \texdefinition{btx:sbl:inlinelong:loctext}
          \removeunwantedspaces
          \removepunctuation
          \stopparen
          \btxcomma
        }
      }
      \endgroup
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlineshort:ancienttextcrossref
  \btxdoif{crossref} {
    % Is this entry of subtype "PGM"?
    \doifelse{\btxflush{entrysubtype}}{PGM}{
      % If so, then print the translator (if there is one) in parentheses,
      % followed by any cited page numbers (§6.4.3.3)
      \btxdoif {translator} {
        \removeunwantedspaces
        \removepunctuation
        \btxspace
        \startparen
        \btxflush{translator}
        \texdefinition{btx:sbl:inlineshort:loctext}
        \stopparen
        \btxcomma
      }
    } {
      % Otherwise, if there are any cited pages, remove the preceding comma and print source shorthand and cited pages in parentheses
      \doifnot {\currentbtxloctext} {\empty} {
        \removeunwantedspaces
        \removepunctuation
        \btxspace
        \startparen
        \begingroup
        \def\crossreftag{\btxflush{crossref}}
        \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{crossref} {
          % If the collection entry has a shorthand, then cite it;
          % otherwise, just cite its author/editor
          \def\btxsblvolumebeforeloctext{yes}
          \def\collectiontag{\clf_btxdirect{\currentbtxdataset}{\crossreftag}{crossref}}
          \clf_btxdoifelse{\currentbtxdataset}{\collectiontag}{shorthand} {
            \textcite[alternative=inlineshort][\collectiontag]
            \btxspace
          } {
            \clf_btxauthor
              {\currentbtxdataset}%
              {\crossreftag}%
              {author}%
              {%
                  combiner    {name}%
                  kind        {cite}%
                  etallimit   {sbl:\s!cite\c!etallimit}%
                  etaldisplay {sbl:\s!cite\c!etaldisplay}%
                  etaloption  {sbl:\s!cite\c!etaloption}%
                  symbol      {sbl:\s!cite\c!stopper:initials}%
                  connector   {sbl:\s!cite\c!connector:initials}%
              }%
            \btxcomma
          }
          \textcite[alternative=volume][\crossreftag]
          \btxdoif {part} {
            \btxperiod
            \removeunwantedspaces
            \btxflush{part}
          }
          \btxcomma
          \texdefinition{btx:sbl:inlineshort:loctext}
        } {
          % If the book containing this text is of type "seriesascollection", 
          % then remove the preceding comma and print the series and series entry numbers, 
          % followed by the part number of this entry (if it has one) and cited pages
          \doifelse {\clf_btxdirect{\currentbtxdataset}{\crossreftag}{type}} {seriesascollection} {
            \def\btxsblvolumebeforeloctext{yes}
            \textcite[alternative=inlineshort][\crossreftag]
            \btxcomma
            \btxdoif {part} {
              \removeunwantedspaces
              \removepunctuation
              \btxperiod
              \removeunwantedspaces
              \btxflush{part}
              \btxcomma
            }
          } {
            % Otherwise, cite the shorthand (or, failing that, the author/editor) of the book
            \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{shorthand} {
              \textcite[alternative=inlineshort][\crossreftag]
              \btxcomma
              \btxdoifelse {part} {
                \def\btxsblvolumebeforeloctext{yes}
                \removeunwantedspaces
                \removepunctuation
                \btxflush{part}
                \btxcomma
              } {
                \def\btxsblshorthandbeforeloctext{yes}
              }
            } {
              \clf_btxauthor
                {\currentbtxdataset}%
                {\crossreftag}%
                {author}%
                {%
                    combiner    {name}%
                    kind        {cite}%
                    etallimit   {sbl:\s!cite\c!etallimit}%
                    etaldisplay {sbl:\s!cite\c!etaldisplay}%
                    etaloption  {sbl:\s!cite\c!etaloption}%
                    symbol      {sbl:\s!cite\c!stopper:initials}%
                    connector   {sbl:\s!cite\c!connector:initials}%
                }%
              \btxcomma
              \btxdoif {part} {
                \def\btxsblvolumebeforeloctext{yes}
                \btxflush{part}
                \btxcomma
              }
            }
          }
          \texdefinition{btx:sbl:inlineshort:loctext}
        }
        \removeunwantedspaces
        \removepunctuation
        \endgroup
        \stopparen
        \btxcomma
      }
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinelong:classictextcrossref
  % If this entry is of type "seriesascollection", then cite the series (and number), followed by any cited page numbers
  \doifelse {\btxflush{type}} {seriesascollection} {
    % The book cross-reference will always be in parentheses/brackets:
    \removeunwantedspaces
    \removepunctuation
    \btxspace
    \startparen
    \texdefinition{btx:sbl:inlinelong:seriesxref}
    \doifnot {\currentbtxloctext} {\empty} {
      \removeunwantedspaces
      \removepunctuation
      \btxcolon
      \removeunwantedspaces
      \texdefinition{btx:sbl:inlinelong:loctext}
    }
    \removeunwantedspaces
    \removepunctuation
    \stopparen
    \btxcomma
  } {
    \btxdoif {crossref} {
      % The book cross-reference will always be in parentheses/brackets, and it must include a loctext or a translator
      % If there is a translator, then print their last name
      \texdefinition{btx:sbl:doifownfield} {translator} {
        \removeunwantedspaces
        \removepunctuation
        \btxspace
        \startparen
        \btxflushauthorname{translator}
        \begingroup
        \def\crossreftag{\btxflush{crossref}}
        % If the collection, volume, or book containing this text uses the shorthand of its series (e.g., LCL), then cite it here,
        % followed by any cited page numbers
        \doif{\clf_btxdirect{\currentbtxdataset}{\crossreftag}{type}} {useseriesshorthand} {
          \btxcomma
          \textcite[alternative=inlineshort][\crossreftag]
          \doifnot {\currentbtxloctext} {\empty} {
            \btxcomma
            \texdefinition{btx:sbl:inlinelong:loctext}
          }
        }
        \endgroup
        \stopparen
        \btxspace
      }
      \doifnot {\currentbtxloctext} {\empty} {
        \removeunwantedspaces
        \removepunctuation
        \btxdoifelse {translator} {
          \btxcomma
        } {
          \btxspace
          \startparen
        }
        \begingroup
        \def\crossreftag{\btxflush{crossref}}
        % If this entry is of type "seriesascollection", then cite the series (and number), followed by any cited page numbers
        \doifelse {\btxflush{type}} {seriesascollection} {
          \texdefinition{btx:sbl:inlinelong:seriesxref}
          \doifnot {\currentbtxloctext} {\empty} {
            \removeunwantedspaces
            \removepunctuation
            \btxcolon
            \removeunwantedspaces
            \texdefinition{btx:sbl:inlinelong:loctext}
          }
        } {
          % Otherwise, cite the shorthand (if there is one) of the book or collection containing this text, followed by any cited page numbers
          \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{crossref} {
            \def\collectiontag{\clf_btxdirect{\currentbtxdataset}{\crossreftag}{crossref}}
            \textcite[alternative=inlineshort][\collectiontag]
            \btxspace
            \textcite[alternative=volume][\crossreftag]
            \btxcolon
            \removeunwantedspaces
            \texdefinition{btx:sbl:inlinelong:loctext}
          } {
            % A classictext may cross-reference a multivolume set directly (rather than through a single volume in it), 
            % so a comma after the shorthand may or may not be needed
            \clf_btxdoif{\currentbtxdataset}{\crossreftag}{shorthand} {
              \textcite[alternative=inlineshort][\crossreftag]
              \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{volumes} {
                \btxspace
              } {
                \btxcomma
              }
            }
            \texdefinition{btx:sbl:inlinelong:loctext}
          }
        }
        \removeunwantedspaces
        \removepunctuation
        \endgroup
        \btxdoifnot {translator} {
          \stopparen
        }
        \btxcomma
      }
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlineshort:classictextcrossref
  \texdefinition{btx:sbl:inlinelong:classictextcrossref}
\stoptexdefinition

\starttexdefinition btx:sbl:list:bookcrossref
  \btxdoif{crossref} {
    \begingroup
    \def\crossreftag{\btxflush{crossref}}
    % If there is a volume number, then print it here
    \btxdoif {volume} {
      \btxoneorrange {volume} {
        % If the entry has a different title than the collection containing it, then we start a sentence with the volume (and part) here;
        % otherwise, it is in the middle of a sentence
        \texdefinition{btx:sbl:doifsametitleelse}{\currentbtxtag}{\crossreftag} {
          \btxlabeltext{sbl:volume}
        } {
          \btxlabeltext{sbl:Volume}
        }
      } {
        % If the entry has a different title than the collection containing it, then we start a sentence with the volume (and part) here;
        % otherwise, it is in the middle of a sentence
        \texdefinition{btx:sbl:doifsametitleelse}{\currentbtxtag}{\crossreftag} {
          \btxlabeltext{sbl:volumes}
        } {
          \btxlabeltext{sbl:Volumes}
        }
      }
      \btxspace
      % Is there a volume series number preceding the volume?
      \btxdoif {volumeseries} {
        \btxflush{volumeseries}
        {/}
      }
      \btxflush{volume}
      % Is there a part number subdividing the volume?
      \btxdoif {part} {
        \btxcomma
        \btxoneorrange {part} {
          \btxlabeltext{sbl:part}
        } {
          \btxlabeltext{sbl:parts}
        }
        \btxspace
        \btxflush{part}
      }
      \btxspace
      \btxlabeltext{sbl:of}
      \btxspace
    }
    % If this entry has the same title as the collection containing it, then cite the collection, and add it to the list;
    % otherwise, cite it, but do not add it to the list
    \texdefinition{btx:sbl:doifsametitleelse}{\currentbtxtag}{\crossreftag} {
      \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\crossreftag}{
        \textcite[alternative=entry,useauthor=no,usepubl=no][\crossreftag]
        \removeunwantedspaces
        \removepunctuation
      } {
        \textcite[alternative=entry,titleauthor=yes,usepubl=no][\crossreftag]
        \removeunwantedspaces
        \removepunctuation
      }
    } {
      \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\crossreftag}{
        \textcite[alternative=entry,useauthor=no,usepubl=no][\crossreftag]
        \removeunwantedspaces
        \removepunctuation
      } {
        \textcite[alternative=entry,titleauthor=yes,usepubl=no][\crossreftag]
        \removeunwantedspaces
        \removepunctuation
      }
    }
    \endgroup
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinelong:bookcrossref
  \btxdoif{crossref} {
    % If this entry has a title distinct from its collection's title, then we can print its volume (and part) here;
    % otherwise, we do nothing, as the collection will be cited instead of this entry, and the volume and part numbers will prefix page numbers later
    \begingroup
    \def\crossreftag{\btxflush{crossref}}
    \texdefinition{btx:sbl:doifsametitleelse}{\currentbtxtag}{\crossreftag} {
      % If they are the same, then just recursively cite the collection, adding it to the list
      \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\crossreftag} {
        %TODO: We should register the collection's entry to the list, but using \cite here doesn't print it
        \textcite[alternative=inlinelong,useauthor=no,usepubl=no,lefttext=,righttext=,loctext=,altloctext=,punct=][\crossreftag]
      } {
        %TODO: We should register the collection's entry to the list, but using \cite here doesn't print it
        \textcite[alternative=inlinelong,titleauthor=yes,usepubl=no,lefttext=,righttext=,loctext=,altloctext=,punct=][\crossreftag]
      }
    } {
      % Otherwise, print the volume and part, and cite the collection without adding it to the list
      \btxdoif {volume} {
        \btxoneorrange {volume} {
          \btxlabeltext{sbl:volume}
        } {
          \btxlabeltext{sbl:volumes}
        }
        \btxspace
        % Is there a volume series number preceding the volume?
        \btxdoif {volumeseries} {
          \btxflush{volumeseries}
          {/}
        }
        \btxflush{volume}
        % Is there a part number subdividing the volume?
        \btxdoif {part} {
          \btxcomma
          \btxoneorrange {part} {
            \btxlabeltext{sbl:part}
          } {
            \btxlabeltext{sbl:parts}
          }
          \btxspace
          \btxflush{volume}
        }
        \btxspace
        \btxlabeltext{sbl:of}
        \btxspace
      }
      % Recursively cite the collection, but do not add it to the list
      \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\crossreftag} {
        \textcite[alternative=inlinelong,useauthor=no,usepubl=no,lefttext=,righttext=,loctext=,altloctext=,punct=][\crossreftag]
      } {
        \textcite[alternative=inlinelong,titleauthor=yes,usepubl=no,lefttext=,righttext=,loctext=,altloctext=,punct=][\crossreftag]
      }
    }
    \btxcomma
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:volumes
  \btxdoif {volumes} {
    \btxflush{volumes}
    \btxspace
    \doifelse {\btxflush{volumes}} {1} {
      \btxlabeltext{sbl:volume}
    } {
      \btxlabeltext{sbl:volumes}
    }
    % If the volumes are subdivided into a specified number of parts or series,
    % then print the number of parts or series, as well
    \btxdoif {parts} {
      \btxspace
      \btxlabeltext{sbl:in}
      \btxspace
      \btxflush{parts}
    }
    % Don't duplicate the period from "vol." or "vols."
    \removeunwantedspaces
    \removepunctuation
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinelong:volumes
  \btxdoif {volumes} {
    \btxflush{volumes}
    \btxspace
    \doifelse {\btxflush{volumes}} {1} {
      \btxlabeltext{sbl:volume}
    } {
      \btxlabeltext{sbl:volumes}
    }
    % If the volumes are subdivided by a specified number of parts,
    % then print the number of parts, as well
    \btxdoif {parts} {
      \btxspace
      \btxlabeltext{sbl:in}
      \btxspace
      \btxflush{parts}
    }
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:edition
  \btxdoif{edition} {
    % Is the edition a string or a number?
    \doifnumberelse {\btxflush{edition}} {
      % If a number, then convert it to an ordinal
      \btxusecommand[sbl:\s!list:edition] {
        \btxflush{edition}%
      }
    } {
      % If a string, then capitalize its first word
      \Word{\btxflush{edition}}%
    }
    \btxspace
    \btxlabeltext{sbl:edition}
    % Don't duplicate the period from "ed."
    \removeunwantedspaces
    \removepunctuation
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinelong:edition
  \btxdoif{edition} {
    % Is the edition a string or a number?
    \doifnumberelse {\btxflush{edition}} {
      % If a number, then convert it to an ordinal
      \btxusecommand[sbl:\s!list:edition] {
        \btxflush{edition}%
      }
    } {
      % If a string, then print it as-is
      \btxflush{edition}
    }
    \btxspace
    \btxlabeltext{sbl:edition}
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:seriesxref
  \btxdoif {series} {
    % Is this a cross-reference to a separate entry for the series?
    \doifelse {\btxfoundname{series}} {seriesxref} {
      % If so, then recursively cite the series, but do not add it to the list
      \begingroup
      \def\seriesxreftag{\btxflush{series}}
      \textcite[alternative=inlineshort][\seriesxreftag]
      \endgroup
    } {
      % Otherwise, this field just contains the series name; print it with the appropriate formatting
      \btxstartstyleandcolor[sbl:\s!list:title:series]
        \btxusecommand[sbl:\s!list:title:series] {
          \btxflush{series}% set the series name according to its style
        }
      \btxstopstyleandcolor
    }
    % If the series itself has a series number (e.g., "WUNT 2", the second series of WUNT),
    % then print that number before the series entry number, with a forward slash in between
    \btxdoifelse {seriesseries} {
      \btxspace
      \btxflush{seriesseries}
      \btxdoif {number} {
        \removeunwantedspaces
        {/}
        \btxflush{number}
      }
    } {
      % Otherwise, just print the series entry number, if there is one
      \btxdoif {number} {
        \btxspace
        \btxflush{number}
      }
    }
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinelong:seriesxref
  \btxdoif {series} {
    % Is this a cross-reference to a separate entry for the series?
    \doifelse {\btxfoundname{series}} {seriesxref} {
      % If so, then recursively cite the series, but do not add it to the list
      \begingroup
      \def\seriesxreftag{\btxflush{series}}
      \textcite[alternative=inlineshort][\seriesxreftag]
      \endgroup
    } {
      % Otherwise, this field just contains the series name; print it with the appropriate formatting
      \btxstartstyleandcolor[sbl:\s!list:title:series]
        \btxusecommand[sbl:\s!list:title:series] {
          \btxflush{series}% set the series name according to its style
        }
      \btxstopstyleandcolor
    }
    % If the series itself has a series number (e.g., "WUNT 2", the second series of WUNT),
    % then print that number before the series entry number, with a forward slash in between
    \btxdoifelse {seriesseries} {
      \btxspace
      \btxflush{seriesseries}
      \btxdoif {number} {
        \removeunwantedspaces
        {/}
        \btxflush{number}
      }
    } {
      % Otherwise, just print the series entry number, if there is one
      \btxdoif {number} {
        \btxspace
        \btxflush{number}
      }
    }
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:howpublished
  \btxdoif {howpublished} {
    % Print the how-published statement, making sure to captialize it
    \Word{\btxflush{howpublished}}
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinelong:howpublished
  \btxdoif {howpublished} {
    % Print the how-published statement
    \btxflush{howpublished}
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:journalxref
  \btxdoif {journal} {
    % Is this a cross-reference to a separate entry for the journal?
    \doifelse {\btxfoundname{journal}} {journalxref} {
      % If so, then recursively cite the journal, but do not add it to the list
      \begingroup
      \def\journalxreftag{\btxflush{journal}}
      \textcite[alternative=inlineshort][\journalxreftag]
      \endgroup
    } {
      % Otherwise, this field just contains the journal name; print it with the appropriate formatting
      \btxstartstyleandcolor[sbl:\s!list:title:journal]
        \btxusecommand[sbl:\s!list:title:journal] {
          \btxflush{journal}% set the journal name according to its style
        }
      \btxstopstyleandcolor
    }
    % Print the volume(s), number(s), date(s), and page range(s)
    \btx_sbl_serializevolumenumberdatepage{\btxflush{volume}}{\btxflush{number}}{\btxflush{date}}{\btxflush{pages}}
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinelong:journalxref
  \btxdoif {journal} {
    % Is this a cross-reference to a separate entry for the journal?
    \doifelse {\btxfoundname{journal}} {journalxref} {
      % If so, then recursively cite the journal, but do not add it to the list
      \begingroup
      \def\journalxreftag{\btxflush{journal}}
      \textcite[alternative=inlineshort][\journalxreftag]
      \endgroup
    } {
      % Otherwise, this field just contains the journal name; print it with the appropriate formatting
      \btxstartstyleandcolor[sbl:\s!list:title:journal]
        \btxusecommand[sbl:\s!list:title:journal] {
          \btxflush{journal}% set the journal name according to its style
        }
      \btxstopstyleandcolor
    }
    % Print the volume(s), number(s), date(s), and page range(s)
    \btx_sbl_serializevolumenumberdatepage{\btxflush{volume}}{\btxflush{number}}{\btxflush{date}}{\btxflush{pages}}
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:publisher
  \btxdoif {publisher} {
    % Is this a reprint?
    \btxdoif {origdate} {
      % Is there an original publisher distinct from the current publisher?
      % If not, then we assume that the publisher is the same, and only the date is different
      \btxdoif {origpublisher} {
        \doifnot {\btxflush{origpublisher}} {\btxflush{publisher}} {
          % Is the original location distinct from the current location?
          \btxdoifelse {origlocation} {
            \btx_sbl_serializelocationpublisher{\btxflush{origlocation}}{\btxflush{origpublisher}}
          } {
            \btx_sbl_serializelocationpublisher{\btxflush{location}}{\btxflush{origpublisher}}
          }
          \btxcomma
        }
      }
      \btxflush{origdate}
      \btxperiod
      % Follow this with the reprint notation
      \btxlabeltext{sbl:Reprint}
      \btxcomma
    }
    % Is there a publisher?
    \btxdoif {publisher} {
      % Does the publisher have a location?
      \btxdoifelse {location} {
        \btx_sbl_serializelocationpublisher{\btxflush{location}}{\btxflush{publisher}}% in case there are multiple publishers at different locations
      } {
        \btxflush{publisher}
      }
      \btxcomma
    }
    % Is there a publication date?
    \btxdoif{date} {
      \btxflush{date}
      \btxcomma
    }
    % Close the publication block
    \removeunwantedspaces
    \removepunctuation
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinelong:publisher
  \btxdoif {publisher} {
    % Remove all preceding punctuation and spaces and use a parenthesis or bracket
    \removeunwantedspaces
    \removepunctuation
    \btxspace
    \startparen
    % Is this a reprint?
    \btxdoif {origdate} {
      % Is there an original publisher distinct from the current publisher?
      % If not, then we assume that the publisher is the same, and only the date is different
      \btxdoif {origpublisher} {
        \doifnot {\btxflush{origpublisher}} {\btxflush{publisher}} {
          % Is the original location distinct from the current location?
          \btxdoifelse {origlocation} {
            \btx_sbl_serializelocationpublisher{\btxflush{origlocation}}{\btxflush{origpublisher}}
          } {
            \btx_sbl_serializelocationpublisher{\btxflush{location}}{\btxflush{origpublisher}}
          }
          \btxcomma
        }
      }
      \btxflush{origdate}
      \btxsemicolon
      % Follow this with the reprint notation
      \btxlabeltext{sbl:reprint}
      \btxcomma
    }
    % Is there a publisher?
    \btxdoif {publisher} {
      % Does the publisher have a location?
      \btxdoifelse {location} {
        \btx_sbl_serializelocationpublisher{\btxflush{location}}{\btxflush{publisher}}% in case there are multiple publishers at different locations
      } {
        \btxflush{publisher}
      }
      \btxcomma
    }
    % Is there a publication date?
    \btxdoif{date} {
      \btxflush{date}
      \btxcomma
    }
    % Close the publication block
    \removeunwantedspaces
    \removepunctuation
    \stopparen
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:institution
  \btxdoif {institution} {
    % Print which type of thesis is being cited
    \doifelse {\currentbtxcategory} {phdthesis} {
      \btxlabeltext{sbl:phd}
      \btxspace
      \btxlabeltext{sbl:diss}
      \btxcomma
    } {
      \doifelse {\currentbtxcategory} {mastersthesis} {
        \btxlabeltext{sbl:masters}
        \btxspace
        \btxlabeltext{sbl:thesis}
        \btxcomma
      } {
        \btxdoif {type} {
          \doif {\btxfield{type}} {phdthesis} {
            \btxlabeltext{sbl:phd}
            \btxspace
            \btxlabeltext{sbl:diss}
            \btxcomma
          }
          \doif {\btxfield{type}} {mastersthesis} {
            \btxlabeltext{sbl:masters}
            \btxspace
            \btxlabeltext{sbl:thesis}
            \btxcomma
          }
        }
      }
    }
    % Print the institution name:
    \btxflush{institution}
    \btxcomma
    % Print the date:
    \btxdoif {date} {
      \btxflush{date}
      \btxcomma
    }
    \removeunwantedspaces
    \removepunctuation
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinelong:institution
  \btxdoif {institution} {
    % Remove all preceding punctuation and spaces and use a parenthesis or bracket
    \removeunwantedspaces
    \removepunctuation
    \btxspace
    \startparen
    % Print which type of thesis is being cited
    \doifelse {\currentbtxcategory} {phdthesis} {
      \btxlabeltext{sbl:phd}
      \btxspace
      \btxlabeltext{sbl:diss}
      \btxcomma
    } {
      \doifelse {\currentbtxcategory} {mastersthesis} {
        \btxlabeltext{sbl:masters}
        \btxspace
        \btxlabeltext{sbl:diss}
        \btxcomma
      } {
        \btxdoif {type} {
          \doif {\btxfield{type}} {phdthesis} {
            \btxlabeltext{sbl:phd}
            \btxspace
            \btxlabeltext{sbl:diss}
            \btxcomma
          }
          \doif {\btxfield{type}} {mastersthesis} {
            \btxlabeltext{sbl:masters}
            \btxspace
            \btxlabeltext{sbl:diss}
            \btxcomma
          }
        }
      }
    }
    % Print the institution name:
    \btxflush{institution}
    \btxcomma
    % Print the date:
    \btxdoif {date} {
      \btxflush{date}
      \btxcomma
    }
    % Close the institution block
    \removeunwantedspaces
    \removepunctuation
    \stopparen
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:presentedat
  \btxdoif {conference} {
    % Print the "paper presented at" preamble
    \btxlabeltext{sbl:Paperpresentedat}
    \btxspace
    \btxflush{conference}
    \btxperiod
    % Is there a location?
    \btxdoif {location} {
      \btxflush{location}
      \btxcomma
    }
    % Print the event date (formatted appropriately)
    \btxdoif {date} {
      \btx_sbl_convertdate{\btxflush{date}}
      \btxcomma
    }
    % Close the block
    \removeunwantedspaces
    \removepunctuation
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinelong:presentedat
  \btxdoif {conference} {
    % Remove all preceding punctuation and spaces and use a parenthesis
    \removeunwantedspaces
    \removepunctuation
    \btxspace
    \startparen
    % Print the "paper presented at" preamble
    \btxlabeltext{sbl:paperpresentedat}
    \btxspace
    \btxflush{conference}
    \btxcomma
    % Is there a location?
    \btxdoif {location} {
      \btxflush{location}
      \btxcomma
    }
    % Print the event date (formatted appropriately)
    \btxdoif {date} {
      \btx_sbl_convertdate{\btxflush{date}}
      \btxcomma
    }
    % Close the block
    \removeunwantedspaces
    \removepunctuation
    \stopparen
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:ebook
  \btxdoif {eprint} {
    % Just print the eprint as an edition (e.g., "Nook edition")
    \btxflush{eprint}
    \btxspace
    \btxlabeltext{sbl:editionfull}
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinelong:ebook
  \btxdoif {eprint} {
    % Just print the eprint as an edition (e.g., "Nook edition")
    \btxflush{eprint}
    \btxspace
    \btxlabeltext{sbl:editionfull}
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:related
  \btxdoif{related} {
    % Print the appropriate preamble for the type of the related entry, if there is one;
    % if it is not a supported type, then print it as-is
    \doif {\btxflush{relatedtype}} {reprintof} {
      \btxlabeltext{sbl:Reprintof}
      \btxspace
    }
    \doif {\btxflush{relatedtype}} {translationof} {
      \btxlabeltext{sbl:Translationof}
      \btxspace
    }
    \doifnotinset {\btxflush{relatedtype}} {reprintof, translationof} {
      \btxusecommand[sbl:\s!list:type]{
        \btxflush{relatedtype}% make sure it's capitalized
      }
    }
    % Recursively cite the related entry, but do not add it to the list
    % TODO: biblatex allows multiple comma-separated related entries, although they all have to share a single relatedtype
    \begingroup
    \def\relatedtag{\btxflush{related}}
    \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\relatedtag}{
      \textcite[alternative=entry,useauthor=no,usepubl=yes][\relatedtag]
      \removeunwantedspaces
      \removepunctuation
    } {
      \textcite[alternative=entry,titleauthor=yes,usepubl=yes][\relatedtag]
      \removeunwantedspaces
      \removepunctuation
    }
    \endgroup
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinelong:related
  \btxdoif{related} {
    % Replace any preceding punctuation with a semicolon
    \removeunwantedspaces
    \removepunctuation
    \btxsemicolon
    % Print the appropriate preamble for the type of the related entry, if there is one;
    % if it is not a supported type, then print it as-is
    \doif {\btxflush{relatedtype}} {reprintof} {
      \btxlabeltext{sbl:reprintof}
      \btxspace
    }
    \doif {\btxflush{relatedtype}} {translationof} {
      \btxlabeltext{sbl:translationof}
      \btxspace
    }
    \doifnotinset {\btxflush{relatedtype}} {reprintof, translationof} {
      \btxflush{relatedtype}% make sure it's capitalized
    }
    % Recursively cite the related entry, but do not add it to the list
    % TODO: biblatex allows multiple comma-separated related entries, although they all have to share a single relatedtype
    \begingroup
    \def\relatedtag{\btxflush{related}}
    \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\relatedtag}{
      \textcite[alternative=inlinelong,useauthor=no,usepubl=yes,lefttext=,righttext=,loctext=,altloctext=,punct=][\relatedtag]
    } {
      \textcite[alternative=inlinelong,titleauthor=yes,usepubl=yes,lefttext=,righttext=,loctext=,altloctext=,punct=][\relatedtag]
    }
    \endgroup
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:eprint
  % Is the eprint field present?
  \btxdoifelse {eprint} {
    % Does it have an eprintclass?
    \btxdoifelse {eprintclass} {
      % If so, then this is a document published only online
      % Print the release date (formated appropriately) first, if there is one:
      \btxdoif {eprintdate} {
        \btxlabeltext{sbl:Released}
        \btxspace
        \btx_sbl_convertdate{\btxflush{eprintdate}}
        \btxperiod
      }
      % If it has an eprinttype, then produce a DOI by concatenating it with the the eprint identifier
      \btxdoifelse {eprinttype} {
        {\sc doi}
        \btxcolon
        \removeunwantedspaces
        \hyphenatedurl{\btxflush{eprinttype}/: \btxflush{eprint}}
      } {
        \hyphenatedurl{\btxflush{eprint}}
      }
      % Finally, print its eprintclass in parentheses or brackets
      \btxspace
      \startparen
      \btxflush{eprintclass}
      \stopparen
      \btxperiod
    } {
      % If not, then this is an online database or website with eprint fields
      % Print its eprinttype first, if there is one
      \btxdoif {eprinttype} {
        \btxflush{eprinttype}
        \btxperiod
      }
      % Print the release date (formated appropriately) first, if there is one:
      \btxdoif {eprintdate} {
        \btxlabeltext{sbl:Released}
        \btxspace
        \btx_sbl_convertdate{\btxflush{eprintdate}}
        \btxperiod
      }
      % Then print the eprint identifier
      \hyphenatedurl{\btxflush{eprint}}
      \btxperiod
      % If a DOI was specified, then use it here
      \btxdoif {doi} {
        {\sc doi}
        \btxcolon
        \removeunwantedspaces
        \hyphenatedurl{\btxflush{doi}}
        \btxperiod
      }
    }
  } {
    % If not, then treat this as a website or blog post
    % Does it have a blog title?
    \btxdoif {journal} {
      \doifelse {\btxfoundname{journal}} {journalxref} {
        \begingroup
        \def\journalxreftag{\btxflush{journal}}
        \textcite[alternative=inlineshort][\journalxreftag]
        \endgroup
      } {
        \btxstartstyleandcolor[sbl:\s!list:title:journal]
          \btxusecommand[sbl:\s!list:title:journal] {
            \btxflush{journal}% set the journal name according to its style
          }
        \btxstopstyleandcolor
      }
      \btxperiod
    }
    % Then print the date of the post (with appropriate formatting), if specified
    \btxdoif {date} {
      \btx_sbl_convertdate{\btxflush{date}}
      \btxperiod
    }
    % Then print the URL, if specified
    \btxdoif {doi} {
      \hyphenatedurl{\btxflush{doi}}
      \btxperiod
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinelong:eprint
  % Is the eprint field present?
  \btxdoifelse {eprint} {
    % Does it have an eprintclass?
    \btxdoifelse {eprintclass} {
      % If so, then this is a document published only online
      % Print the release date (with appropriate formatting) first, if there is one:
      \btxdoif {eprintdate} {
        \btxlabeltext{sbl:released}
        \btxspace
        \btx_sbl_convertdate{\btxflush{eprintdate}}
        \btxcomma
      }
      % If it has an eprinttype, then produce a DOI by concatenating it with the the eprint identifier
      \btxdoifelse {eprinttype} {
        {\sc doi}
        \btxcolon
        \removeunwantedspaces
        \hyphenatedurl{\btxflush{eprinttype}/: \btxflush{eprint}}
      } {
        \hyphenatedurl{\btxflush{eprint}}
      }
      % Finally, print its eprintclass in parentheses or brackets
      \startparen
      \btxflush{eprintclass}
      \stopparen
      \btxcomma
    } {
      % If not, then this is an online database or website with eprint fields
      % Print its eprinttype first, if there is one
      \btxdoif {eprinttype} {
        \btxflush{eprinttype}
        \btxcomma
      }
      % Print the release date (with appropriate formatting) next, if there is one:
      \btxdoif {eprintdate} {
        \btxlabeltext{sbl:released}
        \btxspace
        \btx_sbl_convertdate{\btxflush{eprintdate}}
        \btxcomma
      }
      % Then print the eprint identifier
      \hyphenatedurl{\btxflush{eprint}}
      \btxcomma
      % If a DOI was specified, then use it here
      \btxdoif {doi} {
        {\sc doi}
        \btxcolon
        \removeunwantedspaces
        \hyphenatedurl{\btxflush{doi}}
        \btxcomma
      }
    }
  } {
    % If not, then treat this as a website or blog post
    % Does it have a blog cross-reference?
    \btxdoif {journal} {
      \doifelse {\btxfoundname{journal}} {journalxref} {
        \begingroup
        \def\journalxreftag{\btxflush{journal}}
        \textcite[alternative=inlineshort][\journalxreftag]
        \endgroup
      } {
        \btxstartstyleandcolor[sbl:\s!list:title:journal]
          \btxusecommand[sbl:\s!list:title:journal] {
            \btxflush{journal}% set the journal name according to its style
          }
        \btxstopstyleandcolor
      }
      \btxcomma
    }
    % Then print the date of the post (with appropriate formatting), if specified
    \btxdoif {date} {
      \btx_sbl_convertdate{\btxflush{date}}
      \btxcomma
    }
    % Then print the URL, if specified
    \btxdoif {doi} {
      \hyphenatedurl{\btxflush{doi}}
      \btxcomma
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:doi
  \btxdoif {doi} {
    % If the URL is actually a DOI (the preferred case), then indicate this
    \doifelse {\btxfoundname{doi}} {doi} {
      {\sc doi}
      \btxcolon
      \removeunwantedspaces
      \hyphenatedurl{\btxflush{doi}}
      % If both a DOI and URL are present, then print the URL after the DOI
      \btxdoif {url} {
        \btxperiod
        \hyphenatedurl{\btxflush{url}}
      }
    } {
      \hyphenatedurl{\btxflush{doi}}
    }
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinelong:doi
  \btxdoif {doi} {
    % If the URL is actually a DOI (the preferred case), then indicate this
    \doifelse {\btxfoundname{doi}} {doi} {
      {\sc doi}
      \btxcolon
      \removeunwantedspaces
      \hyphenatedurl{\btxflush{doi}}
      % If both a DOI and URL are present, then print the URL after the DOI
      \btxdoif {url} {
        \btxcomma
        \hyphenatedurl{\btxflush{url}}
      }
    } {
      \hyphenatedurl{\btxflush{doi}}
    }
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:note
  \btxdoif {note} {
    % Make sure the first word is capitalized
    \btxusecommand[sbl:\s!list:note] {
      \btxflush{note}%
    }
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinelong:note
  \btxdoif {note} {
    \btxflush{note}
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinelong:loctext
  \doifnot {\currentbtxloctext} {\empty} {
    % TODO: If the entry includes a pages field, there is no bibliography, and this is the first citation of this entry, 
    % then the full page range should be followed by "here" and the specific pages cited in the loctext;
    % if there is a bibliography, then the full page range does not need to be included in the first citation.
    % (https://sblhs2.com/2018/02/08/citing-page-numbers-for-chapters-and-articles/)
    \btxdoif {pages} {
      \btxlabeltext{sbl:here}
      \btxspace
    }
    \currentbtxloctext
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlineshort:loctext
  % Same as inline variant, except that we don't need to check for existing page ranges
  % and we redefine the \loc macro to behave like the \loctextloc macro (which removes preceding punctuation contextually)
  \doifnot {\currentbtxloctext} {\empty} {
    \begingroup
    \let\loc\loctextloc
    % If the loctext has a numeric prefix (i.e., if the user has input just a page number and not a locator),
    % then apply any necessary formatting
    \btx_sbl_doifhasnumericprefix{\currentbtxloctext} {
      \doif{\btxsblvolumebeforeloctext}{yes} {
        \removeunwantedspaces
        \removepunctuation
        \btxcolon
        \removeunwantedspaces
      }
    }
    % If the loctext starts with a volume division,
    % then apply any necessary formatting
    \btx_sbl_doifhasvolumepartprefix{\currentbtxloctext} {
      \doif{\btxsblshorthandbeforeloctext}{yes} {
        \removeunwantedspaces
        \removepunctuation
        \btxspace
      }
    }
    % If the loctext starts with a section or paragraph mark,
    % then replace any preceding punctuation with a space
    \btx_sbl_doifprefix{§}{\currentbtxloctext} {
      \removeunwantedspaces
      \removepunctuation
      \btxspace
    }
    \btx_sbl_doifprefix{¶}{\currentbtxloctext} {
      \removeunwantedspaces
      \removepunctuation
      \btxspace
    }
    \currentbtxloctext
    \btxcomma
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinelong:altloctext
  \doifnot {\currentbtxaltloctext} {\empty} {
    \begingroup
    \let\loc\loctextloc
    % If the loctext has a numeric prefix (i.e., if the user has input just a passage index and not a locator),
    % then apply any necessary formatting
    \btx_sbl_doifhasnumericprefix{\currentbtxaltloctext} {
      % Only remove the comma after the title if the title of this entry does not end with a number of its own (e.g., "Epistle 1")
      \btx_sbl_doifhasnumericsuffixelse{\btxdirect{title}} {} {
        \removeunwantedspaces
        \removepunctuation
        \btxspace
      }
    }
    % If the loctext starts with a section or paragraph mark,
    % then replace any preceding punctuation with a space
    \btx_sbl_doifprefix{§}{\currentbtxaltloctext} {
      \removeunwantedspaces
      \removepunctuation
      \btxspace
    }
    \btx_sbl_doifprefix{¶}{\currentbtxaltloctext} {
      \removeunwantedspaces
      \removepunctuation
      \btxspace
    }
    \currentbtxaltloctext
    \btxcomma
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlineshort:altloctext
  \doifnot {\currentbtxaltloctext} {\empty} {
    \begingroup
    \let\loc\loctextloc
    % If the loctext has a numeric prefix (i.e., if the user has input just a passage index and not a locator),
    % then apply any necessary formatting
    \btx_sbl_doifhasnumericprefix{\currentbtxaltloctext} {
      % Only remove the comma after the title if the short title of this entry (or the title, if there is no short title) does not end with a number of its own (e.g., "Epistle 1")
      \texdefinition{btx:sbl:doifownfieldelse} {shorttitle} {
        \btx_sbl_doifhasnumericsuffixelse{\btxdirect{shorttitle}} {} {
          \removeunwantedspaces
          \removepunctuation
          \btxspace
        }
      } {
        \btx_sbl_doifhasnumericsuffixelse{\btxdirect{title}} {} {
          \removeunwantedspaces
          \removepunctuation
          \btxspace
        }
      }
    }
    % If the loctext starts with a section or paragraph mark,
    % then replace any preceding punctuation with a space
    \btx_sbl_doifprefix{§}{\currentbtxaltloctext} {
      \removeunwantedspaces
      \removepunctuation
      \btxspace
    }
    \btx_sbl_doifprefix{¶}{\currentbtxaltloctext} {
      \removeunwantedspaces
      \removepunctuation
      \btxspace
    }
    \currentbtxaltloctext
    \btxcomma
    \endgroup
  }
\stoptexdefinition

% List citation setups
\startsetups btx:sbl:list:series
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:list:editortranslator}
  \texdefinition{btx:sbl:list:volumes}
  \texdefinition{btx:sbl:list:publisher}
  \texdefinition{btx:sbl:list:doi}
  \texdefinition{btx:sbl:list:related}
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:journal
  \fastsetup{btx:sbl:list:series}
\stopsetups

\startsetups btx:sbl:list:mvbook
  % Only cite the author if the useauthor option is set
  \doifelse {\btxparameter{useauthor}} {\v!yes} {
    % If the titleauthor option is set, then cite the title first, followed by the author
    \doifelse {\btxparameter{titleauthor}} {\v!yes} {
      \texdefinition{btx:sbl:list:title}
      \texdefinition{btx:sbl:list:author-after-title}
    } {
      \texdefinition{btx:sbl:list:author}
      \texdefinition{btx:sbl:list:title}
    }
  } {
    \texdefinition{btx:sbl:list:title}
  }
  % Only cite publication data if the usepubl option is set
  \doif {\btxparameter{usepubl}} {\v!yes} {
    \texdefinition{btx:sbl:list:editortranslator}
    \texdefinition{btx:sbl:list:edition}
    \texdefinition{btx:sbl:list:volumes}
    \texdefinition{btx:sbl:list:seriesxref}
    \texdefinition{btx:sbl:list:publisher}
    \texdefinition{btx:sbl:list:ebook}
    \texdefinition{btx:sbl:list:doi}
    \texdefinition{btx:sbl:list:related}
  }
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:mvreference
  \fastsetup{btx:sbl:list:mvbook}
\stopsetups

\startsetups btx:sbl:list:mvcollection
  \fastsetup{btx:sbl:list:mvbook}
\stopsetups

\startsetups btx:sbl:list:mvproceedings
  \fastsetup{btx:sbl:list:mvbook}
\stopsetups

\startsetups btx:sbl:list:book
  % A book may be an untitled volume in a cross-referenced multivolume set
  \texdefinition{btx:sbl:doifownfieldelse} {title} {
    % Only cite the author if the useauthor option is set
    \doifelse {\btxparameter{useauthor}} {\v!yes} {
      % If the titleauthor option is set, then cite the title first, followed by the author
      \doifelse {\btxparameter{titleauthor}} {\v!yes} {
        \texdefinition{btx:sbl:list:title}
        \texdefinition{btx:sbl:list:author-after-title}
      } {
        \texdefinition{btx:sbl:list:author}
        \texdefinition{btx:sbl:list:title}
      }
    } {
      \texdefinition{btx:sbl:list:title}
    }
    % Only cite the cross-reference if the usecrossref option is set
    \doif {\btxparameter{usecrossref}} {\v!yes} {
      \texdefinition{btx:sbl:list:bookcrossref}
    }
  } {
    % If the titleauthor option is set, then cite the cross-reference first, followed by the author
    \doifelse {\btxparameter{titleauthor}} {\v!yes} {
      % Only cite the cross-reference if the usecrossref option is set
      \doif {\btxparameter{usecrossref}} {\v!yes} {
        \texdefinition{btx:sbl:list:bookcrossref}
      }
      % Only cite the author if the useauthor option is set
      \doif {\btxparameter{useauthor}} {\v!yes} {
        \texdefinition{btx:sbl:list:author-after-title}
      }
    } {
      % Only cite the author if the useauthor option is set
      \doif {\btxparameter{useauthor}} {\v!yes} {
        \texdefinition{btx:sbl:list:author}
      }
      % Only cite the cross-reference if the usecrossref option is set
      \doif {\btxparameter{usecrossref}} {\v!yes} {
        \texdefinition{btx:sbl:list:bookcrossref}
      }
    }
  }
  % Only cite publication data if the usepubl option is set
  \doif {\btxparameter{usepubl}} {\v!yes} {
    \texdefinition{btx:sbl:list:editortranslator}
    \texdefinition{btx:sbl:list:edition}
    \texdefinition{btx:sbl:list:seriesxref}
    \texdefinition{btx:sbl:list:publisher}
    \texdefinition{btx:sbl:list:ebook}
    \texdefinition{btx:sbl:list:doi}
    \texdefinition{btx:sbl:list:related}
  }
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:reference
  \fastsetup{btx:sbl:list:book}
\stopsetups

\startsetups btx:sbl:list:collection
  \fastsetup{btx:sbl:list:book}
\stopsetups

\startsetups btx:sbl:list:proceedings
  \fastsetup{btx:sbl:list:book}
\stopsetups

\startsetups btx:sbl:list:manual
  \fastsetup{btx:sbl:list:book}
\stopsetups

\startsetups btx:sbl:list:inbook
  % Only cite the author if the useauthor option is set
  \doifelse {\btxparameter{useauthor}} {\v!yes} {
    % If the titleauthor option is set, then cite the title first, followed by the author
    \doifelse {\btxparameter{titleauthor}} {\v!yes} {
      \texdefinition{btx:sbl:list:title}
      \texdefinition{btx:sbl:list:author-after-title}
    } {
      \texdefinition{btx:sbl:list:author}
      \texdefinition{btx:sbl:list:title}
    }
  } {
    \texdefinition{btx:sbl:list:title}
  }
  % Only cite the cross-reference if the usecrossref option is set
  \doif {\btxparameter{usecrossref}} {\v!yes} {
    \texdefinition{btx:sbl:list:inbookcrossref}
  }
  % Only cite publication data if the usepubl option is set
  \doif {\btxparameter{usepubl}} {\v!yes} {
    \texdefinition{btx:sbl:list:doi}
    \texdefinition{btx:sbl:list:related}
  }
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:inreference
  \fastsetup{btx:sbl:list:inbook}
\stopsetups

\startsetups btx:sbl:list:incollection
  \fastsetup{btx:sbl:list:inbook}
\stopsetups

\startsetups btx:sbl:list:inproceedings
  \fastsetup{btx:sbl:list:inbook}
\stopsetups

\startsetups btx:sbl:list:suppbook
  % Only cite the author if the useauthor option is set
  \doifelse {\btxparameter{useauthor}} {\v!yes} {
    % If the titleauthor option is set, then cite the title first, followed by the author
    \doifelse {\btxparameter{titleauthor}} {\v!yes} {
      \texdefinition{btx:sbl:list:title}
      \texdefinition{btx:sbl:list:author-after-title}
    } {
      \texdefinition{btx:sbl:list:author}
      \texdefinition{btx:sbl:list:title}
    }
  } {
    \texdefinition{btx:sbl:list:title}
  }
  % Only cite the cross-reference if the usecrossref option is set
  \doif {\btxparameter{usecrossref}} {\v!yes} {
    \texdefinition{btx:sbl:list:suppbookcrossref}
  }
  % Only cite publication data if the usepubl option is set
  \doif {\btxparameter{usepubl}} {\v!yes} {
    \texdefinition{btx:sbl:list:doi}
    \texdefinition{btx:sbl:list:related}
  }
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:ancienttext
  % Only cite the author if the useauthor option is set
  \doifelse {\btxparameter{useauthor}} {\v!yes} {
    % If the titleauthor option is set, then cite the title first, followed by the author
    \doifelse {\btxparameter{titleauthor}} {\v!yes} {
      \texdefinition{btx:sbl:list:title}
      % An ancienttext may not have an author, 
      % so be sure not to use one inherited from a cross-referenced source
      \texdefinition{btx:sbl:doifownfield} {author} {
        \texdefinition{btx:sbl:list:author-after-title}
      }
    } {
      % An ancienttext may not have an author, 
      % so be sure not to use one inherited from a cross-referenced source
      \texdefinition{btx:sbl:doifownfield} {author} {
        \texdefinition{btx:sbl:list:author}
      }
      \texdefinition{btx:sbl:list:title}
    }
  } {
    \texdefinition{btx:sbl:list:title}
  }
  % Only cite the cross-reference if the usecrossref option is set
  \doif {\btxparameter{usecrossref}} {\v!yes} {
    \texdefinition{btx:sbl:list:inbookcrossref}
  }
  % Only cite publication data if the usepubl option is set
  \doif {\btxparameter{usepubl}} {\v!yes} {
    % An ancienttext may not have its own editor or translator, 
    % so be sure not to use one inherited from a cross-referenced source
    \texdefinition{btx:sbl:doifownfieldelse} {editor} {
      \texdefinition{btx:sbl:doifownfieldelse} {translator} {
        \texdefinition{btx:sbl:list:editortranslator}
      } {
        \texdefinition{btx:sbl:list:editor}
      }
    } {
      \texdefinition{btx:sbl:doifownfield} {translator} {
        \texdefinition{btx:sbl:list:translator}
      }
    }
    % An ancienttext may have its own location of provenance,
    % but make sure that it is not a place of publication inherited from a cross-referenced source
    \texdefinition{btx:sbl:doifownfield} {location} {
      \btxflush{location}
      \btxperiod
    }
    \texdefinition{btx:sbl:list:doi}
    \texdefinition{btx:sbl:list:related}
  }
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:classictext
  % Only cite the author if the useauthor option is set
  \doifelse {\btxparameter{useauthor}} {\v!yes} {
    % If the titleauthor option is set, then cite the title first, followed by the author
    \doifelse {\btxparameter{titleauthor}} {\v!yes} {
      \texdefinition{btx:sbl:list:title}
      % A classictext may not have an author, 
      % so be sure not to use one inherited from a cross-referenced source
      \texdefinition{btx:sbl:doifownfield} {author} {
        \texdefinition{btx:sbl:list:author-after-title}
      }
    } {
      % A classictext may not have an author, 
      % so be sure not to use one inherited from a cross-referenced source
      \texdefinition{btx:sbl:doifownfield} {author} {
        \texdefinition{btx:sbl:list:author}
      }
      \texdefinition{btx:sbl:list:title}
    }
  } {
    \texdefinition{btx:sbl:list:title}
  }
  % Only cite the cross-reference if the usecrossref option is set
  \doif {\btxparameter{usecrossref}} {\v!yes} {
    \texdefinition{btx:sbl:list:inbookcrossref}
  }
  % Only cite publication data if the usepubl option is set
  \doif {\btxparameter{usepubl}} {\v!yes} {
    % A classictext may not have its own editor or translator, 
    % so be sure not to use one inherited from a cross-referenced source
    \texdefinition{btx:sbl:doifownfieldelse} {editor} {
      \texdefinition{btx:sbl:doifownfieldelse} {translator} {
        \texdefinition{btx:sbl:list:editortranslator}
      } {
        \texdefinition{btx:sbl:list:editor}
      }
    } {
      \texdefinition{btx:sbl:doifownfield} {translator} {
        \texdefinition{btx:sbl:list:translator}
      }
    }
    \texdefinition{btx:sbl:list:doi}
    \texdefinition{btx:sbl:list:related}
  }
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:article
  % Only cite the author if the useauthor option is set
  \doifelse {\btxparameter{useauthor}} {\v!yes} {
    % If the titleauthor option is set, then cite the title first, followed by the author
    \doifelse {\btxparameter{titleauthor}} {\v!yes} {
      \texdefinition{btx:sbl:list:title}
      \texdefinition{btx:sbl:list:author-after-title}
    } {
      \texdefinition{btx:sbl:list:author}
      \texdefinition{btx:sbl:list:title}
    }
  } {
    \texdefinition{btx:sbl:list:title}
  }
  % Only cite publication data if the usepubl option is set
  \doif {\btxparameter{usepubl}} {\v!yes} {
    \texdefinition{btx:sbl:list:editortranslator}
    \texdefinition{btx:sbl:list:journalxref}
    \texdefinition{btx:sbl:list:doi}
    \texdefinition{btx:sbl:list:related}
  }
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:magazine
  \fastsetup{btx:sbl:list:article}
\stopsetups

\startsetups btx:sbl:list:newspaper
  \fastsetup{btx:sbl:list:article}
\stopsetups

\startsetups btx:sbl:list:periodical
  \fastsetup{btx:sbl:list:article}
\stopsetups

\startsetups btx:sbl:list:review
  % Only cite the author if the useauthor option is set
  \doifelse {\btxparameter{useauthor}} {\v!yes} {
    % If the titleauthor option is set, then cite the title first, followed by the author
    \doifelse {\btxparameter{titleauthor}} {\v!yes} {
      \texdefinition{btx:sbl:list:title}
      \texdefinition{btx:sbl:list:author-after-title}
    } {
      \texdefinition{btx:sbl:list:author}
      \texdefinition{btx:sbl:list:title}
    }
  } {
    \texdefinition{btx:sbl:list:title}
  }
  % Only cite the cross-reference if the usecrossref option is set
  \doif {\btxparameter{usecrossref}} {\v!yes} {
    \texdefinition{btx:sbl:list:reviewcrossref}
  }
  % Only cite publication data if the usepubl option is set
  \doif {\btxparameter{usepubl}} {\v!yes} {
    \texdefinition{btx:sbl:list:editortranslator}
    \texdefinition{btx:sbl:list:journalxref}
    \texdefinition{btx:sbl:list:doi}
    \texdefinition{btx:sbl:list:related}
  }
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:conferencepaper
  % Only cite the author if the useauthor option is set
  \doifelse {\btxparameter{useauthor}} {\v!yes} {
    % If the titleauthor option is set, then cite the title first, followed by the author
    \doifelse {\btxparameter{titleauthor}} {\v!yes} {
      \texdefinition{btx:sbl:list:title}
      \texdefinition{btx:sbl:list:author-after-title}
    } {
      \texdefinition{btx:sbl:list:author}
      \texdefinition{btx:sbl:list:title}
    }
  } {
    \texdefinition{btx:sbl:list:title}
  }
  % Only cite publication data if the usepubl option is set
  \doif {\btxparameter{usepubl}} {\v!yes} {
    \texdefinition{btx:sbl:list:presentedat}
    \texdefinition{btx:sbl:list:doi}
    \texdefinition{btx:sbl:list:related}
  }
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:thesis
  % Only cite the author if the useauthor option is set
  \doifelse {\btxparameter{useauthor}} {\v!yes} {
    % If the titleauthor option is set, then cite the title first, followed by the author
    \doifelse {\btxparameter{titleauthor}} {\v!yes} {
      \texdefinition{btx:sbl:list:title}
      \texdefinition{btx:sbl:list:author-after-title}
    } {
      \texdefinition{btx:sbl:list:author}
      \texdefinition{btx:sbl:list:title}
    }
  } {
    \texdefinition{btx:sbl:list:title}
  }
  % Only cite publication data if the usepubl option is set
  \doif {\btxparameter{usepubl}} {\v!yes} {
    \texdefinition{btx:sbl:list:editortranslator}
    \texdefinition{btx:sbl:list:institution}
    \texdefinition{btx:sbl:list:doi}
    \texdefinition{btx:sbl:list:related}
  }
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:mastersthesis
  \fastsetup{btx:sbl:list:thesis}
\stopsetups

\startsetups btx:sbl:list:phdthesis
  \fastsetup{btx:sbl:list:thesis}
\stopsetups

\startsetups btx:sbl:list:unpublished
  % Only cite the author if the useauthor option is set
  \doifelse {\btxparameter{useauthor}} {\v!yes} {
    % If the titleauthor option is set, then cite the title first, followed by the author
    \doifelse {\btxparameter{titleauthor}} {\v!yes} {
      \texdefinition{btx:sbl:list:title}
      \texdefinition{btx:sbl:list:author-after-title}
    } {
      \texdefinition{btx:sbl:list:author}
      \texdefinition{btx:sbl:list:title}
    }
  } {
    \texdefinition{btx:sbl:list:title}
  }
  % Only cite publication data if the usepubl option is set
  \doif {\btxparameter{usepubl}} {\v!yes} {
    \texdefinition{btx:sbl:list:editortranslator}
    \texdefinition{btx:sbl:list:doi}
    \texdefinition{btx:sbl:list:related}
  }
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:online
  % Only cite the author if the useauthor option is set
  \doifelse {\btxparameter{useauthor}} {\v!yes} {
    % If the titleauthor option is set, then cite the title first, followed by the author
    \doifelse {\btxparameter{titleauthor}} {\v!yes} {
      \texdefinition{btx:sbl:list:title}
      \texdefinition{btx:sbl:list:author-after-title}
    } {
      \texdefinition{btx:sbl:list:author}
      \texdefinition{btx:sbl:list:title}
    }
  } {
    \texdefinition{btx:sbl:list:title}
  }
  % Only cite publication data if the usepubl option is set
  \doif {\btxparameter{usepubl}} {\v!yes} {
    \texdefinition{btx:sbl:list:editortranslator}
    \texdefinition{btx:sbl:list:eprint}
    \texdefinition{btx:sbl:list:related}
  }
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:electronic
  \fastsetup{btx:sbl:list:online}
\stopsetups

\startsetups btx:sbl:list:misc
  % Only cite the author if the useauthor option is set
  \doifelse {\btxparameter{useauthor}} {\v!yes} {
    % If the titleauthor option is set, then cite the title first, followed by the author
    \doifelse {\btxparameter{titleauthor}} {\v!yes} {
      \texdefinition{btx:sbl:list:title}
      \texdefinition{btx:sbl:list:author-after-title}
    } {
      \texdefinition{btx:sbl:list:author}
      \texdefinition{btx:sbl:list:title}
    }
  } {
    \texdefinition{btx:sbl:list:title}
  }
  % Only cite publication data if the usepubl option is set
  \doif {\btxparameter{usepubl}} {\v!yes} {
    \texdefinition{btx:sbl:list:editortranslator}
    \texdefinition{btx:sbl:list:edition}
    \texdefinition{btx:sbl:list:volumes}
    \texdefinition{btx:sbl:list:seriesxref}
    \texdefinition{btx:sbl:list:journalxref}
    \texdefinition{btx:sbl:list:howpublished}
    \texdefinition{btx:sbl:list:publisher}
    \texdefinition{btx:sbl:list:institution}
    \texdefinition{btx:sbl:list:presentedat}
    \texdefinition{btx:sbl:list:doi}
    \texdefinition{btx:sbl:list:related}
  }
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

% Inline citation setups
\startsetups btx:sbl:inlinelong:series
  \texdefinition{btx:sbl:inlinelong:title}
  % Only recursively cite publication data if the usepubl option is set
  \doif {\btxparameter{usepubl}} {\v!yes} {
    \texdefinition{btx:sbl:inlinelong:editortranslator}
    \texdefinition{btx:sbl:inlinelong:volumes}
    \texdefinition{btx:sbl:inlinelong:publisher}
    \texdefinition{btx:sbl:inlinelong:doi}
    \texdefinition{btx:sbl:inlinelong:related}
  }
  \texdefinition{btx:sbl:inlinelong:note}
  \texdefinition{btx:sbl:inlinelong:loctext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlinelong:journal
  \fastsetup{btx:sbl:inlinelong:series}
\stopsetups

\startsetups btx:sbl:inlinelong:mvbook
  % Only cite the author if the useauthor option is set
  \doifelse {\btxparameter{useauthor}} {\v!yes} {
    % If the titleauthor option is set, then cite the title first, followed by the author
    \doifelse {\btxparameter{titleauthor}} {\v!yes} {
      \texdefinition{btx:sbl:inlinelong:title}
      \texdefinition{btx:sbl:inlinelong:author-after-title}
    } {
      \texdefinition{btx:sbl:inlinelong:author}
      \texdefinition{btx:sbl:inlinelong:title}
    }  
  } {
    \texdefinition{btx:sbl:inlinelong:title}
  }
  % Only recursively cite publication data if the usepubl option is set
  \doif {\btxparameter{usepubl}} {\v!yes} {
    \texdefinition{btx:sbl:inlinelong:editortranslator}
    \texdefinition{btx:sbl:inlinelong:edition}
    \texdefinition{btx:sbl:inlinelong:volumes}
    \texdefinition{btx:sbl:inlinelong:seriesxref}
    \texdefinition{btx:sbl:inlinelong:publisher}
    \texdefinition{btx:sbl:inlinelong:ebook}
    \texdefinition{btx:sbl:inlinelong:doi}
    \texdefinition{btx:sbl:inlinelong:related}
  }
  \texdefinition{btx:sbl:inlinelong:note}
  \texdefinition{btx:sbl:inlinelong:loctext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlinelong:mvreference
  \fastsetup{btx:sbl:inlinelong:mvbook}
\stopsetups

\startsetups btx:sbl:inlinelong:mvcollection
  \fastsetup{btx:sbl:inlinelong:mvbook}
\stopsetups

\startsetups btx:sbl:inlinelong:mvproceedings
  \fastsetup{btx:sbl:inlinelong:mvbook}
\stopsetups

\startsetups btx:sbl:inlinelong:book
  % A book may be an untitled volume in a cross-referenced multivolume set
  \texdefinition{btx:sbl:doifownfieldelse} {title} {
    % Only cite the author if the useauthor option is set
    \doifelse {\btxparameter{useauthor}} {\v!yes} {
      % If the titleauthor option is set, then cite the title first, followed by the author
      \doifelse {\btxparameter{titleauthor}} {\v!yes} {
        \texdefinition{btx:sbl:inlinelong:title}
        \texdefinition{btx:sbl:inlinelong:author-after-title}
      } {
        \texdefinition{btx:sbl:inlinelong:author}
        \texdefinition{btx:sbl:inlinelong:title}
      }
    } {
      \texdefinition{btx:sbl:inlinelong:title}
    }
    % Only cite the cross-reference if the usecrossref option is set
    \doif {\btxparameter{usecrossref}} {\v!yes} {
      \texdefinition{btx:sbl:inlinelong:bookcrossref}
    }
  } {
    % If the titleauthor option is set, then cite the cross-reference first, followed by the author
    \doifelse {\btxparameter{titleauthor}} {\v!yes} {
      % Only cite the cross-reference if the usecrossref option is set
      \doif {\btxparameter{usecrossref}} {\v!yes} {
        \texdefinition{btx:sbl:inlinelong:bookcrossref}
      }
      % Only cite the author if the useauthor option is set
      \doif {\btxparameter{useauthor}} {\v!yes} {
        \texdefinition{btx:sbl:inlinelong:author-after-title}
      }
    } {
      % Only cite the author if the useauthor option is set
      \doif {\btxparameter{useauthor}} {\v!yes} {
        \texdefinition{btx:sbl:inlinelong:author}
      }
      % Only cite the cross-reference if the usecrossref option is set
      \doif {\btxparameter{usecrossref}} {\v!yes} {
        \texdefinition{btx:sbl:inlinelong:bookcrossref}
      }
    }
  }
  % Only recursively cite publication data if the usepubl option is set
  \doif {\btxparameter{usepubl}} {\v!yes} {
    \texdefinition{btx:sbl:inlinelong:editortranslator}
    \texdefinition{btx:sbl:inlinelong:edition}
    \texdefinition{btx:sbl:inlinelong:seriesxref}
    \texdefinition{btx:sbl:inlinelong:publisher}
    \texdefinition{btx:sbl:inlinelong:ebook}
    \texdefinition{btx:sbl:inlinelong:doi}
    \texdefinition{btx:sbl:inlinelong:related}
  }
  \texdefinition{btx:sbl:inlinelong:note}
  \texdefinition{btx:sbl:inlinelong:loctext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlinelong:reference
  \fastsetup{btx:sbl:inlinelong:book}
\stopsetups

\startsetups btx:sbl:inlinelong:collection
  \fastsetup{btx:sbl:inlinelong:book}
\stopsetups

\startsetups btx:sbl:inlinelong:proceedings
  \fastsetup{btx:sbl:inlinelong:book}
\stopsetups

\startsetups btx:sbl:inlinelong:manual
  \fastsetup{btx:sbl:inlinelong:book}
\stopsetups

\startsetups btx:sbl:inlinelong:inbook
  % Only cite the author if the useauthor option is set
  \doifelse {\btxparameter{useauthor}} {\v!yes} {
    % If the titleauthor option is set, then cite the title first, followed by the author
    \doifelse {\btxparameter{titleauthor}} {\v!yes} {
      \texdefinition{btx:sbl:inlinelong:title}
      \texdefinition{btx:sbl:inlinelong:author-after-title}
    } {
      \texdefinition{btx:sbl:inlinelong:author}
      \texdefinition{btx:sbl:inlinelong:title}
    }  
  } {
    \texdefinition{btx:sbl:inlinelong:title}
  }
  % Only cite the cross-reference if the usecrossref option is set
  \doif {\btxparameter{usecrossref}} {\v!yes} {
    \texdefinition{btx:sbl:inlinelong:inbookcrossref}
  }
  % Only recursively cite publication data if the usepubl option is set
  \doif {\btxparameter{usepubl}} {\v!yes} {
    \texdefinition{btx:sbl:inlinelong:doi}
    \texdefinition{btx:sbl:inlinelong:related}
  }
  \texdefinition{btx:sbl:inlinelong:note}
  \texdefinition{btx:sbl:inlinelong:loctext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlinelong:inreference
  \fastsetup{btx:sbl:inlinelong:inbook}
\stopsetups

\startsetups btx:sbl:inlinelong:incollection
  \fastsetup{btx:sbl:inlinelong:inbook}
\stopsetups

\startsetups btx:sbl:inlinelong:inproceedings
  \fastsetup{btx:sbl:inlinelong:inbook}
\stopsetups

\startsetups btx:sbl:inlinelong:suppbook
  % Only cite the author if the useauthor option is set
  \doifelse {\btxparameter{useauthor}} {\v!yes} {
    % If the titleauthor option is set, then cite the title first, followed by the author
    \doifelse {\btxparameter{titleauthor}} {\v!yes} {
      \texdefinition{btx:sbl:inlinelong:title}
      \texdefinition{btx:sbl:inlinelong:author-after-title}
    } {
      \texdefinition{btx:sbl:inlinelong:author}
      \texdefinition{btx:sbl:inlinelong:title}
    }  
  } {
    \texdefinition{btx:sbl:inlinelong:title}
  }
  % Only cite the cross-reference if the usecrossref option is set
  \doif {\btxparameter{usecrossref}} {\v!yes} {
    \texdefinition{btx:sbl:inlinelong:suppbookcrossref}
  }
  % Only recursively cite publication data if the usepubl option is set
  \doif {\btxparameter{usepubl}} {\v!yes} {
    \texdefinition{btx:sbl:inlinelong:doi}
    \texdefinition{btx:sbl:inlinelong:related}
  }
  \texdefinition{btx:sbl:inlinelong:note}
  \texdefinition{btx:sbl:inlinelong:loctext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlinelong:ancienttext
  % Only cite the author if the useauthor option is set
  \doifelse {\btxparameter{useauthor}} {\v!yes} {
    % If the titleauthor option is set, then cite the title first, followed by the author
    \doifelse {\btxparameter{titleauthor}} {\v!yes} {
      \texdefinition{btx:sbl:inlinelong:title}
      % An ancienttext may not have an author, 
      % so be sure not to use one inherited from a cross-referenced source
      % TODO: This would mess up entries that correctly list the ancient author as the author of both the individual text and the volume;
      % the correct way to solve this is to have inherited field mappings properly implemented.
      \texdefinition{btx:sbl:doifownfield} {author} {
        \texdefinition{btx:sbl:inlinelong:author-after-title}
      }
    } {
      % An ancienttext may not have an author, 
      % so be sure not to use one inherited from a cross-referenced source
      % TODO: This would mess up entries that correctly list the ancient author as the author of both the individual text and the volume;
      % the correct way to solve this is to have inherited field mappings properly implemented.
      \texdefinition{btx:sbl:doifownfield} {author} {
        \texdefinition{btx:sbl:inlinelong:author}
      }
      \texdefinition{btx:sbl:inlinelong:title}
    }
  } {
    \texdefinition{btx:sbl:inlinelong:title}
  }
  % Only cite the cross-reference if the usecrossref option is set
  \doif {\btxparameter{usecrossref}} {\v!yes} {
    \texdefinition{btx:sbl:inlinelong:ancienttextcrossref}
  }
  % Only recursively cite publication data if the usepubl option is set
  \doif {\btxparameter{usepubl}} {\v!yes} {
    \texdefinition{btx:sbl:inlinelong:doi}
    \texdefinition{btx:sbl:inlinelong:related}
  }
  \texdefinition{btx:sbl:inlinelong:note}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlinelong:classictext
  % Only cite the author if the useauthor option is set
  \doifelse {\btxparameter{useauthor}} {\v!yes} {
    % If the titleauthor option is set, then cite the title first, followed by the author
    \doifelse {\btxparameter{titleauthor}} {\v!yes} {
      \texdefinition{btx:sbl:inlinelong:title}
      % A classictext may not have an author,
      % so be sure not to use one inherited from a cross-referenced source
      % TODO: This will mess up entries that correctly list the classical author as the author of both the individual text and the volume;
      % the correct way to solve this is to have inherited field mappings properly implemented.
      \texdefinition{btx:sbl:doifownfield} {author} {
        \texdefinition{btx:sbl:inlinelong:author-after-title}
      }
    } {
      % A classictext may not have an author, 
      % so be sure not to use one inherited from a cross-referenced source
      % TODO: This would mess up entries that correctly list the classical author as the author of both the individual text and the volume;
      % the correct way to solve this is to have inherited field mappings properly implemented.
      \texdefinition{btx:sbl:doifownfield} {author} {
        \texdefinition{btx:sbl:inlinelong:author}
      }
      \texdefinition{btx:sbl:inlinelong:title}
    }
  } {
    \texdefinition{btx:sbl:inlinelong:title}
  }
  % Only cite the cross-reference if the usecrossref option is set
  \doif {\btxparameter{usecrossref}} {\v!yes} {
    \texdefinition{btx:sbl:inlinelong:classictextcrossref}
  }
  % Only recursively cite publication data if the usepubl option is set
  \doif {\btxparameter{usepubl}} {\v!yes} {
    \texdefinition{btx:sbl:inlinelong:doi}
    \texdefinition{btx:sbl:inlinelong:related}
  }
  \texdefinition{btx:sbl:inlinelong:note}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlinelong:article
  % Only cite the author if the useauthor option is set
  \doifelse {\btxparameter{useauthor}} {\v!yes} {
    % If the titleauthor option is set, then cite the title first, followed by the author
    \doifelse {\btxparameter{titleauthor}} {\v!yes} {
      \texdefinition{btx:sbl:inlinelong:title}
      \texdefinition{btx:sbl:inlinelong:author-after-title}
    } {
      \texdefinition{btx:sbl:inlinelong:author}
      \texdefinition{btx:sbl:inlinelong:title}
    }  
  } {
    \texdefinition{btx:sbl:inlinelong:title}
  }
  % Only recursively cite publication data if the usepubl option is set
  \doif {\btxparameter{usepubl}} {\v!yes} {
    \texdefinition{btx:sbl:inlinelong:editortranslator}
    \texdefinition{btx:sbl:inlinelong:journalxref}
    \texdefinition{btx:sbl:inlinelong:doi}
    \texdefinition{btx:sbl:inlinelong:related}
  }
  \texdefinition{btx:sbl:inlinelong:note}
  \texdefinition{btx:sbl:inlinelong:loctext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlinelong:magazine
  \fastsetup{btx:sbl:inlinelong:article}
\stopsetups

\startsetups btx:sbl:inlinelong:newspaper
  \fastsetup{btx:sbl:inlinelong:article}
\stopsetups

\startsetups btx:sbl:inlinelong:periodical
  \fastsetup{btx:sbl:inlinelong:article}
\stopsetups

\startsetups btx:sbl:inlinelong:review
  % Only cite the author if the useauthor option is set
  \doifelse {\btxparameter{useauthor}} {\v!yes} {
    % If the titleauthor option is set, then cite the title first, followed by the author
    \doifelse {\btxparameter{titleauthor}} {\v!yes} {
      \texdefinition{btx:sbl:inlinelong:title}
      \texdefinition{btx:sbl:inlinelong:author-after-title}
    } {
      \texdefinition{btx:sbl:inlinelong:author}
      \texdefinition{btx:sbl:inlinelong:title}
    }  
  } {
    \texdefinition{btx:sbl:inlinelong:title}
  }
  % Only cite the cross-reference if the usecrossref option is set
  \doif {\btxparameter{usecrossref}} {\v!yes} {
    \texdefinition{btx:sbl:inlinelong:reviewcrossref}
  }
  % Only recursively cite publication data if the usepubl option is set
  \doif {\btxparameter{usepubl}} {\v!yes} {
    \texdefinition{btx:sbl:inlinelong:editortranslator}
    \texdefinition{btx:sbl:inlinelong:journalxref}
    \texdefinition{btx:sbl:inlinelong:doi}
    \texdefinition{btx:sbl:inlinelong:related}
  }
  \texdefinition{btx:sbl:inlinelong:note}
  \texdefinition{btx:sbl:inlinelong:loctext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlinelong:conferencepaper
  % Only cite the author if the useauthor option is set
  \doifelse {\btxparameter{useauthor}} {\v!yes} {
    % If the titleauthor option is set, then cite the title first, followed by the author
    \doifelse {\btxparameter{titleauthor}} {\v!yes} {
      \texdefinition{btx:sbl:inlinelong:title}
      \texdefinition{btx:sbl:inlinelong:author-after-title}
    } {
      \texdefinition{btx:sbl:inlinelong:author}
      \texdefinition{btx:sbl:inlinelong:title}
    }
  } {
    \texdefinition{btx:sbl:inlinelong:title}
  }
  % Only recursively cite publication data if the usepubl option is set
  \doif {\btxparameter{usepubl}} {\v!yes} {
    \texdefinition{btx:sbl:inlinelong:presentedat}
    \texdefinition{btx:sbl:inlinelong:doi}
    \texdefinition{btx:sbl:inlinelong:related}
  }
  \texdefinition{btx:sbl:inlinelong:note}
  \texdefinition{btx:sbl:inlinelong:loctext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlinelong:thesis
  % Only cite the author if the useauthor option is set
  \doifelse {\btxparameter{useauthor}} {\v!yes} {
    % If the titleauthor option is set, then cite the title first, followed by the author
    \doifelse {\btxparameter{titleauthor}} {\v!yes} {
      \texdefinition{btx:sbl:inlinelong:title}
      \texdefinition{btx:sbl:inlinelong:author-after-title}
    } {
      \texdefinition{btx:sbl:inlinelong:author}
      \texdefinition{btx:sbl:inlinelong:title}
    }  
  } {
    \texdefinition{btx:sbl:inlinelong:title}
  }
  % Only recursively cite publication data if the usepubl option is set
  \doif {\btxparameter{usepubl}} {\v!yes} {
    \texdefinition{btx:sbl:inlinelong:editortranslator}
    \texdefinition{btx:sbl:inlinelong:institution}
    \texdefinition{btx:sbl:inlinelong:doi}
    \texdefinition{btx:sbl:inlinelong:related}
  }
  \texdefinition{btx:sbl:inlinelong:note}
  \texdefinition{btx:sbl:inlinelong:loctext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlinelong:mastersthesis
  \fastsetup{btx:sbl:inlinelong:thesis}
\stopsetups

\startsetups btx:sbl:inlinelong:phdthesis
  \fastsetup{btx:sbl:inlinelong:thesis}
\stopsetups

\startsetups btx:sbl:inlinelong:unpublished
  % Only cite the author if the useauthor option is set
  \doifelse {\btxparameter{useauthor}} {\v!yes} {
    % If the titleauthor option is set, then cite the title first, followed by the author
    \doifelse {\btxparameter{titleauthor}} {\v!yes} {
      \texdefinition{btx:sbl:inlinelong:title}
      \texdefinition{btx:sbl:inlinelong:author-after-title}
    } {
      \texdefinition{btx:sbl:inlinelong:author}
      \texdefinition{btx:sbl:inlinelong:title}
    }
  } {
    \texdefinition{btx:sbl:inlinelong:title}
  }
  % Only recursively cite publication data if the usepubl option is set
  \doif {\btxparameter{usepubl}} {\v!yes} {
    \texdefinition{btx:sbl:inlinelong:editortranslator}
    \texdefinition{btx:sbl:inlinelong:doi}
    \texdefinition{btx:sbl:inlinelong:related}
  }
  \texdefinition{btx:sbl:inlinelong:note}
  \texdefinition{btx:sbl:inlinelong:loctext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlinelong:online
  % Only cite the author if the useauthor option is set
  \doifelse {\btxparameter{useauthor}} {\v!yes} {
    % If the titleauthor option is set, then cite the title first, followed by the author
    \doifelse {\btxparameter{titleauthor}} {\v!yes} {
      \texdefinition{btx:sbl:inlinelong:title}
      \texdefinition{btx:sbl:inlinelong:author-after-title}
    } {
      \texdefinition{btx:sbl:inlinelong:author}
      \texdefinition{btx:sbl:inlinelong:title}
    }
  } {
    \texdefinition{btx:sbl:inlinelong:title}
  }
  % Only recursively cite publication data if the usepubl option is set
  \doif {\btxparameter{usepubl}} {\v!yes} {
    \texdefinition{btx:sbl:inlinelong:editortranslator}
    \texdefinition{btx:sbl:inlinelong:eprint}
    \texdefinition{btx:sbl:inlinelong:related}
  }
  \texdefinition{btx:sbl:inlinelong:note}
  \texdefinition{btx:sbl:inlinelong:loctext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlinelong:electronic
  \fastsetup{btx:sbl:inlinelong:online}
\stopsetups

\startsetups btx:sbl:inlinelong:misc
  % Only cite the author if the useauthor option is set
  \doifelse {\btxparameter{useauthor}} {\v!yes} {
    % If the titleauthor option is set, then cite the title first, followed by the author
    \doifelse {\btxparameter{titleauthor}} {\v!yes} {
      \texdefinition{btx:sbl:inlinelong:title}
      \texdefinition{btx:sbl:inlinelong:author-after-title}
    } {
      \texdefinition{btx:sbl:inlinelong:author}
      \texdefinition{btx:sbl:inlinelong:title}
    }
  } {
    \texdefinition{btx:sbl:inlinelong:title}
  }
  % Only recursively cite publication data if the usepubl option is set
  \doif {\btxparameter{usepubl}} {\v!yes} {
    \texdefinition{btx:sbl:inlinelong:editortranslator}
    \texdefinition{btx:sbl:inlinelong:edition}
    \texdefinition{btx:sbl:inlinelong:volumes}
    \texdefinition{btx:sbl:inlinelong:seriesxref}
    \texdefinition{btx:sbl:inlinelong:journalxref}
    \texdefinition{btx:sbl:inlinelong:howpublished}
    \texdefinition{btx:sbl:inlinelong:publisher}
    \texdefinition{btx:sbl:inlinelong:institution}
    \texdefinition{btx:sbl:inlinelong:presentedat}
    \texdefinition{btx:sbl:inlinelong:doi}
    \texdefinition{btx:sbl:inlinelong:related}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

% Short inline citation setups
\startsetups btx:sbl:inlineshort:series
  \fastsetup{btx:sbl:inlineshort:book}
\stopsetups

\startsetups btx:sbl:inlineshort:journal
  \fastsetup{btx:sbl:inlineshort:series}
\stopsetups

\startsetups btx:sbl:inlineshort:mvbook
  \begingroup
  % If this entry has its own type, then it requires special handling
  \texdefinition{btx:sbl:doifownfieldelse} {type} {
    % If this entry is of type "seriesascollection", then cite the series (and number), followed by any cited page numbers
    \doif {\btxflush{type}} {seriesascollection} {
      \def\btxsblvolumebeforeloctext{yes}
      \texdefinition{btx:sbl:inlinelong:seriesxref}
    }
    % If this entry is of type "useseriesshorthand", then cite the shorthand of its series (without series and entry numbers) as its shorthand, followed by any cited page numbers
    \doif{\btxflush{type}}{useseriesshorthand} {
      \def\btxsblshorthandbeforeloctext{yes}
      % Is this a cross-reference to a separate entry for the series?
      \doifelse {\btxfoundname{series}} {seriesxref} {
        % If so, then recursively cite the shorthand for the series
        \def\seriesxreftag{\btxflush{series}}
        \textcite[alternative=inlineshort][\seriesxreftag]
        \btxspace
      } {
        % Otherwise, this field just contains the series shorthand or name; print it with the appropriate formatting
        \btxstartstyleandcolor[sbl:\s!list:title:series]
          \btxusecommand[sbl:\s!list:title:series] {
            \btxflush{series}% set the series name according to its style
          }
        \btxstopstyleandcolor
        \btxcomma
      }
    }
    % Otherwise, proceed normally
    \doifnotinset{\btxflush{type}}{seriesascollection, useseriesshorthand} {
      \btxdoifelse {shorthand} {
        \def\btxsblshorthandbeforeloctext{yes}
        \texdefinition{btx:sbl:inlineshort:shorthand}
      } {
        % Only cite the author if the useauthor option is set
        \doif {\btxparameter{useauthor}} {\v!yes} {
          \texdefinition{btx:sbl:inlineshort:author}
        }
        \texdefinition{btx:sbl:inlineshort:title}
      }
    }
  } {
    % Otherwise, proceed normally
    \btxdoifelse {shorthand} {
      \def\btxsblshorthandbeforeloctext{yes}
      \texdefinition{btx:sbl:inlineshort:shorthand}
    } {
      % Only cite the author if the useauthor option is set
      \doif {\btxparameter{useauthor}} {\v!yes} {
        \texdefinition{btx:sbl:inlineshort:author}
      }
      \texdefinition{btx:sbl:inlineshort:title}
    }
  }
  \texdefinition{btx:sbl:inlineshort:loctext}
  \endgroup
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlineshort:mvreference
  \fastsetup{btx:sbl:inlineshort:mvbook}
\stopsetups

\startsetups btx:sbl:inlineshort:mvcollection
  \fastsetup{btx:sbl:inlineshort:mvbook}
\stopsetups

\startsetups btx:sbl:inlineshort:mvproceedings
  \fastsetup{btx:sbl:inlineshort:mvbook}
\stopsetups

\startsetups btx:sbl:inlineshort:book
  \begingroup
  % If this entry has its own type, then check it requires special handling
  \texdefinition{btx:sbl:doifownfieldelse} {type} {
    % If this entry is of type "seriesascollection", then cite the series (and number), followed by any cited page numbers
    \doif {\btxflush{type}} {seriesascollection} {
      \def\btxsblvolumebeforeloctext{yes}
      \texdefinition{btx:sbl:inlinelong:seriesxref}
    }
    % If this entry is of type "useseriesshorthand", then cite the shorthand of its series (without series and entry numbers) as its shorthand, followed by any cited page numbers
    \doif {\btxflush{type}}{useseriesshorthand} {
      \def\btxsblshorthandbeforeloctext{yes}
      % Is this a cross-reference to a separate entry for the series?
      \doifelse {\btxfoundname{series}} {seriesxref} {
        % If so, then recursively cite the shorthand for the series
        \def\seriesxreftag{\btxflush{series}}
        \textcite[alternative=inlineshort][\seriesxreftag]
        \btxcomma
      } {
        % Otherwise, this field just contains the series shorthand or name; print it with the appropriate formatting
        \btxstartstyleandcolor[sbl:\s!list:title:series]
          \btxusecommand[sbl:\s!list:title:series] {
            \btxflush{series}% set the series name according to its style
          }
        \btxstopstyleandcolor
        \btxcomma
      }
    }
    % Otherwise, proceed normally
    \doifnotinset{\btxflush{type}}{seriesascollection, useseriesshorthand} {
      % Does this entry have its own title?
      \texdefinition{btx:sbl:doifownfieldelse} {title} {
        % If so, then use its own shorthand, if it has one;
        % otherwise, use the shorthand of the set containing it, if there is one;
        % otherwise, use its title
        \texdefinition{btx:sbl:doifownfieldelse} {shorthand} {
          \def\btxsblshorthandbeforeloctext{yes}
          \texdefinition{btx:sbl:inlineshort:shorthand}
        } {
          \btxdoifelse{crossref} {
            \def\crossreftag{\btxflush{crossref}}
            \def\btxsblvolumebeforeloctext{yes}
            \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{shorthand} {
              % If the set containing this entry has a shorthand, then cite it, followed by the volume and part of this entry
              \textcite[alternative=inlineshort][\crossreftag]
              \btxspace
              % Is there a volume series number preceding the volume?
              \btxdoif{volumeseries} {
                \btxflush{volumeseries}
                {/}
              }
              \btxflush{volume}
              \btxdoif{part} {
                \btxperiod
                \removeunwantedspaces
                \btxflush{part}
              }
              \btxcomma
            } {
              % Only cite the author if the useauthor option is set
              \doif {\btxparameter{useauthor}} {\v!yes} {
                \texdefinition{btx:sbl:inlineshort:author}
              }
              \texdefinition{btx:sbl:inlineshort:title}
            }
          } {
            % Only cite the author if the useauthor option is set
            \doif {\btxparameter{useauthor}} {\v!yes} {
              \texdefinition{btx:sbl:inlineshort:author}
            }
            \texdefinition{btx:sbl:inlineshort:title}
          }
        }
      } {
        % If not, then it is part of a multivolume set; do a short citation of the set followed by the volume and part of this entry
        \def\crossreftag{\btxflush{crossref}}
        \def\btxsblvolumebeforeloctext{yes}
        \textcite[alternative=inlineshort][\crossreftag]
        \btxcomma
        % If the set has a shorthand, then remove the preceding comma
        \clf_btxdoif{\currentbtxdataset}{\crossreftag}{shorthand} {
          \removeunwantedspaces
          \removepunctuation
          \btxspace
        }
        % Is there a volume series number preceding the volume?
        \btxdoif{volumeseries} {
          \btxflush{volumeseries}
          {/}
        }
        \btxflush{volume}
        \btxdoif{part} {
          \btxperiod
          \removeunwantedspaces
          \btxflush{part}
        }
        \btxcomma
      }
    }
  } {
    % Otherwise, proceed normally
    % Does this entry have its own title?
    \texdefinition{btx:sbl:doifownfieldelse} {title} {
      % If so, then use its own shorthand, if it has one;
      % otherwise, use the shorthand of the set containing it, if there is one;
      % otherwise, use its title
      \texdefinition{btx:sbl:doifownfieldelse} {shorthand} {
        \def\btxsblshorthandbeforeloctext{yes}
        \texdefinition{btx:sbl:inlineshort:shorthand}
      } {
        \btxdoifelse{crossref} {
          \def\crossreftag{\btxflush{crossref}}
          \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{shorthand} {
            \def\btxsblvolumebeforeloctext{yes}
            % If the set containing this entry has a shorthand, then cite it
            \textcite[alternative=inlineshort][\crossreftag]
            \btxspace
            % Is there a volume series number preceding the volume?
            \btxdoif{volumeseries} {
              \btxflush{volumeseries}
              {/}
            }
            \btxflush{volume}
            \btxdoif{part} {
              \btxperiod
              \removeunwantedspaces
              \btxflush{part}
            }
            \btxcomma
          } {
            % Only cite the author if the useauthor option is set
            \doif {\btxparameter{useauthor}} {\v!yes} {
              \texdefinition{btx:sbl:inlineshort:author}
            }
            \texdefinition{btx:sbl:inlineshort:title}
          }
        } {
          % Only cite the author if the useauthor option is set
          \doif {\btxparameter{useauthor}} {\v!yes} {
            \texdefinition{btx:sbl:inlineshort:author}
          }
          \texdefinition{btx:sbl:inlineshort:title}
        }
      }
    } {
      % If not, then it is part of a multivolume set; do a short citation of the set followed by the volume and part of this entry
      \def\btxsblvolumebeforeloctext{yes}
      \def\crossreftag{\btxflush{crossref}}
      \textcite[alternative=inlineshort][\crossreftag]
      \btxspace
      % Is there a volume series number preceding the volume?
      \btxdoif{volumeseries} {
        \btxflush{volumeseries}
        {/}
      }
      \btxflush{volume}
      \btxdoif{part} {
        \btxperiod
        \removeunwantedspaces
        \btxflush{part}
      }
      \btxcomma
    }
  }
  \texdefinition{btx:sbl:inlineshort:loctext}
  \endgroup
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlineshort:reference
  \fastsetup{btx:sbl:inlineshort:book}
\stopsetups

\startsetups btx:sbl:inlineshort:collection
  \fastsetup{btx:sbl:inlineshort:book}
\stopsetups

\startsetups btx:sbl:inlineshort:proceedings
  \fastsetup{btx:sbl:inlineshort:book}
\stopsetups

\startsetups btx:sbl:inlineshort:manual
  \fastsetup{btx:sbl:inlineshort:book}
\stopsetups

\startsetups btx:sbl:inlineshort:inbook
  % Only cite the author if the useauthor option is set
  \doif {\btxparameter{useauthor}} {\v!yes} {
    \texdefinition{btx:sbl:inlineshort:author}
  }
  \texdefinition{btx:sbl:inlineshort:title}
  \texdefinition{btx:sbl:inlineshort:loctext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlineshort:inreference
  % Only cite the author if the useauthor option is set
  \doif {\btxparameter{useauthor}} {\v!yes} {
    \texdefinition{btx:sbl:inlineshort:author}
  }
  \begingroup
  % This entry should be contained in a reference book,
  % but if it isn't, then just print its title
  \btxdoifelse{crossref} {
    % Does the book containing this entry belong to a multivolume set?
    \def\crossreftag{\btxflush{crossref}}
    \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{crossref} {
      % If so, does the multivolume set have a shorthand?
      \def\collectiontag{\clf_btxdirect{\currentbtxdataset}{\crossreftag}{crossref}}
      \clf_btxdoifelse{\currentbtxdataset}{\collectiontag}{shorthand} {
        % If so, then print the shorthand followed by the volume number (and any part numbers)
        \def\btxsblvolumebeforeloctext{yes}
        \texdefinition{btx:sbl:inlineshort:inbookcrossref}
      } {
        % If not, does the book containing this entry have a shorthand?
        \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{shorthand} {
          % If so, then print the shorthand followed by any part numbers
          \btxdoifelse {part} {
            \def\btxsblvolumebeforeloctext{yes}
          } {
            \def\btxsblshorthandbeforeloctext{yes}
          }
          \texdefinition{btx:sbl:inlineshort:inbookcrossref}
        } {
          % If not, then just print the title of this entry
          \texdefinition{btx:sbl:inlineshort:title}
        }
      }
    } {
      % If not, does the book containing this entry have a shorthand?
      \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{shorthand} {
        % If so, then print the shorthand followed by any part numbers
        \btxdoifelse {part} {
          \def\btxsblvolumebeforeloctext{yes}
        } {
          \def\btxsblshorthandbeforeloctext{yes}
        }
        \texdefinition{btx:sbl:inlineshort:inbookcrossref}
      } {
        % If not, then just print the title of this entry
        \texdefinition{btx:sbl:inlineshort:title}
      }
    }
  } {
    \texdefinition{btx:sbl:inlineshort:title}
  }
  \texdefinition{btx:sbl:inlineshort:loctext}
  \endgroup
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlineshort:incollection
  \fastsetup{btx:sbl:inlineshort:inbook}
\stopsetups

\startsetups btx:sbl:inlineshort:inproceedings
  \fastsetup{btx:sbl:inlineshort:inbook}
\stopsetups

\startsetups btx:sbl:inlineshort:suppbook
  % Only cite the author if the useauthor option is set
  \doif {\btxparameter{useauthor}} {\v!yes} {
    \texdefinition{btx:sbl:inlineshort:author}
  }
  \texdefinition{btx:sbl:inlineshort:suppbookcrossref}
  \texdefinition{btx:sbl:inlineshort:loctext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlineshort:ancienttext
  \texdefinition{btx:sbl:doifownfieldelse} {shorthand} {
    \texdefinition{btx:sbl:inlineshort:shorthand} % currentbtxaltloctext is handled in here
    \texdefinition{btx:sbl:inlineshort:ancienttextcrossref} % currentbtxloctext is handled in here
  } {
    % Only cite the author if the useauthor option is set
    \doif {\btxparameter{useauthor}} {\v!yes} {
      % An ancienttext may not have an author, 
      % so be sure not to use one inherited from a cross-referenced source
      \texdefinition{btx:sbl:doifownfield} {author} {
        \texdefinition{btx:sbl:inlineshort:author}
      }
    }
    \texdefinition{btx:sbl:inlineshort:title} % currentbtxaltloctext is handled in here
    \texdefinition{btx:sbl:inlineshort:ancienttextcrossref} % currentbtxloctext is handled in here
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlineshort:classictext
  \texdefinition{btx:sbl:doifownfieldelse} {shorthand} {
    \texdefinition{btx:sbl:inlineshort:shorthand}
    \texdefinition{btx:sbl:inlineshort:altloctext}
  } {
    % Only cite the author if the useauthor option is set
    \doif {\btxparameter{useauthor}} {\v!yes} {
      % A classictext may not have an author, 
      % so be sure not to use one inherited from a cross-referenced source
      % TODO: This would mess up entries that correctly list the classical author as the author of both the individual text and the volume;
      % the correct way to solve this is to have inherited field mappings properly implemented.
      \texdefinition{btx:sbl:doifownfield} {author} {
        \texdefinition{btx:sbl:inlineshort:author}
      }
    }
    \texdefinition{btx:sbl:inlineshort:classictexttitle} % currentbtxaltloctext is handled in here
    \texdefinition{btx:sbl:inlineshort:classictextcrossref} % currentbtxloctext is handled in here
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlineshort:article
  \fastsetup{btx:sbl:inlineshort:book}
\stopsetups

\startsetups btx:sbl:inlineshort:magazine
  \fastsetup{btx:sbl:inlineshort:article}
\stopsetups

\startsetups btx:sbl:inlineshort:newspaper
  \fastsetup{btx:sbl:inlineshort:article}
\stopsetups

\startsetups btx:sbl:inlineshort:periodical
  \fastsetup{btx:sbl:inlineshort:article}
\stopsetups

\startsetups btx:sbl:inlineshort:review
  % Print the author, then either the title (if there is one) or a summary of the review
  % Only cite the author if the useauthor option is set
  \doif {\btxparameter{useauthor}} {\v!yes} {
    \texdefinition{btx:sbl:inlineshort:author}
  }
  \texdefinition{btx:sbl:doifownfieldelse} {title} {
    \texdefinition{btx:sbl:inlineshort:title}
  } {
    \texdefinition{btx:sbl:inlineshort:reviewcrossref}
  }
  \texdefinition{btx:sbl:inlineshort:loctext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlineshort:thesis
  \fastsetup{btx:sbl:inlineshort:book}
\stopsetups

\startsetups btx:sbl:inlineshort:mastersthesis
  \fastsetup{btx:sbl:inlineshort:thesis}
\stopsetups

\startsetups btx:sbl:inlineshort:phdthesis
  \fastsetup{btx:sbl:inlineshort:thesis}
\stopsetups

\startsetups btx:sbl:inlineshort:conferencepaper
  \fastsetup{btx:sbl:inlineshort:book}
\stopsetups

\startsetups btx:sbl:inlineshort:unpublished
  \fastsetup{btx:sbl:inlineshort:book}
\stopsetups

\startsetups btx:sbl:inlineshort:online
  \fastsetup{btx:sbl:inlineshort:book}
\stopsetups

\startsetups btx:sbl:inlineshort:electronic
  \fastsetup{btx:sbl:inlineshort:online}
\stopsetups

\startsetups btx:sbl:inlineshort:misc
  \fastsetup{btx:sbl:inlineshort:book}
\stopsetups

%%%%%%%%%%%%%%%%%%%%%%%%%
% Cite alternative setups
%%%%%%%%%%%%%%%%%%%%%%%%%

% Lefttext citation setup
\startsetups btx:sbl:cite:lefttext {
  \doifnot{\btxparameter{lefttext}} {\empty} {
    \btxparameter{lefttext}
    % Remove any trailing space and replace it with a single space
    \removeunwantedspaces
    \btxspace
  }
}
\stopsetups

% Righttext citation setup
\startsetups btx:sbl:cite:righttext {
  \doifnot{\btxparameter{righttext}} {\empty} {
    % If the righttext starts with a punctuation mark, then remove any preceding space before typesetting it
    \btx_sbl_doifstartswithpunctelse{\btxparameter{righttext}} {
      \removeunwantedspaces
    } {
      \removeunwantedspaces
      \btxspace
    }
    \btxparameter{righttext}
  }
}
\stopsetups

% List citation setup
\startsetups btx:sbl:cite:entry
  \fastsetup{\s!btx:\s!cite:concat}
  \fastsetup{btx:sbl:cite:lefttext}
  \begingroup
  % Reset variables for new citation
  \def\currentbtxcitealternative{list}
  \def\currentbtxcategory{\btxfield{category}}
  \btxhandleciteentry
  \endgroup
  \fastsetup{btx:sbl:cite:righttext}
\stopsetups

% Long-form inline citation setup
\startsetups btx:sbl:cite:inlinelong
  \begingroup
  \def\currentbtxcitealternative{inlinelong}
  \def\currentbtxcategory{\btxfield{category}}
  \def\currentbtxloctext{\btxparameter{loctext}}
  \def\currentbtxaltloctext{\btxparameter{altloctext}}
  \fastsetup{btx:sbl:inlinelong:\currentbtxcategory}
  \endgroup
\stopsetups

% Short-form inline citation setup
\startsetups btx:sbl:cite:inlineshort
  \begingroup
  \def\currentbtxcitealternative{inlineshort}
  \def\currentbtxcategory{\btxfield{category}}
  \def\currentbtxloctext{\btxparameter{loctext}}
  \def\currentbtxaltloctext{\btxparameter{altloctext}}
  % If this entry has its own shorthand, then add it to the abbreviations list
  \texdefinition{btx:sbl:doifownfield} {shorthand} {
    % If the shorthand matches the shorttitle, then use the titleauthor option for the long-form citation;
    % otherwise, use the standard list entry variant.
    % NB: Alternate abbreviation lists (e.g., a separate one for the bibliography, or individual ones for journals, series, books, etc.)
    % could be used based on user settings if we replace "abbreviation" below with the appropriate name
    \doifelse {\btxflush{shorthand}} {\btxflush{shorttitle}} {
      %\expanded{\definesynonym[yes][abbreviation][\currentbtxtag]{\fastsetup{btx:sbl:cite:shorthand}}{\fastsetup{btx:sbl:cite:entry}\removepunctuation}}
      \expanded{\definesynonym[yes][abbreviation][\currentbtxtag]{\textcite[alternative=shorthand][\currentbtxtag]}{\textcite[alternative=entry,usecrossref=no,titleauthor=yes][\currentbtxtag]\removeunwantedspaces\removepunctuation}}
    } {
      %\expanded{\definesynonym[yes][abbreviation][\currentbtxtag]{\fastsetup{btx:sbl:cite:shorthand}}{\fastsetup{btx:sbl:cite:entry}\removepunctuation}}
      \expanded{\definesynonym[yes][abbreviation][\currentbtxtag]{\textcite[alternative=shorthand][\currentbtxtag]}{\textcite[alternative=entry,usecrossref=no,titleauthor=no][\currentbtxtag]\removeunwantedspaces\removepunctuation}}
    }
    \registersynonym[abbreviation][\currentbtxtag]% register as being printed in text, but don't print (we'll do that separately next)
  }
  \fastsetup{btx:sbl:inlineshort:\currentbtxcategory}
  \endgroup
\stopsetups

% Main inline citation setup
% This setup intelligently determines if it should use a long-form or short-form citation 
% based on existing citations and the fields of the entry being cited.
% For this reason, it should be the entry point for most biblatex-style citation macros (\autocite, \parencite, \footcite, \inlinecite)
\startsetups btx:sbl:cite:inline
  \fastsetup{\s!btx:\s!cite:concat}
  \fastsetup{btx:sbl:cite:lefttext}
  \begingroup
  \letbtxparameter{punct}\empty % don't pass the trailing punctuation down to any other setup
  \def\currentbtxcitealternative{inline}
  \def\currentbtxcategory{\btxfield{category}}
  \def\currentbtxloctext{\btxparameter{loctext}}
  \def\currentbtxaltloctext{\btxparameter{altloctext}}
  % If the useibid option is set and this entry matches the last one cited, then just print "ibid.", followed by any cited passages and page numbers
  \texdefinition{btx:sbl:doifibidelse} {\currentbtxtag} {
    \btxlabeltext{sbl:ibid}
    \btxcomma
    \doifelse {\currentbtxaltloctext} {\empty} {
      \texdefinition{btx:sbl:inlineshort:loctext}
    } {
      \texdefinition{btx:sbl:inlineshort:altloctext}
      \removeunwantedspaces
      \removepunctuation
      \btxspace
      \startparen
        \currentbtxloctext %don't redefine \loc to remove any preceding punctuation in this case
      \stopparen
    }
    \removeunwantedspaces
    \removepunctuation
  } {
    % Check if the entry with the current tag has been cited already
    \btxdoifelsecitedone\currentbtxdataset\currentbtxtag{
      % If it has been, then use a short-form citation
      \fastsetup{btx:sbl:cite:inlineshort}
    } {
      % Otherwise, invoke the appropriate setup according to the fields of the entry
      % If it has a shorthand, then use a short-form citation
      \texdefinition{btx:sbl:doifownfieldelse} {shorthand} {
        \fastsetup{btx:sbl:cite:inlineshort}
      } {
        % Otherwise, if this entry has its own type, then check if it requires special handling
        % TODO: This is probably better done through a biblatex-style options field
        \texdefinition{btx:sbl:doifownfieldelse} {type} {
          % If this entry is of type "useseriesshorthand", then cite the shorthand of its series (without series and entry numbers) as its shorthand, followed by any cited page numbers
          \doif{\btxflush{type}}{useseriesshorthand} {
            \def\btxsblshorthandbeforeloctext{yes}
            % Is this a cross-reference to a separate entry for the series?
            \doifelse {\btxfoundname{series}} {seriesxref} {
              % If so, then recursively cite the shorthand for the series
              \def\seriesxreftag{\btxflush{series}}
              \textcite[alternative=inlineshort][\seriesxreftag]
              \btxcomma
            } {
              % Otherwise, this field just contains the series shorthand or name; print it with the appropriate formatting
              \btxstartstyleandcolor[sbl:\s!list:title:series]
                \btxusecommand[sbl:\s!list:title:series] {
                  \btxflush{series}% set the series name according to its style
                }
              \btxstopstyleandcolor
              \btxcomma
            }
            \texdefinition{btx:sbl:inlineshort:loctext}
            \removeunwantedspaces
            \removepunctuation
          }
          % Otherwise, proceed normally
          \doifnotinset{\btxflush{type}}{useseriesshorthand} {
            \fastsetup{btx:sbl:cite:inlinelong}
          }
        } {
          % Otherwise, proceed normally
          \fastsetup{btx:sbl:cite:inlinelong}
        }
      }
    }
  }
  \endgroup
  \removeunwantedspaces
  \removepunctuation
  \fastsetup{btx:sbl:cite:righttext}
  \doifnot{\btxparameter{punct}}{\empty} {
    \btxparameter{punct}
  }
  % TODO: register this entry for ibid and idem tracking here, if this is not built into the \cite command
  %\setxvariables[btx:sbl][previousinlinetag=\currentbtxtag]
\stopsetups

% Inline parenthetical citation setup
\startsetups btx:sbl:cite:paren
  \begingroup
  \letbtxparameter{punct}\empty % don't pass the trailing punctuation down to the inline setup
  \startparen
    \fastsetup{btx:sbl:cite:inline}
    \removeunwantedspaces
    \removepunctuation
  \stopparen
  \endgroup
  \doifnot{\btxparameter{punct}}{\empty} {
    \btxparameter{punct}
  }
\stopsetups

% Inline footnote citation setup (with intelligent trailing punctuation replacement)
\startsetups btx:sbl:cite:footnote
  \removeunwantedspaces
  \doifinstring{\btxparameter{punct}}{\btxparameter{autopunctuation}}{\btxparameter{punct}}
  \begingroup
  \letbtxparameter{punct}\empty % don't pass the trailing punctuation down to the inline setup
  \let\doifendswithpunctelse\btx_sbl_doifendswithpunctelse % why is this necessary? For some reason, \btx_sbl_doifendswithpunctelse is not recognizd within the footnote environment...
  \startfootnote
    \Word{\fastsetup{btx:sbl:cite:inline}}% capitalize the first word in the footnote (needed to render "Ibid." and "Idem" correctly)
    % Add a closing period, unless the righttext ends with punctuation
    \doifendswithpunctelse{\btxparameter{righttext}} {
      \removeunwantedspaces
    } {
      \removeunwantedspaces
      \btxperiod
    }
  \stopfootnote
  \endgroup
  \doifnotinstring{\btxparameter{punct}}{\btxparameter{autopunctuation}}{\btxparameter{punct}}
\stopsetups

% Title citation setup
\startsetups btx:sbl:cite:title
  \begingroup
  \letbtxparameter{punct}\empty % don't pass the trailing punctuation down to any other setup
  \texdefinition{btx:sbl:inlinelong:title}
  \endgroup
  \removeunwantedspaces
  \removepunctuation
  \doifnot{\btxparameter{punct}}{\empty} {
    \btxparameter{punct}
  }
\stopsetups

% Shorthand citation setup
\startsetups btx:sbl:cite:shorthand
  \begingroup
  \letbtxparameter{punct}\empty % don't pass the trailing punctuation down to any other setup
  \def\currentbtxcitealternative{short}
  \def\currentbtxcategory{\btxfield{category}}
  \def\currentbtxloctext{\btxparameter{loctext}}
  \def\currentbtxaltloctext{\btxparameter{altloctext}}
  \texdefinition{btx:sbl:inlineshort:shorthand}
  \endgroup
  \removeunwantedspaces
  \removepunctuation
  \doifnot{\btxparameter{punct}}{\empty} {
    \btxparameter{punct}
  }
\stopsetups

% Volume (and part) number citation setup
\startsetups btx:sbl:cite:volume
  \begingroup
  \letbtxparameter{punct}\empty % don't pass the trailing punctuation down to any other setup
  \btxdoif{volume} {
    % Is there a volume series number preceding the volume?
    \btxdoif{volumeseries} {
      \btxflush{volumeseries}
      {/}
    }
    \btxflush{volume}
    \removeunwantedspaces
    \btxdoif{part} {
      \btxperiod
      \removeunwantedspaces
      \btxflush{part}
    }
  }
  \removeunwantedspaces
  \doifnot{\btxparameter{punct}}{\empty} {
    \removeunwantedspaces
    \removepunctuation
    \btxparameter{punct}
  }
  \endgroup
\stopsetups

% Define more concise biblatex-style citation commands

% default alternative citation
\def\autocite{\doquadrupleempty\doautocite}
\def\doautocite[#1][#2][#3][#4]#5#6{%
  \iffourthargument
    % if there are four optional arguments,
    % then assume that they are the prenote, the alternate locator, the locator, and the postnote, respectively
    \cite[lefttext={#1},altloctext={#2},loctext={#3},righttext={#4},punct={#6}][#5]%
  \else
    \ifthirdargument
      % if there are three optional arguments,
      % then assume that they are the alternate locator, the locator, and the postnote, respectively
      \cite[altloctext={#1},loctext={#2},righttext={#3},punct={#6}][#5]%
    \else
      \ifsecondargument
        % if there are two optional arguments,
        % then assume that they are the the locator and the postnote respectively
        \cite[loctext={#1},righttext={#2},punct={#6}][#5]%
      \else
        \iffirstargument
          % if there is only one optional argument,
          % then assume it is the postnote
          \cite[righttext={#1},punct={#6}][#5]%
        \else
          % if there are no optional arguments,
          % then just cite the entry by itself
          \cite[punct={#6}][#5]%
        \fi
      \fi
    \fi
  \fi
}

% inline citation (biblatex uses \textcite, but that is reserved for a different function in publ-ini.mkiv)
\def\inlinecite{\doquadrupleempty\doinlinecite}
\def\doinlinecite[#1][#2][#3][#4]#5#6{%
  \iffourthargument
    % if there are four optional arguments,
    % then assume that they are the prenote, the alternate locator, the locator, and the postnote, respectively
    \cite[alternative=inline,lefttext={#1},altloctext={#2},loctext={#3},righttext={#4},punct={#6}][#5]%
  \else
    \ifthirdargument
      % if there are three optional arguments,
      % then assume that they are the alternate locator, the locator, and the postnote, respectively
      \cite[alternative=inline,altloctext={#1},loctext={#2},righttext={#3},punct={#6}][#5]%
    \else
      \ifsecondargument
        % if there are two optional arguments,
        % then assume that they are the the locator and the postnote respectively
        \cite[alternative=inline,loctext={#1},righttext={#2},punct={#6}][#5]%
      \else
        \iffirstargument
          % if there is only one optional argument,
          % then assume it is the postnote
          \cite[alternative=inline,righttext={#1},punct={#6}][#5]%
        \else
          % if there are no optional arguments,
          % then just cite the entry by itself
          \cite[alternative=inline,punct={#6}][#5]%
        \fi
      \fi
    \fi
  \fi
}

% parenthetical citation
\def\parencite{\doquadrupleempty\doparencite}
\def\doparencite[#1][#2][#3][#4]#5#6{%
  \iffourthargument
    % if there are four optional arguments,
    % then assume that they are the prenote, the alternate locator, the locator, and the postnote, respectively
    \cite[alternative=paren,lefttext={#1},altloctext={#2},loctext={#3},righttext={#4},punct={#6}][#5]%
  \else
    \ifthirdargument
      % if there are three optional arguments,
      % then assume that they are the alternate locator, the locator, and the postnote, respectively
      \cite[alternative=paren,altloctext={#1},loctext={#2},righttext={#3},punct={#6}][#5]%
    \else
      \ifsecondargument
        % if there are two optional arguments,
        % then assume that they are the the locator and the postnote respectively
        \cite[alternative=paren,loctext={#1},righttext={#2},punct={#6}][#5]%
      \else
        \iffirstargument
          % if there is only one optional argument,
          % then assume it is the postnote
          \cite[alternative=paren,righttext={#1},punct={#6}][#5]%
        \else
          % if there are no optional arguments,
          % then just cite the entry by itself
          \cite[alternative=paren,punct={#6}][#5]%
        \fi
      \fi
    \fi
  \fi
}

% footnote citation
\def\footcite{\doquadrupleempty\dofootcite}
\def\dofootcite[#1][#2][#3][#4]#5#6{%
  \iffourthargument
    % if there are four optional arguments,
    % then assume that they are the prenote, the alternate locator, the locator, and the postnote, respectively
    \cite[alternative=footnote,lefttext={#1},altloctext={#2},loctext={#3},righttext={#4},punct={#6}][#5]%
  \else
    \ifthirdargument
      % if there are three optional arguments,
      % then assume that they are the alternate locator, the locator, and the postnote, respectively
      \cite[alternative=footnote,altloctext={#1},loctext={#2},righttext={#3},punct={#6}][#5]%
    \else
      \ifsecondargument
        % if there are two optional arguments,
        % then assume that they are the the locator and the postnote respectively
        \cite[alternative=footnote,loctext={#1},righttext={#2},punct={#6}][#5]%
      \else
        \iffirstargument
          % if there is only one optional argument,
          % then assume it is the postnote
          \cite[alternative=footnote,righttext={#1},punct={#6}][#5]%
        \else
          % if there are no optional arguments,
          % then just cite the entry by itself
          \cite[alternative=footnote,punct={#6}][#5]%
        \fi
      \fi
    \fi
  \fi
}

\stopbtxrenderingdefinitions
