%D \module
%D   [       file=publ-imp-sbl,
%D        version=2021.08.07,
%D          title=SBL bibliography style,
%D       subtitle=Publications,
%D         author=Joey McCollum,
%D           date=\currentdate,
%D      copyright={PRAGMA ADE \& \CONTEXT\ Development Team}]
%C
%C This module is part of the \CONTEXT\ macro||package and is therefore copyrighted
%D by \PRAGMA. See mreadme.pdf for details.

% NOTE FOR HANS: Because of cross-reference relationships between bibliographic entries that this rendering uses,
% I have had to use several low-level macros to retrieve fields from entries other than the current one.
% Specifically, these are \clf_btxfield, \clf_btxdirect, \clf_btxdoif, \clf_btxdoifelse, \clf_btxfoundname, and \clf_btxauthor.
% Higher-level helper functions should be defined to serve the same functions.

\startbtxrenderingdefinitions[sbl]

\ifdefined\c!translate \else \def\c!translate{translate} \fi

%D Reference:
%D \startTEX
%D @manual{SBLH2,
%D     title     ={Society of Biblical Literature Handbook of Style},
%D     shorttitle={SBLHS},
%D     shorthand ={SBLHS},
%D     edition   ={2},
%D     address   ={Atlanta, GA},
%D     publisher ={SBL Press},
%D     date      ={2014},
%D     Xpages    ={368},
%D     url       ={https://www.sbl-site.org/publications/sblhandbookofstyle.aspx},
%D }
%D \stopTEX

% set ALL specific SBL compliant values

\definebtx
  [sbl]
  [\c!default=default,
   \c!specification=sbl,
   \c!otherstext={\btxspace\btxlabeltext{others}},
   % TODO: the following fields are not language-sensitive and probably should be
   useibid=\v!no, % useibid=yes will enable abbreviation of consecutive citations of the same entry as "ibid."
   useidem=\v!no, % useidem=yes will enable abbreviation of an author cited multiple times consecutively as "idem"
   synonym=\v!abbreviation, % TODO: this can determine which synonyms set we will use for shorthands
   synonyms=\v!abbreviations, % TODO: this can determine which synonyms set we will use for shorthands
  %\c!journalconversion=\v!normal,
   \c!monthconversion=\v!month,
   \c!stopper:initials={. }, % with a (breakable) space
   \c!separator:names:2={\btxcomma}, % between subsequent names except for last 2
   \c!separator:names:3={\btxcomma\btxlabeltext{and}\space}, % between last 2 names if > 2
   \c!separator:names:4={\btxspace\btxlabeltext{and}\space}] % between only 2 names

% Because some common punctuation characters are escaped in publ-ini.mkiv,
% we have to set this option separately
\pushcatcodetable
\setcatcodetable\ctxcatcodes
  \setupbtx[sbl][autopunctuation={!,.:;?}]% undelimited list of trailing punctuation to move before footnote citations
\popcatcodetable

% First, define list and rendering parameters

% Sort the unnumbered rendered list by authortitle
\definebtxrendering
  [sbl]
  [\c!specification=sbl,
   \c!sorttype=authortitle, % defined in publ-aut.lua
   \c!numbering=\v!no] % by default, do not number bibliographic entries

% Print the bibliographic list as a paragraph, 
% with normal alignment settings (justified and with hyphenation)
\setupbtxlist
  [sbl]
  [\c!alternative=\v!paragraph,
   \c!align={normal,verytolerant,stretch},
  %\c!width=\v!fit,
  %\c!distance=.5\emwidth,
   \c!margin=3.5\emwidth]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% List citation field styles
%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\definebtx
  [sbl:\s!list]
  [sbl]
  [\c!otherstext={\btxspace\btxlabeltext{others}},
  \c!etallimit=,
  \c!etaldisplay=,
  \c!etaloption=last,
  \c!authorconversion=normal]

% First, we define a namespace for a few special fields (mostly names that require special handling)

\definebtx
  [sbl:\s!list:author]
  [sbl:\s!list]
  [\c!authorconversion=invertedfirst,
  \c!separator:names:4={\btxcomma\btxlabeltext{and}\space}] % between only 2 names

\definebtx
  [sbl:\s!list:withauthor]
  [sbl:\s!list]

\definebtx
  [sbl:\s!list:editor]
  [sbl:\s!list] % use normal authorconversion for editors who are in addition to authors (editors in place of authors should be handled by sbl:\s!list:author)

\definebtx
  [sbl:\s!list:witheditor]
  [sbl:\s!list]

\definebtx
  [sbl:\s!list:translator]
  [sbl:\s!list]

\definebtx
  [sbl:\s!list:withtranslator]
  [sbl:\s!list]

\definebtx
  [sbl:\s!list:suffix]
  [sbl:\s!list]

\definebtx
  [sbl:\s!list:url]
  [sbl:\s!list]

\definebtx
  [sbl:\s!list:doi]
  [sbl:\s!list]

\definebtx
  [sbl:\s!list:\s!page]
  [sbl:\s!list]

\definebtx
  [sbl:\s!list:numbering]
  [sbl:\s!list]
  [\c!right={\btxspace}]

\definebtx
  [sbl:\s!list:numbering:default]
  [sbl:\s!list:numbering]

\definebtx
  [sbl:\s!list:numbering:num]
  [sbl:\s!list:numbering]
  [\c!stopper={.}]

\definebtx
  [sbl:\s!list:numbering:short]
  [sbl:\s!list:numbering]

\definebtx
  [sbl:\s!list:numbering:tag]
  [sbl:\s!list:numbering]

\definebtx
  [sbl:\s!list:numbering:index]
  [sbl:\s!list:numbering]

% Since the title may be italicized or quoted depending on the entry category, 
% it will help to define a namespace for each category.
% Note that the namespacing is simply for clarity and convenience;
% to get ConTeXt to actually use category-dependent styles, we need to use the
% \btxstartstyleandcolor[sbl:\s!list:title:\currentbtxcategory] ... \btxstopstyleandcolor environment
% (to activate the style parameter)
% and the \btxusecommand[sbl:\s!list:title:\currentbtxcategory] command
% (to invoke the command parameter)

\starttexdefinition titleemph #1
  \emph{\Word{#1}}
\stoptexdefinition

\starttexdefinition titlequote #1
  \quotation{\Word{#1}}
\stoptexdefinition

\definebtx
  [sbl:\s!list:title]
  [sbl:\s!list]
  [\c!command=\titleemph, % by default, titles should be italicized and their first word capitalized
   \c!translate=\v!yes]

\definebtx
  [sbl:\s!list:title:mvbook]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:mvreference]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:mvcollection]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:mvproceedings]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:series]
  [sbl:\s!list:title]
  [\c!command=,] %disable italics and capitalization

\definebtx
  [sbl:\s!list:title:journal]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:book]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:reference]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:collection]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:proceedings]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:manual]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:inbook]
  [sbl:\s!list:title]
  [\c!command=\titlequote] % article title is quoted and its first word is capitalized

\definebtx
  [sbl:\s!list:title:inreference]
  [sbl:\s!list:title:inbook]

\definebtx
  [sbl:\s!list:title:incollection]
  [sbl:\s!list:title:inbook]

\definebtx
  [sbl:\s!list:title:inproceedings]
  [sbl:\s!list:title:inbook]

\definebtx
  [sbl:\s!list:title:article]
  [sbl:\s!list:title]
  [\c!command=\titlequote] % article title is quoted and its first word is capitalized

\definebtx
  [sbl:\s!list:title:magazine]
  [sbl:\s!list:title:article]

\definebtx
  [sbl:\s!list:title:newspaper]
  [sbl:\s!list:title:article]

\definebtx
  [sbl:\s!list:title:periodical]
  [sbl:\s!list:title:article]

\definebtx
  [sbl:\s!list:title:review]
  [sbl:\s!list:title:article]

\definebtx
  [sbl:\s!list:title:ancienttext]
  [sbl:\s!list:title:inbook]

\definebtx
  [sbl:\s!list:title:classictext]
  [sbl:\s!list:title]

\definebtx
  [sbl:\s!list:title:conferencepaper]
  [sbl:\s!list:title:inbook]

\definebtx
  [sbl:\s!list:title:thesis]
  [sbl:\s!list:title:unpublished]

\definebtx
  [sbl:\s!list:title:mastersthesis]
  [sbl:\s!list:title:thesis]

\definebtx
  [sbl:\s!list:title:phdthesis]
  [sbl:\s!list:title:thesis]

\definebtx
  [sbl:\s!list:title:unpublished]
  [sbl:\s!list:title]
  [\c!command=\titlequote] % unpublished title is quoted and its first word is capitalized

\definebtx
  [sbl:\s!list:title:online]
  [sbl:\s!list:title:unpublished]

\definebtx
  [sbl:\s!list:title:electronic]
  [sbl:\s!list:title:unpublished]

\definebtx
  [sbl:\s!list:title:misc]
  [sbl:\s!list:title:unpublished]

\definebtx
  [sbl:\s!list:title:literal]
  [sbl:\s!list:title:unpublished]

\definebtx
  [sbl:\s!list:date]
  [\c!command=\btx_sbl_convertdate] % convert dates in "YYYY-MM-DD" or "YYYY-MM" format to "d month year" or "month year" format

\definebtx
  [sbl:\s!list:pages]
  [\c!command=\btx_sbl_abbreviatepagerange] % truncate page ranges according to Chicago/SBL rules

\definebtx
  [sbl:\s!list:type]
  [\c!command=\Word] % always capitalize, as the type field will follow a period in the list entry

\definebtx
  [sbl:\s!list:edition]
  [\c!command=\btx_sbl_ordinal] % convert numerical edition fields to ordinal form

\definebtx
  [sbl:\s!list:note]
  [\c!command=\Word] % always capitalize, as the note field will follow a period in the list entry

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% In-text citation field styles
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% General rules to be inherited or excepted by other types of citations
\definebtx
  [sbl:\s!cite]
  [sbl]
  [\c!alternative=footnote, % by default, SBL uses footnote citation format (defined below)
   \c!otherstext={\btxspace\btxlabeltext{others}}, % use et al. for truncated author / editor list
   \c!etallimit=3, % don't use et al. for 3 or fewer authors
   \c!etaldisplay=1, % but if there are > 3, then only list the first explicitly
   \c!etaloption=last,
   \c!authorconversion=\v!normal, % by default, use normal name order for in-text citations
   % TODO: the following fields are not language-sensitive and probably should be
   printauthor=\v!yes, % printauthor=no will skip printing the author
   printpubl=\v!yes, % printpubl=no will skip printing the publication fields
   lefttext=\empty, % empty by default
   righttext=\empty, % empty by default
   punct=\empty, % trailing punctuation (empty by default)
   \c!sorttype=normal, % \v!normal ?
   \c!style=, % do not apply any styles across the whole citation
   \c!compress=\v!yes] % note that cite sorts only work with compress=yes.

% Just cite the author's last name
\definebtx
  [sbl:\s!cite:name]
  [sbl:\s!cite]
  [\c!authorconversion=\v!name]

% The alternatives that follow are not suggested by SBL,
% so perhaps they are not necessary?

% Just cite the author's last name in full followed by first names(s) in full
\definebtx
  [sbl:\s!cite:inverted]
  [sbl:\s!cite]
  [\c!authorconversion=\v!inverted]

% Cite the authors, with the first in inverted order and the rest in normal order
\definebtx
  [sbl:\s!cite:invertedfirst]
  [sbl:\s!cite]
  [\c!authorconversion=\v!invertedfirst]

% Just cite the author's last name in full followed by first initial(s)
\definebtx
  [sbl:\s!cite:invertedshort]
  [sbl:\s!cite]
  [\c!authorconversion=\v!invertedshort]

% Just cite the author's first initial(s) followed by last name in full
\definebtx
  [sbl:\s!cite:normalshort]
  [sbl:\s!cite]
  [\c!authorconversion=\v!normalshort]

% Just cite the author's name in full
\definebtx
  [sbl:\s!cite:normal]
  [sbl:\s!cite]
  [\c!authorconversion=\v!normal]

\definebtx
  [sbl:\s!cite:author]
  [sbl:\s!cite:normal]

\definebtx
  [sbl:\s!cite:lefttext]
  [sbl:\s!cite]

\definebtx
  [sbl:\s!cite:righttext]
  [sbl:\s!cite]

\definebtx
  [sbl:\s!cite:year]
  [sbl:\s!cite]
  [\c!separator:2={\btxcomma}, % between subsequent years except for last 2
   \c!separator:3={\btxcomma\btxlabeltext{and}\space}, % between last 2 years if > 2
   \c!separator:4={\btxspace\btxlabeltext{and}\space}] % between only 2 years

% these setups need to be explicitly defined in order to get cite rendering

\startsetups \s!btx:sbl:\s!cite:author
  \fastsetup{\s!btx:\s!cite:normal}
\stopsetups

% Citation rules for titles (italicize by default)
\definebtx
  [sbl:\s!cite:title]
  [sbl:\s!cite]
  [\c!separator:2={\btxcomma}, % between subsequent titles except for last 2
   \c!separator:3={\btxcomma\btxlabeltext{and}\space}, % between last 2 titles if > 2
   \c!separator:4={\btxspace\btxlabeltext{and}\space}, % between only 2 titles
   \c!command={\language[\currentbtxlanguage]}, % set the language to that of the entry with the current title
   \c!sorttype=none,
   \c!command=\titleemph]

\definebtx
  [sbl:\s!cite:title:journal]
  [sbl:\s!cite:title]

% Exceptional cases; these titles are only in quotations, not italicized
\definebtx
  [sbl:\s!cite:title:article]
  [sbl:\s!cite:title]
  [\c!command=\titlequote] % article title is quoted

\definebtx
  [sbl:\s!cite:title:magazine]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:newspaper]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:periodical]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:inbook]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:inproceedings]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:thesis]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:mastersthesis]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:phdthesis]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:unpublished]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:electronic]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:online]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:title:misc]
  [sbl:\s!cite:title:article]

\definebtx
  [sbl:\s!cite:tag]
  [sbl:\s!cite]
  [\c!left={[},
   \c!right={]}]

\definebtx
  [sbl:\s!cite:index]
  [sbl:\s!cite]
  [\c!left={[},
   \c!right={]}]

% Page number citations
\definebtx
  [sbl:\s!cite:page]
  [sbl:\s!cite]
  [\c!left=,
   \c!right=,
   \c!command=\btx_sbl_abbreviatepagerange, % truncate page ranges according to Chicago/SBL rules
   \c!separator:2={\btxcomma}, % between subsequent page ranges except for last 2
   \c!separator:3={\btxcomma\btxlabeltext{and}\space}, % between last 2 page ranges if > 2
   \c!separator:4={\btxspace\btxlabeltext{and}\space}] % between only 2 page ranges

\definebtx
  [sbl:\s!cite:pages]
  [sbl:\s!cite:page]

\definebtx
  [sbl:\s!cite:keywords]
  [sbl:\s!cite]

\definebtx
  [sbl:\s!cite:short]
  [sbl:\s!cite:name]

\definebtx
  [sbl:\s!cite:category]
  [sbl:\s!cite]

\definebtx
  [sbl:\s!cite:url]
  [sbl:\s!cite]
  [\c!left={(},
   \c!right={)}]

\definebtx
  [sbl:\s!cite:doi]
  [sbl:\s!cite:url]

% LaTeX-style bibliography entry number citation
\definebtx
  [sbl:\s!cite:num]
  [sbl:\s!cite]
  [\c!left={[},
   \c!right={]},
   \c!separator:2={,}, % between subsequent reference numbers except for last 2
   \c!separator:3=\btxparameter{\c!separator:2}, % between last 2 reference numbers if > 2
   \c!separator:4=\btxparameter{\c!separator:2}] % between only 2 reference numbers

% LaTeX \ref-style bibliography entry number citation
\definebtx
  [sbl:\s!cite:textnum]
  [sbl:\s!cite:num]
  [\c!left={Ref.\nbsp},
   \c!right=,
   \c!separator:2={\btxcomma}, % between subsequent reference numbers except for last 2
   \c!separator:3={\btxspace\btxlabeltext{and}\space}, % between last 2 reference numbers if > 2
   \c!separator:4={\btxspace\btxlabeltext{and}\space}] % between only 2 reference numbers

% Define default settings for citations that replicate list entries
\definebtx
  [sbl:\s!cite:entry]
  [sbl:\s!cite]
  [\c!separator:2={\btxsemicolon}, % between subsequent citations except for last 2
   \c!separator:3={\btxsemicolon\btxlabeltext{and}\space}, % between last 2 citations if > 2
   \c!separator:4={\btxsemicolon\btxlabeltext{and}\space}] % between only 2 citations

% Inline citations are similar to list entry citations, 
% but they have slightly different rules for punctuation and capitalization for fields
\definebtx
  [sbl:\s!cite:inline]
  [sbl:\s!cite]
  [\c!separator:2={\btxsemicolon}, % between subsequent citations except for last 2
   \c!separator:3={\btxsemicolon\btxlabeltext{and}\space}, % between last 2 citations if > 2
   \c!separator:4={\btxsemicolon\btxlabeltext{and}\space}] % between only 2 citations

% List subcitations are similar to list citations
\definebtx
  [sbl:\s!cite:listsubcite]
  [sbl:\s!cite:entry]

% Inline subcitations are similar to inline citations
\definebtx
  [sbl:\s!cite:inlinesubcite]
  [sbl:\s!cite:inline]

% Parenthetical citations should be rendered exactly like inline citations, 
% but the whole citation should be surrounded by parentheses, 
% and brackets should be used where parentheses are within the citation 
% (e.g., journal years and publication and institution blocks) 
\definebtx
  [sbl:\s!cite:paren]
  [sbl:\s!cite:inline]
  [\c!left={\startparen},
   \c!right={\stopparen}]

% Citations in footnotes (and endnotes, for the philistines who use them) should be rendered exactly like citations in the text, 
% but followed by a period and placed in footnotes
\definebtx
  [sbl:\s!cite:footnote]
  [sbl:\s!cite:inline]

% By default, SBL uses inline format for in-text citations
\definebtx
  [sbl:\s!cite:default]
  [sbl:\s!cite:inline]

% Volume (and part) number citations
\definebtx
  [sbl:\s!cite:volume]
  [sbl:\s!cite:page]

% Now we setup for the details of the renderings

%D Sometimes we have verbose injections in an entry and these can be language
%D dependent, so we use labels.
%D
%D Because we want to mix rendering (in the manual) we need a namespace in label
%D texts:

\setupbtxlabeltext
  [en]
  [
  sbl:ibid={ibid.},
  sbl:idem={idem},
  sbl:edition={ed.},
  sbl:editionfull={edition},
  sbl:editor={ed.},
  sbl:editors={eds.},
  sbl:Page={Page},
  sbl:Pages={Pages},
  sbl:here={here},
  sbl:edited={edited},
  sbl:Edited={Edited},
  sbl:translator={trans.},
  sbl:translated={translated},
  sbl:Translated={Translated},
  sbl:volume={vol.},
  sbl:Volume={Vol.},
  sbl:volumes={vols.},
  sbl:Volumes={Vols.},
  sbl:part={part},
  sbl:parts={parts},
  sbl:masters={Master's},
  sbl:thesis={thesis},
  sbl:phd={PhD},
  sbl:diss={diss.},
  sbl:reprint={repr.},
  sbl:Reprint={Repr.},
  sbl:paperpresentedat={paper presented at},
  sbl:Paperpresentedat={Paper presented at},
  sbl:with={with},
  sbl:by={by},
  sbl:in={in},
  sbl:In={In},
  sbl:of={of},
  sbl:to={to},
  sbl:released={released},
  sbl:Released={Released},
  sbl:reviewof={review of},
  sbl:Reviewof={Review of},
  sbl:translationof={trans. of},
  sbl:Translationof={Translation of},
  sbl:reprintof={repr. of},
  sbl:Reprintof={Reprint of}
  ]

% First some helpers:

%Setup nested quotation handling (e.g., article titles with quotes)
\setupdelimitedtext[quotation:1][left={\symbol[leftquotation]},right={\symbol[rightquotation]}]
\setupdelimitedtext[quotation:2][left={\symbol[leftquote]}, right={\symbol[rightquote]}]
\setupdelimitedtext[quotation:3][left={\symbol[leftquotation]},right={\symbol[rightquotation]}]
\setupdelimitedtext[quotation:4][left={\symbol[leftquote]}, right={\symbol[rightquote]}]

% Nested parentheses (used for things like publisher and institution blocks) should alternate between proper parentheses and brackets
\definedelimitedtext[paren][quotation][location=text,left={(},right={)}]
\setupdelimitedtext[paren:1][left={(},right={)}]
\setupdelimitedtext[paren:2][left={[}, right={]}]
\setupdelimitedtext[paren:3][left={(},right={)}]
\setupdelimitedtext[paren:4][left={[}, right={]}]

% Setup abbreviation settings
\definesynonyms[abbreviation][abbreviations][\infull][\inshort] % we need the \inshort command to access abbreviations by their entry tag

% Various Lua macros for parsing and conversion
\startluacode
  publications.btx = publications.btx or {}

  local sbl = {}
  publications.btx.sbl = sbl

  function sbl.regexsplit(str, regex)
    -- by default, split on whitespace
    if regex == nil then
      regex = "%s+"
    end
    local splits = {}
    local i = 1
    local next_start = 0
    local next_end = 0
    while true do
      -- get the next occurrence of the separator pattern
      next_start, next_end = string.find(str, regex, i) -- find next occurrence of separator pattern
      if next_start == nil then
        -- if there isn't one, then add the suffix of the input string starting at the current index and exit the loop
        table.insert(splits, string.sub(str, i, string.len(str)))
        break
      else
        -- if there is, then add the substring between the current index and the start of the match,
        -- then update the current index
        table.insert(splits, string.sub(str, i, next_start - 1))
        i = next_end + 1
      end
    end
    return splits
  end

  function sbl.doifprefix(prefix, str, ifyes)
    -- if the given string is a prefix of the given string, then print the "ifyes" argument
    if string.sub(str, 1, string.len(prefix)) == prefix then
      context(ifyes)
    end
  end

  function sbl.doifprefixelse(prefix, str, ifyes, ifno)
    -- if the given string is a prefix of the given string, then print the ifyes argument; otherwise, print the ifno argument
    if string.sub(str, 1, string.len(prefix)) == prefix then
      context(ifyes)
    else
      context(ifno)
    end
  end

  function sbl.hasvolumepartprefix(str)
    if string.match(str, "^[%d%.]*%d+:") then
      return(true)
    end
    return(false)
  end

  function sbl.doifhasvolumepartprefix(str, ifyes)
    if sbl.hasvolumepartprefix(str) then
      context(ifyes)
    end
  end

  function sbl.doifhasvolumepartprefixelse(str, ifyes, ifno)
    if sbl.hasvolumepartprefix(str) then
      context(ifyes)
    else
      context(ifno)
    end
  end

  function sbl.ispagerange(str)
    -- a page citation may consist of several page ranges separated by commas (and whitespace)
    if string.count(str, ",%s*") > 0 then
      -- if so, then split it along these separators and recursively test all of them
      --local commasplitter = string.wordsplitter(",") -- when Hans adds it
      local components = sbl.regexsplit(str, ",%s*")
      for i=1,#components do
        if not sbl.ispagerange(components[i]) then
          return false
        end
      end
      return true
    end
    -- a colon may separate volume (and part) numbers from the page range proper
    if string.count(str, ":") > 0 then
      -- if so, then split it and recursively test the substring after the colon
      local left = string.split(str, ":")[1]
      local right = string.split(str, ":")[2]
      if sbl.ispagerange(right) then
        return true
      end
      return(false)
    end
    -- otherwise, just make sure that the input matches the pattern for a page range
    if string.match(str, "^%d+%-%-%d+$") then
      return(true)
    end
    return(false)
  end

  function sbl.doifpagerange(str, ifyes)
    if sbl.ispagerange(str) then
      context(ifyes)
    end
  end

  function sbl.doifpagerangeelse(str, ifyes, ifno)
    if sbl.ispagerange(str) then
      context(ifyes)
    else
      context(ifno)
    end
  end

  function sbl.ordinal(num)
    -- if the input is not a number, then print is as-is;
    -- otherwise, strip it of any leading zeroes (which may have been included for sorting purposes)
    if not tonumber(num) then
      context(num)
      return
    else
      num = tostring(tonumber(num))
    end
    if string.sub(num, -2, -1) == "11" or string.sub(num, -2, -1) == "12" or string.sub(num, -2, -1) == "13" then
      context("%sth", num)
      return
    end
    if string.sub(num, -1, -1) == "1" then
      context("%sst", num)
      return
    end
    if string.sub(num, -1, -1) == "2" then
      context("%snd", num)
      return
    end
    if string.sub(num, -1, -1) == "3" then
      context("%srd", num)
      return
    else
      context("%sth", num)
      return
    end
  end

  function sbl.abbreviatepagerange(pages)
    -- if this is not a page range, then print it as-is
    if string.count(pages, "%-%-") == 0 then
      context(pages)
      return
    end
    -- if the page range is prefixed with volume and part numbers, followed by a colon 
    -- then recursively process the actual page range 
    -- and add the prefix back when we're done
    if string.count(pages, ":") > 0 then
      local volume_prefix = string.split(pages, ":")[1]
      local pages_in_volume = string.split(pages, ":")[2]
      context("%s:", volume_prefix)
      sbl.abbreviatepagerange(pages_in_volume)
      return
    end
    -- if this is a disjoint set of page ranges separated by commas (and possibly whitespace),
    -- then recursively convert each one, separating them by a comma and a single space
    local page_ranges = sbl.regexsplit(pages, ",%s*")
    if #page_ranges > 1 then
      for i=1,#page_ranges do
        sbl.abbreviatepagerange(page_ranges[i])
        if i < #page_ranges then
          context(", ")
        end
      end
      return
    end
    -- if this is a single page range, then truncate according to Chicago/SBL's horrendous rules
    -- (§4.2.3)
    local start_page = string.split(pages, "--")[1]
    local end_page = string.split(pages, "--")[2]
    -- if either page number is not an Arabic numeral (e.g., Roman numerals),
    -- then print the range as-is
    if not tonumber(start_page) or not tonumber(end_page) then
      context(pages)
      return
    end
    -- otherwise, if the second page number is smaller than the first page number, then print the range as-is 
    -- (this shouldn't happen unless users are already applying this rule)
    if tonumber(end_page) < tonumber(start_page) then
      context(pages)
      return
    end
    -- otherwise, if the second page number is equal to the first page number, then the "range" is just a single page;
    -- print just the first page number
    if tonumber(end_page) == tonumber(start_page) then
      context(start_page)
      return
    end
    -- otherwise, if the second page number has more digits than the first page number, then print the range as-is
    if string.len(end_page) > string.len(start_page) then
      context(pages)
      return
    end
    -- otherwise, if both numbers are fewer than three digits, then print the range as-is
    if string.len(start_page) < 3 then
      context(pages)
      return
    end
    -- otherwise, if the first page number ends in 00, then print the range as-is
    if string.sub(start_page, -2, -1) == "00" then
      context(pages)
      return
    end
    -- otherwise, if both page numbers end in 01-09, then only use the last digit of the end page in the range
    if tonumber(string.sub(start_page, -2, -1)) < 10 and tonumber(string.sub(end_page, -2, -1)) < 10 then
      context("%s--%s", start_page, string.sub(end_page, -1, -1))
      return
    end
    -- otherwise, find the first digit at which the two numbers differ 
    -- and only use the suffix starting from that position of the end page in the range
    -- unless it is the last position, in which case use the last two digits
    local index = 1
    while string.sub(start_page, 1, index) == string.sub(end_page, 1, index) do
      index = index + 1
    end
    if index == string.len(start_page) then
      index = index - 1
    end
    context("%s--%s", start_page, string.sub(end_page, index, -1))
    return
  end
	
  function sbl.convertdate(date)
    -- if the date is a string without date formatting (e.g., "forthcoming", or a single year), then return it as-is
    if string.count(date, "%-") == 0 then
      context(date)
      return
    end
    -- if the date is a range of years, then return it as-is
    if string.count(date, "%-%-") > 0 then
      context(date)
      return
    end
    local components = string.split(date, "-")
    if #components == 1 then
      context.date({y = components[1]}, {"year"})
      return
    end
    if #components == 2 then
      context.date({y = components[1], m = components[2]}, {"month,year"})
      return
    end
    if #components == 3 then
      context.date({y = components[1], m = components[2], d = components[3]}, {"d,month,year"})
      return
    else
      context(date)
      return
    end
  end

  function sbl.serializelocationpublisher(location, publisher)
    -- split all fields into arrays of components separated by the word "and"
    --local andsplitter = string.wordsplitter("and") -- when Hans adds it
    --local locations = wordsplitter(location)
    --local publishers = wordsplitter(publisher)
    local locations = sbl.regexsplit(location, "%s+and%s+")
    local publishers = sbl.regexsplit(publisher, "%s+and%s+")
    -- if the locations array is shorter than the publishers array (because we may be citing multiple publishers in the same city), 
    -- then pad it with its last value (if it has one) until it is the same length
    while #locations < #publishers do
      if locations[#locations] and locations[#locations] ~= "" then
        table.insert(locations, locations[#locations])
      else
        break
      end
    end
    for i=1,#publishers do
      context("%s: %s", locations[i], publishers[i])
      if i < #publishers then
        context("; ")
      end
    end
  end

  function sbl.serializevolumenumberdatepage(volume, number, date, page)
    -- split all fields into arrays of components separated by the word "and"
    --local andsplitter = string.wordsplitter("and") -- when Hans adds it
    --local volumes = andsplitter(volume)
    --local numbers = andsplitter(number)
    --local dates = andsplitter(date)
    --local pages = andsplitter(page)
    local volumes = {}
    if string.count(volume, "%s+and%s+") > 0 then
      volumes = sbl.regexsplit(volume, "%s+and%s+")
    else
      if volume and volume ~= "" then
        table.insert(volumes, volume)
      end
    end
    local numbers = {}
    if string.count(number, "%s+and%s+") > 0 then
      numbers = sbl.regexsplit(number, "%s+and%s+")
    else
      if number and number ~= "" then
        table.insert(numbers, number)
      end
    end
    local dates = {}
    if string.count(date, "%s+and%s+") > 0 then
      dates = sbl.regexsplit(date, "%s+and%s+")
    else
      if date and date ~= "" then
        table.insert(dates, date)
      end
    end
    local pages = {}
    if string.count(page, "%s+and%s+") > 0 then
      pages = sbl.regexsplit(page, "%s+and%s+")
    else
      if page and page ~= "" then
        table.insert(pages, page)
      end
    end
    -- pad all arrays until they are the length of the longest array
    local max_len = math.max(#volumes, #numbers, #dates, #pages)
    while #volumes < max_len do
      if volumes[#volumes] and volumes[#volumes] ~= "" then
        table.insert(volumes, volumes[#volumes])
      else
        table.insert(volumes, "")
      end
    end
    while #numbers < max_len do
      if numbers[#numbers] and numbers[#numbers] ~= "" then
        table.insert(numbers, numbers[#numbers])
      else
        table.insert(numbers, "")
      end
    end
    while #dates < max_len do
      if dates[#dates] and dates[#dates] ~= "" then
        table.insert(dates, dates[#dates])
      else
        table.insert(dates, "")
      end
    end
    while #pages < max_len do
      if pages[#pages] and pages[#pages] ~= "" then
        table.insert(pages, pages[#pages])
      else
        table.insert(pages, "")
      end
    end
    -- now print all fields together
    for i=1,max_len do
      if volumes[i] ~= "" then
        context(" ") -- add a space to follow the journal name
        context("%s", volumes[i])
        if numbers[i] ~= "" then
          context(".%s", numbers[i])
        end
      end
      -- we replace surrounding parentheses and colons with commas if it is a full date
      if string.find(dates[i], "%d%d%d%d%-%d%d%-%d%d") then
        context(", ")
        sbl.convertdate(dates[i])
        context(",")
      else
        context(" (")
        sbl.convertdate(dates[i])
        context("):")
      end
      if pages[i] ~= "" then
        context(" ")
        sbl.abbreviatepagerange(pages[i])
      end
      if i < max_len then
        context(";")
      end
    end
  end
\stopluacode
\def\btx_sbl_doifprefix#1#2#3{\ctxlua{publications.btx.sbl.doifprefix([==[#1]==],[==[#2]==],[==[#3]==])}}
\def\btx_sbl_doifprefixelse#1#2#3#4{\ctxlua{publications.btx.sbl.doifprefixelse([==[#1]==],[==[#2]==],[==[#3]==],[==[#4]==])}}
\def\btx_sbl_doifhasvolumepartprefix#1#2{\ctxlua{publications.btx.sbl.doifhasvolumepartprefix([==[#1]==],[==[#2]==])}}
\def\btx_sbl_doifhasvolumepartprefixelse#1#2#3{\ctxlua{publications.btx.sbl.doifhasvolumepartprefixeelse([==[#1]==],[==[#2]==],[==[#3]==])}}
\def\btx_sbl_doifpagerange#1#2{\ctxlua{publications.btx.sbl.doifpagerange([==[#1]==],[==[#2]==])}}
\def\btx_sbl_doifpagerangeelse#1#2#3{\ctxlua{publications.btx.sbl.doifpagerangeelse([==[#1]==],[==[#2]==],[==[#3]==])}}
\def\btx_sbl_ordinal#1{\ctxlua{publications.btx.sbl.ordinal([==[#1]==])}}
\def\btx_sbl_abbreviatepagerange#1{\ctxlua{publications.btx.sbl.abbreviatepagerange([==[#1]==])}}
\def\btx_sbl_convertdate#1{\ctxlua{publications.btx.sbl.convertdate([==[#1]==])}}
\def\btx_sbl_serializelocationpublisher#1#2{\ctxlua{publications.btx.sbl.serializelocationpublisher([==[#1]==],[==[#2]==])}}
\def\btx_sbl_serializevolumenumberdatepage#1#2#3#4{\ctxlua{publications.btx.sbl.serializevolumenumberdatepage([==[#1]==],[==[#2]==],[==[#3]==],[==[#4]==])}}

\starttexdefinition btx:sbl:doifsamefield #1#2#3#4
  % If two input entry tags (#1 and #2) have the same field (#3),
  % then execute input #4
  \doif {\clf_btxdirect{\currentbtxdataset}{#1}{#3}} {\clf_btxdirect{\currentbtxdataset}{#2}{#3}} {
    {#4}
  }
\stoptexdefinition

\starttexdefinition btx:sbl:doifnotsamefield #1#2#3#4
  % If two input entry tags (#1 and #2) do not have the same field (#3),
  % then execute input #4
  \doifnot {\clf_btxdirect{\currentbtxdataset}{#1}{#3}} {\clf_btxdirect{\currentbtxdataset}{#2}{#3}} {
    {#4}
  }
\stoptexdefinition

\starttexdefinition btx:sbl:doifsamefieldelse #1#2#3#4#5
  % If two input entry tags (#1 and #2) have the same field (#3),
  % then execute input #4; otherwise, execute input #5
  \doifelse {\clf_btxdirect{\currentbtxdataset}{#1}{#3}} {\clf_btxdirect{\currentbtxdataset}{#2}{#3}} {
    {#4}
  } {
    {#5}
  }
\stoptexdefinition

\starttexdefinition btx:sbl:doifsameauthorelse #1#2#3#4
  % If two input entry tags (#1 and #2) have the same author (and contributing/assisting author) fields
  % (not including editors in the place of authors),
  % then execute input #3; otherwise, execute input #4
  \texdefinition{btx:sbl:doifsamefieldelse} {#1}{#2}{author} {
    % Are the assisting authors identical?
    \texdefinition{btx:sbl:doifsamefieldelse} {#1}{#2}{withauthor} {
      {#3}
    } {
      {#4}
    }
  } {
    {#4}
  }
\stoptexdefinition

\starttexdefinition btx:sbl:doifsameeditorelse #1#2#3#4
  % If two input entry tags (#1 and #2) have the same editor (and contributing/assisting editor) fields, 
  % then execute input #3; otherwise, execute input #4
  \texdefinition{btx:sbl:doifsamefieldelse} {#1}{#2}{editor} {
    % Are the assisting editors identical?
    \texdefinition{btx:sbl:doifsamefieldelse} {#1}{#2}{witheditor} {
      {#3}
    } {
      {#4}
    }
  } {
    {#4}
  }
\stoptexdefinition

% Define some helper functions for subcitations
\starttexdefinition btx:sbl:doifsamefoundnameauthorelse #1#2#3#4
  % If two input entry tags (#1 and #2) have the same found-name author (and contributing/assisting author) fields
  % (i.e., author, editor, or in some cases, organization),
  % then execute input #3; otherwise, execute input #4
  \doifelse {\clf_btxfoundname{\currentbtxdataset}{#1}{author}} {\clf_btxfoundname{\currentbtxdataset}{#2}{author}} {
    \doifelse {\clf_btxfoundname{\currentbtxdataset}{#1}{author}} {editor} {
      % Are the editors identical?
      \texdefinition{btx:sbl:doifsameeditorelse} {#1}{#2} {
        {#3}
      } {
        {#4}
      }
    } {
      % Are the authors identical?
      \texdefinition{btx:sbl:doifsameauthorelse} {#1}{#2} {
        {#3}
      } {
        {#4}
      }
    }
  } {
    {#4}
  }
\stoptexdefinition

\starttexdefinition btx:sbl:doifsametitleelse #1#2#3#4
  % If two input entry tags (#1 and #2) have the same title and subtitle,
  % then execute input #3; otherwise, execute input #4
  \texdefinition{btx:sbl:doifsamefieldelse}{#1}{#2}{title} {
    \texdefinition{btx:sbl:doifsamefieldelse}{#1}{#2}{subtitle} {
      {#3}
    } {
      {#4}
    }
  } {
    {#4}
  }
\stoptexdefinition

\starttexdefinition btx:sbl:doifownfield #1#2
  % If the current entry has a field (#1) that is not inherited from a cross-referenced entry,
  % then execute input #2
  \btxdoif{#1} {
    \btxdoifelse{crossref} {
      \begingroup
      \def\crossreftag{\btxflush{crossref}}
      \texdefinition{btx:sbl:doifnotsamefield}{\currentbtxtag}{\crossreftag}{#1} {
        #2
      }
      \endgroup
    } {
      #2
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:doifownfieldelse #1#2#3
  % If the current entry has a field (#1) that is not inherited from a cross-referenced entry,
  % then execute input #2; otherwise, execute input #3
  \btxdoifelse{#1} {
    \btxdoifelse{crossref} {
      \begingroup
      \def\crossreftag{\btxflush{crossref}}
      \texdefinition{btx:sbl:doifsamefieldelse}{\currentbtxtag}{\crossreftag}{#1} {
        #3
      } {
        #2
      }
      \endgroup
    } {
      #2
    }
  } {
    #3
  }
\stoptexdefinition

% Define a helper for previous author handling
% TODO: Remove this if we end up implementing a general-purpose macro for it in publ-ini.lua and publ-ini.mkiv
\setxvariables[btx:sbl][previousinlinetag=\empty]% the tag of last entry cited inline

% Define handlers for same-author entries in the list
\startsetups sbl:list:sameauthor
  \fastsetup{sbl:list:sameauthor:rule} % by default, just use a long line (defined below)
\stopsetups

\startsetups sbl:list:sameauthor:rule
  \blackrule
    [\c!width=6em,
    \c!height=0.75ex,
    \c!depth=\dimexpr\linewidth-0.75ex\relax] % to lift it off the baseline (we're not underlining anything!)
\stopsetups

\startsetups [sbl:list:sameauthor:\v!empty]
  \kern\dimexpr\listparameter\c!margin-\interwordspace\relax% just indent by the margin, minus a space for the next word
\stopsetups

\startsetups sbl:list:sameauthor:ditto
  \Word{\btxlabeltext{sbl:idem}} % capitalize for list entries
\stopsetups

\starttexdefinition btx:sbl:list:author
  \btxdoif {author} {
    % If this entry's author is the same as that of the previous entry, then use sameauthor settings (if they're set):
    \doifelsesetups{sbl:list:sameauthor} {
      \btxdoifelsesameasprevious {author} {
        \fastsetup{sbl:list:sameauthor}
      } {
        \btxflush{author}
      }
    } {
      \btxflush{author}
    }
    % If this is an instance of an editor, then there is no author; 
    % indicate that this is an editor
    \doifelse {\btxfoundname{author}} {editor} {
      \btxcomma
      \btxsingularorplural {author} {
        \btxlabeltext{sbl:editor}
      } {
        \btxlabeltext{sbl:editors}
      }
      % Is there an assisting editor?
      \btxdoif {witheditor} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {witheditortype} {
          \btxflush{witheditortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{witheditor}
      }
    } {
      % If this is an author, is there an assisting author?
      \btxdoif {withauthor} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {withauthortype} {
          \btxflush{withauthortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{withauthor}
      }
    }
    % If the name ends with a period (as is the case for an initial or "et al."), 
    % then remove the preceding period
    \removeunwantedspaces
    \removepunctuation
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:listsubcite:author
  \btxdoif {author} {
    % If this is an instance of an editor, then there is no author; 
    % indicate that this is an editor
    \doifelse {\btxfoundname{author}} {editor} {
      \btxlabeltext{sbl:Edited} % singular or plural doesn't matter here, as "ed." comes first
      \btxspace
      \btxlabeltext{sbl:by}
      \btxspace
      \currentbtxciteauthorbyfield
      % Is there an assisting editor?
      \btxdoif {witheditor} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {witheditortype} {
          \btxflush{witheditortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{witheditor}
      }
    } {
      % If this is a proper author, then replace the preceding period with a comma,
      % and precede the author's name with "by"
      \removeunwantedspaces
      \removepunctuation
      \btxcomma
      \btxlabeltext{sbl:by}
      \btxspace
      \currentbtxciteauthorbyfield
      % If this is an author, is there an assisting author?
      \btxdoif {withauthor} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {withauthortype} {
          \btxflush{withauthortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{withauthor}
      }
    }
    % If the name ends with a period (as is the case for "et al."), 
    % then remove the preceding period
    \removeunwantedspaces
    \removepunctuation
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inline:author
  \btxdoif {author} {
    % If the useidem option is set and this author matches the previously cited author, then just print "idem";
    % otherwise, print the author/editor/org name first in normal order
    \doifelse{\btxparameter{useidem}} {\v!yes} {
      \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\getvariable{btx:sbl}{previousinlinetag}} {
        \btxlabeltext{sbl:idem}
      } {
        \currentbtxciteauthorbyfield
      }
    } {
      \currentbtxciteauthorbyfield
    }
    % If this is an instance of an editor, then there is no author; 
    % indicate that this is an editor
    \doifelse {\btxfoundname{author}} {editor} {
      \btxcomma
      \btxsingularorplural {editor} {
        \btxlabeltext{sbl:editor}
      } {
        \btxlabeltext{sbl:editors}
      }
      % Is there an assisting editor?
      \btxdoif {witheditor} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {witheditortype} {
          \btxflush{witheditortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{witheditor}
      }
    } {
      % If this is an author or organization, is there an assisting author?
      \btxdoif {withauthor} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {withauthortype} {
          \btxflush{withauthortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{withauthor}
      }
    }
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinesubcite:author
  \btxdoif {author} {
    % If this is an instance of an editor, then there is no author; 
    % indicate that this is an editor
    \doifelse {\btxfoundname{author}} {editor} {
      \btxlabeltext{sbl:editor} % singular or plural doesn't matter here, as "ed." comes first
      \btxspace
      \currentbtxciteauthorbyfield
      % Is there an assisting editor?
      \btxdoif {witheditor} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {witheditortype} {
          \btxflush{witheditortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{witheditor}
      }
    } {
      \btxlabeltext{sbl:by}
      \btxspace
      \currentbtxciteauthorbyfield
      % If this is an author, is there an assisting author?
      \btxdoif {withauthor} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {withauthortype} {
          \btxflush{withauthortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{withauthor}
      }
    }
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:short:author
  \btxdoif{author} {
    % If the useidem option is set and this author matches the previously cited author, then just print "idem";
    % otherwise, print the author/editor's last name
    \doifelse{\btxparameter{useidem}} {\v!yes} {
      \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\getvariable{btx:sbl}{previousinlinetag}} {
        \btxlabeltext{sbl:idem}
      } {
        \currentbtxciteauthorbyfield
      }
    } {
      \currentbtxciteauthorbyfield
    }
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:title
  \doifinset {\currentbtxcategory} {ancienttext} {
    \texdefinition{btx:sbl:list:ancienttexttitle}
  }
  \doifnotinset {\currentbtxcategory} {ancienttext} {
    \btxdoif {title} {
      \btxstartstyleandcolor[sbl:\s!list:title:\currentbtxcategory]
        \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
          \btxflush{title}% set the title according to the current category
        }
        \btxdoif {subtitle} {
          \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
            \btxcolon% add a colon between title and subtitle
            \btxflush{subtitle}% set the subtitle according to the current category
          }
        }
      \btxstopstyleandcolor
      \btxperiod
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inline:title
  \doifinset {\currentbtxcategory} {ancienttext} {
    \texdefinition{btx:sbl:inline:ancienttexttitle}
  }
  \doifinset {\currentbtxcategory} {classictext} {
    \texdefinition{btx:sbl:inline:classictexttitle}
  }
  \doifnotinset {\currentbtxcategory} {ancienttext, classictext} {
    \btxdoif {title} {
      \btxstartstyleandcolor[sbl:\s!list:title:\currentbtxcategory]
        \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
          \btxflush{title}% set the title according to the current category
        }
        \btxdoif {subtitle} {
          \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
            \btxcolon% add a colon between title and subtitle
            \btxflush{subtitle}% set the subtitle according to the current category
          }
        }
      \btxstopstyleandcolor
      \btxcomma
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:short:title
  \doifinset {\currentbtxcategory} {ancienttext} {
    \texdefinition{btx:sbl:short:ancienttexttitle}
  }
  \doifnotinset {\currentbtxcategory} {ancienttext} {
    % Use the shorttitle if available;
    % otherwise, use its title (but not any subtitle)
    \texdefinition{btx:sbl:doifownfieldelse}{shorttitle} {
      \btxstartstyleandcolor[sbl:\s!list:title:\currentbtxcategory]
        \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
          \btxflush{shorttitle}% set the title according to the current category
        }
      \btxstopstyleandcolor
      \btxcomma
    } {
      \btxstartstyleandcolor[sbl:\s!list:title:\currentbtxcategory]
        \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
          \btxflush{title}% set the title according to the current category
        }
      \btxstopstyleandcolor
      \btxcomma
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:ancienttexttitle
  \btxdoif {title} {
    % For inscriptions, chronicles, and manuscripts, print the title unformatted
    \doifinset {\btxflush{entrysubtype}} {inscription, chronicle, manuscript} {
      \btxflush{title}
      \btxdoif{subtitle} {
        \btxcolon
        \btxflush{subtitle}
      }
      \btxperiod
    }
    % For all other cases (except for PGM, in which case we should print no title), just use the regular formatting
    \doifnotinset {\btxflush{entrysubtype}} {PGM, inscription, chronicle, manuscript} {
      \btxstartstyleandcolor[sbl:\s!list:title:\currentbtxcategory]
        \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
          \btxflush{title}% set the title according to the current category
        }
        \btxdoif {subtitle} {
          \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
            \btxcolon% add a colon between title and subtitle
            \btxflush{subtitle}% set the subtitle according to the current category
          }
        }
      \btxstopstyleandcolor
      \btxperiod
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inline:ancienttexttitle
  \btxdoif {title} {
    % For PGM, typeset the shorthand PGM with book formatting
    \doifinset {\btxflush{entrysubtype}} {PGM} {
      \btxstartstyleandcolor[sbl:\s!list:title:book]
        \btxusecommand[sbl:\s!list:title:book]{
          {PGM}%
        }
      \btxstopstyleandcolor
      \btxcomma
    }
    % For inscriptions, chronicles, and manuscripts, print the title unformatted
    \doifinset {\btxflush{entrysubtype}} {inscription, chronicle, manuscript} {
      \btxflush{title}
      \btxdoif{subtitle} {
        \btxcolon
        \btxflush{subtitle}
      }
      \btxcomma
    }
    % For all other cases, just use the regular formatting
    \doifnotinset {\btxflush{entrysubtype}} {PGM, inscription, chronicle, manuscript} {
      \btxstartstyleandcolor[sbl:\s!list:title:\currentbtxcategory]
        \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
          \btxflush{title}% set the title according to the current category
        }
        \btxdoif {subtitle} {
          \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
            \btxcolon% add a colon between title and subtitle
            \btxflush{subtitle}% set the subtitle according to the current category
          }
        }
      \btxstopstyleandcolor
      \btxcomma
    }
    \doifnot{\currentbtxlefttext}{\empty} {
      \removeunwantedspaces
      \removepunctuation
      \btxspace
      \texdefinition{btx:sbl:inline:lefttext}
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:short:ancienttexttitle
  \btxdoif {title} {
    % For PGM, typeset the shorthand PGM with book formatting
    \doifinset {\btxflush{entrysubtype}} {PGM} {
      \btxstartstyleandcolor[sbl:\s!list:title:book]
        \btxusecommand[sbl:\s!list:title:book]{
          {PGM}%
        }
      \btxstopstyleandcolor
      \btxcomma
    }
    % For inscriptions, chronicles, and manuscripts, print the title unformatted
    \doifinset {\btxflush{entrysubtype}} {inscription, chronicle, manuscript} {
      \texdefinition{btx:sbl:doifownfieldelse} {shorttitle} {
        \btxflush{shorttitle}
      } {
        \btxflush{title}
      }
      \btxcomma
    }
    % For all other cases, just use the regular formatting
    \doifnotinset {\btxflush{entrysubtype}} {PGM, inscription, chronicle, manuscript} {
      \btxstartstyleandcolor[sbl:\s!list:title:\currentbtxcategory]
        \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
          \texdefinition{btx:sbl:doifownfieldelse} {shorttitle} {%
            \btxflush{shorttitle}%
          }{%
            \btxflush{title}%
          }%
        }
      \btxstopstyleandcolor
      \btxcomma
    }
    \doifnot{\currentbtxlefttext}{\empty} {
      \removeunwantedspaces
      \removepunctuation
      \btxspace
      \texdefinition{btx:sbl:inline:lefttext}
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:classictexttitle
  \texdefinition{btx:sbl:list:title}
\stoptexdefinition

\starttexdefinition btx:sbl:inline:classictexttitle
  \texdefinition{btx:sbl:short:title} % prefer the short title, even in inline citations
  % If there is a lefttext containing a reference within the ancient text, then print it after the title
  \doifnot {\currentbtxlefttext} {\empty} {
    \removeunwantedspaces
    \removepunctuation
    \btxspace
    \texdefinition{btx:sbl:inline:lefttext}
  }
\stoptexdefinition

\starttexdefinition btx:sbl:short:classictexttitle
  \texdefinition{btx:sbl:inline:classictexttitle}
\stoptexdefinition

\starttexdefinition btx:sbl:short:shorthand
  \doifinset {\currentbtxcategory} {ancienttext} {
    \texdefinition{btx:sbl:short:ancienttextshorthand}
  }
  \doifnotinset {\currentbtxcategory} {ancienttext} {
    \texdefinition{btx:sbl:doifownfield} {shorthand} {
      % If the shorthand field matches the shorttitle field, then use title formatting;
      % otherwise, use no formatting
      \doifelse{\btxflush{shorthand}}{\btxflush{shorttitle}} {
        \btxstartstyleandcolor[sbl:\s!list:title:\currentbtxcategory]
          \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
            \btxflush{shorthand}% set the shorthand according to the current category
          }
        \btxstopstyleandcolor
      } {
        \btxflush{shorthand}
      }
      \btxcomma
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:short:ancienttextshorthand
  \texdefinition{btx:sbl:doifownfield} {shorthand} {
    % If the shorthand field matches the shorttitle field, then use title formatting;
    % otherwise, use no formatting
    \doifelse{\btxflush{shorthand}}{\btxflush{shorttitle}} {
      % If this entry is an inscription, a chronicle, or a manuscript, then do not apply formatting to its shorthand
      \doifinsetelse{\btxflush{entrysubtype}}{inscription, chronicle, manuscript} {
        \btxflush{shorthand}
      } {
        \btxstartstyleandcolor[sbl:\s!list:title:\currentbtxcategory]
          \btxusecommand[sbl:\s!list:title:\currentbtxcategory]{
            \btxflush{shorthand}% set the shorthand according to the current category
          }
        \btxstopstyleandcolor
      }
    } {
      \btxflush{shorthand}
    }
    \btxspace
    \texdefinition{btx:sbl:inline:lefttext}
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:editor
  \btxdoif {editor} {
    % If editor(s) not already listed in the author position, then list here
    \doifnot {\btxfoundname{author}} {editor} {
      % Preface with "Edited by" unless a specific editortype is specified
      \btxdoifelse {editortype} {
        \btxusecommand[sbl:\s!list:type]{
          \btxflush{editortype}% make sure it's capitalized
        }
      } {
        \btxlabeltext{sbl:Edited}
        \btxspace
        \btxlabeltext{sbl:by}
      }
      \btxspace
      \btxflush{editor}
      % Is there an assisting editor?
      \btxdoif {witheditor} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {witheditortype} {
          \btxflush{witheditortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{witheditor}
      }
      % If the name ends with a period (as is the case for "et al."), 
      % then remove the preceding period
      \removeunwantedspaces
      \removepunctuation
      \btxperiod
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:listsubcite:editor
  \btxdoif {editor} {
    % Preface with "Edited by" unless a specific editortype is specified
    \btxdoifelse {editortype} {
      \btxusecommand[sbl:\s!list:type]{
        \btxflush{editortype}% make sure it's capitalized
      }
    } {
      \btxlabeltext{sbl:Edited}
      \btxspace
      \btxlabeltext{sbl:by}
    }
    \btxspace
    \btxflush{editor}
    % Is there an assisting editor?
    \btxdoif {witheditor} {
      \btxcomma
      % Use the provided text to introduce them, if one is specified
      \btxdoifelse {witheditortype} {
        \btxflush{witheditortype}
      } {
        \btxlabeltext{sbl:with}
      }
      \btxspace
      \btxflush{witheditor}
    }
    % If the name ends with a period (as is the case for "et al."), 
    % then remove the preceding period
    \removeunwantedspaces
    \removepunctuation
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inline:editor
  \btxdoif {editor} {
    % If editor(s) not already listed in the author position, then list here
    \doifnot {\btxfoundname{author}} {editor} {
      % Preface with the "editor" abbreviation unless a specific editortype is specified
      \btxdoifelse {editortype} {
        \btxflush{editortype}
      } {
        \btxlabeltext{sbl:editor} % singular or plural doesn't matter here, as "ed." comes first
      }
      \btxspace
      \btxflush{editor}
      % Is there an assisting editor?
      \btxdoif {witheditor} {
        \btxcomma
        % Use the provided text to introduce them, if one is specified
        \btxdoifelse {witheditortype} {
          \btxflush{witheditortype}
        } {
          \btxlabeltext{sbl:with}
        }
        \btxspace
        \btxflush{witheditor}
      }
      \btxcomma
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinesubcite:editor
  \btxdoif {editor} {
    % Preface with the "editor" abbreviation unless a specific editortype is specified
    \btxdoifelse {editortype} {
      \btxflush{editortype}
    } {
      \btxlabeltext{sbl:editor} % singular or plural doesn't matter here, as "ed." comes first
    }
    \btxspace
    \btxflush{editor}
    % Is there an assisting editor?
    \btxdoif {witheditor} {
      \btxcomma
      % Use the provided text to introduce them, if one is specified
      \btxdoifelse {witheditortype} {
        \btxflush{witheditortype}
      } {
        \btxlabeltext{sbl:with}
      }
      \btxspace
      \btxflush{witheditor}
    }
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:translator
  \btxdoif {translator} {
    \btxlabeltext{sbl:Translated}
    \btxspace
    % If there is a note on the work in the original language (e.g., "from the 3rd German ed."),
    % then print it here
    \btxdoif {origlanguage} {
      \btxflush{origlanguage}
      \btxspace
    }
    \btxlabeltext{sbl:by}
    \btxspace
    \btxflush{translator}
    % Is there an assisting translator?
    \btxdoif {withtranslator} {
      \btxcomma
      % Use the provided text to introduce them, if one is specified
      \btxdoifelse {withtranslatortype} {
        \btxflush{withtranslatortype}
      } {
        \btxlabeltext{sbl:with}
      }
      \btxspace
      \btxflush{withtranslator}
    }
    % If the name ends with a period (as is the case for "et al."), 
    % then remove the preceding period
    \removeunwantedspaces
    \removepunctuation
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:listsubcite:translator
  \btxdoif {translator} {
    \btxlabeltext{sbl:Translated}
    \btxspace
    \btxlabeltext{sbl:by}
    \btxspace
    \btxflush{translator}
    % Is there an assisting translator?
    \btxdoif {withtranslator} {
      \btxcomma
      % Use the provided text to introduce them, if one is specified
      \btxdoifelse {withtranslatortype} {
        \btxflush{withtranslatortype}
      } {
        \btxlabeltext{sbl:with}
      }
      \btxspace
      \btxflush{withtranslator}
    }
    % If the name ends with a period (as is the case for "et al."), 
    % then remove the preceding period
    \removeunwantedspaces
    \removepunctuation
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inline:translator
  \btxdoif {translator} {
    \btxlabeltext{sbl:translator}
    \btxspace
    \btxflush{translator}
    % Is there an assisting translator?
    \btxdoif {withtranslator} {
      \btxcomma
      % Use the provided text to introduce them, if one is specified
      \btxdoifelse {withtranslatortype} {
        \btxflush{withtranslatortype}
      } {
        \btxlabeltext{sbl:with}
      }
      \btxspace
      \btxflush{withtranslator}
    }
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinesubcite:translator
  \btxdoif {translator} {
    \btxlabeltext{sbl:translator}
    \btxspace
    \btxflush{translator}
    % Is there an assisting translator?
    \btxdoif {withtranslator} {
      \btxcomma
      % Use the provided text to introduce them, if one is specified
      \btxdoifelse {withtranslatortype} {
        \btxflush{withtranslatortype}
      } {
        \btxlabeltext{sbl:with}
      }
      \btxspace
      \btxflush{withtranslator}
    }
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:editortranslator
  % Is there an editor?
  \btxdoifelse {editor} {
    % If so, is there also a translator?
    \btxdoifelse {translator} {
      % If so, is the editor the same as the author?
      \doifelse {\btxfoundname{author}} {editor} {
        % If so, then just handle the translator
        \texdefinition{btx:sbl:list:translator}
      } {
        % If not, are the editor and translator (and their corresponding "with" fields) the same?
        \doifelse {\btxdirect{editor}\btxdirect{witheditor}} {\btxdirect{translator}\btxdirect{withtranslator}} {
          % If so, then typeset them together
          \btxlabeltext{sbl:Translated}
          \btxspace
          \btxlabeltext{and}
          \btxspace
          \btxlabeltext{sbl:edited}
          \btxspace
          % If there is a note on the work in the original language (e.g., "from the 3rd German ed."),
          % then print it here
          \btxdoif {origlanguage} {
            \btxflush{origlanguage}
            \btxspace
          }
          \btxlabeltext{sbl:by}
          \btxspace
          \btxflush{editor}
          % Is there an assisting editor/translator?
          \btxdoif {witheditor} {
            \btxcomma
            % Use the provided text(s) to introduce them, if specified
            \btxdoifelse {witheditortype} {
              \btxflush{witheditortype}
              \btxdoif {withtranslatortype} {
                \btxspace
                \btxlabeltext{and}
                \btxspace
                \btxflush{withtranslatortype}
              }
            } {
              \btxdoif {withtranslatortype} {
                \btxflush{withtranslatortype}
              }
            }
            \btxspace
            \btxflush{witheditor}
          }
          % If the name ends with a period (as is the case for "et al."), 
          % then remove the preceding period
          \removeunwantedspaces
          \removepunctuation
          \btxperiod
        } {
          % If not, then handle them separately
          \texdefinition{btx:sbl:list:editor}
          \texdefinition{btx:sbl:list:translator}
        }
      }
    } {
      % If there is no translator, is the editor the same as the author?
      \doifnot {\btxfoundname{author}} {editor} {
        % If not, then just handle the editor
        \texdefinition{btx:sbl:list:editor}
      }
    }
  } {
    % If not, then just handle the translator
    \texdefinition{btx:sbl:list:translator} 
  }
\stoptexdefinition

\starttexdefinition btx:sbl:listsubcite:editortranslator
  % Is there an editor?
  \btxdoifelse {editor} {
    % If so, is there also a translator?
    \btxdoifelse {translator} {
      % If so, is the editor the same as the author?
      \doifelse {\btxfoundname{author}} {editor} {
        % If so, then just handle the translator
        \texdefinition{btx:sbl:listsubcite:translator}
      } {
        % If not, are the editor and translator (and their corresponding "with" fields) the same?
        \doifelse {\btxdirect{editor}\btxdirect{witheditor}} {\btxdirect{translator}\btxdirect{withtranslator}} {
          % If so, then typeset them together
          \btxlabeltext{sbl:Translated}
          \btxspace
          \btxlabeltext{and}
          \btxspace
          \btxlabeltext{sbl:edited}
          \btxspace
          % If there is a note on the work in the original language (e.g., "from the 3rd German ed."),
          % then print it here
          \btxdoif {origlanguage} {
            \btxflush{origlanguage}
            \btxspace
          }
          \btxlabeltext{sbl:by}
          \btxspace
          \btxflush{editor}
          % Is there an assisting editor/translator?
          \btxdoif {witheditor} {
            \btxcomma
            % Use the provided text(s) to introduce them, if specified
            \btxdoifelse {witheditortype} {
              \btxflush{witheditortype}
              \btxdoif {withtranslatortype} {
                \btxspace
                \btxlabeltext{and}
                \btxspace
                \btxflush{withtranslatortype}
              }
            } {
              \btxdoif {withtranslatortype} {
                \btxflush{withtranslatortype}
              }
            }
            \btxspace
            \btxflush{witheditor}
          }
          % If the name ends with a period (as is the case for "et al."), 
          % then remove the preceding period
          \removeunwantedspaces
          \removepunctuation
          \btxperiod
        } {
          % If not, then handle them separately
          \texdefinition{btx:sbl:listsubcite:editor}
          \texdefinition{btx:sbl:listsubcite:translator}
        }
      }
    } {
      % If there is no translator, is the editor the same as the author?
      \doifnot {\btxfoundname{author}} {editor} {
        % If not, then just handle the editor
        \texdefinition{btx:sbl:listsubcite:editor}
      }
    }
  } {
    % If not, then just handle the translator
    \texdefinition{btx:sbl:listsubcite:translator} 
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inline:editortranslator
  % Is there an editor?
  \btxdoifelse {editor} {
    % If so, is there also a translator?
    \btxdoifelse {translator} {
      % If so, is the editor the same as the author?
      \doifelse {\btxfoundname{author}} {editor} {
        % If so, then just handle the translator
        \texdefinition{btx:sbl:inline:translator}
      } {
        % If not, are the editor and translator (and their corresponding "with" fields) the same?
        \doifelse {\btxdirect{editor}\btxdirect{witheditor}} {\btxdirect{translator}\btxdirect{withtranslator}} {
          % If so, then typeset them together
          \btxlabeltext{sbl:translator}
          \btxspace
          \btxlabeltext{and}
          \btxspace
          \btxlabeltext{sbl:editor}
          \btxspace
          \btxflush{editor}
          % Is there an assisting editor/translator?
          \btxdoif {witheditor} {
            \btxcomma
            % Use the provided text(s) to introduce them, if specified
            \btxdoifelse {witheditortype} {
              \btxflush{witheditortype}
              \btxdoif {withtranslatortype} {
                \btxspace
                \btxlabeltext{and}
                \btxspace
                \btxflush{withtranslatortype}
              }
            } {
              \btxdoif {withtranslatortype} {
                \btxflush{withtranslatortype}
              }
            }
            \btxspace
            \btxflush{witheditor}
          }
          % If the name ends with a period (as is the case for "et al."), 
          % then remove the preceding period
          \removeunwantedspaces
          \removepunctuation
          \btxperiod
        } {
          % If not, then handle them separately
          \texdefinition{btx:sbl:inline:editor}
          \texdefinition{btx:sbl:inline:translator}
        }
      }
    } {
      % If there is no translator, is the editor the same as the author?
      \doifnot {\btxfoundname{author}} {editor} {
        % If not, then just handle the editor
        \texdefinition{btx:sbl:inline:editor}
      }
    }
  } {
    % If not, then just handle the translator
    \texdefinition{btx:sbl:inline:translator} 
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinesubcite:editortranslator
  % Is there an editor?
  \btxdoifelse {editor} {
    % If so, is there also a translator?
    \btxdoifelse {translator} {
      % If so, is the editor the same as the author?
      \doifelse {\btxfoundname{author}} {editor} {
        % If so, then just handle the translator
        \texdefinition{btx:sbl:inlinesubcite:translator}
      } {
        % If not, are the editor and translator (and their corresponding "with" fields) the same?
        \doifelse {\btxdirect{editor}\btxdirect{witheditor}} {\btxdirect{translator}\btxdirect{withtranslator}} {
          % If so, then typeset them together
          \btxlabeltext{sbl:translator}
          \btxspace
          \btxlabeltext{and}
          \btxspace
          \btxlabeltext{sbl:editor}
          \btxspace
          \btxflush{editor}
          % Is there an assisting editor/translator?
          \btxdoif {witheditor} {
            \btxcomma
            % Use the provided text(s) to introduce them, if specified
            \btxdoifelse {witheditortype} {
              \btxflush{witheditortype}
              \btxdoif {withtranslatortype} {
                \btxspace
                \btxlabeltext{and}
                \btxspace
                \btxflush{withtranslatortype}
              }
            } {
              \btxdoif {withtranslatortype} {
                \btxflush{withtranslatortype}
              }
            }
            \btxspace
            \btxflush{witheditor}
          }
          % If the name ends with a period (as is the case for "et al."), 
          % then remove the preceding period
          \removeunwantedspaces
          \removepunctuation
          \btxperiod
        } {
          % If not, then handle them separately
          \texdefinition{btx:sbl:inlinesubcite:editor}
          \texdefinition{btx:sbl:inlinesubcite:translator}
        }
      }
    } {
      % If there is no translator, is the editor the same as the author?
      \doifnot {\btxfoundname{author}} {editor} {
        % If not, then just handle the editor
        \texdefinition{btx:sbl:inlinesubcite:editor}
      }
    }
  } {
    % If not, then just handle the translator
    \texdefinition{btx:sbl:inlinesubcite:translator} 
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:inbookcrossref
  \btxdoif{crossref} {
    \begingroup
    \def\crossreftag{\btxflush{crossref}}
    % Print page numbers here, if there are any
    \btxdoifelse {pages} {
      \btxoneorrange {pages} {
        \btxlabeltext{sbl:Page}
      } {
        \btxlabeltext{sbl:Pages}
      }
      \btxspace
      % If this entry has a part number, then prefix the page range with it
      \btxdoif {part} {
        \btxflush{part}
        \btxcolon
        \removeunwantedspaces
      }
      \btxusecommand[sbl:\s!list:pages]{
        \btxflush{pages}%
      }
      \btxspace
      \btxlabeltext{sbl:in}
    } {
      \btxlabeltext{sbl:In}
    }
    \btxspace
    % Recursively cite the book or volume
    \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\crossreftag}{
      \textcite[alternative=listsubcite,printauthor=no][\crossreftag]
    } {
      \textcite[alternative=listsubcite,printauthor=yes][\crossreftag]
    }
    \btxperiod
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inline:inbookcrossref
  \btxdoif{crossref} {
    \begingroup
    % Use a short citation if the book or set of books containing this entry has a shorthand;
    % otherwise, use a full subcitation preceded by "in"
    \def\crossreftag{\btxflush{crossref}}
    \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{crossref} {
      \def\collectiontag{\clf_btxdirect{\currentbtxdataset}{\crossreftag}{crossref}}
      \clf_btxdoifelse{\currentbtxdataset}{\collectiontag}{shorthand} {
        \textcite[alternative=short][\collectiontag]
        \btxspace
        \textcite[alternative=volume][\crossreftag]
        \btxdoif {part} {
          \btxperiod
          \removeunwantedspaces
          \btxflush{part}
        }
        \btxcolon
        \removeunwantedspaces
        \btxusecommand[sbl:\s!list:pages] {
          \btxflush{pages}%
        }
      } {
        \btxlabeltext{sbl:in}
        \btxspace
        % If the volume and collection have the same name, then prefix the page numbers with the volume number
        \texdefinition{btx:sbl:doifsametitleelse}{\crossreftag}{\collectiontag} {
          \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\crossreftag} {
            \textcite[alternative=inlinesubcite,printauthor=no][\crossreftag]
          } {
            \textcite[alternative=inlinesubcite,printauthor=yes][\crossreftag]
          }
          \btxcomma
          \textcite[alternative=volume][\crossreftag]
          \btxdoif {part} {
            \btxperiod
            \removeunwantedspaces
            \btxflush{part}
          }
          \btxcolon
          \removeunwantedspaces
          \btxusecommand[sbl:\s!list:pages]{
            \btxflush{pages}%
          }
        } {
          \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\crossreftag} {
            \textcite[alternative=inlinesubcite,printauthor=no][\crossreftag]
          } {
            \textcite[alternative=inlinesubcite,printauthor=yes][\crossreftag]
          }
          \btxcomma
          % If this entry has a part number, then prefix the page range with the part number
          \btxdoif {part} {
            \btxflush{part}
            \btxcolon
            \removeunwantedspaces
          }
          \btxusecommand[sbl:\s!list:pages]{
            \btxflush{pages}%
          }
        }
      }
    } {
      % Otherwise, print the shorthand of the book containing this entry, or, failing that, its entry
      \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{shorthand} {
        \textcite[alternative=short][\crossreftag]
        \btxcomma
        % If this entry has a part number, then remove the preceding comma and prefix the page range with the part number
        \btxdoif {part} {
          \removeunwantedspaces
          \removepunctuation
          \btxspace
          \btxflush{part}
          \btxcolon
          \removeunwantedspaces
        }
      } {
        \btxlabeltext{sbl:in}
        \btxspace
        \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\crossreftag} {
          \textcite[alternative=inlinesubcite,printauthor=no][\crossreftag]
        } {
          \textcite[alternative=inlinesubcite,printauthor=yes][\crossreftag]
        }
        \btxcomma
        % If this entry has a part number, then prefix the page range with the part number
        \btxdoif {part} {
          \btxflush{part}
          \btxcolon
          \removeunwantedspaces
        }
      }
      \btxusecommand[sbl:\s!list:pages]{
        \btxflush{pages}%
      }
    }
    \btxcomma
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:short:inreferencecrossref
  \btxdoif{crossref} {
    \begingroup
    % If this entry is in a multivolume reference, 
    % then cite the shorthand (or, failing that, its title) and prefix any cited pages accordingly;
    % otherwise, just cite the pages
    \def\crossreftag{\btxflush{crossref}}
    \doifnot {\currentbtxrighttext} {\empty} {
      \clf_btxdoif{\currentbtxdataset}{\crossreftag}{crossref} {
        \def\collectiontag{\clf_btxdirect{\currentbtxdataset}{\crossreftag}{crossref}}
        \clf_btxdoifelse{\currentbtxdataset}{\collectiontag}{shorthand} {
          \textcite[alternative=short][\collectiontag]
          \btxspace
        } {
          \textcite[alternative=title][\collectiontag]
          \btxcomma
        }
        \textcite[alternative=volume][\crossreftag]
        \btxcolon
        \removeunwantedspaces
      }
      \texdefinition{btx:sbl:short:righttext}
    }
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:reviewcrossref
  \btxdoif{crossref} {
    \begingroup
    \def\crossreftag{\btxflush{crossref}}
    % Precede the subcitation with "Review of"
    \btxlabeltext{sbl:Reviewof}
    \btxspace
    % Cite the title and author/editor of the the reviewed book
    \textcite[alternative=title][\crossreftag]
    \btxcomma
    \doifelse{\clf_btxfoundname{\currentbtxdataset}{\crossreftag}{author}}{editor} {
      \btxlabeltext{sbl:editor}
    } {
      \btxlabeltext{sbl:by}
    }
    \btxspace
    \clf_btxauthor
      {\currentbtxdataset}%
      {\crossreftag}%
      {author}%
      {%
          combiner    {normal}%
          kind        {cite}%
          etallimit   {sbl:\s!cite\c!etallimit}%
          etaldisplay {sbl:\s!cite\c!etaldisplay}%
          etaloption  {sbl:\s!cite\c!etaloption}%
          symbol      {sbl:\s!cite\c!stopper:initials}%
          connector   {sbl:\s!cite\c!connector:initials}%
      }%
    \btxperiod
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inline:reviewcrossref
  \btxdoif{crossref} {
    \begingroup
    \def\crossreftag{\btxflush{crossref}}
    % Precede the subcitation with "review of"
    \btxlabeltext{sbl:reviewof}
    \btxspace
    % Cite the title and author/editor of the the reviewed book
    \textcite[alternative=title][\crossreftag]
    \btxcomma
    \doifelse{\clf_btxfoundname{\currentbtxdataset}{\crossreftag}{author}}{editor} {
      \btxlabeltext{sbl:editor}
    } {
      \btxlabeltext{sbl:by}
    }
    \btxspace
    \clf_btxauthor
      {\currentbtxdataset}%
      {\crossreftag}%
      {author}%
      {%
          combiner    {normal}%
          kind        {cite}%
          etallimit   {sbl:\s!cite\c!etallimit}%
          etaldisplay {sbl:\s!cite\c!etaldisplay}%
          etaloption  {sbl:\s!cite\c!etaloption}%
          symbol      {sbl:\s!cite\c!stopper:initials}%
          connector   {sbl:\s!cite\c!connector:initials}%
      }%
    \btxcomma
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:short:reviewcrossref
  \btxdoif{crossref} {
    \begingroup
    \def\crossreftag{\btxflush{crossref}}
    % Precede the subcitation with "review of"
    \btxlabeltext{sbl:reviewof}
    \btxspace
    % Cite the title and author/editor of the the reviewed book
    \textcite[alternative=title][\crossreftag]
    \btxspace
    \startparen
    \doifelse{\clf_btxfoundname{\currentbtxdataset}{\crossreftag}{author}}{editor} {
      \btxlabeltext{sbl:editor}
    } {
      \btxlabeltext{sbl:by}
    }
    \btxspace
    \clf_btxauthor
      {\currentbtxdataset}%
      {\crossreftag}%
      {author}%
      {%
          combiner    {name}%
          kind        {cite}%
          etallimit   {sbl:\s!cite\c!etallimit}%
          etaldisplay {sbl:\s!cite\c!etaldisplay}%
          etaloption  {sbl:\s!cite\c!etaloption}%
          symbol      {sbl:\s!cite\c!stopper:initials}%
          connector   {sbl:\s!cite\c!connector:initials}%
      }%
    \stopparen
    \btxcomma
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:suppbookcrossref
  \btxdoif{crossref} {
    \begingroup
    \def\crossreftag{\btxflush{crossref}}
    % Print the section of the book (this is a required field)
    % For list citations, make sure the type is capitalized
    \btxusecommand[sbl:\s!list:type] {
      \btxflush{type}%
    }
    \btxspace
    \btxlabeltext{sbl:to}
    \btxspace
    % Recursively cite the book/collection
    \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\crossreftag}{
      \textcite[alternative=listsubcite,printauthor=no][\crossreftag]
    } {
      \textcite[alternative=listsubcite,printauthor=yes][\crossreftag]
    }
    \btxperiod
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inline:suppbookcrossref
  \btxdoif{crossref} {
    \begingroup
    \def\crossreftag{\btxflush{crossref}}
    % Print the section of the book (this is a required field)
    % For inline citations, this can be printed without capitalization
    \btxflush{type}
    \btxspace
    \btxlabeltext{sbl:to}
    \btxspace
    % Recursively cite the book/collection
    \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\crossreftag}{
      \textcite[alternative=inlinesubcite,printauthor=no][\crossreftag]
    } {
      \textcite[alternative=inlinesubcite,printauthor=yes][\crossreftag]
    }
    \btxcomma
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:short:suppbookcrossref
  % Just print the type (this is a required field)
  \btxflush{type}
  \btxcomma
\stoptexdefinition

\starttexdefinition btx:sbl:inline:ancienttextcrossref
  \btxdoif{crossref} {
    % Is this entry of subtype "PGM"?
    \doifelse{\btxflush{entrysubtype}}{PGM}{
      % If so, then print the translator (if there is one) in parentheses,
      % but don't print anything else in parentheses (§6.4.3.3)
      \btxdoif {translator} {
        \removeunwantedspaces
        \removepunctuation
        \btxspace
        \startparen
        \btxflush{translator}
        \stopparen
        \btxcomma
      }
    } {
      % If not, then print the translator first, then print publication information in parentheses
      \btxdoif {translator} {
        \btxlabeltext{sbl:translator}
        \btxspace
        \btxflush{translator}
        \btxcomma
      }
      % If the book or set containing this text has a shorthand, then only cite its shorthand if there are page numbers;
      % otherwise, do a full inline citation, adding it to the list
      \begingroup
      \def\crossreftag{\btxflush{crossref}}
      \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{shorthand} {
        \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{crossref} {
          \def\collectiontag{\clf_btxdirect{\currentbtxdataset}{\crossreftag}{crossref}}
          \texdefinition{btx:sbl:doifsamefieldelse}{\crossreftag}{\collectiontag}{shorthand} {
            \doifnot{\btxflush{pages}\currentbtxrighttext}{\empty} {
              \removeunwantedspaces
              \removepunctuation
              \btxspace
              \startparen
              \textcite[alternative=short][\collectiontag]
              \btxspace
              \textcite[alternative=volume][\crossreftag]
              \btxdoif {part} {
                \btxperiod
                \removeunwantedspaces
                \btxflush{part}
              }
              \btxcolon
              \removeunwantedspaces
              \btxdoif{pages} {
                \btxusecommand[sbl:\s!list:pages]{
                  \btxflush{pages}%
                }
                \btxcomma
              }
              % If any specific page numbers were cited explicitly by the user, then print them next
              \texdefinition{btx:sbl:inline:righttext}
              \removeunwantedspaces
              \removepunctuation
              \stopparen
              \btxcomma
            }
          } {
            \doifnot{\btxflush{pages}\currentbtxrighttext}{\empty} {
              \removeunwantedspaces
              \removepunctuation
              \btxspace
              \startparen
              \textcite[alternative=short][\crossreftag]
              \btxcomma
              \btxdoif {part} {
                \removeunwantedspaces
                \removepunctuation
                \btxspace
                \btxflush{part}
                \btxcolon
                \removeunwantedspaces
              }
              \btxdoif{pages} {
                \btxusecommand[sbl:\s!list:pages]{
                  \btxflush{pages}%
                }
                \btxcomma
              }
              % If any specific page numbers were cited explicitly by the user, then print them next
              \texdefinition{btx:sbl:inline:righttext}
              \removeunwantedspaces
              \removepunctuation
              \stopparen
              \btxcomma
            }
          }
        } {
          \doifnot{\btxflush{pages}\currentbtxrighttext}{\empty} {
            \removeunwantedspaces
            \removepunctuation
            \btxspace
            \startparen
            \textcite[alternative=short][\crossreftag]
            \btxcomma
            \btxdoif {part} {
              \removeunwantedspaces
              \removepunctuation
              \btxspace
              \btxflush{part}
              \btxcolon
              \removeunwantedspaces
            }
            \btxdoif{pages} {
              \btxusecommand[sbl:\s!list:pages]{
                \btxflush{pages}%
              }
              \btxcomma
            }
            % If any specific page numbers were cited explicitly by the user, then print them next
            \texdefinition{btx:sbl:inline:righttext}
            \removeunwantedspaces
            \removepunctuation
            \stopparen
            \btxcomma
          }
        }
      } {
        \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{crossref} {
          \def\collectiontag{\clf_btxdirect{\currentbtxdataset}{\crossreftag}{crossref}}
          \clf_btxdoifelse{\currentbtxdataset}{\collectiontag}{shorthand} {
            \doifnot{\btxflush{pages}\currentbtxrighttext}{\empty} {
              \removeunwantedspaces
              \removepunctuation
              \btxspace
              \startparen
              \textcite[alternative=short][\collectiontag]
              \btxspace
              \textcite[alternative=volume][\crossreftag]
              \btxdoif {part} {
                \btxperiod
                \removeunwantedspaces
                \btxflush{part}
              }
              \btxcolon
              \removeunwantedspaces
              \btxdoif{pages} {
                \btxusecommand[sbl:\s!list:pages]{
                  \btxflush{pages}%
                }
                \btxcomma
              }
              % If any specific page numbers were cited explicitly by the user, then print them next
              \texdefinition{btx:sbl:inline:righttext}
              \removeunwantedspaces
              \removepunctuation
              \stopparen
              \btxcomma
            }
          } {
            \removeunwantedspaces
            \removepunctuation
            \btxspace
            \startparen
            \cite[alternative=inline,printauthor=yes,printpubl=yes,lefttext=,righttext=,punct=][\crossreftag]
            \btxcomma
            \btxdoif {part} {
              \btxflush{part}
              \btxcolon
              \removeunwantedspaces
            }
            \btxdoif{pages} {
              \btxusecommand[sbl:\s!list:pages]{
                \btxflush{pages}%
              }
              \btxcomma
            }
            % If any specific page numbers were cited explicitly by the user, then print them next
            \texdefinition{btx:sbl:inline:righttext}
            \removeunwantedspaces
            \removepunctuation
            \stopparen
            \btxcomma
          }
        } {
          \removeunwantedspaces
          \removepunctuation
          \btxspace
          \startparen
          \cite[alternative=inline,printauthor=yes,printpubl=yes,lefttext=,righttext=,punct=][\crossreftag]
          \btxcomma
          \btxdoif {part} {
            \btxflush{part}
            \btxcolon
            \removeunwantedspaces
          }
          \btxdoif{pages} {
            \btxusecommand[sbl:\s!list:pages]{
              \btxflush{pages}%
            }
            \btxcomma
          }
          % If any specific page numbers were cited explicitly by the user, then print them next
          \texdefinition{btx:sbl:inline:righttext}
          \removeunwantedspaces
          \removepunctuation
          \stopparen
          \btxcomma
        }
      }
      \endgroup
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:short:ancienttextcrossref
  \btxdoif{crossref} {
    % Is this entry of subtype "PGM"?
    \doifelse{\btxflush{entrysubtype}}{PGM}{
      % If so, then print the translator (if there is one) in parentheses,
      % followed by any cited page numbers (§6.4.3.3)
      \btxdoif {translator} {
        \removeunwantedspaces
        \removepunctuation
        \btxspace
        \startparen
        \btxflush{translator}
        \doifnot {\currentbtxlefttext} {\empty} {
          \btxcomma
          \texdefinition{btx:sbl:short:righttext}
        }
        \stopparen
        \btxcomma
      }
    } {
      % Otherwise, if there are any cited pages, remove the preceding comma and print source shorthand and cited pages in parentheses
      \doifnot {\currentbtxrighttext} {\empty} {
        \removeunwantedspaces
        \removepunctuation
        \btxspace
        \startparen
        \begingroup
        \def\crossreftag{\btxflush{crossref}}
        \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{crossref} {
          % If the collection entry has a shorthand, then cite it;
          % otherwise, just cite its author/editor
          \def\collectiontag{\clf_btxdirect{\currentbtxdataset}{\crossreftag}{crossref}}
          \clf_btxdoifelse{\currentbtxdataset}{\collectiontag}{shorthand} {
            \textcite[alternative=short][\collectiontag]
            \btxspace
          } {
            \clf_btxauthor
              {\currentbtxdataset}%
              {\crossreftag}%
              {author}%
              {%
                  combiner    {name}%
                  kind        {cite}%
                  etallimit   {sbl:\s!cite\c!etallimit}%
                  etaldisplay {sbl:\s!cite\c!etaldisplay}%
                  etaloption  {sbl:\s!cite\c!etaloption}%
                  symbol      {sbl:\s!cite\c!stopper:initials}%
                  connector   {sbl:\s!cite\c!connector:initials}%
              }%
            \btxcomma
          }
          \textcite[alternative=volume][\crossreftag]
          \btxdoif {part} {
            \btxperiod
            \removeunwantedspaces
            \btxflush{part}
          }
          \btxcolon
          \removeunwantedspaces
          \texdefinition{btx:sbl:short:righttext}
        } {
          % If the book containing this text is of type "seriesascollection", 
          % then remove the preceding comma and print the series and series entry numbers, 
          % followed by the part number of this entry (if it has one) and cited pages
          \doifelse {\clf_btxdirect{\currentbtxdataset}{\crossreftag}{type}} {seriesascollection} {
            \textcite[alternative=short][\crossreftag]
            \removeunwantedspaces
            \removepunctuation
            \btxdoif {part} {
              \btxperiod
              \removeunwantedspaces
              \btxflush{part}
            }
            \btxcolon
            \removeunwantedspaces
          } {
            % Otherwise, cite the shorthand (or, failing that, the author/editor) of the book
            \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{shorthand} {
              \textcite[alternative=short][\crossreftag]
            } {
              \clf_btxauthor
                {\currentbtxdataset}%
                {\crossreftag}%
                {author}%
                {%
                    combiner    {name}%
                    kind        {cite}%
                    etallimit   {sbl:\s!cite\c!etallimit}%
                    etaldisplay {sbl:\s!cite\c!etaldisplay}%
                    etaloption  {sbl:\s!cite\c!etaloption}%
                    symbol      {sbl:\s!cite\c!stopper:initials}%
                    connector   {sbl:\s!cite\c!connector:initials}%
                }%
            }
            \btxcomma
            \btxdoif {part} {
              \btxflush{part}
              \btxcolon
              \removeunwantedspaces
            }
          }
          \texdefinition{btx:sbl:short:righttext}
        }
        \removeunwantedspaces
        \removepunctuation
        \endgroup
        \stopparen
        \btxcomma
      }
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inline:classictextcrossref
  % If this entry is of type "seriesascollection", then cite the series (and number), followed by any cited page numbers
  \doifelse {\btxflush{type}} {seriesascollection} {
    % The book cross-reference will always be in parentheses/brackets:
    \removeunwantedspaces
    \removepunctuation
    \btxspace
    \startparen
    \texdefinition{btx:sbl:inline:seriesxref}
    \doifnot {\currentbtxrighttext} {\empty} {
      \removeunwantedspaces
      \removepunctuation
      \btxcolon
      \removeunwantedspaces
      \texdefinition{btx:sbl:inline:righttext}
    }
    \removeunwantedspaces
    \removepunctuation
    \stopparen
    \btxcomma
  } {
    \btxdoif {crossref} {
      % The book cross-reference will always be in parentheses/brackets, and it must include a righttext or a translator
      % If there is a translator, then print their last name
      \texdefinition{btx:sbl:doifownfield} {translator} {
        \removeunwantedspaces
        \removepunctuation
        \btxspace
        \startparen
        \btxflushauthorname{translator}
        \begingroup
        \def\crossreftag{\btxflush{crossref}}
        % If the collection, volume, or book containing this text uses the shorthand of its series (e.g., LCL), then cite it here,
        % followed by any cited page numbers
        \doif{\clf_btxdirect{\currentbtxdataset}{\crossreftag}{type}} {useseriesshorthand} {
          \btxcomma
          \cite[alternative=short][\crossreftag]
          \doifnot {\currentbtxrighttext} {\empty} {
            \btxcomma
            \texdefinition{btx:sbl:inline:righttext}
          }
        }
        \endgroup
        \stopparen
        \btxspace
      }
      \doifnot {\currentbtxrighttext} {\empty} {
        \removeunwantedspaces
        \removepunctuation
        \btxdoifelse {translator} {
          \btxcomma
        } {
          \btxspace
          \startparen
        }
        \begingroup
        \def\crossreftag{\btxflush{crossref}}
        % If this entry is of type "seriesascollection", then cite the series (and number), followed by any cited page numbers
        \doifelse {\btxflush{type}} {seriesascollection} {
          \texdefinition{btx:sbl:inline:seriesxref}
          \doifnot {\currentbtxrighttext} {\empty} {
            \removeunwantedspaces
            \removepunctuation
            \btxcolon
            \removeunwantedspaces
            \texdefinition{btx:sbl:inline:righttext}
          }
        } {
          % Otherwise, cite the shorthand (if there is one) of the book or collection containing this text, followed by any cited page numbers
          \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{crossref} {
            \def\collectiontag{\clf_btxdirect{\currentbtxdataset}{\crossreftag}{crossref}}
            \textcite[alternative=short][\collectiontag]
            \btxspace
            \textcite[alternative=volume][\crossreftag]
            \btxcolon
            \removeunwantedspaces
            \texdefinition{btx:sbl:inline:righttext}
          } {
            % A classictext may cross-reference a multivolume set directly (rather than through a single volume in it), 
            % so a comma after the shorthand may or may not be needed
            \clf_btxdoif{\currentbtxdataset}{\crossreftag}{shorthand} {
              \textcite[alternative=short][\crossreftag]
              \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{volumes} {
                \btxspace
              } {
                \btxcomma
              }
            }
            \texdefinition{btx:sbl:inline:righttext}
          }
        }
        \removeunwantedspaces
        \removepunctuation
        \endgroup
        \btxdoifnot {translator} {
          \stopparen
        }
        \btxcomma
      }
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:short:classictextcrossref
  \texdefinition{btx:sbl:inline:classictextcrossref}
\stoptexdefinition

\starttexdefinition btx:sbl:list:part
  \btxdoif {part} {
    \btxflush{part}
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inline:part
  \texdefinition{btx:sbl:list:part}
\stoptexdefinition

\starttexdefinition btx:sbl:list:bookcrossref
  \btxdoif{crossref} {
    \begingroup
    \def\crossreftag{\btxflush{crossref}}
    % If there is a volume number, then print it here
    \btxdoif {volume} {
      \btxoneorrange {volume} {
        \btxlabeltext{sbl:Volume}
      } {
        \btxlabeltext{sbl:Volumes}
      }
      \btxspace
      \btxflush{volume}
      % Is there a part number subdividing the volume?
      \btxdoif {part} {
        \btxcomma
        \btxoneorrange {part} {
          \btxlabeltext{sbl:part}
        } {
          \btxlabeltext{sbl:parts}
        }
        \btxspace
        \texdefinition{btx:sbl:list:part}
      }
      \btxspace
      \btxlabeltext{sbl:of}
      \btxspace
    }
    % If this entry has the same title as the collection containing it, then cite the collection, and add it to the list;
    % otherwise, cite it, but do not add it to the list
    \texdefinition{btx:sbl:doifsametitleelse}{\currentbtxtag}{\crossreftag} {
      \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\crossreftag}{
        \cite[alternative=listsubcite,printauthor=no,printpubl=no][\crossreftag]
      } {
        \cite[alternative=listsubcite,printauthor=yes,printpubl=no][\crossreftag]
      }
    } {
      \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\crossreftag}{
        \textcite[alternative=listsubcite,printauthor=no,printpubl=no][\crossreftag]
      } {
        \textcite[alternative=listsubcite,printauthor=yes,printpubl=no][\crossreftag]
      }
    }
    \endgroup
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:listsubcite:bookcrossref
  \btxdoif{crossref} {
    \begingroup
    \def\crossreftag{\btxflush{crossref}}
    % If there is a volume number (and there should be, as it is a required field), then print it here
    \btxdoif {volume} {
      \btxoneorrange {volume} {
        % If the entry has a different title than the collection containing it, then we start a sentence with the volume (and part) here;
        % otherwise, it is in the middle of a sentence
        \texdefinition{btx:sbl:doifsametitleelse}{\currentbtxtag}{\crossreftag} {
          \btxlabeltext{sbl:volume}
        } {
          \btxlabeltext{sbl:Volume}
        }
      } {
        % If the entry has a different title than the collection containing it, then we start a sentence with the volume (and part) here;
        % otherwise, it is in the middle of a sentence
        \texdefinition{btx:sbl:doifsametitleelse}{\currentbtxtag}{\crossreftag} {
          \btxlabeltext{sbl:volumes}
        } {
          \btxlabeltext{sbl:Volumes}
        }
      }
      \btxspace
      \btxflush{volume}
      % Is there a part number subdividing the volume?
      \btxdoif {part} {
        \btxcomma
        \btxoneorrange {part} {
          \btxlabeltext{sbl:part}
        } {
          \btxlabeltext{sbl:parts}
        }
        \btxspace
        \texdefinition{btx:sbl:list:part}
      }
      \btxspace
      \btxlabeltext{sbl:of}
      \btxspace
    }
    % Recursively cite the collection, but do not save it to the list
    \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\crossreftag}{
      \textcite[alternative=listsubcite,printauthor=no,printpubl=no][\crossreftag]
    } {
      \textcite[alternative=listsubcite,printauthor=yes,printpubl=no][\crossreftag]
    }
    \btxperiod
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inline:bookcrossref
  \btxdoif{crossref} {
    % If this entry has a title distinct from its collection's title, then we can print its volume (and part) here;
    % otherwise, we do nothing, as the collection will be cited instead of this entry, and the volume and part numbers will prefix page numbers later
    \begingroup
    \def\crossreftag{\btxflush{crossref}}
    \texdefinition{btx:sbl:doifsametitleelse}{\currentbtxtag}{\crossreftag} {
      % If they are the same, then just recursively cite the collection, adding it to the list
      \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\crossreftag} {
        \cite[alternative=inline,printauthor=no,printpubl=no][\crossreftag]
      } {
        \cite[alternative=inline,printauthor=yes,printpubl=no][\crossreftag]
      }
    } {
      % Otherwise, print the volume and part, and cite the collection without adding it to the list
      \btxdoif {volume} {
        \btxoneorrange {volume} {
          \btxlabeltext{sbl:volume}
        } {
          \btxlabeltext{sbl:volumes}
        }
        \btxspace
        \btxflush{volume}
        % Is there a part number subdividing the volume?
        \btxdoif {part} {
          \btxcomma
          \btxoneorrange {part} {
            \btxlabeltext{sbl:part}
          } {
            \btxlabeltext{sbl:parts}
          }
          \btxspace
          \btxflush{volume}
        }
        \btxspace
        \btxlabeltext{sbl:of}
        \btxspace
      }
      % Recursively cite the collection, but do not add it to the list
      \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\crossreftag} {
        \textcite[alternative=inlinesubcite,printauthor=no,printpubl=no][\crossreftag]
      } {
        \textcite[alternative=inlinesubcite,printauthor=yes,printpubl=no][\crossreftag]
      }
      \btxcomma
    }
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inlinesubcite:bookcrossref
  \btxdoif{crossref} {
    % If this entry has a title distinct from its collection's title, then we can print its volume (and part) here;
    % otherwise, we do nothing, as the collection will be cited instead of this entry, and the volume and part numbers will prefix page numbers later
    \begingroup
    \def\crossreftag{\btxflush{crossref}}
    \texdefinition{btx:sbl:doifsametitleelse}{\currentbtxtag}{\crossreftag} {
      % If they are the same, then just recursively cite the collection
      \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\crossreftag} {
        \textcite[alternative=inlinesubcite,printauthor=no,printpubl=no][\crossreftag]
      } {
        \textcite[alternative=inlinesubcite,printauthor=yes,printpubl=no][\crossreftag]
      }
      \btxcomma
    } {
      % Otherwise, print the volume and part, and cite the collection
      \btxdoif {volume} {
        \btxoneorrange {volume} {
          \btxlabeltext{sbl:volume}
        } {
          \btxlabeltext{sbl:volumes}
        }
        \btxspace
        \btxflush{volume}
        % Is there a part number subdividing the volume?
        \btxdoif {part} {
          \btxcomma
          \btxoneorrange {part} {
            \btxlabeltext{sbl:part}
          } {
            \btxlabeltext{sbl:parts}
          }
          \btxspace
          \btxflush{part}
        }
        \btxspace
        \btxlabeltext{sbl:of}
        \btxspace
      }
      % Recursively cite the collection, but do not add it to the list
      \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\crossreftag} {
        \textcite[alternative=inlinesubcite,printauthor=no,printpubl=no][\crossreftag]
      } {
        \textcite[alternative=inlinesubcite,printauthor=yes,printpubl=no][\crossreftag]
      }
      \btxcomma
    }
    \endgroup
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:volumes
  \btxdoif {volumes} {
    \btxflush{volumes}
    \btxspace
    \doifelse {\btxflush{volumes}} {1} {
      \btxlabeltext{sbl:volume}
    } {
      \btxlabeltext{sbl:volumes}
    }
    % If the volumes are subdivided by a specified number of parts,
    % then print the number of parts, as well
    \btxdoif {parts} {
      \btxspace
      \btxlabeltext{sbl:in}
      \btxspace
      \btxflush{parts}
    }
    % Don't duplicate the period from "vol." or "vols."
    \removeunwantedspaces
    \removepunctuation
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inline:volumes
  \btxdoif {volumes} {
    \btxflush{volumes}
    \btxspace
    \doifelse {\btxflush{volumes}} {1} {
      \btxlabeltext{sbl:volume}
    } {
      \btxlabeltext{sbl:volumes}
    }
    % If the volumes are subdivided by a specified number of parts,
    % then print the number of parts, as well
    \btxdoif {parts} {
      \btxspace
      \btxlabeltext{sbl:in}
      \btxspace
      \btxflush{parts}
    }
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:edition
  \btxdoif{edition} {
    % Is the edition a string or a number?
    \doifnumberelse {\btxflush{edition}} {
      % If a number, then convert it to an ordinal
      \btxusecommand[sbl:\s!list:edition] {
        \btxflush{edition}%
      }
    } {
      % If a string, then capitalize its first word
      \Word{\btxflush{edition}}%
    }
    \btxspace
    \btxlabeltext{sbl:edition}
    % Don't duplicate the period from "ed."
    \removeunwantedspaces
    \removepunctuation
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inline:edition
  \btxdoif{edition} {
    % Is the edition a string or a number?
    \doifnumberelse {\btxflush{edition}} {
      % If a number, then convert it to an ordinal
      \btxusecommand[sbl:\s!list:edition] {
        \btxflush{edition}%
      }
    } {
      % If a string, then print it as-is
      \btxflush{edition}
    }
    \btxspace
    \btxlabeltext{sbl:edition}
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:seriesxref
  \btxdoif {series} {
    % Is this a cross-reference to a separate entry for the series?
    \doifelse {\btxfoundname{series}} {seriesxref} {
      % If so, then recursively cite the series, but do not add it to the list
      \begingroup
      \def\seriesxreftag{\btxflush{series}}
      \textcite[alternative=short][\seriesxreftag]
      \endgroup
    } {
      % Otherwise, this field just contains the series name; print it with the appropriate formatting
      \btxstartstyleandcolor[sbl:\s!list:title:series]
        \btxusecommand[sbl:\s!list:title:series] {
          \btxflush{series}% set the series name according to its style
        }
      \btxstopstyleandcolor
    }
    % If the series itself has a series number (e.g., "WUNT 2", the second series of WUNT),
    % then print that number before the series entry number, with a forward slash in between
    \btxdoifelse {seriesseries} {
      \btxspace
      \btxflush{seriesseries}
      \btxdoif {number} {
        \removeunwantedspaces
        {/}
        \btxflush{number}
      }
    } {
      % Otherwise, just print the series entry number, if there is one
      \btxdoif {number} {
        \btxspace
        \btxflush{number}
      }
    }
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inline:seriesxref
  \btxdoif {series} {
    % Is this a cross-reference to a separate entry for the series?
    \doifelse {\btxfoundname{series}} {seriesxref} {
      % If so, then recursively cite the series, but do not add it to the list
      \begingroup
      \def\seriesxreftag{\btxflush{series}}
      \textcite[alternative=short][\seriesxreftag]
      \endgroup
    } {
      % Otherwise, this field just contains the series name; print it with the appropriate formatting
      \btxstartstyleandcolor[sbl:\s!list:title:series]
        \btxusecommand[sbl:\s!list:title:series] {
          \btxflush{series}% set the series name according to its style
        }
      \btxstopstyleandcolor
    }
    % If the series itself has a series number (e.g., "WUNT 2", the second series of WUNT),
    % then print that number before the series entry number, with a forward slash in between
    \btxdoifelse {seriesseries} {
      \btxspace
      \btxflush{seriesseries}
      \btxdoif {number} {
        \removeunwantedspaces
        {/}
        \btxflush{number}
      }
    } {
      % Otherwise, just print the series entry number, if there is one
      \btxdoif {number} {
        \btxspace
        \btxflush{number}
      }
    }
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:howpublished
  \btxdoif {howpublished} {
    % Print the how-published statement
    \btxflush{howpublished}
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inline:howpublished
  \btxdoif {howpublished} {
    % Print the how-published statement
    \btxflush{howpublished}
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:journalxref
  \btxdoif {journal} {
    % Is this a cross-reference to a separate entry for the journal?
    \doifelse {\btxfoundname{journal}} {journalxref} {
      % If so, then recursively cite the journal, but do not add it to the list
      \begingroup
      \def\journalxreftag{\btxflush{journal}}
      \textcite[alternative=short][\journalxreftag]
      \endgroup
    } {
      % Otherwise, this field just contains the journal name; print it with the appropriate formatting
      \btxstartstyleandcolor[sbl:\s!list:title:journal]
        \btxusecommand[sbl:\s!list:title:journal] {
          \btxflush{journal}% set the journal name according to its style
        }
      \btxstopstyleandcolor
    }
    % Print the volume(s), number(s), date(s), and page range(s)
    \btx_sbl_serializevolumenumberdatepage{\btxflush{volume}}{\btxflush{number}}{\btxflush{date}}{\btxflush{pages}}
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inline:journalxref
  \btxdoif {journal} {
    % Is this a cross-reference to a separate entry for the journal?
    \doifelse {\btxfoundname{journal}} {journalxref} {
      % If so, then recursively cite the journal, but do not add it to the list
      \begingroup
      \def\journalxreftag{\btxflush{journal}}
      \textcite[alternative=short][\journalxreftag]
      \endgroup
    } {
      % Otherwise, this field just contains the journal name; print it with the appropriate formatting
      \btxstartstyleandcolor[sbl:\s!list:title:journal]
        \btxusecommand[sbl:\s!list:title:journal] {
          \btxflush{journal}% set the journal name according to its style
        }
      \btxstopstyleandcolor
    }
    % Print the volume(s), number(s), date(s), and page range(s)
    \btx_sbl_serializevolumenumberdatepage{\btxflush{volume}}{\btxflush{number}}{\btxflush{date}}{\btxflush{pages}}
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:publisher
  \btxdoif {publisher} {
    % Is this a reprint?
    \btxdoif {origdate} {
      % Is there an original publisher distinct from the current publisher?
      % If not, then we assume that the publisher is the same, and only the date is different
      \btxdoif {origpublisher} {
        \doifnot {\btxflush{origpublisher}} {\btxflush{publisher}} {
          % Is the original location distinct from the current location?
          \btxdoifelse {origlocation} {
            \btx_sbl_serializelocationpublisher{\btxflush{origlocation}}{\btxflush{origpublisher}}
          } {
            \btx_sbl_serializelocationpublisher{\btxflush{location}}{\btxflush{origpublisher}}
          }
          \btxcomma
        }
      }
      \btxflush{origdate}
      \btxperiod
      % Follow this with the reprint notation
      \btxlabeltext{sbl:Reprint}
      \btxcomma
    }
    % Is there a publisher?
    \btxdoif {publisher} {
      % Does the publisher have a location?
      \btxdoifelse {location} {
        \btx_sbl_serializelocationpublisher{\btxflush{location}}{\btxflush{publisher}}% in case there are multiple publishers at different locations
      } {
        \btxflush{publisher}
      }
      \btxcomma
    }
    % Is there a publication date?
    \btxdoif{date} {
      \btxflush{date}
      \btxcomma
    }
    % Close the publication block
    \removeunwantedspaces
    \removepunctuation
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inline:publisher
  \btxdoif {publisher} {
    % Remove all preceding punctuation and spaces and use a parenthesis or bracket
    \removeunwantedspaces
    \removepunctuation
    \btxspace
    \startparen
    % Is this a reprint?
    \btxdoif {origdate} {
      % Is there an original publisher distinct from the current publisher?
      % If not, then we assume that the publisher is the same, and only the date is different
      \btxdoif {origpublisher} {
        \doifnot {\btxflush{origpublisher}} {\btxflush{publisher}} {
          % Is the original location distinct from the current location?
          \btxdoifelse {origlocation} {
            \btx_sbl_serializelocationpublisher{\btxflush{origlocation}}{\btxflush{origpublisher}}
          } {
            \btx_sbl_serializelocationpublisher{\btxflush{location}}{\btxflush{origpublisher}}
          }
          \btxcomma
        }
      }
      \btxflush{origdate}
      \btxsemicolon
      % Follow this with the reprint notation
      \btxlabeltext{sbl:reprint}
      \btxcomma
    }
    % Is there a publisher?
    \btxdoif {publisher} {
      % Does the publisher have a location?
      \btxdoifelse {location} {
        \btx_sbl_serializelocationpublisher{\btxflush{location}}{\btxflush{publisher}}% in case there are multiple publishers at different locations
      } {
        \btxflush{publisher}
      }
      \btxcomma
    }
    % Is there a publication date?
    \btxdoif{date} {
      \btxflush{date}
      \btxcomma
    }
    % Close the publication block
    \removeunwantedspaces
    \removepunctuation
    \stopparen
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:institution
  \btxdoif {institution} {
    % Print which type of thesis is being cited
    \doifelse {\currentbtxcategory} {phdthesis} {
      \btxlabeltext{sbl:phd}
      \btxspace
      \btxlabeltext{sbl:diss}
      \btxcomma
    } {
      \doifelse {\currentbtxcategory} {mastersthesis} {
        \btxlabeltext{sbl:masters}
        \btxspace
        \btxlabeltext{sbl:thesis}
        \btxcomma
      } {
        \btxdoif {type} {
          \doif {\btxfield{type}} {phdthesis} {
            \btxlabeltext{sbl:phd}
            \btxspace
            \btxlabeltext{sbl:diss}
            \btxcomma
          }
          \doif {\btxfield{type}} {mastersthesis} {
            \btxlabeltext{sbl:masters}
            \btxspace
            \btxlabeltext{sbl:thesis}
            \btxcomma
          }
        }
      }
    }
    % Print the institution name:
    \btxflush{institution}
    \btxcomma
    % Print the date:
    \btxdoif {date} {
      \btxflush{date}
      \btxcomma
    }
    \removeunwantedspaces
    \removepunctuation
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inline:institution
  \btxdoif {institution} {
    % Remove all preceding punctuation and spaces and use a parenthesis or bracket
    \removeunwantedspaces
    \removepunctuation
    \btxspace
    \startparen
    % Print which type of thesis is being cited
    \doifelse {\currentbtxcategory} {phdthesis} {
      \btxlabeltext{sbl:phd}
      \btxspace
      \btxlabeltext{sbl:diss}
      \btxcomma
    } {
      \doifelse {\currentbtxcategory} {mastersthesis} {
        \btxlabeltext{sbl:masters}
        \btxspace
        \btxlabeltext{sbl:diss}
        \btxcomma
      } {
        \btxdoif {type} {
          \doif {\btxfield{type}} {phdthesis} {
            \btxlabeltext{sbl:phd}
            \btxspace
            \btxlabeltext{sbl:diss}
            \btxcomma
          }
          \doif {\btxfield{type}} {mastersthesis} {
            \btxlabeltext{sbl:masters}
            \btxspace
            \btxlabeltext{sbl:diss}
            \btxcomma
          }
        }
      }
    }
    % Print the institution name:
    \btxflush{institution}
    \btxcomma
    % Print the date:
    \btxdoif {date} {
      \btxflush{date}
      \btxcomma
    }
    % Close the institution block
    \removeunwantedspaces
    \removepunctuation
    \stopparen
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:presentedat
  \btxdoif {conference} {
    % Print the "paper presented at" preamble
    \btxlabeltext{sbl:Paperpresentedat}
    \btxspace
    \btxflush{conference}
    \btxperiod
    % Is there a location?
    \btxdoif {location} {
      \btxflush{location}
      \btxcomma
    }
    % Print the event date (formatted appropriately)
    \btxdoif {date} {
      \btx_sbl_convertdate{\btxflush{date}}
      \btxcomma
    }
    % Close the block
    \removeunwantedspaces
    \removepunctuation
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inline:presentedat
  \btxdoif {conference} {
    % Remove all preceding punctuation and spaces and use a parenthesis
    \removeunwantedspaces
    \removepunctuation
    \btxspace
    \startparen
    % Print the "paper presented at" preamble
    \btxlabeltext{sbl:paperpresentedat}
    \btxspace
    \btxflush{conference}
    \btxcomma
    % Is there a location?
    \btxdoif {location} {
      \btxflush{location}
      \btxcomma
    }
    % Print the event date (formatted appropriately)
    \btxdoif {date} {
      \btx_sbl_convertdate{\btxflush{date}}
      \btxcomma
    }
    % Close the block
    \removeunwantedspaces
    \removepunctuation
    \stopparen
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:ebook
  \btxdoif {eprint} {
    % Just print the eprint as an edition (e.g., "Nook edition")
    \btxflush{eprint}
    \btxspace
    \btxlabeltext{sbl:editionfull}
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inline:ebook
  \btxdoif {eprint} {
    % Just print the eprint as an edition (e.g., "Nook edition")
    \btxflush{eprint}
    \btxspace
    \btxlabeltext{sbl:editionfull}
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:related
  \btxdoif{related} {
    % Print the appropriate preamble for the type of the related entry, if there is one;
    % if it is not a supported type, then print it as-is
    \doif {\btxflush{relatedtype}} {reprintof} {
      \btxlabeltext{sbl:Reprintof}
      \btxspace
    }
    \doif {\btxflush{relatedtype}} {translationof} {
      \btxlabeltext{sbl:Translationof}
      \btxspace
    }
    \doifnotinset {\btxflush{relatedtype}} {reprintof, translationof} {
      \btxusecommand[sbl:\s!list:type]{
        \btxflush{relatedtype}% make sure it's capitalized
      }
    }
    % Recursively cite the related entry, but do not add it to the list
    % TODO: biblatex allows multiple comma-separated related entries, although they all have to share a single relatedtype
    \begingroup
    \def\relatedtag{\btxflush{related}}
    \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\relatedtag}{
      \textcite[alternative=listsubcite,printauthor=no,printpubl=yes][\relatedtag]
    } {
      \textcite[alternative=listsubcite,printauthor=yes,printpubl=yes][\relatedtag]
    }
    \endgroup
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inline:related
  \btxdoif{related} {
    % Replace any preceding punctuation with a semicolon
    \removeunwantedspaces
    \removepunctuation
    \btxsemicolon
    % Print the appropriate preamble for the type of the related entry, if there is one;
    % if it is not a supported type, then print it as-is
    \doif {\btxflush{relatedtype}} {reprintof} {
      \btxlabeltext{sbl:reprintof}
      \btxspace
    }
    \doif {\btxflush{relatedtype}} {translationof} {
      \btxlabeltext{sbl:translationof}
      \btxspace
    }
    \doifnotinset {\btxflush{relatedtype}} {reprintof, translationof} {
      \btxflush{relatedtype}% make sure it's capitalized
    }
    % Recursively cite the related entry, but do not add it to the list
    % TODO: biblatex allows multiple comma-separated related entries, although they all have to share a single relatedtype
    \begingroup
    \def\relatedtag{\btxflush{related}}
    \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\relatedtag}{
      \textcite[alternative=inlinesubcite,printauthor=no,printpubl=yes][\relatedtag]
    } {
      \textcite[alternative=inlinesubcite,printauthor=yes,printpubl=yes][\relatedtag]
    }
    \endgroup
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:eprint
  % Is the eprint field present?
  \btxdoifelse {eprint} {
    % Does it have an eprintclass?
    \btxdoifelse {eprintclass} {
      % If so, then this is a document published only online
      % Print the release date (formated appropriately) first, if there is one:
      \btxdoif {eprintdate} {
        \btxlabeltext{sbl:Released}
        \btxspace
        \btx_sbl_convertdate{\btxflush{eprintdate}}
        \btxperiod
      }
      % If it has an eprinttype, then produce a DOI by concatenating it with the the eprint identifier
      \btxdoifelse {eprinttype} {
        {\sc doi}
        \btxcolon
        \removeunwantedspaces
        \hyphenatedurl{\btxflush{eprinttype}/: \btxflush{eprint}}
      } {
        \hyphenatedurl{\btxflush{eprint}}
      }
      % Finally, print its eprintclass in parentheses or brackets
      \btxspace
      \startparen
      \btxflush{eprintclass}
      \stopparen
      \btxperiod
    } {
      % If not, then this is an online database or website with eprint fields
      % Print its eprinttype first, if there is one
      \btxdoif {eprinttype} {
        \btxflush{eprinttype}
        \btxperiod
      }
      % Print the release date (formated appropriately) first, if there is one:
      \btxdoif {eprintdate} {
        \btxlabeltext{sbl:Released}
        \btxspace
        \btx_sbl_convertdate{\btxflush{eprintdate}}
        \btxperiod
      }
      % Then print the eprint identifier
      \hyphenatedurl{\btxflush{eprint}}
      \btxperiod
      % If a DOI was specified, then use it here
      \btxdoif {doi} {
        {\sc doi}
        \btxcolon
        \removeunwantedspaces
        \hyphenatedurl{\btxflush{doi}}
        \btxperiod
      }
    }
  } {
    % If not, then treat this as a website or blog post
    % Does it have a blog title?
    \btxdoif {journal} {
      \doifelse {\btxfoundname{journal}} {journalxref} {
        \begingroup
        \def\journalxreftag{\btxflush{journal}}
        \textcite[alternative=short][\journalxreftag]
        \endgroup
      } {
        \btxstartstyleandcolor[sbl:\s!list:title:journal]
          \btxusecommand[sbl:\s!list:title:journal] {
            \btxflush{journal}% set the journal name according to its style
          }
        \btxstopstyleandcolor
      }
      \btxperiod
    }
    % Then print the date of the post (with appropriate formatting), if specified
    \btxdoif {date} {
      \btx_sbl_convertdate{\btxflush{date}}
      \btxperiod
    }
    % Then print the URL, if specified
    \btxdoif {doi} {
      \hyphenatedurl{\btxflush{doi}}
      \btxperiod
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inline:eprint
  % Is the eprint field present?
  \btxdoifelse {eprint} {
    % Does it have an eprintclass?
    \btxdoifelse {eprintclass} {
      % If so, then this is a document published only online
      % Print the release date (with appropriate formatting) first, if there is one:
      \btxdoif {eprintdate} {
        \btxlabeltext{sbl:released}
        \btxspace
        \btx_sbl_convertdate{\btxflush{eprintdate}}
        \btxcomma
      }
      % If it has an eprinttype, then produce a DOI by concatenating it with the the eprint identifier
      \btxdoifelse {eprinttype} {
        {\sc doi}
        \btxcolon
        \removeunwantedspaces
        \hyphenatedurl{\btxflush{eprinttype}/: \btxflush{eprint}}
      } {
        \hyphenatedurl{\btxflush{eprint}}
      }
      % Finally, print its eprintclass in parentheses or brackets
      \startparen
      \btxflush{eprintclass}
      \stopparen
      \btxcomma
    } {
      % If not, then this is an online database or website with eprint fields
      % Print its eprinttype first, if there is one
      \btxdoif {eprinttype} {
        \btxflush{eprinttype}
        \btxcomma
      }
      % Print the release date (with appropriate formatting) next, if there is one:
      \btxdoif {eprintdate} {
        \btxlabeltext{sbl:released}
        \btxspace
        \btx_sbl_convertdate{\btxflush{eprintdate}}
        \btxcomma
      }
      % Then print the eprint identifier
      \hyphenatedurl{\btxflush{eprint}}
      \btxcomma
      % If a DOI was specified, then use it here
      \btxdoif {doi} {
        {\sc doi}
        \btxcolon
        \removeunwantedspaces
        \hyphenatedurl{\btxflush{doi}}
        \btxcomma
      }
    }
  } {
    % If not, then treat this as a website or blog post
    % Does it have a blog cross-reference?
    \btxdoif {journal} {
      \doifelse {\btxfoundname{journal}} {journalxref} {
        \begingroup
        \def\journalxreftag{\btxflush{journal}}
        \textcite[alternative=short][\journalxreftag]
        \endgroup
      } {
        \btxstartstyleandcolor[sbl:\s!list:title:journal]
          \btxusecommand[sbl:\s!list:title:journal] {
            \btxflush{journal}% set the journal name according to its style
          }
        \btxstopstyleandcolor
      }
      \btxcomma
    }
    % Then print the date of the post (with appropriate formatting), if specified
    \btxdoif {date} {
      \btx_sbl_convertdate{\btxflush{date}}
      \btxcomma
    }
    % Then print the URL, if specified
    \btxdoif {doi} {
      \hyphenatedurl{\btxflush{doi}}
      \btxcomma
    }
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:doi
  \btxdoif {doi} {
    % If the URL is actually a DOI (the preferred case), then indicate this
    \doifelse {\btxfoundname{doi}} {doi} {
      {\sc doi}
      \btxcolon
      \removeunwantedspaces
      \hyphenatedurl{\btxflush{doi}}
      % If both a DOI and URL are present, then print the URL after the DOI
      \btxdoif {url} {
        \btxperiod
        \hyphenatedurl{\btxflush{url}}
      }
    } {
      \hyphenatedurl{\btxflush{doi}}
    }
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inline:doi
  \btxdoif {doi} {
    % If the URL is actually a DOI (the preferred case), then indicate this
    \doifelse {\btxfoundname{doi}} {doi} {
      {\sc doi}
      \btxcolon
      \removeunwantedspaces
      \hyphenatedurl{\btxflush{doi}}
      % If both a DOI and URL are present, then print the URL after the DOI
      \btxdoif {url} {
        \btxcomma
        \hyphenatedurl{\btxflush{url}}
      }
    } {
      \hyphenatedurl{\btxflush{doi}}
    }
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:list:note
  \btxdoif {note} {
    % Make sure the first word is capitalized
    \btxusecommand[sbl:\s!list:note] {
      \btxflush{note}%
    }
    \btxperiod
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inline:note
  \btxdoif {note} {
    \btxflush{note}
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:inline:lefttext
  % In this specification, the lefttext parameter should be reserved for things like line numbers or references within an ancient or classic work,
  % as it will be placed after the ancient or classical work title and not the reference to the work containing or translating it.
  \doifnot {\currentbtxlefttext} {\empty} {
    \currentbtxlefttext
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:short:lefttext
  \texdefinition{btx:sbl:inline:lefttext}
\stoptexdefinition

\starttexdefinition btx:sbl:inline:righttext
  \doifnot {\currentbtxrighttext} {\empty} {
    % TODO: If the entry already has a full page range, there is no bibliography, and this is the first citation of this entry, 
    % then the full page range should be followed by "here" and the specific pages cited in the righttext
    % (https://sblhs2.com/2018/02/08/citing-page-numbers-for-chapters-and-articles/)
    % \btxdoif {pages} {
    %   \btxlabeltext{sbl:here}
    %   \btxspace
    % }
    % If the righttext starts with a section mark, then remove any preceding punctuation
    \btx_sbl_doifprefix {§} {\currentbtxrighttext} {
      \removeunwantedspaces
      \removepunctuation
      \btxspace
    }
    % If the righttext starts with a paragraph mark, then remove any preceding punctuation
    \btx_sbl_doifprefix {¶} {\currentbtxrighttext} {
      \removeunwantedspaces
      \removepunctuation
      \btxspace
    }
    % If the righttext is a page range, then truncate it; otherwise, print it as-is
    \btx_sbl_doifpagerangeelse{\currentbtxrighttext} {
      \btx_sbl_abbreviatepagerange{\currentbtxrighttext}
    } {
      \currentbtxrighttext
    }
    \btxcomma
  }
\stoptexdefinition

\starttexdefinition btx:sbl:short:righttext
  % Same as inline variant, except that we don't need to check for existing page ranges
  \doifnot {\currentbtxrighttext} {\empty} {
    % If the righttext starts with a section mark, then remove any preceding punctuation
    \btx_sbl_doifprefix {§} {\currentbtxrighttext} {
      \removeunwantedspaces
      \removepunctuation
      \btxspace
    }
    % If the righttext starts with a paragraph mark, then remove any preceding punctuation
    \btx_sbl_doifprefix {¶} {\currentbtxrighttext} {
      \removeunwantedspaces
      \removepunctuation
      \btxspace
    }
    % If this entry or the entry it cross-references has a shorthand and the righttext is prefixed by a volume or part number, 
    % then remove any preceding punctuation
    \texdefinition{btx:sbl:doifownfieldelse} {shorthand} {
      \btx_sbl_doifhasvolumepartprefix {\currentbtxrighttext} {
        \removeunwantedspaces
        \removepunctuation
        \btxspace
      }
    } {
      \btxdoif {crossref} {
        \begingroup
        \def\crossreftag{\btxflush{crossref}}
        \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{shorthand} {
          \btx_sbl_doifhasvolumepartprefix {\currentbtxrighttext} {
            \removeunwantedspaces
            \removepunctuation
            \btxspace
          }
        } {
          \clf_btxdoif{\currentbtxdataset}{\crossreftag}{crossref} {
            \def\collectiontag{\clf_btxdirect{\currentbtxdataset}{\crossreftag}{crossref}}
            \clf_btxdoif{\currentbtxdataset}{\collectiontag}{shorthand} {
              \btx_sbl_doifhasvolumepartprefix {\currentbtxrighttext} {
                \removeunwantedspaces
                \removepunctuation
                \btxspace
              }
            }
          }
        }
        \endgroup
      }
    }
    % If the righttext is a page range, then truncate it; otherwise, print it as-is
    \btx_sbl_doifpagerangeelse{\currentbtxrighttext} {
      \btx_sbl_abbreviatepagerange{\currentbtxrighttext}
    } {
      \currentbtxrighttext
    }
    \btxcomma
  }
\stoptexdefinition

% List citation setups
\startsetups btx:sbl:list:series
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:list:editortranslator}
  \texdefinition{btx:sbl:list:volumes}
  \texdefinition{btx:sbl:list:publisher}
  \texdefinition{btx:sbl:list:doi}
  \texdefinition{btx:sbl:list:related}
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:journal
  \fastsetup{btx:sbl:list:series}
\stopsetups

\startsetups btx:sbl:list:mvbook
  \texdefinition{btx:sbl:list:author}
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:list:editortranslator}
  \texdefinition{btx:sbl:list:edition}
  \texdefinition{btx:sbl:list:volumes}
  \texdefinition{btx:sbl:list:seriesxref}
  \texdefinition{btx:sbl:list:publisher}
  \texdefinition{btx:sbl:list:ebook}
  \texdefinition{btx:sbl:list:doi}
  \texdefinition{btx:sbl:list:related}
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:mvreference
  \fastsetup{btx:sbl:list:mvbook}
\stopsetups

\startsetups btx:sbl:list:mvcollection
  \fastsetup{btx:sbl:list:mvbook}
\stopsetups

\startsetups btx:sbl:list:mvproceedings
  \fastsetup{btx:sbl:list:mvbook}
\stopsetups

\startsetups btx:sbl:list:book
  \texdefinition{btx:sbl:list:author}
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:list:bookcrossref}
  \texdefinition{btx:sbl:list:editortranslator}
  \texdefinition{btx:sbl:list:edition}
  \texdefinition{btx:sbl:list:seriesxref}
  \texdefinition{btx:sbl:list:publisher}
  \texdefinition{btx:sbl:list:ebook}
  \texdefinition{btx:sbl:list:doi}
  \texdefinition{btx:sbl:list:related}
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:reference
  \fastsetup{btx:sbl:list:book}
\stopsetups

\startsetups btx:sbl:list:collection
  \fastsetup{btx:sbl:list:book}
\stopsetups

\startsetups btx:sbl:list:proceedings
  \fastsetup{btx:sbl:list:book}
\stopsetups

\startsetups btx:sbl:list:manual
  \fastsetup{btx:sbl:list:book}
\stopsetups

\startsetups btx:sbl:list:inbook
  \texdefinition{btx:sbl:list:author}
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:list:inbookcrossref}
  \texdefinition{btx:sbl:list:related}
  \texdefinition{btx:sbl:list:doi}
  \texdefinition{btx:sbl:list:related}
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:inreference
  \fastsetup{btx:sbl:list:inbook}
\stopsetups

\startsetups btx:sbl:list:incollection
  \fastsetup{btx:sbl:list:inbook}
\stopsetups

\startsetups btx:sbl:list:inproceedings
  \fastsetup{btx:sbl:list:inbook}
\stopsetups

\startsetups btx:sbl:list:suppbook
  \texdefinition{btx:sbl:list:author}
  \texdefinition{btx:sbl:list:suppbookcrossref}
  \texdefinition{btx:sbl:list:related}
  \texdefinition{btx:sbl:list:doi}
  \texdefinition{btx:sbl:list:related}
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:ancienttext
  % An ancienttext may not have an author, 
  % so be sure not to use one inherited from a cross-referenced source
  \texdefinition{btx:sbl:doifownfield} {author} {
    \texdefinition{btx:sbl:list:author}
  }
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:list:editortranslator}
  \texdefinition{btx:sbl:list:inbookcrossref}
  \texdefinition{btx:sbl:list:doi}
  \texdefinition{btx:sbl:list:related}
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:classictext
  % A classictext may not have an author,
  % so be sure not to use one inherited from a cross-referenced source
  \texdefinition{btx:sbl:doifownfield} {author} {
    \texdefinition{btx:sbl:list:author}
  }
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:list:editortranslator}
  \texdefinition{btx:sbl:list:inbookcrossref}
  \texdefinition{btx:sbl:list:doi}
  \texdefinition{btx:sbl:list:related}
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:article
  \texdefinition{btx:sbl:list:author}
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:list:journalxref}
  \texdefinition{btx:sbl:list:doi}
  \texdefinition{btx:sbl:list:related}
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:magazine
  \fastsetup{btx:sbl:list:article}
\stopsetups

\startsetups btx:sbl:list:newspaper
  \fastsetup{btx:sbl:list:article}
\stopsetups

\startsetups btx:sbl:list:periodical
  \fastsetup{btx:sbl:list:article}
\stopsetups

\startsetups btx:sbl:list:review
  \texdefinition{btx:sbl:list:author}
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:list:reviewcrossref}
  \texdefinition{btx:sbl:list:journalxref}
  \texdefinition{btx:sbl:list:doi}
  \texdefinition{btx:sbl:list:related}
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:thesis
  \texdefinition{btx:sbl:list:author}
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:list:editortranslator}
  \texdefinition{btx:sbl:list:institution}
  \texdefinition{btx:sbl:list:doi}
  \texdefinition{btx:sbl:list:related}
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:mastersthesis
  \fastsetup{btx:sbl:list:thesis}
\stopsetups

\startsetups btx:sbl:list:phdthesis
  \fastsetup{btx:sbl:list:thesis}
\stopsetups

\startsetups btx:sbl:list:conferencepaper
  \texdefinition{btx:sbl:list:author}
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:list:presentedat}
  \texdefinition{btx:sbl:list:doi}
  \texdefinition{btx:sbl:list:related}
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:unpublished
  \texdefinition{btx:sbl:list:author}
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:list:editortranslator}
  \texdefinition{btx:sbl:list:doi}
  \texdefinition{btx:sbl:list:related}
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:online
  \texdefinition{btx:sbl:list:author}
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:list:editortranslator}
  \texdefinition{btx:sbl:list:eprint}
  \texdefinition{btx:sbl:list:related}
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:list:electronic
  \fastsetup{btx:sbl:list:online}
\stopsetups

\startsetups btx:sbl:list:misc
  \texdefinition{btx:sbl:list:author}
  \texdefinition{btx:sbl:list:title}
  \texdefinition{btx:sbl:list:editortranslator}
  \texdefinition{btx:sbl:list:edition}
  \texdefinition{btx:sbl:list:volumes}
  \texdefinition{btx:sbl:list:seriesxref}
  \texdefinition{btx:sbl:list:howpublished}
  \texdefinition{btx:sbl:list:publisher}
  \texdefinition{btx:sbl:list:doi}
  \texdefinition{btx:sbl:list:related}
  \texdefinition{btx:sbl:list:note}
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

% List subcitation setups
\startsetups btx:sbl:listsubcite:series
  \texdefinition{btx:sbl:list:title}
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:listsubcite:editortranslator}
    \texdefinition{btx:sbl:list:volumes}
    \texdefinition{btx:sbl:list:publisher}
    \texdefinition{btx:sbl:list:doi}
    \texdefinition{btx:sbl:list:related}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:listsubcite:journal
  \fastsetup{btx:sbl:listsubcite:series}
\stopsetups

\startsetups btx:sbl:listsubcite:mvbook
  \texdefinition{btx:sbl:list:title}
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:listsubcite:author}
  }
  % Only cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:listsubcite:editortranslator}
    \texdefinition{btx:sbl:list:edition}
    \texdefinition{btx:sbl:list:volumes}
    \texdefinition{btx:sbl:list:seriesxref}
    \texdefinition{btx:sbl:list:publisher}
    \texdefinition{btx:sbl:list:ebook}
    \texdefinition{btx:sbl:list:doi}
    \texdefinition{btx:sbl:list:related}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:listsubcite:mvreference
  \fastsetup{btx:sbl:listsubcite:mvbook}
\stopsetups

\startsetups btx:sbl:listsubcite:mvcollection
  \fastsetup{btx:sbl:listsubcite:mvbook}
\stopsetups

\startsetups btx:sbl:listsubcite:mvproceedings
  \fastsetup{btx:sbl:listsubcite:mvbook}
\stopsetups

\startsetups btx:sbl:listsubcite:book
  % A book may be untitled and have only a volume number and cross-reference,
  % so be sure not to use a title inherited from a cross-referenced source
  \texdefinition{btx:sbl:doifownfieldelse} {title} {
    \texdefinition{btx:sbl:list:title}
    \btxdoifelse {crossref} {
      \begingroup
      \def\crossreftag{\btxflush{crossref}}
      % If this entry has the same author as the collection to which it belongs, then print the author after subciting the collection;
      % otherwise, print it inline format
      \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\crossreftag}{
        \texdefinition{btx:sbl:listsubcite:bookcrossref}
        % Only cite the author if the printauthor option is set
        \doif {\btxparameter{printauthor}} {\v!yes} {
          \texdefinition{btx:sbl:listsubcite:author}
        }
      } {
        % Only cite the author if the printauthor option is set
        \doif {\btxparameter{printauthor}} {\v!yes} {
          \texdefinition{btx:sbl:inline:author}
        }
        \texdefinition{btx:sbl:listsubcite:bookcrossref}
      }
      \endgroup
    } {
      % Only cite the author if the printauthor option is set
      \doif {\btxparameter{printauthor}} {\v!yes} {
        \texdefinition{btx:sbl:listsubcite:author}
      }
    }
  } {
    \begingroup
    \def\crossreftag{\btxflush{crossref}}
    % If this entry has the same author as the collection to which it belongs, then print the author after subciting the collection;
    % otherwise, print it inline format
    \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\crossreftag}{
      \texdefinition{btx:sbl:listsubcite:bookcrossref}
      % Only cite the author if the printauthor option is set
      \doif {\btxparameter{printauthor}} {\v!yes} {
        \texdefinition{btx:sbl:listsubcite:author}
      }
    } {
      % Only cite the author if the printauthor option is set
      \doif {\btxparameter{printauthor}} {\v!yes} {
        \texdefinition{btx:sbl:inline:author}
      }
      \texdefinition{btx:sbl:listsubcite:bookcrossref}
    }
    \endgroup
  }
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:listsubcite:editortranslator}
    \texdefinition{btx:sbl:list:edition}
    \texdefinition{btx:sbl:list:seriesxref}
    \texdefinition{btx:sbl:list:publisher}
    \texdefinition{btx:sbl:list:ebook}
    \texdefinition{btx:sbl:list:doi}
    \texdefinition{btx:sbl:list:related}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:listsubcite:reference
  \fastsetup{btx:sbl:listsubcite:book}
\stopsetups

\startsetups btx:sbl:listsubcite:collection
  \fastsetup{btx:sbl:listsubcite:book}
\stopsetups

\startsetups btx:sbl:listsubcite:proceedings
  \fastsetup{btx:sbl:listsubcite:book}
\stopsetups

\startsetups btx:sbl:listsubcite:manual
  \fastsetup{btx:sbl:listsubcite:book}
\stopsetups

\startsetups btx:sbl:listsubcite:inbook
  \texdefinition{btx:sbl:list:title}
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:listsubcite:author}
  }
  \texdefinition{btx:sbl:list:inbookcrossref}
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:list:doi}
    \texdefinition{btx:sbl:list:related}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:listsubcite:inreference
  \fastsetup{btx:sbl:listsubcite:inbook}
\stopsetups

\startsetups btx:sbl:listsubcite:incollection
  \fastsetup{btx:sbl:listsubcite:inbook}
\stopsetups

\startsetups btx:sbl:listsubcite:inproceedings
  \fastsetup{btx:sbl:listsubcite:inbook}
\stopsetups

\startsetups btx:sbl:listsubcite:suppbook
  % booksupps do not have titles, so print the author first in normal order, followed by the book cross-reference
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:inline:author}
    \removeunwantedspaces
    \removepunctuation
    \btxperiod
  }
  \texdefinition{btx:sbl:list:suppbookcrossref}
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:list:doi}
    \texdefinition{btx:sbl:list:related}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

% This should only be cited in the abbreviations list
\startsetups btx:sbl:listsubcite:ancienttext
  \texdefinition{btx:sbl:list:title}
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    % An ancienttext may not have an author, 
    % so be sure not to use one inherited from a cross-referenced source
    \texdefinition{btx:sbl:doifownfield} {author} {
      \texdefinition{btx:sbl:listsubcite:author}
    }
  }
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:listsubcite:editortranslator}
    \btxdoif{location} {
      \btxflush{location}
      \btxperiod
    }
    \texdefinition{btx:sbl:list:doi}
    \texdefinition{btx:sbl:list:related}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:listsubcite:classictext
  \texdefinition{btx:sbl:list:title}
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    % A classictext may not have an author, 
    % so be sure not to use one inherited from a cross-referenced source
    \texdefinition{btx:sbl:doifownfield} {author} {
      \texdefinition{btx:sbl:listsubcite:author}
    }
  }
   % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:listsubcite:editortranslator}
    \texdefinition{btx:sbl:list:doi}
    \texdefinition{btx:sbl:list:related}
  }
\stopsetups

\startsetups btx:sbl:listsubcite:article
  \texdefinition{btx:sbl:list:title}
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:listsubcite:author}
  }
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:list:journalxref}
    \texdefinition{btx:sbl:list:doi}
    \texdefinition{btx:sbl:list:related}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:listsubcite:magazine
  \fastsetup{btx:sbl:listsubcite:article}
\stopsetups

\startsetups btx:sbl:listsubcite:newspaper
  \fastsetup{btx:sbl:listsubcite:article}
\stopsetups

\startsetups btx:sbl:listsubcite:periodical
  \fastsetup{btx:sbl:listsubcite:article}
\stopsetups

\startsetups btx:sbl:listsubcite:review
  % Titles are not necessary for book reviews, 
  % so render the author correctly if there isn't one
  \btxdoifelse {title} {
    % "Title, by author."
    \texdefinition{btx:sbl:list:title}
    % Only cite the author if the printauthor option is set
    \doif {\btxparameter{printauthor}} {\v!yes} {
      \texdefinition{btx:sbl:listsubcite:author}
    }
  } {
    % "Author."
    % Only cite the author if the printauthor option is set
    \doif {\btxparameter{printauthor}} {\v!yes} {
      \texdefinition{btx:sbl:inline:author}
      \removeunwantedspaces
      \removepunctuation
      \btxperiod
    }
  }
  \texdefinition{btx:sbl:list:reviewcrossref}
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:list:journalxref}
    \texdefinition{btx:sbl:list:doi}
    \texdefinition{btx:sbl:list:related}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:listsubcite:thesis
  \texdefinition{btx:sbl:list:title}
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:listsubcite:author}
  }
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:listsubcite:editortranslator}
    \texdefinition{btx:sbl:list:institution}
    \texdefinition{btx:sbl:list:doi}
    \texdefinition{btx:sbl:list:related}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:listsubcite:mastersthesis
  \fastsetup{btx:sbl:listsubcite:thesis}
\stopsetups

\startsetups btx:sbl:listsubcite:phdthesis
  \fastsetup{btx:sbl:listsubcite:thesis}
\stopsetups

\startsetups btx:sbl:listsubcite:conferencepaper
  \texdefinition{btx:sbl:list:title}
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:listsubcite:author}
  }
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:list:presentedat}
    \texdefinition{btx:sbl:list:doi}
    \texdefinition{btx:sbl:list:related}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:listsubcite:unpublished
  \texdefinition{btx:sbl:list:title}
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:listsubcite:author}
  }
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:list:editortranslator}
    \texdefinition{btx:sbl:list:doi}
    \texdefinition{btx:sbl:list:related}
  }
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:listsubcite:online
  \texdefinition{btx:sbl:list:title}
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:listsubcite:author}
  }
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:list:editortranslator}
    \texdefinition{btx:sbl:list:eprint}
    \texdefinition{btx:sbl:list:related}
  }
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:listsubcite:electronic
  \fastsetup{btx:sbl:listsubcite:online}
\stopsetups

\startsetups btx:sbl:listsubcite:misc
  \texdefinition{btx:sbl:list:title}
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:listsubcite:author}
  }
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:list:editortranslator}
    \texdefinition{btx:sbl:list:edition}
    \texdefinition{btx:sbl:list:volumes}
    \texdefinition{btx:sbl:list:seriesxref}
    \texdefinition{btx:sbl:list:howpublished}
    \texdefinition{btx:sbl:list:publisher}
    \texdefinition{btx:sbl:list:doi}
    \texdefinition{btx:sbl:list:related}
  }
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

% Inline citation setups
\startsetups btx:sbl:inline:series
  \texdefinition{btx:sbl:inline:title}
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:inline:editortranslator}
    \texdefinition{btx:sbl:inline:volumes}
    \texdefinition{btx:sbl:inline:publisher}
    \texdefinition{btx:sbl:inline:doi}
    \texdefinition{btx:sbl:inline:related}
  }
  \texdefinition{btx:sbl:inline:note}
  \texdefinition{btx:sbl:inline:righttext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inline:journal
  \fastsetup{btx:sbl:inline:series}
\stopsetups

\startsetups btx:sbl:inline:mvbook
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:inline:author}
  }
  \texdefinition{btx:sbl:inline:title}
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:inline:editortranslator}
    \texdefinition{btx:sbl:inline:edition}
    \texdefinition{btx:sbl:inline:volumes}
    \texdefinition{btx:sbl:inline:seriesxref}
    \texdefinition{btx:sbl:inline:publisher}
    \texdefinition{btx:sbl:inline:ebook}
    \texdefinition{btx:sbl:inline:doi}
    \texdefinition{btx:sbl:inline:related}
  }
  \texdefinition{btx:sbl:inline:note}
  \texdefinition{btx:sbl:inline:righttext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inline:mvreference
  \fastsetup{btx:sbl:inline:mvbook}
\stopsetups

\startsetups btx:sbl:inline:mvcollection
  \fastsetup{btx:sbl:inline:mvbook}
\stopsetups

\startsetups btx:sbl:inline:mvproceedings
  \fastsetup{btx:sbl:inline:mvbook}
\stopsetups

\startsetups btx:sbl:inline:book
  % If this entry has the same title as the collection containing it, then just cite its collection, adding it to the list
  \texdefinition{btx:sbl:doifownfieldelse} {title} {
    % Only cite the author if the printauthor option is set
    \doif {\btxparameter{printauthor}} {\v!yes} {
      \texdefinition{btx:sbl:inline:author}
    }
    \texdefinition{btx:sbl:inline:title}
    \texdefinition{btx:sbl:inline:bookcrossref}
    % Only recursively cite publication data if the printpubl option is set
    \doif {\btxparameter{printpubl}} {\v!yes} {
      \texdefinition{btx:sbl:inline:editortranslator}
      \texdefinition{btx:sbl:inline:edition}
      \texdefinition{btx:sbl:inline:seriesxref}
      \texdefinition{btx:sbl:inline:publisher}
      \texdefinition{btx:sbl:inline:ebook}
      \texdefinition{btx:sbl:inline:doi}
      \texdefinition{btx:sbl:inline:related}
    }
    \texdefinition{btx:sbl:inline:note}
    \texdefinition{btx:sbl:inline:righttext}
  } {
    \begingroup
    \def\crossreftag{\btxflush{crossref}}
    \clf_btxdoifelse {\currentbtxdataset}{\crossreftag}{shorthand} {
      \textcite[alternative=short][\crossreftag]
      \btxspace
    } {
      \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\crossreftag} {
        \cite[alternative=inline,printauthor=yes,printpubl=no][\crossreftag]
      } {
        % Only cite the author if the printauthor option is set
        \doif {\btxparameter{printauthor}} {\v!yes} {
          \texdefinition{btx:sbl:inline:author}
        }
        \cite[alternative=inline,printauthor=no,printpubl=no][\crossreftag]
      }
      \btxcomma
      % Only recursively cite publication data if the printpubl option is set
      \doif {\btxparameter{printpubl}} {\v!yes} {
        \texdefinition{btx:sbl:inline:editortranslator}
        \texdefinition{btx:sbl:inline:edition}
        \texdefinition{btx:sbl:inline:seriesxref}
        \texdefinition{btx:sbl:inline:publisher}
        \texdefinition{btx:sbl:inline:ebook}
        \texdefinition{btx:sbl:inline:doi}
        \texdefinition{btx:sbl:inline:related}
      }
    }
    \doifnot {\currentbtxrighttext} {\empty} {
      \btxdoif {volume} {
        \btxflush{volume}
        \btxdoif {part} {
          \btxperiod
          \removeunwantedspaces
          \btxflush{part}
        }
        \btxcolon
      }
      \removeunwantedspaces
      \texdefinition{btx:sbl:inline:righttext}
    }
    \endgroup
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inline:reference
  \fastsetup{btx:sbl:inline:book}
\stopsetups

\startsetups btx:sbl:inline:collection
  \fastsetup{btx:sbl:inline:book}
\stopsetups

\startsetups btx:sbl:inline:proceedings
  \fastsetup{btx:sbl:inline:book}
\stopsetups

\startsetups btx:sbl:inline:manual
  \fastsetup{btx:sbl:inline:book}
\stopsetups

\startsetups btx:sbl:inline:inbook
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:inline:author}
  }
  \texdefinition{btx:sbl:inline:title}
  \texdefinition{btx:sbl:inline:inbookcrossref}
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:inline:doi}
    \texdefinition{btx:sbl:inline:related}
  }
  \texdefinition{btx:sbl:inline:note}
  \texdefinition{btx:sbl:inline:righttext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inline:inreference
  \fastsetup{btx:sbl:inline:inbook}
\stopsetups

\startsetups btx:sbl:inline:incollection
  \fastsetup{btx:sbl:inline:inbook}
\stopsetups

\startsetups btx:sbl:inline:inproceedings
  \fastsetup{btx:sbl:inline:inbook}
\stopsetups

\startsetups btx:sbl:inline:suppbook
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:inline:author}
  }
  \texdefinition{btx:sbl:inline:suppbookcrossref}
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:inline:doi}
    \texdefinition{btx:sbl:inline:related}
  }
  \texdefinition{btx:sbl:inline:note}
  \texdefinition{btx:sbl:inline:righttext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inline:ancienttext
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    % An ancienttext may not have an author, 
    % so be sure not to use one inherited from a cross-referenced source
    % TODO: This would mess up entries that correctly list the ancient author as the author of both the individual text and the volume;
    % the correct way to solve this is to have inherited field mappings properly implemented.
    \texdefinition{btx:sbl:doifownfield} {author} {
      \texdefinition{btx:sbl:inline:author}
    }
  }
  \texdefinition{btx:sbl:inline:title} % lefttext is handled in here
  % Only recursively cite publication data if the printpubl option is set
  \texdefinition{btx:sbl:inline:ancienttextcrossref} % righttext is handled in here
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:inline:doi}
    \texdefinition{btx:sbl:inline:related}
  }
  \texdefinition{btx:sbl:inline:note}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inline:classictext
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    % A classictext may not have an author,
    % so be sure not to use one inherited from a cross-referenced source
    % TODO: This messes up the entries tacitus:ann and tacitus:ann:jackson,
    % which correctly list "Tacitus" as the author of both the individual text and the volume;
    % the correct way to solve this is to have inherited field mappings properly implemented.
    \texdefinition{btx:sbl:doifownfield} {author} {
      \texdefinition{btx:sbl:inline:author}
    }
  }
  \texdefinition{btx:sbl:inline:title} % lefttext is handled in here
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:inline:classictextcrossref} % righttext is handled in here
    \texdefinition{btx:sbl:inline:doi}
    \texdefinition{btx:sbl:inline:related}
  }
  \texdefinition{btx:sbl:inline:note}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inline:article
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:inline:author}
  }
  \texdefinition{btx:sbl:inline:title}
  \texdefinition{btx:sbl:inline:journalxref}
  \texdefinition{btx:sbl:inline:doi}
  \texdefinition{btx:sbl:inline:related}
  \texdefinition{btx:sbl:inline:note}
  \texdefinition{btx:sbl:inline:righttext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inline:magazine
  \fastsetup{btx:sbl:inline:article}
\stopsetups

\startsetups btx:sbl:inline:newspaper
  \fastsetup{btx:sbl:inline:article}
\stopsetups

\startsetups btx:sbl:inline:periodical
  \fastsetup{btx:sbl:inline:article}
\stopsetups

\startsetups btx:sbl:inline:review
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:inline:author}
  }
  \texdefinition{btx:sbl:inline:title}
  \texdefinition{btx:sbl:inline:reviewcrossref}
  \texdefinition{btx:sbl:inline:journalxref}
  \texdefinition{btx:sbl:inline:doi}
  \texdefinition{btx:sbl:inline:related}
  \texdefinition{btx:sbl:inline:note}
  \texdefinition{btx:sbl:inline:righttext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inline:thesis
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:inline:author}
  }
  \texdefinition{btx:sbl:inline:title}
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:inline:editortranslator}
    \texdefinition{btx:sbl:inline:institution}
    \texdefinition{btx:sbl:inline:doi}
    \texdefinition{btx:sbl:inline:related}
  }
  \texdefinition{btx:sbl:inline:note}
  \texdefinition{btx:sbl:inline:righttext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inline:mastersthesis
  \fastsetup{btx:sbl:inline:thesis}
\stopsetups

\startsetups btx:sbl:inline:phdthesis
  \fastsetup{btx:sbl:inline:thesis}
\stopsetups

\startsetups btx:sbl:inline:conferencepaper
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:inline:author}
  }
  \texdefinition{btx:sbl:inline:title}
  \texdefinition{btx:sbl:inline:presentedat}
  \texdefinition{btx:sbl:inline:doi}
  \texdefinition{btx:sbl:inline:related}
  \texdefinition{btx:sbl:inline:note}
  \texdefinition{btx:sbl:inline:righttext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inline:unpublished
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:inline:author}
  }
  \texdefinition{btx:sbl:inline:title}
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:inline:editortranslator}
    \texdefinition{btx:sbl:inline:doi}
    \texdefinition{btx:sbl:inline:related}
  }
  \texdefinition{btx:sbl:inline:note}
  \texdefinition{btx:sbl:inline:righttext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inline:online
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:inline:author}
  }
  \texdefinition{btx:sbl:inline:title}
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:inline:editortranslator}
    \texdefinition{btx:sbl:inline:eprint}
    \texdefinition{btx:sbl:inline:related}
  }
  \texdefinition{btx:sbl:inline:note}
  \texdefinition{btx:sbl:inline:righttext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inline:electronic
  \fastsetup{btx:sbl:inline:online}
\stopsetups

\startsetups btx:sbl:inline:misc
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:inline:author}
  }
  \texdefinition{btx:sbl:inline:title}
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:inline:editortranslator}
    \texdefinition{btx:sbl:inline:edition}
    \texdefinition{btx:sbl:inline:volumes}
    \texdefinition{btx:sbl:inline:seriesxref}
    \texdefinition{btx:sbl:inline:howpublished}
    \texdefinition{btx:sbl:inline:publisher}
    \texdefinition{btx:sbl:inline:doi}
    \texdefinition{btx:sbl:inline:related}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

% Inline subcitation setups
\startsetups btx:sbl:inlinesubcite:series
  % Always use the short form in subcites, if available
  \btxdoifelse {shorthand} {
    \texdefinition{btx:sbl:short:shorthand}
  } {
    \texdefinition{btx:sbl:inline:title}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlinesubcite:journal
  \fastsetup{btx:sbl:inlinesubcite:series}
\stopsetups

\startsetups btx:sbl:inlinesubcite:mvbook
  \texdefinition{btx:sbl:inline:title}
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:inlinesubcite:author}
  }
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:inlinesubcite:editortranslator}
    \texdefinition{btx:sbl:inline:edition}
    \texdefinition{btx:sbl:inline:volumes}
    \texdefinition{btx:sbl:inline:seriesxref}
    \texdefinition{btx:sbl:inline:publisher}
    \texdefinition{btx:sbl:inline:ebook}
    \texdefinition{btx:sbl:inline:doi}
    \texdefinition{btx:sbl:inline:related}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlinesubcite:mvreference
  \fastsetup{btx:sbl:inlinesubcite:mvbook}
\stopsetups

\startsetups btx:sbl:inlinesubcite:mvcollection
  \fastsetup{btx:sbl:inlinesubcite:mvbook}
\stopsetups

\startsetups btx:sbl:inlinesubcite:mvproceedings
  \fastsetup{btx:sbl:inlinesubcite:mvbook}
\stopsetups

\startsetups btx:sbl:inlinesubcite:book
  % A book may be untitled and have only a volume number and cross-reference,
  % so be sure not to use a title inherited from a cross-referenced source
  \texdefinition{btx:sbl:doifownfieldelse} {title} {
    \texdefinition{btx:sbl:inline:title}
    \btxdoifelse {crossref} {
      \begingroup
      \def\crossreftag{\btxflush{crossref}}
      % If this entry has the same author as the collection to which it belongs, then print the author after subciting the collection;
      % otherwise, print it inline format
      \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\crossreftag}{
        \texdefinition{btx:sbl:inlinesubcite:bookcrossref}
        % Only cite the author if the printauthor option is set
        \doif {\btxparameter{printauthor}} {\v!yes} {
          \texdefinition{btx:sbl:inlinesubcite:author}
        }
      } {
        % Only cite the author if the printauthor option is set
        \doif {\btxparameter{printauthor}} {\v!yes} {
          \texdefinition{btx:sbl:inline:author}
        }
        \texdefinition{btx:sbl:inlinesubcite:bookcrossref}
      }
      \endgroup
    } {
      % Only cite the author if the printauthor option is set
      \doif {\btxparameter{printauthor}} {\v!yes} {
        \texdefinition{btx:sbl:inlinesubcite:author}
      }
    }
  } {
    \begingroup
    \def\crossreftag{\btxflush{crossref}}
    % If this entry has the same author as the collection to which it belongs, then print the author after subciting the collection;
    % otherwise, print it inline format
    \texdefinition{btx:sbl:doifsamefoundnameauthorelse}{\currentbtxtag}{\crossreftag}{
      \texdefinition{btx:sbl:inlinesubcite:bookcrossref}
      % Only cite the author if the printauthor option is set
      \doif {\btxparameter{printauthor}} {\v!yes} {
        \texdefinition{btx:sbl:inlinesubcite:author}
      }
    } {
      % Only cite the author if the printauthor option is set
      \doif {\btxparameter{printauthor}} {\v!yes} {
        \texdefinition{btx:sbl:inline:author}
      }
      \texdefinition{btx:sbl:inlinesubcite:bookcrossref}
    }
    \endgroup
  }
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:inlinesubcite:editortranslator}
    \texdefinition{btx:sbl:inline:edition}
    \texdefinition{btx:sbl:inline:seriesxref}
    \texdefinition{btx:sbl:inline:publisher}
    \texdefinition{btx:sbl:inline:ebook}
    \texdefinition{btx:sbl:inline:doi}
    \texdefinition{btx:sbl:inline:related}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlinesubcite:reference
  \fastsetup{btx:sbl:inlinesubcite:book}
\stopsetups

\startsetups btx:sbl:inlinesubcite:collection
  \fastsetup{btx:sbl:inlinesubcite:book}
\stopsetups

\startsetups btx:sbl:inlinesubcite:proceedings
  \fastsetup{btx:sbl:inlinesubcite:book}
\stopsetups

\startsetups btx:sbl:inlinesubcite:manual
  \fastsetup{btx:sbl:inlinesubcite:book}
\stopsetups

\startsetups btx:sbl:inlinesubcite:inbook
  \texdefinition{btx:sbl:inline:title}
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:inlinesubcite:author}
  }
  \texdefinition{btx:sbl:inline:inbookcrossref}
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:inline:doi}
    \texdefinition{btx:sbl:inline:related}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlinesubcite:inreference
  \fastsetup{btx:sbl:inlinesubcite:inbook}
\stopsetups

\startsetups btx:sbl:inlinesubcite:incollection
  \fastsetup{btx:sbl:inlinesubcite:inbook}
\stopsetups

\startsetups btx:sbl:inlinesubcite:inproceedings
  \fastsetup{btx:sbl:inlinesubcite:inbook}
\stopsetups

\startsetups btx:sbl:inlinesubcite:suppbook
  % booksupps do not have titles, so print the author first in normal order, followed by the book cross-reference
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:inline:author}
    \removeunwantedspaces
    \removepunctuation
    \btxcomma
  }
  \texdefinition{btx:sbl:inline:suppbookcrossref}
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:list:doi}
    \texdefinition{btx:sbl:inline:related}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlinesubcite:ancienttext
  \texdefinition{btx:sbl:inline:title}
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    % An ancienttext may not have an author, 
    % so be sure not to use one inherited from a cross-referenced source
    \texdefinition{btx:sbl:doifownfield} {author} {
      \texdefinition{btx:sbl:inlinesubcite:author}
    }
  }
  \texdefinition{btx:sbl:inline:ancienttextcrossref}
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:inline:doi}
    \texdefinition{btx:sbl:inline:related}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlinesubcite:classictext
  \texdefinition{btx:sbl:inline:title}
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    % A classictext may not have an author,
    % so be sure not to use one inherited from a cross-referenced source
    \texdefinition{btx:sbl:doifownfield} {author} {
      \texdefinition{btx:sbl:inline:author}
    }
  }
  \texdefinition{btx:sbl:inline:classictextcrossref}
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:inline:doi}
    \texdefinition{btx:sbl:inline:related}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlinesubcite:article
  \texdefinition{btx:sbl:inline:title}
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:inlinesubcite:author}
  }
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:inline:journalxref}
    \texdefinition{btx:sbl:inline:doi}
    \texdefinition{btx:sbl:inline:related}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlinesubcite:magazine
  \fastsetup{btx:sbl:inlinesubcite:article}
\stopsetups

\startsetups btx:sbl:inlinesubcite:newspaper
  \fastsetup{btx:sbl:inlinesubcite:article}
\stopsetups

\startsetups btx:sbl:inlinesubcite:periodical
  \fastsetup{btx:sbl:inlinesubcite:article}
\stopsetups

\startsetups btx:sbl:inlinesubcite:review
  % Titles are not necessary for book reviews, 
  % so render the author correctly if there isn't one
  \btxdoifelse {title} {
    \texdefinition{btx:sbl:inline:title}
    % Only cite the author if the printauthor option is set
    \doif {\btxparameter{printauthor}} {\v!yes} {
      \texdefinition{btx:sbl:inlinesubcite:author}
    }
  } {
    % Only cite the author if the printauthor option is set
    \doif {\btxparameter{printauthor}} {\v!yes} {
      \texdefinition{btx:sbl:inline:author}
    }
  }
  \texdefinition{btx:sbl:inline:reviewcrossref}
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:inline:journalxref}
    \texdefinition{btx:sbl:inline:doi}
    \texdefinition{btx:sbl:inline:related}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlinesubcite:thesis
  \texdefinition{btx:sbl:inline:title}
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:inlinesubcite:author}
  }
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:inlinesubcite:editortranslator}
    \texdefinition{btx:sbl:inline:institution}
    \texdefinition{btx:sbl:inline:doi}
    \texdefinition{btx:sbl:inline:related}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlinesubcite:mastersthesis
  \fastsetup{btx:sbl:inlinesubcite:thesis}
\stopsetups

\startsetups btx:sbl:inlinesubcite:phdthesis
  \fastsetup{btx:sbl:inlinesubcite:thesis}
\stopsetups

\startsetups btx:sbl:inlinesubcite:conferencepaper
  \texdefinition{btx:sbl:inline:title}
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:inlinesubcite:author}
  }
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:inline:presentedat}
    \texdefinition{btx:sbl:inline:doi}
    \texdefinition{btx:sbl:inline:related}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:inlinesubcite:unpublished
  \texdefinition{btx:sbl:inline:title}
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:inlinesubcite:author}
  }
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:inline:editortranslator}
    \texdefinition{btx:sbl:inline:doi}
    \texdefinition{btx:sbl:inline:related}
  }
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:inlinesubcite:online
  \texdefinition{btx:sbl:inline:title}
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:inlinesubcite:author}
  }
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:inline:editortranslator}
    \texdefinition{btx:sbl:inline:eprint}
    \texdefinition{btx:sbl:inline:related}
  }
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

\startsetups btx:sbl:inlinesubcite:electronic
  \fastsetup{btx:sbl:inlinesubcite:online}
\stopsetups

\startsetups btx:sbl:inlinesubcite:misc
  \texdefinition{btx:sbl:inline:title}
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:inlinesubcite:author}
  }
  % Only recursively cite publication data if the printpubl option is set
  \doif {\btxparameter{printpubl}} {\v!yes} {
    \texdefinition{btx:sbl:inline:editortranslator}
    \texdefinition{btx:sbl:inline:edition}
    \texdefinition{btx:sbl:inline:volumes}
    \texdefinition{btx:sbl:inline:seriesxref}
    \texdefinition{btx:sbl:inline:howpublished}
    \texdefinition{btx:sbl:inline:publisher}
    \texdefinition{btx:sbl:inline:doi}
    \texdefinition{btx:sbl:inline:related}
  }
  \removeunwantedspaces
  \removepunctuation
  \btxperiod
\stopsetups

% Short citation setups
\startsetups btx:sbl:short:series
  \fastsetup{btx:sbl:short:book}
\stopsetups

\startsetups btx:sbl:short:journal
  \fastsetup{btx:sbl:short:series}
\stopsetups

\startsetups btx:sbl:short:mvbook
  \begingroup
  % If this entry has its own type, then check it requires special handling
  \texdefinition{btx:sbl:doifownfieldelse} {type} {
    % If this entry is of type "seriesascollection", then cite the series (and number), followed by any cited page numbers
    \doif {\btxflush{type}} {seriesascollection} {
      \texdefinition{btx:sbl:inline:seriesxref}
      \doifnot {\currentbtxrighttext} {\empty} {
        \removeunwantedspaces
        \removepunctuation
        \btxcolon
        \removeunwantedspaces
        \texdefinition{btx:sbl:short:righttext}
      }
    }
    % If this entry is of type "useseriesshorthand", then cite the shorthand of its series (without series and entry numbers) as its shorthand, followed by any cited page numbers
    \doif{\btxflush{type}}{useseriesshorthand} {
      % Is this a cross-reference to a separate entry for the series?
      \doifelse {\btxfoundname{series}} {seriesxref} {
        % If so, then recursively cite the shorthand for the series
        \def\seriesxreftag{\btxflush{series}}
        \textcite[alternative=short][\seriesxreftag]
        \btxspace
      } {
        % Otherwise, this field just contains the series shorthand or name; print it with the appropriate formatting
        \btxstartstyleandcolor[sbl:\s!list:title:series]
          \btxusecommand[sbl:\s!list:title:series] {
            \btxflush{series}% set the series name according to its style
          }
        \btxstopstyleandcolor
        \btxcomma
      }
      \texdefinition{btx:sbl:short:righttext}
    }
    % Otherwise, proceed normally
    \doifnotinset{\btxflush{type}}{seriesascollection, useseriesshorthand} {
      \btxdoifelse {shorthand} {
        \texdefinition{btx:sbl:short:shorthand}
      } {
        % Only cite the author if the printauthor option is set
        \doif {\btxparameter{printauthor}} {\v!yes} {
          \texdefinition{btx:sbl:short:author}
        }
        \texdefinition{btx:sbl:short:title}
      }
      \texdefinition{btx:sbl:short:righttext}
    }
  } {
    % Otherwise, proceed normally
    \btxdoifelse {shorthand} {
      \texdefinition{btx:sbl:short:shorthand}
    } {
      % Only cite the author if the printauthor option is set
      \doif {\btxparameter{printauthor}} {\v!yes} {
        \texdefinition{btx:sbl:short:author}
      }
      \texdefinition{btx:sbl:short:title}
    }
    \texdefinition{btx:sbl:short:righttext}
  }
  \removeunwantedspaces
  \removepunctuation
  \endgroup
\stopsetups

\startsetups btx:sbl:short:mvreference
  \fastsetup{btx:sbl:short:mvbook}
\stopsetups

\startsetups btx:sbl:short:mvcollection
  \fastsetup{btx:sbl:short:mvbook}
\stopsetups

\startsetups btx:sbl:short:mvproceedings
  \fastsetup{btx:sbl:short:mvbook}
\stopsetups

\startsetups btx:sbl:short:book
  % If this entry has its own type, then check it requires special handling
  \texdefinition{btx:sbl:doifownfieldelse} {type} {
    % If this entry is of type "seriesascollection", then cite the series (and number), followed by any cited page numbers
    \doif {\btxflush{type}} {seriesascollection} {
      \texdefinition{btx:sbl:inline:seriesxref}
      \doifnot {\currentbtxrighttext} {\empty} {
        \removeunwantedspaces
        \removepunctuation
        \btxcolon
        \removeunwantedspaces
        \texdefinition{btx:sbl:short:righttext}
      }
    }
    % If this entry is of type "useseriesshorthand", then cite the shorthand of its series (without series and entry numbers) as its shorthand, followed by any cited page numbers
    \doif {\btxflush{type}}{useseriesshorthand} {
      % Is this a cross-reference to a separate entry for the series?
      \doifelse {\btxfoundname{series}} {seriesxref} {
        % If so, then recursively cite the shorthand for the series
        \def\seriesxreftag{\btxflush{series}}
        \textcite[alternative=short][\seriesxreftag]
        \btxspace
      } {
        % Otherwise, this field just contains the series shorthand or name; print it with the appropriate formatting
        \btxstartstyleandcolor[sbl:\s!list:title:series]
          \btxusecommand[sbl:\s!list:title:series] {
            \btxflush{series}% set the series name according to its style
          }
        \btxstopstyleandcolor
        \btxcomma
      }
      \texdefinition{btx:sbl:short:righttext}
    }
    % Otherwise, proceed normally
    \doifnotinset{\btxflush{type}}{seriesascollection, useseriesshorthand} {
      % Does this entry have its own title?
      \texdefinition{btx:sbl:doifownfieldelse} {title} {
        % If so, then use its own shorthand, if it has one;
        % otherwise, use the shorthand of the set containing it, if there is one;
        % otherwise, use its title
        \texdefinition{btx:sbl:doifownfieldelse} {shorthand} {
          \texdefinition{btx:sbl:short:shorthand}
          \texdefinition{btx:sbl:short:righttext}
        } {
          \btxdoifelse{crossref} {
            \begingroup
            \def\crossreftag{\btxflush{crossref}}
            \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{shorthand} {
              % If the set containing this entry has a shorthand, then cite it
              \textcite[alternative=short][\crossreftag]
              \btxcomma
              % If there are any cited page numbers, then prefix them with the volume and part of this entry
              \doifnot {\currentbtxrighttext} {\empty} {
                \removeunwantedspaces
                \removepunctuation
                \btxspace
                \btxflush{volume}
                \btxdoif{part} {
                  \btxperiod
                  \removeunwantedspaces
                  \btxflush{part}
                }
                \btxcolon
                \removeunwantedspaces
                \texdefinition{btx:sbl:short:righttext}
              }
            } {
              % Only cite the author if the printauthor option is set
              \doif {\btxparameter{printauthor}} {\v!yes} {
                \texdefinition{btx:sbl:short:author}
              }
              \texdefinition{btx:sbl:short:title}
              \texdefinition{btx:sbl:short:righttext}
            }
            \endgroup
          } {
            % Only cite the author if the printauthor option is set
            \doif {\btxparameter{printauthor}} {\v!yes} {
              \texdefinition{btx:sbl:short:author}
            }
            \texdefinition{btx:sbl:short:title}
            \texdefinition{btx:sbl:short:righttext}
          }
        }
      } {
        % If not, then it is part of a multivolume set; do a short citation of the set
        \begingroup
        \def\crossreftag{\btxflush{crossref}}
        \textcite[alternative=short][\crossreftag]
        \btxcomma
        % If there are any cited page numbers, then prefix them with the volume and part of this entry
        \doifnot {\currentbtxrighttext} {\empty} {
          % If the set has a shorthand, then remove the preceding comma
          \clf_btxdoif{\currentbtxdataset}{\crossreftag}{shorthand} {
            \removeunwantedspaces
            \removepunctuation
            \btxspace
          }
          \btxflush{volume}% required field for incollection
          \btxdoif{part} {
            \btxperiod
            \removeunwantedspaces
            \btxflush{part}
          }
          \btxcolon
          \removeunwantedspaces
          \texdefinition{btx:sbl:short:righttext}
        }
        \endgroup
      }
    }
  } {
    % Otherwise, proceed normally
    % Does this entry have its own title?
    \texdefinition{btx:sbl:doifownfieldelse} {title} {
      % If so, then use its own shorthand, if it has one;
      % otherwise, use the shorthand of the set containing it, if there is one;
      % otherwise, use its title
      \texdefinition{btx:sbl:doifownfieldelse} {shorthand} {
        \texdefinition{btx:sbl:short:shorthand}
        \texdefinition{btx:sbl:short:righttext}
      } {
        \btxdoifelse{crossref} {
          \begingroup
          \def\crossreftag{\btxflush{crossref}}
          \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{shorthand} {
            % If the set containing this entry has a shorthand, then cite it
            \textcite[alternative=short][\crossreftag]
            \btxcomma
            % If there are any cited page numbers, then prefix them with the volume and part of this entry
            \doifnot {\currentbtxrighttext} {\empty} {
              \removeunwantedspaces
              \removepunctuation
              \btxspace
              \btxflush{volume}
              \btxdoif{part} {
                \btxperiod
                \removeunwantedspaces
                \btxflush{part}
              }
              \btxcolon
              \removeunwantedspaces
              \texdefinition{btx:sbl:short:righttext}
            }
          } {
            % Only cite the author if the printauthor option is set
            \doif {\btxparameter{printauthor}} {\v!yes} {
              \texdefinition{btx:sbl:short:author}
            }
            \texdefinition{btx:sbl:short:title}
            \texdefinition{btx:sbl:short:righttext}
          }
          \endgroup
        } {
          % Only cite the author if the printauthor option is set
          \doif {\btxparameter{printauthor}} {\v!yes} {
            \texdefinition{btx:sbl:short:author}
          }
          \texdefinition{btx:sbl:short:title}
          \texdefinition{btx:sbl:short:righttext}
        }
      }
    } {
      % If not, then it is part of a multivolume set; do a short citation of the set
      \begingroup
      \def\crossreftag{\btxflush{crossref}}
      \textcite[alternative=short][\crossreftag]
      \btxcomma
      % If there are any cited page numbers, then prefix them with the volume and part of this entry
      \doifnot {\currentbtxrighttext} {\empty} {
        % If the set has a shorthand, then remove the preceding comma
        \clf_btxdoif{\currentbtxdataset}{\crossreftag}{shorthand} {
          \removeunwantedspaces
          \removepunctuation
          \btxspace
        }
        \btxflush{volume}% required field for incollection
        \btxdoif{part} {
          \btxperiod
          \removeunwantedspaces
          \btxflush{part}
        }
        \btxcolon
        \removeunwantedspaces
        \texdefinition{btx:sbl:short:righttext}
      }
      \endgroup
    }
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:short:reference
  \fastsetup{btx:sbl:short:book}
\stopsetups

\startsetups btx:sbl:short:collection
  \fastsetup{btx:sbl:short:book}
\stopsetups

\startsetups btx:sbl:short:proceedings
  \fastsetup{btx:sbl:short:book}
\stopsetups

\startsetups btx:sbl:short:manual
  \fastsetup{btx:sbl:short:book}
\stopsetups

\startsetups btx:sbl:short:inbook
  \texdefinition{btx:sbl:doifownfieldelse} {shorthand} {
    \texdefinition{btx:sbl:short:shorthand}
  } {
    % Only cite the author if the printauthor option is set
    \doif {\btxparameter{printauthor}} {\v!yes} {
      \texdefinition{btx:sbl:short:author}
    }
    \texdefinition{btx:sbl:short:title}
  }
  % Otherwise, just print the cited page number as-is
  \texdefinition{btx:sbl:short:righttext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:short:inreference
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:short:author}
  }
  % If this is part of a multivolume reference with a shorthand, 
  % then print that shorthand instead of this entry's title
  \btxdoifelse{crossref} {
    \begingroup
    \def\crossreftag{\btxflush{crossref}}
    \clf_btxdoifelse{\currentbtxdataset}{\crossreftag}{crossref} {
      \def\collectiontag{\clf_btxdirect{\currentbtxdataset}{\crossreftag}{crossref}}
      \clf_btxdoifelse{\currentbtxdataset}{\collectiontag}{shorthand} {
        \texdefinition{btx:sbl:short:inreferencecrossref} % righttext is handled in here
      } {
        \texdefinition{btx:sbl:short:title}
        \texdefinition{btx:sbl:short:righttext}
      }
    } {
      \texdefinition{btx:sbl:short:title}
      \texdefinition{btx:sbl:short:righttext}
    }
    \endgroup
  } {
    \texdefinition{btx:sbl:short:title}
    \texdefinition{btx:sbl:short:righttext}
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:short:incollection
  \fastsetup{btx:sbl:short:inbook}
\stopsetups

\startsetups btx:sbl:short:inproceedings
  \fastsetup{btx:sbl:short:inbook}
\stopsetups

\startsetups btx:sbl:short:suppbook
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:short:author}
  }
  \texdefinition{btx:sbl:short:suppbookcrossref}
  \texdefinition{btx:sbl:short:righttext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:short:ancienttext
  \texdefinition{btx:sbl:doifownfieldelse} {shorthand} {
    \texdefinition{btx:sbl:short:shorthand} % lefttext is handled in here
    \texdefinition{btx:sbl:short:ancienttextcrossref} % righttext is handled in here
  } {
    % Only cite the author if the printauthor option is set
    \doif {\btxparameter{printauthor}} {\v!yes} {
      % An ancienttext may not have an author, 
      % so be sure not to use one inherited from a cross-referenced source
      \texdefinition{btx:sbl:doifownfield} {author} {
        \texdefinition{btx:sbl:short:author}
      }
    }
    \texdefinition{btx:sbl:short:title} % lefttext is handled in here
    \texdefinition{btx:sbl:short:ancienttextcrossref} % righttext is handled in here
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:short:classictext
  \texdefinition{btx:sbl:doifownfieldelse} {shorthand} {
    \texdefinition{btx:sbl:short:shorthand}
    \doifnot {\currentbtxlefttext} {\empty} {
      \removeunwantedspaces
      \removepunctuation
      \btxspace
      \texdefinition{btx:sbl:short:lefttext}
    }
  } {
    % Only cite the author if the printauthor option is set
    \doif {\btxparameter{printauthor}} {\v!yes} {
      \texdefinition{btx:sbl:short:author}
    }
    \texdefinition{btx:sbl:short:classictexttitle} % lefttext is handled in here
    \texdefinition{btx:sbl:short:classictextcrossref} % righttext is handled in here
  }
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:short:article
  \fastsetup{btx:sbl:short:book}
\stopsetups

\startsetups btx:sbl:short:magazine
  \fastsetup{btx:sbl:short:article}
\stopsetups

\startsetups btx:sbl:short:newspaper
  \fastsetup{btx:sbl:short:article}
\stopsetups

\startsetups btx:sbl:short:periodical
  \fastsetup{btx:sbl:short:article}
\stopsetups

\startsetups btx:sbl:short:review
  % Print the author, then either the title (if there is one) or a summary of the review
  % Only cite the author if the printauthor option is set
  \doif {\btxparameter{printauthor}} {\v!yes} {
    \texdefinition{btx:sbl:short:author}
  }
  \texdefinition{btx:sbl:doifownfieldelse} {title} {
    \texdefinition{btx:sbl:short:title}
  } {
    \texdefinition{btx:sbl:short:reviewcrossref}
  }
  \texdefinition{btx:sbl:short:righttext}
  \removeunwantedspaces
  \removepunctuation
\stopsetups

\startsetups btx:sbl:short:thesis
  \fastsetup{btx:sbl:short:book}
\stopsetups

\startsetups btx:sbl:short:mastersthesis
  \fastsetup{btx:sbl:short:thesis}
\stopsetups

\startsetups btx:sbl:short:phdthesis
  \fastsetup{btx:sbl:short:thesis}
\stopsetups

\startsetups btx:sbl:short:conferencepaper
  \fastsetup{btx:sbl:short:book}
\stopsetups

\startsetups btx:sbl:short:unpublished
  \fastsetup{btx:sbl:short:book}
\stopsetups

\startsetups btx:sbl:short:online
  \fastsetup{btx:sbl:short:book}
\stopsetups

\startsetups btx:sbl:short:electronic
  \fastsetup{btx:sbl:short:online}
\stopsetups

\startsetups btx:sbl:short:misc
  \fastsetup{btx:sbl:short:book}
\stopsetups

%%%%%%%%%%%%%%%%%%%%%%%%%
% Cite alternative setups
%%%%%%%%%%%%%%%%%%%%%%%%%

% List citation setup
\startsetups btx:sbl:cite:entry
  \fastsetup{\s!btx:\s!cite:concat}
  \fastsetup{\s!btx:\s!cite:left}
  \begingroup
  \def\currentbtxcitealternative{list}
  % Reset variables for new citation
  \def\currentbtxcategory{\btxfield{category}}
  \btxhandleciteentry
  \endgroup
  \fastsetup{\s!btx:\s!cite:right}
\stopsetups

% List subcitation setup
\startsetups btx:sbl:cite:listsubcite
  \begingroup
  \def\currentbtxcitealternative{listsubcite}
  % This gets cleared in cites, so set it here 
  \def\currentbtxcategory{\btxfield{category}}
  \fastsetup{btx:sbl:listsubcite:\currentbtxcategory}
  \endgroup
\stopsetups

% Inline citation setup
\startsetups btx:sbl:cite:inline
  \fastsetup{\s!btx:\s!cite:concat}
  \fastsetup{\s!btx:\s!cite:left}
  \begingroup
  \def\currentbtxcitealternative{inline}
  % This gets cleared in cites, so set it here
  \def\currentbtxcategory{\btxfield{category}}
  % Check if the entry with the current tag has been cited already
  \btxdoifelsecitedone\currentbtxdataset\currentbtxtag{
    % If it has, then use a short citation
    \fastsetup{btx:sbl:cite:short}
  } {
    % Otherwise, invoke the appropriate setup
    \texdefinition{btx:sbl:doifownfieldelse} {shorthand} {
      \fastsetup{btx:sbl:cite:short}
    } {
      % If this entry has its own type, then check if it requires special handling
      \texdefinition{btx:sbl:doifownfieldelse} {type} {
        % If this entry is of type "useseriesshorthand", then cite the shorthand of its series (without series and entry numbers) as its shorthand, followed by any cited page numbers
        \doif{\btxflush{type}}{useseriesshorthand} {
          % Is this a cross-reference to a separate entry for the series?
          \doifelse {\btxfoundname{series}} {seriesxref} {
            % If so, then recursively cite the shorthand for the series
            \def\seriesxreftag{\btxflush{series}}
            \textcite[alternative=short][\seriesxreftag]
            \btxspace
          } {
            % Otherwise, this field just contains the series shorthand or name; print it with the appropriate formatting
            \btxstartstyleandcolor[sbl:\s!list:title:series]
              \btxusecommand[sbl:\s!list:title:series] {
                \btxflush{series}% set the series name according to its style
              }
            \btxstopstyleandcolor
            \btxcomma
          }
          \texdefinition{btx:sbl:short:righttext}
          \removeunwantedspaces
          \removepunctuation
        }
        % Otherwise, proceed normally
        \doifnotinset{\btxflush{type}}{useseriesshorthand} {
          \fastsetup{btx:sbl:inline:\currentbtxcategory}
        }
      } {
        % Otherwise, proceed normally
        \fastsetup{btx:sbl:inline:\currentbtxcategory}
      }
    }
  }
  \endgroup
  \removeunwantedspaces
  \removepunctuation
  \doifnot{\btxparameter{punct}}{\empty} {
    \btxparameter{punct}
  }
  \fastsetup{\s!btx:\s!cite:right}
  % Finally, update the global variable for the previous inline citation
  \setxvariables[btx:sbl][previousinlinetag=\currentbtxtag]
\stopsetups

% Inline subcitation setup
\startsetups btx:sbl:cite:inlinesubcite
  \begingroup
  \def\currentbtxcitealternative{inlinesubcite}
  % This gets cleared in cites, so set it here
  \def\currentbtxcategory{\btxfield{category}}
  % Then invoke the appropriate setup
  \texdefinition{btx:sbl:doifownfieldelse} {shorthand} {
    \fastsetup{btx:sbl:cite:short}
  } {
    \fastsetup{btx:sbl:inlinesubcite:\currentbtxcategory}
  }
  \endgroup
\stopsetups

% Inline parenthetical citation setup
\startsetups btx:sbl:cite:paren
  \fastsetup{btx:sbl:cite:inline}
\stopsetups

% Inline footnote citation setup (with intelligent trailing punctuation replacement)
\startsetups btx:sbl:cite:footnote
  \removeunwantedspaces
  \doifinstring{\btxparameter{punct}}{\btxparameter{autopunctuation}}{\btxparameter{punct}}
  \startfootnote
    \fastsetup{btx:sbl:cite:inline}
    \removeunwantedspaces
    \removepunctuation
    \btxperiod
  \stopfootnote
  \doifnotinstring{\btxparameter{punct}}{\btxparameter{autopunctuation}}{\btxparameter{punct}}
\stopsetups

% Short citations setup
\startsetups btx:sbl:cite:short
  \fastsetup{\s!btx:\s!cite:concat}
  \fastsetup{\s!btx:\s!cite:left}
  \begingroup
  \def\currentbtxcitealternative{short}
  \def\currentbtxcategory{\btxfield{category}}
  % If this entry has its own shorthand, then add it to the abbreviations list,
  % associated with the listsubcite alternative of its citation
  \texdefinition{btx:sbl:doifownfieldelse} {shorthand} {
    % If the shorthand matches the shorttitle, then use the listsubcite (= title first) variant for the long-form citation;
    % otherwise, use the list entry (= author first) variant.
    % NB: Alternate abbreviation lists (e.g., a separate one for the bibliography, or individual ones for journals, series, books, etc.)
    % could be used based on user settings if we replace "abbreviation" below with the appropriate name
    \doifelse {\btxflush{shorthand}} {\btxflush{shorttitle}} {
      %\expanded{\definesynonym[yes][abbreviation][\currentbtxtag]{\fastsetup{btx:sbl:cite:shorthand}}{\fastsetup{btx:sbl:cite:listsubcite}}}
      \expanded{\definesynonym[yes][abbreviation][\currentbtxtag]{\textcite[alternative=shorthand][\currentbtxtag]}{\textcite[alternative=listsubcite][\currentbtxtag]}}
    } {
      %\expanded{\definesynonym[yes][abbreviation][\currentbtxtag]{\fastsetup{btx:sbl:cite:shorthand}}{\fastsetup{btx:sbl:cite:entry}\removepunctuation}}
      \expanded{\definesynonym[yes][abbreviation][\currentbtxtag]{\textcite[alternative=shorthand][\currentbtxtag]}{\textcite[alternative=entry][\currentbtxtag]\removepunctuation}}
    }
    % If the useibid option is set and this entry matches the last one cited, then just print "ibid.", followed by any cited passages and page numbers
    \doifelse {\btxparameter{useibid}} {\v!yes} {
      \doifelse {\currentbtxtag} {\getvariable{btx:sbl}{previousinlinetag}} {
        \btxlabeltext{sbl:ibid}
        \btxcomma
        \doifnot {\currentbtxlefttext} {\empty} {
          \texdefinition{btx:sbl:short:lefttext}
        }
        \doifnot {\currentbtxrighttext} {\empty} {
          \texdefinition{btx:sbl:short:righttext}
        }
        \removeunwantedspaces
        \removepunctuation
      } {
        \inshort{\currentbtxtag}
        \btxcomma
        \doifnot {\currentbtxlefttext} {\empty} {
          \texdefinition{btx:sbl:short:lefttext}
        }
        \doifnot {\currentbtxrighttext} {\empty} {
          \texdefinition{btx:sbl:short:righttext}
        }
        \removeunwantedspaces
        \removepunctuation
      }
    } {
      \inshort{\currentbtxtag}
      \btxcomma
      \doifnot {\currentbtxlefttext} {\empty} {
        \texdefinition{btx:sbl:short:lefttext}
      }
      \doifnot {\currentbtxrighttext} {\empty} {
        \texdefinition{btx:sbl:short:righttext}
      }
      \removeunwantedspaces
      \removepunctuation
    }
  } {
    % If the useibid option is set and this entry matches the last one cited, then just print "ibid.", followed by any cited passages and page numbers
    \doifelse {\btxparameter{useibid}} {\v!yes} {
      \doifelse {\currentbtxtag} {\getvariable{btx:sbl}{previousinlinetag}} {
        \btxlabeltext{sbl:ibid}
        \btxcomma
        \doifnot {\currentbtxlefttext} {\empty} {
          \texdefinition{btx:sbl:short:lefttext}
        }
        \doifnot {\currentbtxrighttext} {\empty} {
          \texdefinition{btx:sbl:short:righttext}
        }
        \removeunwantedspaces
        \removepunctuation
      } {
        \fastsetup{btx:sbl:short:\currentbtxcategory}
      }
    } {
      \fastsetup{btx:sbl:short:\currentbtxcategory}
    }
  }
  \endgroup
  \removeunwantedspaces
  \removepunctuation
  \doifnot{\btxparameter{punct}}{\empty} {
    \btxparameter{punct}
  }
  \fastsetup{\s!btx:\s!cite:right}
  % Finally, update the global variable for the previous inline citation
  \setxvariables[btx:sbl][previousinlinetag=\currentbtxtag]
\stopsetups

% Title citation setup
\startsetups btx:sbl:cite:title
  \texdefinition{btx:sbl:inline:title}
  \removeunwantedspaces
  \removepunctuation
  \doifnot{\btxparameter{punct}}{\empty} {
    \btxparameter{punct}
  }
\stopsetups

% Shorthand citation setup
\startsetups btx:sbl:cite:shorthand
  \begingroup
  \def\currentbtxcitealternative{short}
  \def\currentbtxcategory{\btxfield{category}}
  \texdefinition{btx:sbl:short:shorthand}
  \endgroup
  \removeunwantedspaces
  \removepunctuation
  \doifnot{\btxparameter{punct}}{\empty} {
    \btxparameter{punct}
  }
\stopsetups

% Volume (and part) number citation setup
\startsetups btx:sbl:cite:volume
  \btxdoif{volume} {
    \btxflush{volume}
    \removeunwantedspaces
    \btxdoif{part} {
      \btxperiod
      \removeunwantedspaces
      \btxflush{part}
    }
  }
  \removeunwantedspaces
  \doifnot{\btxparameter{punct}}{\empty} {
    \removeunwantedspaces
    \removepunctuation
    \btxparameter{punct}
  }
\stopsetups

% Define more concise biblatex-style citation commands

% default alternative citation
\def\autocite{\dodoubleempty\doautocite}
\def\doautocite[#1][#2]#3#4{%
  \ifsecondargument
    % if there are two optional arguments,
    % then assume the first is the prenote and the second is the postnote
    \cite[lefttext={#1},righttext={#2},punct={#4}][#3]%
  \else
    \iffirstargument
      % if there is only one optional argument,
      % then assume it is a postnote
      \cite[righttext={#1},punct={#4}][#3]%
    \else
      % if there are no optional arguments,
      % then just cite the entry by itself
      \cite[punct={#4}][#3]%
    \fi
  \fi
}

% inline citation (biblatex uses \textcite, but that is reserved for a different function in publ-ini.mkiv)
\def\inlinecite{\dodoubleempty\doinlinecite}
\def\doinlinecite[#1][#2]#3#4{%
  \ifsecondargument
    % if there are two optional arguments,
    % then assume the first is the prenote and the second is the postnote
    \cite[alternative=inline,lefttext={#1},righttext={#2},punct={#4}][#3]%
  \else
    \iffirstargument
      % if there is only one optional argument,
      % then assume it is a postnote
      \cite[alternative=inline,righttext={#1},punct={#4}][#3]%
    \else
      % if there are no optional arguments,
      % then just cite the entry by itself
      \cite[alternative=inline,punct={#4}][#3]%
    \fi
  \fi
}

% parenthetical citation
\unexpanded\def\parencite{\dodoubleempty\doparencite}
\unexpanded\def\doparencite[#1][#2]#3#4{%
  \ifsecondargument
    % if there are two optional arguments,
    % then assume the first is the prenote and the second is the postnote
    \cite[alternative=paren,lefttext={#1},righttext={#2},punct={#4}][#3]%
  \else
    \iffirstargument
      % if there is only one optional argument,
      % then assume it is a postnote
      \cite[alternative=paren,righttext={#1},punct={#4}][#3]%
    \else
      % if there are no optional arguments,
      % then just cite the entry by itself
      \cite[alternative=paren,punct={#4}][#3]%
    \fi
  \fi
}

% footnote citation
\def\footcite{\dodoubleempty\dofootcite}
\def\dofootcite[#1][#2]#3#4{%
  \ifsecondargument
    % if there are two optional arguments,
    % then assume the first is the prenote and the second is the postnote
    \cite[alternative=footnote,lefttext={#1},righttext={#2},punct={#4}][#3]%
  \else
    \iffirstargument
      % if there is only one optional argument,
      % then assume it is a postnote
      \cite[alternative=footnote,righttext={#1},punct={#4}][#3]%
    \else
      % if there are no optional arguments,
      % then just cite the entry by itself
      \cite[alternative=footnote,punct={#4}][#3]%
    \fi
  \fi
}

\stopbtxrenderingdefinitions
